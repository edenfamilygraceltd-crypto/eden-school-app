<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portail Directeur - Eden Family School</title>
    
    <!-- üîí S√âCURIT√â: Script d'authentification -->
    <script src="security-auth.js"></script>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Responsive CSS Global -->
    <link rel="stylesheet" href="responsive.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase v8 (Version stable) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script>
    
    <style>
        :root {
            --primary: #1e3a8a;
            --primary-light: #3b82f6;
            --secondary: #7c3aed;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            --dark: #1f2937;
            --light: #f9fafb;
            --gradient-primary: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            --gradient-secondary: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%);
            --box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            --box-shadow-hover: 0 15px 50px rgba(0, 0, 0, 0.15);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%);
            min-height: 100vh;
            color: var(--dark);
        }
        
        /* Header */
        .admin-header {
            background: var(--gradient-primary);
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 4px 20px rgba(30, 58, 138, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo-icon {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: var(--primary);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.3);
        }
        
        .logo-text h1 {
            font-family: 'Poppins', sans-serif;
            font-weight: 800;
            font-size: 1.8rem;
            margin: 0;
        }
        
        .logo-text p {
            margin: 0;
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        /* Navigation */
        .admin-nav {
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 100px;
            z-index: 999;
        }
        
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }
        
        .nav-tabs {
            display: flex;
            gap: 5px;
            overflow-x: auto;
            padding: 1rem 0;
        }
        
        .nav-btn {
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: var(--dark);
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-btn:hover {
            background: rgba(30, 58, 138, 0.1);
            color: var(--primary);
        }
        
        .nav-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
        }
        
        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        
        .section {
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Cards */
        .card-modern {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--box-shadow);
            margin-bottom: 2rem;
            border: 1px solid #e5e7eb;
        }
        
        .card-modern:hover {
            box-shadow: var(--box-shadow-hover);
        }
        
        .card-header-modern {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f3f4f6;
        }
        
        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--box-shadow);
            transition: all 0.3s;
            border-left: 4px solid var(--primary);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow-hover);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            margin-bottom: 1rem;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--dark);
            margin: 0.5rem 0;
        }
        
        .stat-label {
            color: #6b7280;
            font-size: 0.9rem;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.5rem;
            display: block;
        }
        
        .form-control-modern {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .form-control-modern:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
        
        /* Buttons */
        .btn-modern {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary-modern {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary-modern:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 58, 138, 0.4);
        }
        
        .btn-success-modern {
            background: var(--success);
            color: white;
        }
        
        .btn-danger-modern {
            background: var(--danger);
            color: white;
        }
        
        .btn-warning-modern {
            background: var(--warning);
            color: white;
        }
        
        /* Table */
        .table-modern {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table-modern thead {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
        }
        
        .table-modern th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }
        
        .table-modern td {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .table-modern tbody tr:hover {
            background: #f9fafb;
        }
        
        /* Badges */
        .badge-modern {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .badge-primary {
            background: rgba(30, 58, 138, 0.1);
            color: var(--primary);
        }
        
        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        
        .badge-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        /* Branch Selector */
        .branch-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .branch-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .branch-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(30, 58, 138, 0.2);
        }
        
        .branch-card.selected {
            border-color: var(--primary);
            background: rgba(30, 58, 138, 0.05);
        }
        
        .branch-card i {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }
        
        .branch-card h6 {
            margin: 0;
            color: var(--dark);
            font-weight: 600;
        }
        
        /* Alert */
        .alert-modern {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border-left: 4px solid var(--success);
            color: var(--success);
        }
        
        .alert-danger {
            background: rgba(239, 68, 68, 0.1);
            border-left: 4px solid var(--danger);
            color: var(--danger);
        }
        
        .alert-info {
            background: rgba(6, 182, 212, 0.1);
            border-left: 4px solid var(--info);
            color: var(--info);
        }
        
        /* Modal */
        .modal-modern {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1100;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content-modern {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--box-shadow);
            animation: modalSlideIn 0.3s;
        }
        
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header-modern {
            padding: 1.5rem;
            border-bottom: 2px solid #f3f4f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body-modern {
            padding: 1.5rem;
        }
        
        .modal-footer-modern {
            padding: 1.5rem;
            border-top: 2px solid #f3f4f6;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        
        /* Gallery Grid */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        .gallery-item {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--box-shadow);
            transition: all 0.3s;
        }
        
        .gallery-item:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow-hover);
        }
        
        .gallery-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        
        .gallery-info {
            padding: 1rem;
        }
        
        /* Message Inbox */
        .message-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .message-item {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--box-shadow);
            border-left: 4px solid var(--primary);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .message-item:hover {
            transform: translateX(5px);
        }
        
        .message-item.unread {
            border-left-color: var(--warning);
            background: rgba(245, 158, 11, 0.05);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-container, .nav-container, .main-content {
                padding: 0 1rem;
            }
            
            .logo-text h1 {
                font-size: 1.3rem;
            }
            
            .nav-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }

            body {
                font-size: 14px;
            }

            input, select, textarea, button {
                font-size: 15px;
                min-height: 44px;
            }

            .col-md-4 {
                margin-bottom: 1rem;
            }
        }

        /* Tr√®s petits √©crans (320px - 479px) */
        @media (max-width: 479px) {
            body {
                font-size: 13px;
                overflow-x: hidden;
            }

            .header-container {
                padding: 0 0.5rem;
                flex-wrap: wrap;
                gap: 0.5rem;
                flex-direction: column;
            }

            .logo-text h1 {
                font-size: 1rem;
            }

            .nav-container, .main-content {
                padding: 0 0.5rem;
            }

            .nav-btn {
                padding: 8px 10px;
                font-size: 0.8rem;
                margin: 2px;
                min-height: 44px;
            }

            .nav-tabs {
                gap: 2px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .stat-card {
                padding: 0.75rem;
                margin-bottom: 0.5rem;
                border-radius: 8px;
            }

            h1 { font-size: 1.1rem; }
            h2 { font-size: 1rem; }
            h3, h4 { font-size: 0.9rem; }

            .form-label {
                font-size: 0.85rem;
                margin-bottom: 0.25rem;
            }

            input[type="text"],
            input[type="email"],
            input[type="tel"],
            input[type="date"],
            input[type="number"],
            select,
            textarea {
                font-size: 16px;
                padding: 0.75rem;
                width: 100%;
                border-radius: 6px;
                min-height: 44px;
            }

            button, .btn {
                padding: 0.75rem;
                font-size: 0.9rem;
                width: 100%;
                border-radius: 6px;
                min-height: 44px;
            }

            .d-flex {
                flex-direction: column;
                gap: 0.5rem;
            }

            .row {
                margin: 0;
                gap: 0.5rem;
            }

            [class*="col-"] {
                padding: 0.25rem;
                margin-bottom: 0.5rem;
                width: 100%;
            }

            table {
                font-size: 0.75rem;
            }

            table th, table td {
                padding: 0.35rem;
            }

            .modal-dialog {
                margin: 0.5rem;
                width: 95%;
                max-width: 95%;
            }

            .modal-content {
                border-radius: 8px;
            }

            .modal-body {
                padding: 0.75rem;
            }

            .modal-header, .modal-footer {
                padding: 0.5rem;
            }

            .toast-notification {
                max-width: 95%;
                right: 5px;
                left: 5px;
                font-size: 0.8rem;
                padding: 0.75rem;
            }

            .d-grid {
                grid-template-columns: 1fr;
            }

            .d-md-flex {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }

            .gap-2 {
                gap: 0.5rem !important;
            }

            .text-end {
                text-align: left;
            }

            .alert {
                padding: 0.75rem;
                margin-bottom: 0.75rem;
                font-size: 0.85rem;
                border-radius: 6px;
            }

            .badge {
                font-size: 0.65rem;
                padding: 0.25em 0.4em;
            }

            .icon-text-primary {
                margin-right: 0.25rem;
            }

            .fa-2x {
                font-size: 1.5rem;
            }

            .fa-3x {
                font-size: 2rem;
            }

            /* Espacements responsifs */
            .mb-3, .mb-4 {
                margin-bottom: 0.75rem !important;
            }

            .mt-3, .mt-4 {
                margin-top: 0.75rem !important;
            }

            .p-3, .p-4 {
                padding: 0.75rem !important;
            }

            .card {
                border-radius: 8px;
                margin-bottom: 0.75rem;
            }

            .card-header {
                padding: 0.5rem;
                font-size: 0.85rem;
            }

            .card-body {
                padding: 0.5rem;
            }
        }

        /* Petites tablettes (480px - 767px) */
        @media (min-width: 480px) and (max-width: 767px) {
            body {
                font-size: 14px;
            }

            .header-container {
                flex-wrap: wrap;
                gap: 0.75rem;
            }

            .logo-text h1 {
                font-size: 1.1rem;
            }

            .nav-btn {
                padding: 8px 12px;
                font-size: 0.85rem;
                min-height: 44px;
            }

            input, select, textarea, button {
                font-size: 14px;
                min-height: 44px;
            }

            .stat-card {
                padding: 0.875rem;
                font-size: 0.9rem;
            }

            table {
                font-size: 0.85rem;
            }

            h1 { font-size: 1.2rem; }
            h2 { font-size: 1rem; }
        }

        /* Tablettes moyennes (768px - 1023px) */
        @media (min-width: 768px) and (max-width: 1023px) {
            .header-container {
                padding: 0 1.5rem;
            }

            .nav-container, .main-content {
                padding: 0 1.5rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .col-md-4 {
                width: 50%;
            }

            .col-md-6 {
                width: 50%;
            }
        }

        /* √âcrans larges (1024px+) */
        @media (min-width: 1024px) {
            .header-container {
                padding: 0 2rem;
            }

            .nav-container, .main-content {
                padding: 0 2rem;
            }

            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .col-md-3 {
                width: 25%;
            }

            .col-md-4 {
                width: 33.33%;
            }

            .col-md-6 {
                width: 50%;
            }
        }
        
        /* Academic Tabs */
        .academic-tab {
            display: block;
        }
        
        /* Toast Notification */
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
            animation: slideInRight 0.3s;
            background: white;
            border-left: 4px solid var(--primary);
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Password toggle styles */
        .password-input-container {
            position: relative;
        }

        .password-toggle-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #999;
            font-size: 16px;
            padding: 4px 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }

        .password-toggle-btn:hover {
            color: #1e3a8a;
        }

        .password-input-container input {
            padding-right: 40px !important;
        }
    </style>
    <script src="password-visibility.js"></script>
    <script>
        // D√©finir logout de mani√®re pr√©coce pour √©viter les probl√®mes de timing
        let auth = null;
        let currentUser = null;
        let currentUserData = null;
        
        function logout() {
            if (!auth) {
                console.error('Firebase auth not initialized yet. Please try again.');
                alert('Erreur: Authentification non initialis√©e. Veuillez r√©essayer.');
                return;
            }
            
            if (confirm('√ätes-vous s√ªr de vouloir vous d√©connecter ?')) {
                auth.signOut().then(() => {
                    console.log('D√©connexion r√©ussie');
                    if (typeof showNotification === 'function') {
                        showNotification('D√©connexion', 'Vous avez √©t√© d√©connect√© avec succ√®s', 'success');
                    }
                    setTimeout(() => {
                        window.location.href = 'Auth.html';
                    }, 500);
                }).catch((error) => {
                    console.error('Erreur lors de la d√©connexion:', error);
                    if (typeof showNotification === 'function') {
                        showNotification('Erreur', 'Erreur lors de la d√©connexion: ' + error.message, 'error');
                    } else {
                        alert('Erreur: ' + error.message);
                    }
                });
            }
        }
    </script>
</head>
<body>
    <!-- Header -->
    <header class="admin-header">
        <div class="header-container">
            <div class="logo">
                <div class="logo-icon">
                    <img src="asset/img/logo_eden.png" alt="Logo Eden Family School" style="height: 40px; width: auto; object-fit: contain;">
                </div>
                <div class="logo-text">
                    <h1>Portail Directeur</h1>
                    <p>Super Administration - Eden Family School</p>
                </div>
            </div>
            
            <div class="d-flex align-items-center gap-3">
                <div class="text-end text-white">
                    <div class="fw-bold" id="directorName">Directeur</div>
                    <small id="userRole">Super Administrateur</small>
                </div>
                <button class="btn-modern btn-danger-modern" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    D√©connexion
                </button>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="admin-nav">
        <div class="nav-container">
            <div class="nav-tabs">
                <button class="nav-btn active" onclick="showSection('dashboard')">
                    <i class="fas fa-chart-line"></i>
                    Tableau de bord
                </button>
                <button class="nav-btn" onclick="showSection('users')">
                    <i class="fas fa-users-cog"></i>
                    Gestion Utilisateurs
                </button>
                <button class="nav-btn" onclick="showSection('secretaries')">
                    <i class="fas fa-user-shield"></i>
                    Secr√©taires
                </button>
                <button class="nav-btn" onclick="showSection('teachers')">
                    <i class="fas fa-chalkboard-teacher"></i>
                    Enseignants
                </button>
                <button class="nav-btn" onclick="showSection('accountants')">
                    <i class="fas fa-calculator"></i>
                    Comptables
                </button>
                <button class="nav-btn" onclick="showSection('students')">
                    <i class="fas fa-graduation-cap"></i>
                    √âl√®ves
                </button>
                <button class="nav-btn" onclick="showSection('branches')">
                    <i class="fas fa-building"></i>
                    Branches
                </button>
                <button class="nav-btn" onclick="showSection('finance')">
                    <i class="fas fa-money-bill-wave"></i>
                    Finances
                </button>
                <button class="nav-btn" onclick="showSection('academics')">
                    <i class="fas fa-book-open"></i>
                    Acad√©mique
                </button>
                <button class="nav-btn" onclick="showSection('gallery')">
                    <i class="fas fa-images"></i>
                    Galerie
                </button>
                <button class="nav-btn" onclick="showSection('messages')">
                    <i class="fas fa-envelope"></i>
                    Messages
                </button>
                <button class="nav-btn" onclick="showSection('reports')">
                    <i class="fas fa-file-alt"></i>
                    Rapports
                </button>
                <button class="nav-btn" onclick="showSection('settings')">
                    <i class="fas fa-cog"></i>
                    Param√®tres
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Section -->
        <section id="dashboard" class="section active">
            <div class="card-modern">
                <div class="card-header-modern">
                    <h2 class="card-title">
                        <i class="fas fa-chart-line"></i>
                        Tableau de Bord Global
                    </h2>
                    <button class="btn-modern btn-primary-modern" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt"></i>
                        Actualiser
                    </button>
                </div>
                
                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #3b82f6, #1e3a8a);">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label">Total Utilisateurs</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
                            <i class="fas fa-chalkboard-teacher"></i>
                        </div>
                        <div class="stat-value" id="totalTeachers">0</div>
                        <div class="stat-label">Enseignants</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                            <i class="fas fa-user-shield"></i>
                        </div>
                        <div class="stat-value" id="totalSecretaries">0</div>
                        <div class="stat-label">Secr√©taires</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #7c3aed, #6d28d9);">
                            <i class="fas fa-calculator"></i>
                        </div>
                        <div class="stat-value" id="totalAccountants">0</div>
                        <div class="stat-label">Comptables</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <div class="stat-value" id="totalStudents">0</div>
                        <div class="stat-label">√âl√®ves</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #06b6d4, #0891b2);">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="stat-value" id="totalRevenue">0 RWF</div>
                        <div class="stat-label">Revenu Total</div>
                    </div>
                </div>
                
                <!-- Charts -->
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card-modern">
                            <h6 class="fw-bold mb-3">R√©partition par R√¥le</h6>
                            <canvas id="rolesChart" height="250"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card-modern">
                            <h6 class="fw-bold mb-3">R√©partition par Branche</h6>
                            <canvas id="branchesChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Activity -->
                <div class="card-modern mt-4">
                    <h6 class="fw-bold mb-3">Activit√©s R√©centes</h6>
                    <div class="table-responsive">
                        <table class="table-modern">
                            <thead>
                                <tr>
                                    <th>Utilisateur</th>
                                    <th>Action</th>
                                    <th>Date</th>
                                    <th>Heure</th>
                                </tr>
                            </thead>
                            <tbody id="recentActivity">
                                <!-- Activities loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Users Management Section -->
        <section id="users" class="section">
            <div class="card-modern">
                <div class="card-header-modern">
                    <h2 class="card-title">
                        <i class="fas fa-users-cog"></i>
                        Gestion des Utilisateurs
                    </h2>
                    <button class="btn-modern btn-primary-modern" onclick="showCreateUserModal()">
                        <i class="fas fa-plus"></i>
                        Cr√©er Utilisateur
                    </button>
                </div>
                
                <!-- Filter -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <input type="text" class="form-control-modern" placeholder="Rechercher..." id="searchUsers">
                    </div>
                    <div class="col-md-3">
                        <select class="form-control-modern" id="filterRole" onchange="filterUsers()">
                            <option value="">Tous les r√¥les</option>
                            <option value="teacher">Enseignant</option>
                            <option value="secretary">Secr√©taire</option>
                            <option value="accountant">Comptable</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-control-modern" id="filterBranch" onchange="filterUsers()">
                            <option value="">Toutes les branches</option>
                            <option value="kacyiru">KACYIRU</option>
                            <option value="kimisagara">KIMISAGARA</option>
                            <option value="gisozi_maternelle">GISOZI MATERNELLE</option>
                            <option value="gisozi_primaire">GISOZI PRIMAIRE</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-control-modern" id="filterStatus" onchange="filterUsers()">
                            <option value="">Tous statuts</option>
                            <option value="active">Actif</option>
                            <option value="inactive">Inactif</option>
                        </select>
                    </div>
                </div>
                
                <!-- Users Table -->
                <div class="table-responsive">
                    <table class="table-modern">
                        <thead>
                            <tr>
                                <th>Nom Complet</th>
                                <th>Email</th>
                                <th>R√¥le</th>
                                <th>Branche</th>
                                <th>T√©l√©phone</th>
                                <th>Statut</th>
                                <th>Date Cr√©ation</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Secretaries Section -->
        <section id="secretaries" class="section">
            <div class="card-modern">
                <div class="card-header-modern">
                    <h2 class="card-title">
                        <i class="fas fa-user-shield"></i>
                        Gestion des Secr√©taires
                    </h2>
                    <button class="btn-modern btn-success-modern" onclick="showCreateSecretaryModal()">
                        <i class="fas fa-plus"></i>
                        Ajouter Secr√©taire
                    </button>
                </div>
                
                <div class="table-responsive">
                    <table class="table-modern">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Email</th>
                                <th>T√©l√©phone</th>
                                <th>Branche</th>
                                <th>D√©partement</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="secretariesTable">
                            <!-- Secretaries will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Teachers Section -->
        <section id="teachers" class="section">
            <div class="card-modern">
                <div class="card-header-modern">
                    <h2 class="card-title">
                        <i class="fas fa-chalkboard-teacher"></i>
                        Gestion des Enseignants
                    </h2>
                    <button class="btn-modern btn-success-modern" onclick="showCreateTeacherModal()">
                        <i class="fas fa-plus"></i>
                        Ajouter Enseignant
                    </button>
                </div>
                
                <div class="table-responsive">
                    <table class="table-modern">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Email</th>
                                <th>T√©l√©phone</th>
                                <th>Branche</th>
                                <th>Section</th>
                                <th>Classe</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="teachersTable">
                            <!-- Teachers will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Accountants Section -->
        <section id="accountants" class="section">
            <div class="card-modern">
                <div class="card-header-modern">
                    <h2 class="card-title">
                        <i class="fas fa-calculator"></i>
                        Gestion des Comptables
                    </h2>
                    <button class="btn-modern btn-success-modern" onclick="showCreateAccountantModal()">
                        <i class="fas fa-plus"></i>
                        Ajouter Comptable
                    </button>
                </div>
                
                <div class="table-responsive">
                    <table class="table-modern">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Email</th>
                                <th>T√©l√©phone</th>
                                <th>Branche</th>
                                <th>D√©partement</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="accountantsTable">
                            <!-- Accountants will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Students Section -->
        <section id="students" class="section">
            <div class="card-modern">
                <div class="card-header-modern">
                    <h2 class="card-title">
                        <i class="fas fa-graduation-cap"></i>
                        Gestion des √âl√®ves
                    </h2>
                    <button class="btn-modern btn-primary-modern" onclick="showCreateStudentModal()">
                        <i class="fas fa-plus"></i>
                        Ajouter √âl√®ve
                    </button>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-3">
                        <select class="form-control-modern" id="filterStudentBranch" onchange="filterStudents()">
                            <option value="">Toutes les branches</option>
                            <option value="kacyiru">KACYIRU</option>
                            <option value="kimisagara">KIMISAGARA</option>
                            <option value="gisozi_maternelle">GISOZI MATERNELLE</option>
                            <option value="gisozi_primaire">GISOZI PRIMAIRE</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-control-modern" id="filterStudentClass" onchange="filterStudents()">
                            <option value="">Toutes les classes</option>
                            <optgroup label="NURSERY (MATERNELLE)">
                                <option value="N1A">N1A (Nursery 1A)</option>
                                <option value="N1B">N1B (Nursery 1B)</option>
                                <option value="N1C">N1C (Nursery 1C)</option>
                                <option value="N2A">N2A (Nursery 2A)</option>
                                <option value="N2B">N2B (Nursery 2B)</option>
                                <option value="N2C">N2C (Nursery 2C)</option>
                                <option value="N3A">N3A (Nursery 3A)</option>
                                <option value="N3B">N3B (Nursery 3B)</option>
                                <option value="N3C">N3C (Nursery 3C)</option>
                            </optgroup>
                            <optgroup label="PRIMAIRE">
                                <option value="P1A">P1A</option>
                                <option value="P1B">P1B</option>
                                <option value="P1C">P1C</option>
                                <option value="P2A">P2A</option>
                                <option value="P2B">P2B</option>
                                <option value="P2C">P2C</option>
                                <option value="P3A">P3A</option>
                                <option value="P3B">P3B</option>
                                <option value="P3C">P3C</option>
                                <option value="P4A">P4A</option>
                                <option value="P4B">P4B</option>
                                <option value="P4C">P4C</option>
                                <option value="P5A">P5A</option>
                                <option value="P5B">P5B</option>
                                <option value="P5C">P5C</option>
                                <option value="P6A">P6A</option>
                                <option value="P6B">P6B</option>
                                <option value="P6C">P6C</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control-modern" placeholder="Rechercher..." id="searchStudents" oninput="filterStudents()">
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table-modern">
                        <thead>
                            <tr>
                                <th>Matricule</th>
                                <th>Nom Complet</th>
                                <th>Date Naissance</th>
                                <th>Branche</th>
                                <th>Classe</th>
                                <th>T√©l√©phone Parent</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTable">
                            <!-- Students will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Branches Section -->
        <section id="branches" class="section">
            <div class="card-modern">
                <div class="card-header-modern">
                    <h2 class="card-title">
                        <i class="fas fa-building"></i>
                        Gestion des Branches
                    </h2>
                    <button class="btn-modern btn-primary-modern" onclick="viewBranchDetails('kacyiru')">
                        <i class="fas fa-chart-pie"></i>
                        Voir Statistiques
                    </button>
                </div>
                
                <div class="branch-selector">
                    <div class="branch-card selected" onclick="viewBranchDetails('kacyiru')" id="branchKacyiru">
                        <i class="fas fa-school"></i>
                        <h6>EDEN FAMILY SCHOOL KACYIRU</h6>
                        <p class="text-muted mb-0">Branche Principale</p>
                        <div class="mt-3">
                            <span class="badge-modern badge-primary" id="kacyiruUsers">0 utilisateurs</span>
                            <span class="badge-modern badge-success" id="kacyiruStudents">0 √©l√®ves</span>
                        </div>
                    </div>
                    
                    <div class="branch-card" onclick="viewBranchDetails('kimisagara')" id="branchKimisagara">
                        <i class="fas fa-school"></i>
                        <h6>EDEN FAMILY SCHOOL KIMISAGARA</h6>
                        <p class="text-muted mb-0">Branche Secondaire</p>
                        <div class="mt-3">
                            <span class="badge-modern badge-primary" id="kimisagaraUsers">0 utilisateurs</span>
                            <span class="badge-modern badge-success" id="kimisagaraStudents">0 √©l√®ves</span>
                        </div>
                    </div>
                    
                    <div class="branch-card" onclick="viewBranchDetails('gisozi_maternelle')" id="branchGisoziMaternelle">
                        <i class="fas fa-school"></i>
                        <h6>EDEN FAMILY SCHOOL GISOZI MATERNELLE</h6>
                        <p class="text-muted mb-0">Section Maternelle</p>
                        <div class="mt-3">
                            <span class="badge-modern badge-primary" id="gisoziMaternelleUsers">0 utilisateurs</span>
                            <span class="badge-modern badge-success" id="gisoziMaternelleStudents">0 √©l√®ves</span>
                        </div>
                    </div>
                    
                    <div class="branch-card" onclick="viewBranchDetails('gisozi_primaire')" id="branchGisoziPrimaire">
                        <i class="fas fa-school"></i>
                        <h6>EDEN FAMILY SCHOOL GISOZI PRIMAIRE</h6>
                        <p class="text-muted mb-0">Section Primaire</p>
                        <div class="mt-3">
                            <span class="badge-modern badge-primary" id="gisoziPrimaireUsers">0 utilisateurs</span>
                            <span class="badge-modern badge-success" id="gisoziPrimaireStudents">0 √©l√®ves</span>
                        </div>
                    </div>
                </div>
                
                <!-- Branch Details -->
                <div class="card-modern mt-4" id="branchDetails" style="display: none;">
                    <div class="card-header-modern">
                        <h2 class="card-title" id="branchDetailsTitle">
                            <i class="fas fa-chart-bar"></i>
                            D√©tails de la Branche
                        </h2>
                        <button class="btn-modern btn-primary-modern" onclick="downloadBranchReport()">
                            <i class="fas fa-download"></i>
                            T√©l√©charger Rapport
                        </button>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="fw-bold mb-3">Statistiques de la Branche</h6>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-value" id="branchTotalUsers">0</div>
                                    <div class="stat-label">Utilisateurs</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="branchTotalStudents">0</div>
                                    <div class="stat-label">√âl√®ves</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="branchTotalTeachers">0</div>
                                    <div class="stat-label">Enseignants</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="branchTotalRevenue">0 RWF</div>
                                    <div class="stat-label">Revenu</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-bold mb-3">R√©partition par Classe</h6>
                            <canvas id="branchClassesChart" height="250"></canvas>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h6 class="fw-bold mb-3">Liste des √âl√®ves</h6>
                        <div class="table-responsive">
                            <table class="table-modern">
                                <thead>
                                    <tr>
                                        <th>Matricule</th>
                                        <th>Nom Complet</th>
                                        <th>Classe</th>
                                        <th>T√©l√©phone Parent</th>
                                        <th>Statut</th>
                                    </tr>
                                </thead>
                                <tbody id="branchStudentsTable">
                                    <!-- Branch students loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Finance Section -->
        <section id="finance" class="section">
            <div class="card-modern">
                <div class="card-header-modern">
                    <h2 class="card-title">
                        <i class="fas fa-money-bill-wave"></i>
                        Gestion Financi√®re
                    </h2>
                    <div class="d-flex gap-2">
                        <button class="btn-modern btn-primary-modern" onclick="showConfigureFeesModal()">
                            <i class="fas fa-cog"></i>
                            Configurer Frais
                        </button>
                        <button class="btn-modern btn-success-modern" onclick="showConfigurePayrollModal()">
                            <i class="fas fa-file-invoice-dollar"></i>
                            Configuration Payroll
                        </button>
                    </div>
                </div>
                
                <!-- Financial Summary -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
                            <i class="fas fa-arrow-up"></i>
                        </div>
                        <div class="stat-value" id="totalIncome">0 RWF</div>
                        <div class="stat-label">Revenu Total</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                            <i class="fas fa-arrow-down"></i>
                        </div>
                        <div class="stat-value" id="totalExpenses">0 RWF</div>
                        <div class="stat-label">D√©penses Total</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #3b82f6, #1e3a8a);">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-value" id="netBalance">0 RWF</div>
                        <div class="stat-label">Solde Net</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-value" id="pendingPayments">0</div>
                        <div class="stat-label">Paiements En Attente</div>
                    </div>
                </div>
                
                <!-- Payments by Branch -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card-modern">
                            <h6 class="fw-bold mb-3">Paiements par Branche</h6>
                            <canvas id="paymentsByBranchChart" height="300"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card-modern">
                            <h6 class="fw-bold mb-3">Derniers Paiements</h6>
                            <div class="table-responsive">
                                <table class="table-modern">
                                    <thead>
                                        <tr>
                                            <th>√âl√®ve</th>
                                            <th>Montant</th>
                                            <th>Branche</th>
                                            <th>Date</th>
                                            <th>Statut</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentPaymentsTable">
                                        <!-- Recent payments loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Expense Breakdown -->
                <div class="card-modern mt-4">
                    <h6 class="fw-bold mb-3">R√©partition des D√©penses</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <canvas id="expensesChart" height="250"></canvas>
                        </div>
                        <div class="col-md-6">
                            <div class="table-responsive">
                                <table class="table-modern">
                                    <thead>
                                        <tr>
                                            <th>Cat√©gorie</th>
                                            <th>Montant</th>
                                            <th>Pourcentage</th>
                                        </tr>
                                    </thead>
                                    <tbody id="expensesTable">
                                        <!-- Expenses loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Academics Section -->
        <section id="academics" class="section">
            <div class="card-modern">
                <div class="card-header-modern">
                    <h2 class="card-title">
                        <i class="fas fa-book-open"></i>
                        Gestion Acad√©mique
                    </h2>
                    <div class="d-flex gap-2">
                        <button class="btn-modern btn-primary-modern" onclick="showAssignments()">
                            <i class="fas fa-tasks"></i>
                            Devoirs
                        </button>
                        <button class="btn-modern btn-success-modern" onclick="showTests()">
                            <i class="fas fa-clipboard-check"></i>
                            Tests
                        </button>
                        <button class="btn-modern btn-warning-modern" onclick="showExams()">
                            <i class="fas fa-file-signature"></i>
                            Examens
                        </button>
                    </div>
                </div>
                
                <!-- Academics Tabs -->
                <div class="d-flex gap-2 mb-4" id="academicsTabs">
                    <button class="btn-modern btn-primary-modern active" onclick="showAcademicTab('homework')">
                        <i class="fas fa-tasks"></i>
                        Devoirs
                    </button>
                    <button class="btn-modern btn-success-modern" onclick="showAcademicTab('tests')">
                        <i class="fas fa-clipboard-check"></i>
                        Tests
                    </button>
                    <button class="btn-modern btn-warning-modern" onclick="showAcademicTab('exams')">
                        <i class="fas fa-file-signature"></i>
                        Examens
                    </button>
                    <button class="btn-modern btn-info-modern" onclick="showAcademicTab('vacation')">
                        <i class="fas fa-umbrella-beach"></i>
                        Travaux Vacances
                    </button>
                    <button class="btn-modern btn-secondary-modern" onclick="showAcademicTab('meetings')">
                        <i class="fas fa-handshake"></i>
                        R√©unions Parents
                    </button>
                    <button class="btn-modern btn-primary-modern" onclick="showAcademicTab('library')">
                        <i class="fas fa-book"></i>
                        Biblioth√®que
                    </button>
                </div>
                
                <!-- Homework Tab -->
                <div id="homeworkTab" class="academic-tab">
                    <div class="card-modern">
                        <h6 class="fw-bold mb-3">Devoirs R√©cemment Assign√©s</h6>
                        <div class="table-responsive">
                            <table class="table-modern">
                                <thead>
                                    <tr>
                                        <th>Mati√®re</th>
                                        <th>Classe</th>
                                        <th>Enseignant</th>
                                        <th>Date Assignation</th>
                                        <th>Date √âch√©ance</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="homeworkTable">
                                    <!-- Homework loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Tests Tab -->
                <div id="testsTab" class="academic-tab" style="display: none;">
                    <div class="card-modern">
                        <h6 class="fw-bold mb-3">Tests et √âvaluations</h6>
                        <div class="table-responsive">
                            <table class="table-modern">
                                <thead>
                                    <tr>
                                        <th>Test</th>
                                        <th>Classe</th>
                                        <th>Date</th>
                                        <th>Heure</th>
                                        <th>Dur√©e</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="testsTable">
                                    <!-- Tests loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Exams Tab -->
                <div id="examsTab" class="academic-tab" style="display: none;">
                    <div class="card-modern">
                        <h6 class="fw-bold mb-3">Calendrier des Examens</h6>
                        <div class="table-responsive">
                            <table class="table-modern">
                                <thead>
                                    <tr>
                                        <th>Examen</th>
                                        <th>Classe</th>
                                        <th>Date D√©but</th>
                                        <th>Date Fin</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="examsTable">
                                    <!-- Exams loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Vacation Work Tab -->
                <div id="vacationTab" class="academic-tab" style="display: none;">
                    <div class="card-modern">
                        <h6 class="fw-bold mb-3">Travaux de Vacances</h6>
                        <div class="table-responsive">
                            <table class="table-modern">
                                <thead>
                                    <tr>
                                        <th>Classe</th>
                                        <th>Mati√®re</th>
                                        <th>Date Assignation</th>
                                        <th>Date Soumission</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="vacationTable">
                                    <!-- Vacation work loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Parent Meetings Tab -->
                <div id="meetingsTab" class="academic-tab" style="display: none;">
                    <div class="card-modern">
                        <h6 class="fw-bold mb-3">R√©unions Parents-Enseignants</h6>
                        <div class="table-responsive">
                            <table class="table-modern">
                                <thead>
                                    <tr>
                                        <th>Classe</th>
                                        <th>Date</th>
                                        <th>Heure</th>
                                        <th>Sujet</th>
                                        <th>Participants</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="meetingsTable">
                                    <!-- Meetings loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Library Tab -->
                <div id="libraryTab" class="academic-tab" style="display: none;">
                    <div class="card-modern">
                        <h6 class="fw-bold mb-3">Gestion Biblioth√®que</h6>
                        <div class="table-responsive">
                            <table class="table-modern">
                                <thead>
                                    <tr>
                                        <th>Livre</th>
                                        <th>Auteur</th>
                                        <th>Classe</th>
                                        <th>Date Emprunt</th>
                                        <th>Date Retour</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="libraryTable">
                                    <!-- Library records loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Reports Card -->
                <div class="card-modern mt-4">
                    <h6 class="fw-bold mb-3">Bulletins Scolaires</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card-modern">
                                <h6 class="fw-bold mb-3">Bulletins Acad√©miques</h6>
                                <div class="table-responsive">
                                    <table class="table-modern">
                                        <thead>
                                            <tr>
                                                <th>Classe</th>
                                                <th>Enseignant</th>
                                                <th>Date Publication</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="academicReportsTable">
                                            <!-- Academic reports loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card-modern">
                                <h6 class="fw-bold mb-3">Bulletins de Conduite (Maternelle)</h6>
                                <div class="table-responsive">
                                    <table class="table-modern">
                                        <thead>
                                            <tr>
                                                <th>Classe</th>
                                                <th>Enseignant</th>
                                                <th>Date Publication</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="conductReportsTable">
                                            <!-- Conduct reports loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button class="btn-modern btn-primary-modern" onclick="downloadAllReports()">
                            <i class="fas fa-download"></i>
                            T√©l√©charger Tous les Bulletins (ZIP)
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Gallery Section -->
        <section id="gallery" class="section">
            <div class="card-modern">
                <div class="card-header-modern">
                    <h2 class="card-title">
                        <i class="fas fa-images"></i>
                        Galerie et Activit√©s
                    </h2>
                    <button class="btn-modern btn-primary-modern" onclick="showUploadGalleryModal()">
                        <i class="fas fa-upload"></i>
                        Ajouter Photo
                    </button>
                </div>
                
                <!-- Gallery Tabs -->
                <div class="d-flex gap-2 mb-4">
                    <button class="btn-modern btn-primary-modern active" onclick="showGalleryTab('all')">
                        <i class="fas fa-images"></i>
                        Toutes les Photos
                    </button>
                    <button class="btn-modern btn-success-modern" onclick="showGalleryTab('academic')">
                        <i class="fas fa-graduation-cap"></i>
                        Activit√©s Acad√©miques
                    </button>
                    <button class="btn-modern btn-warning-modern" onclick="showGalleryTab('events')">
                        <i class="fas fa-calendar-alt"></i>
                        √âv√©nements
                    </button>
                    <button class="btn-modern btn-info-modern" onclick="showGalleryTab('youtube')">
                        <i class="fab fa-youtube"></i>
                        Cha√Æne YouTube
                    </button>
                </div>
                
                <!-- Gallery Grid -->
                <div class="gallery-grid" id="galleryGrid">
                    <!-- Gallery items loaded here -->
                </div>
            </div>
        </section>

        <!-- Messages Section -->
        <section id="messages" class="section">
            <div class="card-modern">
                <div class="card-header-modern">
                    <h2 class="card-title">
                        <i class="fas fa-envelope"></i>
                        Messagerie
                    </h2>
                    <button class="btn-modern btn-primary-modern" onclick="showNewMessageModal()">
                        <i class="fas fa-plus"></i>
                        Nouveau Message
                    </button>
                </div>
                
                <!-- Messages List -->
                <div class="message-list" id="messagesList">
                    <!-- Messages loaded here -->
                </div>
            </div>
        </section>

        <!-- Reports Section -->
        <section id="reports" class="section">
            <div class="card-modern">
                <div class="card-header-modern">
                    <h2 class="card-title">
                        <i class="fas fa-file-alt"></i>
                        Rapports Administratifs
                    </h2>
                    <div class="d-flex gap-2">
                        <button class="btn-modern btn-primary-modern" onclick="generateUserReport()">
                            <i class="fas fa-download"></i>
                            Rapport Utilisateurs
                        </button>
                        <button class="btn-modern btn-success-modern" onclick="generateActivityReport()">
                            <i class="fas fa-chart-line"></i>
                            Rapport Activit√©s
                        </button>
                        <button class="btn-modern btn-warning-modern" onclick="generateFinancialReport()">
                            <i class="fas fa-money-bill-wave"></i>
                            Rapport Financier
                        </button>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card-modern">
                            <h6 class="fw-bold mb-3">G√©n√©ration de Rapports</h6>
                            <div class="form-group">
                                <label class="form-label">Type de Rapport</label>
                                <select class="form-control-modern" id="reportType">
                                    <option value="users">Rapport Utilisateurs</option>
                                    <option value="students">Rapport √âl√®ves</option>
                                    <option value="finance">Rapport Financier</option>
                                    <option value="academic">Rapport Acad√©mique</option>
                                    <option value="attendance">Rapport de Pr√©sence</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Branche</label>
                                <select class="form-control-modern" id="reportBranch">
                                    <option value="all">Toutes les branches</option>
                                    <option value="kacyiru">KACYIRU</option>
                                    <option value="kimisagara">KIMISAGARA</option>
                                    <option value="gisozi_maternelle">GISOZI MATERNELLE</option>
                                    <option value="gisozi_primaire">GISOZI PRIMAIRE</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">P√©riode</label>
                                <select class="form-control-modern" id="reportPeriod">
                                    <option value="today">Aujourd'hui</option>
                                    <option value="week">Cette Semaine</option>
                                    <option value="month">Ce Mois</option>
                                    <option value="quarter">Ce Trimestre</option>
                                    <option value="year">Cette Ann√©e</option>
                                </select>
                            </div>
                            <button class="btn-modern btn-primary-modern w-100" onclick="generateReport()">
                                <i class="fas fa-file-download"></i>
                                G√©n√©rer Rapport
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card-modern">
                            <h6 class="fw-bold mb-3">Rapports R√©cents</h6>
                            <div class="table-responsive">
                                <table class="table-modern">
                                    <thead>
                                        <tr>
                                            <th>Nom</th>
                                            <th>Type</th>
                                            <th>Date</th>
                                            <th>Taille</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentReportsTable">
                                        <!-- Recent reports loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Settings Section -->
        <section id="settings" class="section">
            <div class="card-modern">
                <div class="card-header-modern">
                    <h2 class="card-title">
                        <i class="fas fa-cog"></i>
                        Param√®tres Syst√®me
                    </h2>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="card-modern">
                            <h6 class="fw-bold mb-3">Configuration G√©n√©rale</h6>
                            <div class="form-group">
                                <label class="form-label">Nom de l'√âcole</label>
                                <input type="text" class="form-control-modern" id="schoolName" value="Eden Family School">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Ann√©e Acad√©mique</label>
                                <input type="text" class="form-control-modern" id="academicYear" value="2023-2024">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Devise</label>
                                <select class="form-control-modern" id="currency">
                                    <option value="RWF">RWF (Franc Rwandais)</option>
                                    <option value="USD">USD (Dollar US)</option>
                                    <option value="EUR">EUR (Euro)</option>
                                </select>
                            </div>
                            <button class="btn-modern btn-primary-modern w-100" onclick="saveGeneralSettings()">
                                <i class="fas fa-save"></i>
                                Sauvegarder
                            </button>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card-modern">
                            <h6 class="fw-bold mb-3">Configuration des Branches</h6>
                            <div class="form-group">
                                <label class="form-label">Branche Active</label>
                                <select class="form-control-modern" id="activeBranch">
                                    <option value="kacyiru">KACYIRU</option>
                                    <option value="kimisagara">KIMISAGARA</option>
                                    <option value="gisozi_maternelle">GISOZI MATERNELLE</option>
                                    <option value="gisozi_primaire">GISOZI PRIMAIRE</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Responsable</label>
                                <input type="text" class="form-control-modern" id="branchManager" placeholder="Nom du responsable">
                            </div>
                            <div class="form-group">
                                <label class="form-label">T√©l√©phone</label>
                                <input type="text" class="form-control-modern" id="branchPhone" placeholder="T√©l√©phone de la branche">
                            </div>
                            <button class="btn-modern btn-success-modern w-100" onclick="saveBranchSettings()">
                                <i class="fas fa-save"></i>
                                Sauvegarder
                            </button>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card-modern">
                            <h6 class="fw-bold mb-3">S√©curit√©</h6>
                            <div class="form-group">
                                <label class="form-label">Mot de Passe Actuel</label>
                                <input type="password" class="form-control-modern" id="currentPassword">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Nouveau Mot de Passe</label>
                                <input type="password" class="form-control-modern" id="newPassword">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Confirmer Mot de Passe</label>
                                <input type="password" class="form-control-modern" id="confirmPassword">
                            </div>
                            <button class="btn-modern btn-danger-modern w-100" onclick="changePassword()">
                                <i class="fas fa-key"></i>
                                Changer Mot de Passe
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modals -->
    <!-- Create Secretary Modal -->
    <div class="modal-modern" id="createSecretaryModal">
        <div class="modal-content-modern">
            <div class="modal-header-modern">
                <h5 class="modal-title">Ajouter un Secr√©taire</h5>
                <button class="btn-modern btn-danger-modern" onclick="closeModal('createSecretaryModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body-modern">
                <div class="form-group">
                    <label class="form-label">Nom Complet *</label>
                    <input type="text" class="form-control-modern" id="secretaryName" placeholder="Nom et pr√©nom">
                </div>
                <div class="form-group">
                    <label class="form-label">Email *</label>
                    <input type="email" class="form-control-modern" id="secretaryEmail" placeholder="email@exemple.com">
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Branche *</label>
                            <select class="form-control-modern" id="secretaryBranch">
                                <option value="">S√©lectionner une branche</option>
                                <option value="kacyiru">KACYIRU</option>
                                <option value="kimisagara">KIMISAGARA</option>
                                <option value="gisozi_maternelle">GISOZI MATERNELLE</option>
                                <option value="gisozi_primaire">GISOZI PRIMAIRE</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">T√©l√©phone *</label>
                            <input type="text" class="form-control-modern" id="secretaryPhone" placeholder="+250 XXX XXX XXX">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">D√©partement *</label>
                    <input type="text" class="form-control-modern" id="secretaryDepartment" placeholder="Ex: Secr√©tariat">
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Mot de passe *</label>
                            <input type="password" class="form-control-modern" id="secretaryPassword" placeholder="Mot de passe">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Confirmer mot de passe *</label>
                            <input type="password" class="form-control-modern" id="secretaryConfirmPassword" placeholder="Confirmer le mot de passe">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer-modern">
                <button class="btn-modern btn-secondary-modern" onclick="closeModal('createSecretaryModal')">Annuler</button>
                <button class="btn-modern btn-primary-modern" onclick="createNewSecretary()">Cr√©er Secr√©taire</button>
            </div>
        </div>
    </div>

    <!-- Create Teacher Modal -->
    <div class="modal-modern" id="createTeacherModal">
        <div class="modal-content-modern">
            <div class="modal-header-modern">
                <h5 class="modal-title">Ajouter un Enseignant</h5>
                <button class="btn-modern btn-danger-modern" onclick="closeModal('createTeacherModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body-modern">
                <div class="form-group">
                    <label class="form-label">Nom Complet *</label>
                    <input type="text" class="form-control-modern" id="teacherName" placeholder="Nom et pr√©nom">
                </div>
                <div class="form-group">
                    <label class="form-label">Email *</label>
                    <input type="email" class="form-control-modern" id="teacherEmail" placeholder="email@exemple.com">
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Branche *</label>
                            <select class="form-control-modern" id="teacherBranch">
                                <option value="">S√©lectionner une branche</option>
                                <option value="kacyiru">KACYIRU</option>
                                <option value="kimisagara">KIMISAGARA</option>
                                <option value="gisozi_maternelle">GISOZI MATERNELLE</option>
                                <option value="gisozi_primaire">GISOZI PRIMAIRE</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">T√©l√©phone *</label>
                            <input type="text" class="form-control-modern" id="teacherPhone" placeholder="+250 XXX XXX XXX">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Section *</label>
                            <select class="form-control-modern" id="teacherSection">
                                <option value="">S√©lectionner une section</option>
                                <option value="maternelle">Maternelle</option>
                                <option value="primaire">Primaire</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Classe(s) *</label>
                            <select class="form-control-modern" id="teacherClass" multiple>
                                <optgroup label="NURSERY (MATERNELLE)">
                                    <option value="N1A">N1A (Nursery 1A)</option>
                                    <option value="N1B">N1B (Nursery 1B)</option>
                                    <option value="N1C">N1C (Nursery 1C)</option>
                                    <option value="N2A">N2A (Nursery 2A)</option>
                                    <option value="N2B">N2B (Nursery 2B)</option>
                                    <option value="N2C">N2C (Nursery 2C)</option>
                                    <option value="N3A">N3A (Nursery 3A)</option>
                                    <option value="N3B">N3B (Nursery 3B)</option>
                                    <option value="N3C">N3C (Nursery 3C)</option>
                                </optgroup>
                                <optgroup label="PRIMAIRE">
                                    <option value="P1A">P1A</option>
                                    <option value="P1B">P1B</option>
                                    <option value="P1C">P1C</option>
                                    <option value="P2A">P2A</option>
                                    <option value="P2B">P2B</option>
                                    <option value="P2C">P2C</option>
                                    <option value="P3A">P3A</option>
                                    <option value="P3B">P3B</option>
                                    <option value="P3C">P3C</option>
                                    <option value="P4A">P4A</option>
                                    <option value="P4B">P4B</option>
                                    <option value="P4C">P4C</option>
                                    <option value="P5A">P5A</option>
                                    <option value="P5B">P5B</option>
                                    <option value="P5C">P5C</option>
                                    <option value="P6A">P6A</option>
                                    <option value="P6B">P6B</option>
                                    <option value="P6C">P6C</option>
                                </optgroup>
                            </select>
                            <small class="text-muted">Maintenez Ctrl pour s√©lectionner plusieurs classes</small>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Mot de passe *</label>
                            <input type="password" class="form-control-modern" id="teacherPassword" placeholder="Mot de passe">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Confirmer mot de passe *</label>
                            <input type="password" class="form-control-modern" id="teacherConfirmPassword" placeholder="Confirmer le mot de passe">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer-modern">
                <button class="btn-modern btn-secondary-modern" onclick="closeModal('createTeacherModal')">Annuler</button>
                <button class="btn-modern btn-primary-modern" onclick="createNewTeacher()">Cr√©er Enseignant</button>
            </div>
        </div>
    </div>

    <!-- Edit Teacher Modal -->
    <div class="modal-modern" id="editTeacherModal">
        <div class="modal-content-modern">
            <div class="modal-header-modern">
                <h5 class="modal-title">Modifier Enseignant</h5>
                <button class="btn-modern btn-danger-modern" onclick="closeModal('editTeacherModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body-modern">
                <div class="form-group">
                    <label class="form-label">Nom Complet *</label>
                    <input type="text" class="form-control-modern" id="editTeacherName" placeholder="Nom et pr√©nom">
                </div>
                <div class="form-group">
                    <label class="form-label">Email *</label>
                    <input type="email" class="form-control-modern" id="editTeacherEmail" placeholder="email@exemple.com" readonly>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Branche *</label>
                            <select class="form-control-modern" id="editTeacherBranch">
                                <option value="">S√©lectionner une branche</option>
                                <option value="kacyiru">KACYIRU</option>
                                <option value="kimisagara">KIMISAGARA</option>
                                <option value="gisozi_maternelle">GISOZI MATERNELLE</option>
                                <option value="gisozi_primaire">GISOZI PRIMAIRE</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">T√©l√©phone *</label>
                            <input type="text" class="form-control-modern" id="editTeacherPhone" placeholder="+250 XXX XXX XXX">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Section *</label>
                            <select class="form-control-modern" id="editTeacherSection">
                                <option value="">S√©lectionner une section</option>
                                <option value="maternelle">Maternelle</option>
                                <option value="primaire">Primaire</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Classe(s) *</label>
                            <select class="form-control-modern" id="editTeacherClass" multiple>
                                <optgroup label="NURSERY (MATERNELLE)">
                                    <option value="N1A">N1A (Nursery 1A)</option>
                                    <option value="N1B">N1B (Nursery 1B)</option>
                                    <option value="N1C">N1C (Nursery 1C)</option>
                                    <option value="N2A">N2A (Nursery 2A)</option>
                                    <option value="N2B">N2B (Nursery 2B)</option>
                                    <option value="N2C">N2C (Nursery 2C)</option>
                                    <option value="N3A">N3A (Nursery 3A)</option>
                                    <option value="N3B">N3B (Nursery 3B)</option>
                                    <option value="N3C">N3C (Nursery 3C)</option>
                                </optgroup>
                                <optgroup label="PRIMAIRE">
                                    <option value="P1A">P1A</option>
                                    <option value="P1B">P1B</option>
                                    <option value="P1C">P1C</option>
                                    <option value="P2A">P2A</option>
                                    <option value="P2B">P2B</option>
                                    <option value="P2C">P2C</option>
                                    <option value="P3A">P3A</option>
                                    <option value="P3B">P3B</option>
                                    <option value="P3C">P3C</option>
                                    <option value="P4A">P4A</option>
                                    <option value="P4B">P4B</option>
                                    <option value="P4C">P4C</option>
                                    <option value="P5A">P5A</option>
                                    <option value="P5B">P5B</option>
                                    <option value="P5C">P5C</option>
                                    <option value="P6A">P6A</option>
                                    <option value="P6B">P6B</option>
                                    <option value="P6C">P6C</option>
                                </optgroup>
                            </select>
                            <small class="text-muted">Maintenez Ctrl pour s√©lectionner plusieurs classes</small>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Statut</label>
                    <select class="form-control-modern" id="editTeacherStatus">
                        <option value="active">Actif</option>
                        <option value="inactive">Inactif</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer-modern">
                <button class="btn-modern btn-secondary-modern" onclick="closeModal('editTeacherModal')">Annuler</button>
                <button class="btn-modern btn-primary-modern" onclick="updateTeacher()">Modifier Enseignant</button>
            </div>
        </div>
    </div>

    <!-- Create Accountant Modal -->
    <div class="modal-modern" id="createAccountantModal">
        <div class="modal-content-modern">
            <div class="modal-header-modern">
                <h5 class="modal-title">Ajouter un Comptable</h5>
                <button class="btn-modern btn-danger-modern" onclick="closeModal('createAccountantModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body-modern">
                <div class="form-group">
                    <label class="form-label">Nom Complet *</label>
                    <input type="text" class="form-control-modern" id="accountantName" placeholder="Nom et pr√©nom">
                </div>
                <div class="form-group">
                    <label class="form-label">Email *</label>
                    <input type="email" class="form-control-modern" id="accountantEmail" placeholder="email@exemple.com">
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Branche *</label>
                            <select class="form-control-modern" id="accountantBranch">
                                <option value="">S√©lectionner une branche</option>
                                <option value="kacyiru">KACYIRU</option>
                                <option value="kimisagara">KIMISAGARA</option>
                                <option value="gisozi_maternelle">GISOZI MATERNELLE</option>
                                <option value="gisozi_primaire">GISOZI PRIMAIRE</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">T√©l√©phone *</label>
                            <input type="text" class="form-control-modern" id="accountantPhone" placeholder="+250 XXX XXX XXX">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">D√©partement *</label>
                    <input type="text" class="form-control-modern" id="accountantDepartment" placeholder="Ex: Comptabilit√©">
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Mot de passe *</label>
                            <input type="password" class="form-control-modern" id="accountantPassword" placeholder="Mot de passe">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Confirmer mot de passe *</label>
                            <input type="password" class="form-control-modern" id="accountantConfirmPassword" placeholder="Confirmer le mot de passe">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer-modern">
                <button class="btn-modern btn-secondary-modern" onclick="closeModal('createAccountantModal')">Annuler</button>
                <button class="btn-modern btn-primary-modern" onclick="createNewAccountant()">Cr√©er Comptable</button>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div class="modal-modern" id="createUserModal">
        <div class="modal-content-modern">
            <div class="modal-header-modern">
                <h5 class="modal-title">Cr√©er Nouvel Utilisateur</h5>
                <button class="btn-modern btn-danger-modern" onclick="closeModal('createUserModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body-modern">
                <div class="form-group">
                    <label class="form-label">Nom Complet *</label>
                    <input type="text" class="form-control-modern" id="newUserName" placeholder="Nom et pr√©nom">
                </div>
                <div class="form-group">
                    <label class="form-label">Email *</label>
                    <input type="email" class="form-control-modern" id="newUserEmail" placeholder="email@exemple.com">
                </div>
                <div class="form-group">
                    <label class="form-label">R√¥le *</label>
                    <select class="form-control-modern" id="newUserRole">
                        <option value="">S√©lectionner un r√¥le</option>
                        <option value="secretary">Secr√©taire</option>
                        <option value="teacher">Enseignant</option>
                        <option value="accountant">Comptable</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Branche *</label>
                    <select class="form-control-modern" id="newUserBranch">
                        <option value="">S√©lectionner une branche</option>
                        <option value="kacyiru">KACYIRU</option>
                        <option value="kimisagara">KIMISAGARA</option>
                        <option value="gisozi_maternelle">GISOZI MATERNELLE</option>
                        <option value="gisozi_primaire">GISOZI PRIMAIRE</option>
                    </select>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">T√©l√©phone *</label>
                            <input type="text" class="form-control-modern" id="newUserPhone" placeholder="+250 XXX XXX XXX">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">D√©partement *</label>
                            <input type="text" class="form-control-modern" id="newUserDepartment" placeholder="D√©partement">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Mot de passe *</label>
                            <input type="password" class="form-control-modern" id="newUserPassword" placeholder="Mot de passe">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Confirmer mot de passe *</label>
                            <input type="password" class="form-control-modern" id="newUserPasswordConfirm" placeholder="Confirmer le mot de passe">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer-modern">
                <button class="btn-modern btn-secondary-modern" onclick="closeModal('createUserModal')">Annuler</button>
                <button class="btn-modern btn-primary-modern" onclick="createNewUser()">Cr√©er Utilisateur</button>
            </div>
        </div>
    </div>

    <!-- Create Student Modal -->
    <div class="modal-modern" id="createStudentModal">
        <div class="modal-content-modern">
            <div class="modal-header-modern">
                <h5 class="modal-title">Ajouter Nouvel √âl√®ve</h5>
                <button class="btn-modern btn-danger-modern" onclick="closeModal('createStudentModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body-modern">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Nom *</label>
                            <input type="text" class="form-control-modern" id="studentLastName" placeholder="Nom de famille">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Pr√©nom *</label>
                            <input type="text" class="form-control-modern" id="studentFirstName" placeholder="Pr√©nom">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Date de Naissance *</label>
                    <input type="date" class="form-control-modern" id="studentBirthDate">
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Branche *</label>
                            <select class="form-control-modern" id="studentBranch">
                                <option value="">S√©lectionner une branche</option>
                                <option value="kacyiru">KACYIRU</option>
                                <option value="kimisagara">KIMISAGARA</option>
                                <option value="gisozi_maternelle">GISOZI MATERNELLE</option>
                                <option value="gisozi_primaire">GISOZI PRIMAIRE</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Classe *</label>
                            <select class="form-control-modern" id="studentClass">
                                <option value="">S√©lectionner une classe</option>
                                <optgroup label="NURSERY (MATERNELLE)">
                                    <option value="N1A">N1A (Nursery 1A)</option>
                                    <option value="N1B">N1B (Nursery 1B)</option>
                                    <option value="N1C">N1C (Nursery 1C)</option>
                                    <option value="N2A">N2A (Nursery 2A)</option>
                                    <option value="N2B">N2B (Nursery 2B)</option>
                                    <option value="N2C">N2C (Nursery 2C)</option>
                                    <option value="N3A">N3A (Nursery 3A)</option>
                                    <option value="N3B">N3B (Nursery 3B)</option>
                                    <option value="N3C">N3C (Nursery 3C)</option>
                                </optgroup>
                                <optgroup label="PRIMAIRE">
                                    <option value="P1A">P1A</option>
                                    <option value="P1B">P1B</option>
                                    <option value="P1C">P1C</option>
                                    <option value="P2A">P2A</option>
                                    <option value="P2B">P2B</option>
                                    <option value="P2C">P2C</option>
                                    <option value="P3A">P3A</option>
                                    <option value="P3B">P3B</option>
                                    <option value="P3C">P3C</option>
                                    <option value="P4A">P4A</option>
                                    <option value="P4B">P4B</option>
                                    <option value="P4C">P4C</option>
                                    <option value="P5A">P5A</option>
                                    <option value="P5B">P5B</option>
                                    <option value="P5C">P5C</option>
                                    <option value="P6A">P6A</option>
                                    <option value="P6B">P6B</option>
                                    <option value="P6C">P6C</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">T√©l√©phone Parent 1 *</label>
                            <input type="text" class="form-control-modern" id="studentParentPhone1" placeholder="+250 XXX XXX XXX">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">T√©l√©phone Parent 2</label>
                            <input type="text" class="form-control-modern" id="studentParentPhone2" placeholder="+250 XXX XXX XXX">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Adresse</label>
                    <input type="text" class="form-control-modern" id="studentAddress" placeholder="Adresse de r√©sidence">
                </div>
                <div class="form-group">
                    <label class="form-label">Email Parent</label>
                    <input type="email" class="form-control-modern" id="studentParentEmail" placeholder="parent@exemple.com">
                </div>
            </div>
            <div class="modal-footer-modern">
                <button class="btn-modern btn-secondary-modern" onclick="closeModal('createStudentModal')">Annuler</button>
                <button class="btn-modern btn-primary-modern" onclick="createNewStudent()">Cr√©er √âl√®ve</button>
            </div>
        </div>
    </div>

    <!-- Configure Fees Modal -->
    <div class="modal-modern" id="configureFeesModal">
        <div class="modal-content-modern">
            <div class="modal-header-modern">
                <h5 class="modal-title">Configuration des Frais par Trimestre</h5>
                <button class="btn-modern btn-danger-modern" onclick="closeModal('configureFeesModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body-modern">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Branche *</label>
                            <select class="form-control-modern" id="feesBranch" required>
                                <option value="">S√©lectionner une branche</option>
                                <option value="kacyiru">EDEN FAMILY SCHOOL KACYIRU</option>
                                <option value="kimisagara">EDEN FAMILY SCHOOL KIMISAGARA</option>
                                <option value="gisozi_maternelle">EDEN FAMILY SCHOOL GISOZI MATERNELLE</option>
                                <option value="gisozi_primaire">EDEN FAMILY SCHOOL GISOZI PRIMAIRE</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Trimestre *</label>
                            <select class="form-control-modern" id="feesTrimester" required>
                                <option value="">S√©lectionner un trimestre</option>
                                <option value="1">Trimestre 1</option>
                                <option value="2">Trimestre 2</option>
                                <option value="3">Trimestre 3</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ann√©e Scolaire *</label>
                    <select class="form-control-modern" id="feesAcademicYear" required>
                        <option value="2023-2024">2023-2024</option>
                        <option value="2024-2025" selected>2024-2025</option>
                        <option value="2025-2026">2025-2026</option>
                    </select>
                </div>
                
                <h6 class="fw-bold mt-4 mb-3">Frais Scolaires (RWF)</h6>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Minervale</label>
                            <input type="number" class="form-control-modern" id="feeMinervale" placeholder="150000">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Transport</label>
                            <input type="number" class="form-control-modern" id="feeTransport" placeholder="50000">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Coaching</label>
                            <input type="number" class="form-control-modern" id="feeCoaching" placeholder="80000">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Uniforme</label>
                            <input type="number" class="form-control-modern" id="feeUniform" placeholder="30000">
                        </div>
                    </div>
                </div>
                
                <h6 class="fw-bold mt-4 mb-3">Frais Suppl√©mentaires (RWF)</h6>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Lunch</label>
                            <input type="number" class="form-control-modern" id="feeLunch" placeholder="20000">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Breakfast</label>
                            <input type="number" class="form-control-modern" id="feeBreakfast" placeholder="10000">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Mat√©riel Scolaire</label>
                            <input type="number" class="form-control-modern" id="feeSchoolMaterial" placeholder="15000">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Assurance</label>
                            <input type="number" class="form-control-modern" id="feeInsurance" placeholder="10000">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer-modern">
                <button class="btn-modern btn-secondary-modern" onclick="closeModal('configureFeesModal')">Annuler</button>
                <button class="btn-modern btn-primary-modern" onclick="saveFeesConfiguration()">Enregistrer la Configuration</button>
            </div>
        </div>
    </div>

    <!-- Configure Payroll Modal -->
    <div class="modal-modern" id="configurePayrollModal">
        <div class="modal-content-modern">
            <div class="modal-header-modern">
                <h5 class="modal-title">Configuration Payroll</h5>
                <button class="btn-modern btn-danger-modern" onclick="closeModal('configurePayrollModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body-modern">
                <div class="form-group">
                    <label class="form-label">Type d'employ√© *</label>
                    <select class="form-control-modern" id="payrollEmployeeType">
                        <option value="">S√©lectionner un type</option>
                        <option value="teacher">Enseignant</option>
                        <option value="secretary">Secr√©taire</option>
                        <option value="accountant">Comptable</option>
                    </select>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Salaire de base (RWF)</label>
                            <input type="number" class="form-control-modern" id="payrollBaseSalary" placeholder="Ex: 300000">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Heures suppl√©mentaires (par heure)</label>
                            <input type="number" class="form-control-modern" id="payrollOvertime" placeholder="Ex: 5000">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Prime de transport</label>
                            <input type="number" class="form-control-modern" id="payrollTransport" placeholder="Ex: 20000">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Prime de logement</label>
                            <input type="number" class="form-control-modern" id="payrollHousing" placeholder="Ex: 50000">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer-modern">
                <button class="btn-modern btn-secondary-modern" onclick="closeModal('configurePayrollModal')">Annuler</button>
                <button class="btn-modern btn-primary-modern" onclick="savePayrollConfiguration()">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- New Message Modal -->
    <div class="modal-modern" id="newMessageModal">
        <div class="modal-content-modern">
            <div class="modal-header-modern">
                <h5 class="modal-title">Nouveau Message</h5>
                <button class="btn-modern btn-danger-modern" onclick="closeModal('newMessageModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body-modern">
                <div class="form-group">
                    <label class="form-label">Destinataire</label>
                    <select class="form-control-modern" id="messageRecipient">
                        <option value="all_teachers">Tous les enseignants</option>
                        <option value="all_secretaries">Tous les secr√©taires</option>
                        <option value="all_accountants">Tous les comptables</option>
                        <option value="all_parents">Tous les parents</option>
                        <option value="specific">Personne sp√©cifique</option>
                    </select>
                </div>
                <div class="form-group" id="specificRecipientGroup" style="display: none;">
                    <label class="form-label">Personne sp√©cifique</label>
                    <select class="form-control-modern" id="specificRecipient">
                        <option value="">S√©lectionner un utilisateur</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Sujet</label>
                    <input type="text" class="form-control-modern" id="messageSubject" placeholder="Sujet du message">
                </div>
                <div class="form-group">
                    <label class="form-label">Message</label>
                    <textarea class="form-control-modern" id="messageContent" rows="6" placeholder="Contenu du message..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Pi√®ce jointe</label>
                    <input type="file" class="form-control-modern" id="messageAttachment">
                </div>
            </div>
            <div class="modal-footer-modern">
                <button class="btn-modern btn-secondary-modern" onclick="closeModal('newMessageModal')">Annuler</button>
                <button class="btn-modern btn-primary-modern" onclick="sendMessage()">Envoyer</button>
            </div>
        </div>
    </div>

    <!-- Upload Gallery Modal -->
    <div class="modal-modern" id="uploadGalleryModal">
        <div class="modal-content-modern">
            <div class="modal-header-modern">
                <h5 class="modal-title">Ajouter √† la Galerie</h5>
                <button class="btn-modern btn-danger-modern" onclick="closeModal('uploadGalleryModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body-modern">
                <div class="form-group">
                    <label class="form-label">Titre</label>
                    <input type="text" class="form-control-modern" id="galleryTitle" placeholder="Titre de la photo">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-control-modern" id="galleryDescription" rows="3" placeholder="Description de la photo"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Cat√©gorie</label>
                    <select class="form-control-modern" id="galleryCategory">
                        <option value="academic">Activit√© Acad√©mique</option>
                        <option value="events">√âv√©nement</option>
                        <option value="sports">Activit√© Sportive</option>
                        <option value="cultural">Activit√© Culturelle</option>
                        <option value="other">Autre</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Branche</label>
                    <select class="form-control-modern" id="galleryBranch">
                        <option value="all">Toutes les branches</option>
                        <option value="kacyiru">KACYIRU</option>
                        <option value="kimisagara">KIMISAGARA</option>
                        <option value="gisozi_maternelle">GISOZI MATERNELLE</option>
                        <option value="gisozi_primaire">GISOZI PRIMAIRE</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Classe (optionnel)</label>
                    <select class="form-control-modern" id="galleryClass">
                        <option value="">Toutes les classes</option>
                        <optgroup label="NURSERY (MATERNELLE)">
                            <option value="N1A">N1A (Nursery 1A)</option>
                            <option value="N1B">N1B (Nursery 1B)</option>
                            <option value="N1C">N1C (Nursery 1C)</option>
                            <option value="N2A">N2A (Nursery 2A)</option>
                            <option value="N2B">N2B (Nursery 2B)</option>
                            <option value="N2C">N2C (Nursery 2C)</option>
                            <option value="N3A">N3A (Nursery 3A)</option>
                            <option value="N3B">N3B (Nursery 3B)</option>
                            <option value="N3C">N3C (Nursery 3C)</option>
                        </optgroup>
                        <optgroup label="PRIMAIRE">
                            <option value="P1A">P1A</option>
                            <option value="P1B">P1B</option>
                            <option value="P1C">P1C</option>
                            <option value="P2A">P2A</option>
                            <option value="P2B">P2B</option>
                            <option value="P2C">P2C</option>
                            <option value="P3A">P3A</option>
                            <option value="P3B">P3B</option>
                            <option value="P3C">P3C</option>
                            <option value="P4A">P4A</option>
                            <option value="P4B">P4B</option>
                            <option value="P4C">P4C</option>
                            <option value="P5A">P5A</option>
                            <option value="P5B">P5B</option>
                            <option value="P5C">P5C</option>
                            <option value="P6A">P6A</option>
                            <option value="P6B">P6B</option>
                            <option value="P6C">P6C</option>
                        </optgroup>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Image</label>
                    <input type="file" class="form-control-modern" id="galleryImage" accept="image/*">
                </div>
                <div class="form-group">
                    <label class="form-label">Date de l'√©v√©nement</label>
                    <input type="date" class="form-control-modern" id="galleryDate">
                </div>
            </div>
            <div class="modal-footer-modern">
                <button class="btn-modern btn-secondary-modern" onclick="closeModal('uploadGalleryModal')">Annuler</button>
                <button class="btn-modern btn-primary-modern" onclick="uploadGalleryItem()">Ajouter √† la Galerie</button>
            </div>
        </div>
    </div>

    <!-- Firebase Configuration et Script Principal -->
    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyApUFNELOfgIe7rWEek9GLS9EIphNW09-A",
            authDomain: "edensmart-app.firebaseapp.com",
            databaseURL: "https://edensmart-app-default-rtdb.firebaseio.com",
            projectId: "edensmart-app",
            storageBucket: "edensmart-app.firebasestorage.app",
            messagingSenderId: "1093120876724",
            appId: "1:1093120876724:web:bc37448cadd18d651c77e1",
            measurementId: "G-1FL70PZZSW"
        };
        
        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        auth = firebase.auth();  // Assigner √† la variable globale d√©finie en haut
        const analytics = firebase.analytics();
        
        // Variables globales
        let currentUser = null;
        let currentUserData = null;
        let usersData = [];
        let studentsData = [];
        let secretariesData = [];
        let teachersData = [];
        let accountantsData = [];
        let isInitialized = false;
        
        // V√©rifier l'authentification au chargement
        auth.onAuthStateChanged(async (user) => {
            console.log('√âtat d\'authentification:', user ? 'Connect√©' : 'D√©connect√©');
            if (user) {
                currentUser = user;
                // Charger les donn√©es du directeur
                loadDirectorData(user.uid);
            } else {
                // Rediriger vers Auth.html si pas authentifi√©
                window.location.href = 'Auth.html';
            }
        });
        
        // [Old logout function removed - now defined in <head> section]
        
        // Initialiser la structure de la base de donn√©es
        function initializeDatabaseStructure() {
            const initialStructure = {
                users: {},
                teachers: {},
                secretaries: {},
                accountants: {},
                students: {},
                directors: {},
                payments: {},
                expenses: {},
                feesConfiguration: {},
                activities: {},
                gallery: {},
                messages: {},
                reports: {}
            };
            
            // Cette fonction cr√©e la structure si elle n'existe pas
            database.ref('/').once('value', (snapshot) => {
                if (!snapshot.exists() || Object.keys(snapshot.val()).length === 0) {
                    database.ref('/').set(initialStructure)
                        .then(() => console.log('Structure de base de donn√©es initialis√©e'))
                        .catch(error => console.error('Erreur:', error));
                }
            });
        }
        
        // Charger les donn√©es du directeur depuis Firebase
        async function loadDirectorData(uid) {
            try {
                const directorRef = database.ref('directors/' + uid);
                directorRef.on('value', (snapshot) => {
                    if (snapshot.exists()) {
                        currentUserData = snapshot.val();
                        document.getElementById('directorName').textContent = currentUserData.name || 'Directeur';
                        document.getElementById('userRole').textContent = currentUserData.role || 'Administrateur';
                        
                        // Initialiser la structure de la base de donn√©es
                        initializeDatabaseStructure();
                        
                        // Charger toutes les donn√©es
                        if (!isInitialized) {
                            isInitialized = true;
                            loadDashboardData();
                            loadAllUsers();
                            loadStudents();
                            loadSecretaries();
                            loadTeachers();
                            loadAccountants();
                            loadFinancialData();
                            loadRecentPayments();
                            loadExpensesBreakdown();
                            loadAcademicData();
                            loadGallery();
                            loadMessages();
                        }
                    } else {
                        console.error('Donn√©es directeur non trouv√©es');
                        showNotification('Erreur', 'Donn√©es directeur non trouv√©es', 'error');
                        auth.signOut();
                    }
                }, (error) => {
                    console.error('Erreur lors de la lecture des donn√©es:', error);
                    showNotification('Erreur', 'Impossible de charger vos donn√©es', 'error');
                });
            } catch (error) {
                console.error('Erreur:', error);
                showNotification('Erreur', error.message, 'error');
            }
        }
        
        // Afficher une section
        function showSection(sectionId) {
            // Masquer toutes les sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // D√©sactiver tous les boutons de navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Activer la section demand√©e
            document.getElementById(sectionId).classList.add('active');
            
            // Activer le bouton correspondant
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if (btn.onclick && btn.onclick.toString().includes(sectionId)) {
                    btn.classList.add('active');
                }
            });
        }
        
        // Rafra√Æchir le tableau de bord
        function refreshDashboard() {
            console.log('Rafra√Æchissement du tableau de bord...');
            loadDashboardData();
            loadAllUsers();
            loadStudents();
            loadSecretaries();
            loadTeachers();
            loadAccountants();
            loadFinancialData();
            loadRecentPayments();
            loadExpensesBreakdown();
            showNotification('Tableau de bord', 'Donn√©es actualis√©es avec succ√®s', 'success');
        }
        
        // Fermer un modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // Afficher le modal de cr√©ation d'utilisateur
        function showCreateUserModal() {
            document.getElementById('createUserModal').style.display = 'flex';
        }
        
        // Afficher le modal de cr√©ation de secr√©taire
        function showCreateSecretaryModal() {
            document.getElementById('createSecretaryModal').style.display = 'flex';
        }
        
        // Afficher le modal de cr√©ation d'enseignant
        function showCreateTeacherModal() {
            document.getElementById('createTeacherModal').style.display = 'flex';
        }
        
        // Afficher le modal de cr√©ation de comptable
        function showCreateAccountantModal() {
            document.getElementById('createAccountantModal').style.display = 'flex';
        }
        
        // Afficher le modal de cr√©ation d'√©l√®ve
        function showCreateStudentModal() {
            document.getElementById('createStudentModal').style.display = 'flex';
        }
        
        // Afficher le modal de configuration des frais
        function showConfigureFeesModal() {
            document.getElementById('configureFeesModal').style.display = 'flex';
        }
        
        // Afficher le modal de configuration payroll
        function showConfigurePayrollModal() {
            document.getElementById('configurePayrollModal').style.display = 'flex';
        }
        
        // Cr√©er un nouvel utilisateur
        function createNewUser() {
            const name = document.getElementById('newUserName').value;
            const email = document.getElementById('newUserEmail').value;
            const role = document.getElementById('newUserRole').value;
            const branch = document.getElementById('newUserBranch').value;
            const phone = document.getElementById('newUserPhone').value;
            const department = document.getElementById('newUserDepartment').value;
            const password = document.getElementById('newUserPassword').value;
            const passwordConfirm = document.getElementById('newUserPasswordConfirm').value;
            
            if (!name || !email || !role || !branch || !phone || !department || !password || !passwordConfirm) {
                showNotification('Erreur', 'Veuillez remplir tous les champs obligatoires (*)', 'error');
                return;
            }
            
            if (password !== passwordConfirm) {
                showNotification('Erreur', 'Les mots de passe ne correspondent pas', 'error');
                return;
            }
            
            if (password.length < 6) {
                showNotification('Erreur', 'Le mot de passe doit contenir au moins 6 caract√®res', 'error');
                return;
            }
            
            // Cr√©er l'utilisateur dans Firebase Auth
            auth.createUserWithEmailAndPassword(email, password)
                .then(async (userCredential) => {
                    const uid = userCredential.user.uid;
                    
                    // Structure des donn√©es utilisateur
                    const userData = {
                        name: name,
                        email: email,
                        role: role,
                        branch: branch,
                        phone: phone,
                        department: department,
                        status: 'active',
                        createdAt: new Date().toISOString(),
                        createdBy: currentUser.email,
                        uid: uid
                    };
                    
                    try {
                        // 1. Ajouter dans la collection g√©n√©rale users
                        await database.ref('users/' + uid).set(userData);
                        
                        // 2. Ajouter dans la collection sp√©cifique selon le r√¥le
                        if (role === 'teacher') {
                            await database.ref('teachers/' + uid).set(userData);
                            showNotification('Succ√®s', `Enseignant ${name} cr√©√© avec succ√®s`, 'success');
                        } else if (role === 'secretary') {
                            await database.ref('secretaries/' + uid).set(userData);
                            showNotification('Succ√®s', `Secr√©taire ${name} cr√©√© avec succ√®s`, 'success');
                        } else if (role === 'accountant') {
                            await database.ref('accountants/' + uid).set(userData);
                            showNotification('Succ√®s', `Comptable ${name} cr√©√© avec succ√®s`, 'success');
                        }
                        
                        // 3. Ajouter une activit√© de journalisation
                        const activityData = {
                            user: currentUserData.name || 'Directeur',
                            action: `Cr√©ation d'un ${role}: ${name}`,
                            date: new Date().toLocaleDateString('fr-FR'),
                            time: new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'}),
                            timestamp: Date.now()
                        };
                        
                        await database.ref('activities').push().set(activityData);
                        
                        // 4. Fermer le modal et r√©initialiser le formulaire
                        closeModal('createUserModal');
                        document.getElementById('newUserName').value = '';
                        document.getElementById('newUserEmail').value = '';
                        document.getElementById('newUserPhone').value = '';
                        document.getElementById('newUserDepartment').value = '';
                        document.getElementById('newUserPassword').value = '';
                        document.getElementById('newUserPasswordConfirm').value = '';
                        
                        // 5. Recharger les donn√©es
                        loadAllUsers();
                        loadDashboardData();
                        
                    } catch (error) {
                        console.error('Erreur lors de l\'ajout des donn√©es utilisateur:', error);
                        showNotification('Erreur', 'Erreur lors de la sauvegarde des donn√©es', 'error');
                    }
                })
                .catch((error) => {
                    console.error('Erreur lors de la cr√©ation de l\'utilisateur:', error);
                    let errorMessage = 'Erreur lors de la cr√©ation de l\'utilisateur';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Cet email est d√©j√† utilis√©';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Email invalide';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Mot de passe trop faible';
                    }
                    showNotification('Erreur', errorMessage, 'error');
                });
        }
        
        // Cr√©er un nouveau secr√©taire
        function createNewSecretary() {
            const name = document.getElementById('secretaryName').value;
            const email = document.getElementById('secretaryEmail').value;
            const branch = document.getElementById('secretaryBranch').value;
            const phone = document.getElementById('secretaryPhone').value;
            const department = document.getElementById('secretaryDepartment').value;
            const password = document.getElementById('secretaryPassword').value;
            const passwordConfirm = document.getElementById('secretaryConfirmPassword').value;
            
            if (!name || !email || !branch || !phone || !department || !password || !passwordConfirm) {
                showNotification('Erreur', 'Veuillez remplir tous les champs obligatoires (*)', 'error');
                return;
            }
            
            if (password !== passwordConfirm) {
                showNotification('Erreur', 'Les mots de passe ne correspondent pas', 'error');
                return;
            }
            
            // Cr√©er l'utilisateur dans Firebase Auth
            auth.createUserWithEmailAndPassword(email, password)
                .then(async (userCredential) => {
                    const uid = userCredential.user.uid;
                    
                    const secretaryData = {
                        name: name,
                        email: email,
                        role: 'secretary',
                        branch: branch,
                        phone: phone,
                        department: department,
                        status: 'active',
                        createdAt: new Date().toISOString(),
                        createdBy: currentUser.email,
                        uid: uid
                    };
                    
                    try {
                        await database.ref('users/' + uid).set(secretaryData);
                        await database.ref('secretaries/' + uid).set(secretaryData);
                        
                        // Ajouter une activit√©
                        const activityData = {
                            user: currentUserData.name || 'Directeur',
                            action: `Cr√©ation d'un secr√©taire: ${name}`,
                            date: new Date().toLocaleDateString('fr-FR'),
                            time: new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'}),
                            timestamp: Date.now()
                        };
                        
                        await database.ref('activities').push().set(activityData);
                        
                        showNotification('Succ√®s', `Secr√©taire ${name} cr√©√© avec succ√®s`, 'success');
                        closeModal('createSecretaryModal');
                        
                        // R√©initialiser le formulaire
                        document.getElementById('secretaryName').value = '';
                        document.getElementById('secretaryEmail').value = '';
                        document.getElementById('secretaryPhone').value = '';
                        document.getElementById('secretaryDepartment').value = '';
                        document.getElementById('secretaryPassword').value = '';
                        document.getElementById('secretaryConfirmPassword').value = '';
                        
                        // Recharger les secr√©taires
                        loadSecretaries();
                        loadDashboardData();
                    } catch (error) {
                        console.error('Erreur:', error);
                        showNotification('Erreur', 'Erreur lors de la sauvegarde', 'error');
                    }
                })
                .catch((error) => {
                    console.error('Erreur:', error);
                    let errorMessage = 'Erreur lors de la cr√©ation';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Cet email est d√©j√† utilis√©';
                    }
                    showNotification('Erreur', errorMessage, 'error');
                });
        }
        
        // Cr√©er un nouvel enseignant
        function createNewTeacher() {
            const name = document.getElementById('teacherName').value;
            const email = document.getElementById('teacherEmail').value;
            const branch = document.getElementById('teacherBranch').value;
            const phone = document.getElementById('teacherPhone').value;
            const section = document.getElementById('teacherSection').value;
            const teacherClass = document.getElementById('teacherClass').value;
            const password = document.getElementById('teacherPassword').value;
            const passwordConfirm = document.getElementById('teacherConfirmPassword').value;
            
            if (!name || !email || !branch || !phone || !section || !teacherClass || !password || !passwordConfirm) {
                showNotification('Erreur', 'Veuillez remplir tous les champs obligatoires (*)', 'error');
                return;
            }
            
            if (password !== passwordConfirm) {
                showNotification('Erreur', 'Les mots de passe ne correspondent pas', 'error');
                return;
            }
            
            auth.createUserWithEmailAndPassword(email, password)
                .then(async (userCredential) => {
                    const uid = userCredential.user.uid;
                    
                    const teacherData = {
                        name: name,
                        email: email,
                        role: 'teacher',
                        branch: branch,
                        phone: phone,
                        section: section,
                        class: teacherClass,
                        status: 'active',
                        createdAt: new Date().toISOString(),
                        createdBy: currentUser.email,
                        uid: uid
                    };
                    
                    try {
                        await database.ref('users/' + uid).set(teacherData);
                        await database.ref('teachers/' + uid).set(teacherData);
                        
                        // Ajouter une activit√©
                        const activityData = {
                            user: currentUserData.name || 'Directeur',
                            action: `Cr√©ation d'un enseignant: ${name}`,
                            date: new Date().toLocaleDateString('fr-FR'),
                            time: new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'}),
                            timestamp: Date.now()
                        };
                        
                        await database.ref('activities').push().set(activityData);
                        
                        showNotification('Succ√®s', `Enseignant ${name} cr√©√© avec succ√®s`, 'success');
                        closeModal('createTeacherModal');
                        
                        // R√©initialiser le formulaire
                        document.getElementById('teacherName').value = '';
                        document.getElementById('teacherEmail').value = '';
                        document.getElementById('teacherPhone').value = '';
                        document.getElementById('teacherPassword').value = '';
                        document.getElementById('teacherConfirmPassword').value = '';
                        
                        loadTeachers();
                        loadDashboardData();
                    } catch (error) {
                        console.error('Erreur:', error);
                        showNotification('Erreur', 'Erreur lors de la sauvegarde', 'error');
                    }
                })
                .catch((error) => {
                    console.error('Erreur:', error);
                    let errorMessage = 'Erreur lors de la cr√©ation';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Cet email est d√©j√† utilis√©';
                    }
                    showNotification('Erreur', errorMessage, 'error');
                });
        }
        
        // Variable pour stocker l'UID de l'enseignant en cours de modification
        let currentEditingTeacherUid = null;
        
        // Fonction pour charger les donn√©es de l'enseignant dans le formulaire d'√©dition
        function editTeacher(uid) {
            currentEditingTeacherUid = uid;
            
            // R√©cup√©rer les donn√©es de l'enseignant
            const teacher = teachersData.find(t => t.uid === uid);
            
            if (!teacher) {
                showNotification('Erreur', 'Enseignant non trouv√©', 'error');
                return;
            }
            
            // Remplir le formulaire d'√©dition
            document.getElementById('editTeacherName').value = teacher.name || '';
            document.getElementById('editTeacherEmail').value = teacher.email || '';
            document.getElementById('editTeacherBranch').value = teacher.branch || '';
            document.getElementById('editTeacherPhone').value = teacher.phone || '';
            document.getElementById('editTeacherSection').value = teacher.section || '';
            document.getElementById('editTeacherStatus').value = teacher.status || 'active';
            
            // S√©lectionner les classes
            const classSelect = document.getElementById('editTeacherClass');
            const classes = Array.isArray(teacher.class) ? teacher.class : (teacher.class ? [teacher.class] : []);
            Array.from(classSelect.options).forEach(option => {
                option.selected = classes.includes(option.value);
            });
            
            // Ouvrir le modal
            document.getElementById('editTeacherModal').style.display = 'flex';
        }
        
        // Fonction pour mettre √† jour l'enseignant dans Firebase
        function updateTeacher() {
            const name = document.getElementById('editTeacherName').value;
            const branch = document.getElementById('editTeacherBranch').value;
            const phone = document.getElementById('editTeacherPhone').value;
            const section = document.getElementById('editTeacherSection').value;
            const status = document.getElementById('editTeacherStatus').value;
            
            const classSelect = document.getElementById('editTeacherClass');
            const selectedClasses = Array.from(classSelect.selectedOptions).map(option => option.value);
            
            if (!name || !branch || !phone || !section || selectedClasses.length === 0) {
                showNotification('Erreur', 'Veuillez remplir tous les champs obligatoires (*)', 'error');
                return;
            }
            
            if (!currentEditingTeacherUid) {
                showNotification('Erreur', 'Aucun enseignant s√©lectionn√©', 'error');
                return;
            }
            
            // Pr√©parer les donn√©es mises √† jour
            const updatedData = {
                name: name,
                branch: branch,
                phone: phone,
                section: section,
                class: selectedClasses.join(', '),
                status: status,
                updatedAt: new Date().toISOString(),
                updatedBy: currentUser.email
            };
            
            try {
                // Mettre √† jour dans Firebase
                database.ref('teachers/' + currentEditingTeacherUid).update(updatedData);
                database.ref('users/' + currentEditingTeacherUid).update(updatedData);
                
                // Ajouter une activit√©
                const activityData = {
                    user: currentUserData.name || 'Directeur',
                    action: `Modification d'un enseignant: ${name}`,
                    date: new Date().toLocaleDateString('fr-FR'),
                    time: new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'}),
                    timestamp: Date.now()
                };
                
                database.ref('activities').push().set(activityData);
                
                showNotification('Succ√®s', 'Enseignant modifi√© avec succ√®s', 'success');
                closeModal('editTeacherModal');
                loadTeachers();
                
                currentEditingTeacherUid = null;
            } catch (error) {
                console.error('Erreur:', error);
                showNotification('Erreur', 'Erreur lors de la modification', 'error');
            }
        }
        
        // Cr√©er un nouveau comptable
        function createNewAccountant() {
            const name = document.getElementById('accountantName').value;
            const email = document.getElementById('accountantEmail').value;
            const branch = document.getElementById('accountantBranch').value;
            const phone = document.getElementById('accountantPhone').value;
            const department = document.getElementById('accountantDepartment').value;
            const password = document.getElementById('accountantPassword').value;
            const passwordConfirm = document.getElementById('accountantConfirmPassword').value;
            
            if (!name || !email || !branch || !phone || !department || !password || !passwordConfirm) {
                showNotification('Erreur', 'Veuillez remplir tous les champs obligatoires (*)', 'error');
                return;
            }
            
            if (password !== passwordConfirm) {
                showNotification('Erreur', 'Les mots de passe ne correspondent pas', 'error');
                return;
            }
            
            auth.createUserWithEmailAndPassword(email, password)
                .then(async (userCredential) => {
                    const uid = userCredential.user.uid;
                    
                    const accountantData = {
                        name: name,
                        email: email,
                        role: 'accountant',
                        branch: branch,
                        phone: phone,
                        department: department,
                        status: 'active',
                        createdAt: new Date().toISOString(),
                        createdBy: currentUser.email,
                        uid: uid
                    };
                    
                    try {
                        await database.ref('users/' + uid).set(accountantData);
                        await database.ref('accountants/' + uid).set(accountantData);
                        
                        // Ajouter une activit√©
                        const activityData = {
                            user: currentUserData.name || 'Directeur',
                            action: `Cr√©ation d'un comptable: ${name}`,
                            date: new Date().toLocaleDateString('fr-FR'),
                            time: new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'}),
                            timestamp: Date.now()
                        };
                        
                        await database.ref('activities').push().set(activityData);
                        
                        showNotification('Succ√®s', `Comptable ${name} cr√©√© avec succ√®s`, 'success');
                        closeModal('createAccountantModal');
                        
                        // R√©initialiser le formulaire
                        document.getElementById('accountantName').value = '';
                        document.getElementById('accountantEmail').value = '';
                        document.getElementById('accountantPhone').value = '';
                        document.getElementById('accountantDepartment').value = '';
                        document.getElementById('accountantPassword').value = '';
                        document.getElementById('accountantConfirmPassword').value = '';
                        
                        loadAccountants();
                        loadDashboardData();
                    } catch (error) {
                        console.error('Erreur:', error);
                        showNotification('Erreur', 'Erreur lors de la sauvegarde', 'error');
                    }
                })
                .catch((error) => {
                    console.error('Erreur:', error);
                    let errorMessage = 'Erreur lors de la cr√©ation';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Cet email est d√©j√† utilis√©';
                    }
                    showNotification('Erreur', errorMessage, 'error');
                });
        }
        
        // Cr√©er un nouvel √©l√®ve
        function createNewStudent() {
            const lastName = document.getElementById('studentLastName').value;
            const firstName = document.getElementById('studentFirstName').value;
            const birthDate = document.getElementById('studentBirthDate').value;
            const branch = document.getElementById('studentBranch').value;
            const studentClass = document.getElementById('studentClass').value;
            const parentPhone1 = document.getElementById('studentParentPhone1').value;
            const parentPhone2 = document.getElementById('studentParentPhone2').value || '';
            const parentEmail = document.getElementById('studentParentEmail').value || '';
            const address = document.getElementById('studentAddress').value || '';
            
            if (!lastName || !firstName || !birthDate || !branch || !studentClass || !parentPhone1) {
                showNotification('Erreur', 'Veuillez remplir tous les champs obligatoires (*)', 'error');
                return;
            }
            
            // G√©n√©rer un matricule unique
            const matricule = 'EFS' + new Date().getFullYear() + Math.floor(Math.random() * 10000).toString().padStart(5, '0');
            
            // Mapper les noms de branches
            const branchNames = {
                'kacyiru': 'KACYIRU',
                'kimisagara': 'KIMISAGARA',
                'gisozi_maternelle': 'GISOZI MATERNELLE',
                'gisozi_primaire': 'GISOZI PRIMAIRE'
            };
            
            const studentData = {
                matricule: matricule,
                fullName: `${firstName} ${lastName}`,
                lastName: lastName,
                firstName: firstName,
                dateOfBirth: birthDate,
                branch: branch,
                branchName: branchNames[branch] || branch,
                class: studentClass,
                parentPhone1: parentPhone1,
                parentPhone2: parentPhone2,
                parentEmail: parentEmail,
                address: address,
                status: 'active',
                createdAt: new Date().toISOString(),
                createdBy: currentUser.email
            };
            
            try {
                database.ref('students').push().set(studentData, (error) => {
                    if (error) {
                        console.error('Erreur:', error);
                        showNotification('Erreur', 'Erreur lors de la cr√©ation', 'error');
                    } else {
                        // Ajouter une activit√©
                        const activityData = {
                            user: currentUserData.name || 'Directeur',
                            action: `Cr√©ation d'un √©l√®ve: ${firstName} ${lastName}`,
                            date: new Date().toLocaleDateString('fr-FR'),
                            time: new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'}),
                            timestamp: Date.now()
                        };
                        
                        database.ref('activities').push().set(activityData);
                        
                        showNotification('Succ√®s', `√âl√®ve ${firstName} ${lastName} cr√©√©. Matricule: ${matricule}`, 'success');
                        closeModal('createStudentModal');
                        
                        // R√©initialiser le formulaire
                        document.getElementById('studentLastName').value = '';
                        document.getElementById('studentFirstName').value = '';
                        document.getElementById('studentBirthDate').value = '';
                        document.getElementById('studentParentPhone1').value = '';
                        document.getElementById('studentParentPhone2').value = '';
                        document.getElementById('studentParentEmail').value = '';
                        document.getElementById('studentAddress').value = '';
                        
                        loadStudents();
                        loadDashboardData();
                    }
                });
            } catch (error) {
                console.error('Erreur:', error);
                showNotification('Erreur', error.message, 'error');
            }
        }
        
        // Sauvegarder la configuration des frais
        function saveFeesConfiguration() {
            const branch = document.getElementById('feesBranch').value;
            const trimester = document.getElementById('feesTrimester').value;
            const academicYear = document.getElementById('feesAcademicYear').value;
            
            if (!branch || !trimester || !academicYear) {
                showNotification('Erreur', 'Veuillez remplir tous les champs obligatoires', 'error');
                return;
            }
            
            const feesConfig = {
                branch: branch,
                trimester: trimester,
                academicYear: academicYear,
                schoolFees: {
                    minervale: parseInt(document.getElementById('feeMinervale').value) || 150000,
                    transport: parseInt(document.getElementById('feeTransport').value) || 50000,
                    coaching: parseInt(document.getElementById('feeCoaching').value) || 80000,
                    uniform: parseInt(document.getElementById('feeUniform').value) || 30000
                },
                additionalFees: {
                    lunch: parseInt(document.getElementById('feeLunch').value) || 20000,
                    breakfast: parseInt(document.getElementById('feeBreakfast').value) || 10000,
                    schoolMaterial: parseInt(document.getElementById('feeSchoolMaterial').value) || 15000,
                    insurance: parseInt(document.getElementById('feeInsurance').value) || 10000
                },
                total: 0,
                createdAt: new Date().toISOString(),
                createdBy: currentUser.email
            };
            
            // Calculer le total
            feesConfig.total = Object.values(feesConfig.schoolFees).reduce((a, b) => a + b, 0) + 
                              Object.values(feesConfig.additionalFees).reduce((a, b) => a + b, 0);
            
            try {
                const configKey = `${branch}_${trimester}_${academicYear.replace('-', '_')}`;
                database.ref('feesConfiguration/' + configKey).set(feesConfig, (error) => {
                    if (error) {
                        console.error('Erreur:', error);
                        showNotification('Erreur', 'Erreur lors de la sauvegarde', 'error');
                    } else {
                        // Ajouter une activit√©
                        const activityData = {
                            user: currentUserData.name || 'Directeur',
                            action: `Configuration des frais pour ${branch} - T${trimester} ${academicYear}`,
                            date: new Date().toLocaleDateString('fr-FR'),
                            time: new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'}),
                            timestamp: Date.now()
                        };
                        
                        database.ref('activities').push().set(activityData);
                        
                        showNotification('Succ√®s', `Configuration enregistr√©e pour ${branch} - T${trimester} ${academicYear}`, 'success');
                        closeModal('configureFeesModal');
                    }
                });
            } catch (error) {
                console.error('Erreur:', error);
                showNotification('Erreur', error.message, 'error');
            }
        }
        
        // Sauvegarder configuration payroll
        function savePayrollConfiguration() {
            showNotification('Info', 'Configuration payroll enregistr√©e', 'success');
            closeModal('configurePayrollModal');
        }
        
        // Charger le tableau de bord
        function loadDashboardData() {
            try {
                // Charger les utilisateurs
                const usersRef = database.ref('users');
                usersRef.once('value', (snapshot) => {
                    let totalUsers = 0, totalTeachers = 0, totalSecretaries = 0, totalAccountants = 0;
                    
                    if (snapshot.exists()) {
                        const users = snapshot.val();
                        totalUsers = Object.keys(users).length;
                        
                        Object.values(users).forEach(user => {
                            if (user.role === 'teacher') totalTeachers++;
                            else if (user.role === 'secretary') totalSecretaries++;
                            else if (user.role === 'accountant') totalAccountants++;
                        });
                    }
                    
                    document.getElementById('totalUsers').textContent = totalUsers;
                    document.getElementById('totalTeachers').textContent = totalTeachers;
                    document.getElementById('totalSecretaries').textContent = totalSecretaries;
                    document.getElementById('totalAccountants').textContent = totalAccountants;
                });
                
                // Charger les √©l√®ves
                const studentsRef = database.ref('students');
                studentsRef.once('value', (snapshot) => {
                    let totalStudents = 0;
                    let branchCounts = {
                        kacyiru: 0, kimisagara: 0, 
                        gisozi_maternelle: 0, gisozi_primaire: 0
                    };
                    
                    if (snapshot.exists()) {
                        const students = snapshot.val();
                        totalStudents = Object.keys(students).length;
                        
                        Object.values(students).forEach(student => {
                            if (student.branch && branchCounts.hasOwnProperty(student.branch)) {
                                branchCounts[student.branch]++;
                            }
                        });
                    }
                    
                    document.getElementById('totalStudents').textContent = totalStudents;
                    document.getElementById('kacyiruStudents').textContent = branchCounts.kacyiru + ' √©l√®ves';
                    document.getElementById('kimisagaraStudents').textContent = branchCounts.kimisagara + ' √©l√®ves';
                    document.getElementById('gisoziMaternelleStudents').textContent = branchCounts.gisozi_maternelle + ' √©l√®ves';
                    document.getElementById('gisoziPrimaireStudents').textContent = branchCounts.gisozi_primaire + ' √©l√®ves';
                    
                    // Initialiser les graphiques avec les vraies donn√©es
                    initializeChartsWithData(branchCounts);
                });
                
                // Charger les paiements pour le revenu
                const paymentsRef = database.ref('payments');
                paymentsRef.once('value', (snapshot) => {
                    let totalRevenue = 0;
                    
                    if (snapshot.exists()) {
                        const payments = snapshot.val();
                        Object.values(payments).forEach(payment => {
                            if (payment.status === 'paid' && payment.amount) {
                                totalRevenue += parseInt(payment.amount) || 0;
                            }
                        });
                    }
                    
                    document.getElementById('totalRevenue').textContent = totalRevenue.toLocaleString() + ' RWF';
                });
                
                // Charger les activit√©s r√©centes depuis Firebase
                loadRecentActivity();
                
            } catch (error) {
                console.error('Erreur:', error);
                showNotification('Erreur', 'Erreur lors du chargement', 'error');
            }
        }
        
        // Initialiser les graphiques
        function initializeChartsWithData(branchCounts) {
            try {
                const usersRef = database.ref('users');
                usersRef.once('value', (snapshot) => {
                    let teachers = 0, secretaries = 0, accountants = 0;
                    let branchUsers = {kacyiru: 0, kimisagara: 0, gisozi_maternelle: 0, gisozi_primaire: 0};
                    
                    if (snapshot.exists()) {
                        const users = snapshot.val();
                        Object.values(users).forEach(user => {
                            if (user.role === 'teacher') teachers++;
                            else if (user.role === 'secretary') secretaries++;
                            else if (user.role === 'accountant') accountants++;
                            
                            if (user.branch && branchUsers.hasOwnProperty(user.branch)) {
                                branchUsers[user.branch]++;
                            }
                        });
                    }
                    
                    // Mettre √† jour les badges
                    document.getElementById('kacyiruUsers').textContent = branchUsers.kacyiru + ' utilisateurs';
                    document.getElementById('kimisagaraUsers').textContent = branchUsers.kimisagara + ' utilisateurs';
                    document.getElementById('gisoziMaternelleUsers').textContent = branchUsers.gisozi_maternelle + ' utilisateurs';
                    document.getElementById('gisoziPrimaireUsers').textContent = branchUsers.gisozi_primaire + ' utilisateurs';
                    
                    // Graphique des r√¥les
                    const rolesCtx = document.getElementById('rolesChart');
                    if (rolesCtx) {
                        new Chart(rolesCtx.getContext('2d'), {
                            type: 'doughnut',
                            data: {
                                labels: ['Enseignants', 'Secr√©taires', 'Comptables'],
                                datasets: [{
                                    data: [teachers, secretaries, accountants],
                                    backgroundColor: ['#10b981', '#f59e0b', '#7c3aed'],
                                    borderWidth: 2
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: { position: 'bottom' }
                                }
                            }
                        });
                    }
                    
                    // Graphique des branches
                    const branchesCtx = document.getElementById('branchesChart');
                    if (branchesCtx) {
                        new Chart(branchesCtx.getContext('2d'), {
                            type: 'bar',
                            data: {
                                labels: ['KACYIRU', 'KIMISAGARA', 'GISOZI MAT', 'GISOZI PRI'],
                                datasets: [{
                                    label: 'Nombre d\'√©l√®ves',
                                    data: [
                                        branchCounts.kacyiru || 0,
                                        branchCounts.kimisagara || 0,
                                        branchCounts.gisozi_maternelle || 0,
                                        branchCounts.gisozi_primaire || 0
                                    ],
                                    backgroundColor: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b']
                                }]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    y: { beginAtZero: true }
                                }
                            }
                        });
                    }
                });
            } catch (error) {
                console.error('Erreur:', error);
            }
        }
        
        // Charger l'activit√© r√©cente DEPUIS FIREBASE
        function loadRecentActivity() {
            try {
                const tbody = document.getElementById('recentActivity');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                const activitiesRef = database.ref('activities');
                // Charger les 10 derni√®res activit√©s tri√©es par timestamp
                activitiesRef.orderByChild('timestamp').limitToLast(10).once('value', (snapshot) => {
                    if (snapshot.exists()) {
                        const activities = snapshot.val();
                        // Convertir en tableau et trier par timestamp d√©croissant
                        const activitiesArray = Object.values(activities).sort((a, b) => b.timestamp - a.timestamp);
                        
                        activitiesArray.forEach(activity => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${activity.user || 'Syst√®me'}</td>
                                <td>${activity.action || 'Action'}</td>
                                <td>${activity.date || 'N/A'}</td>
                                <td>${activity.time || 'N/A'}</td>
                            `;
                            tbody.appendChild(row);
                        });
                    } else {
                        // Aucune activit√© trouv√©e
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td colspan="4" class="text-center text-muted">Aucune activit√© r√©cente</td>
                        `;
                        tbody.appendChild(row);
                    }
                });
            } catch (error) {
                console.error('Erreur lors du chargement des activit√©s:', error);
            }
        }
        
        // Charger tous les utilisateurs
        function loadAllUsers() {
            try {
                const usersRef = database.ref('users');
                usersRef.on('value', (snapshot) => {
                    usersData = [];
                    const tbody = document.getElementById('usersTable');
                    
                    if (!tbody) return;
                    
                    tbody.innerHTML = '';
                    
                    if (snapshot.exists()) {
                        const users = snapshot.val();
                        Object.entries(users).forEach(([uid, user]) => {
                            // Exclure l'utilisateur directeur actuel
                            if (user.role === 'director') return;
                            
                            usersData.push({ uid, ...user });
                            
                            const roleLabels = {
                                'teacher': 'Enseignant',
                                'secretary': 'Secr√©taire',
                                'accountant': 'Comptable',
                                'director': 'Directeur'
                            };
                            
                            const branchNames = {
                                'kacyiru': 'KACYIRU',
                                'kimisagara': 'KIMISAGARA',
                                'gisozi_maternelle': 'GISOZI MATERNELLE',
                                'gisozi_primaire': 'GISOZI PRIMAIRE'
                            };
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${user.name || 'N/A'}</td>
                                <td>${user.email || 'N/A'}</td>
                                <td><span class="badge-modern badge-primary">${roleLabels[user.role] || user.role}</span></td>
                                <td>${branchNames[user.branch] || user.branch || 'N/A'}</td>
                                <td>${user.phone || 'N/A'}</td>
                                <td><span class="badge-modern ${user.status === 'active' ? 'badge-success' : 'badge-danger'}">${user.status === 'active' ? 'Actif' : 'Inactif'}</span></td>
                                <td>${user.createdAt ? new Date(user.createdAt).toLocaleDateString('fr-FR') : 'N/A'}</td>
                                <td>
                                    <button class="btn-modern btn-primary-modern btn-sm"><i class="fas fa-edit"></i></button>
                                    <button class="btn-modern btn-danger-modern btn-sm" onclick="deleteUser('${uid}')"><i class="fas fa-trash"></i></button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                    
                    if (tbody.children.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Aucun utilisateur trouv√©</td></tr>';
                    }
                });
            } catch (error) {
                console.error('Erreur:', error);
            }
        }
        
        // Charger les secr√©taires
        function loadSecretaries() {
            try {
                const secretariesRef = database.ref('secretaries');
                secretariesRef.on('value', (snapshot) => {
                    secretariesData = [];
                    const tbody = document.getElementById('secretariesTable');
                    
                    if (!tbody) return;
                    
                    tbody.innerHTML = '';
                    
                    if (snapshot.exists()) {
                        const secretaries = snapshot.val();
                        Object.entries(secretaries).forEach(([uid, secretary]) => {
                            secretariesData.push({ uid, ...secretary });
                            
                            const branchNames = {
                                'kacyiru': 'KACYIRU',
                                'kimisagara': 'KIMISAGARA',
                                'gisozi_maternelle': 'GISOZI MATERNELLE',
                                'gisozi_primaire': 'GISOZI PRIMAIRE'
                            };
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${secretary.name || 'N/A'}</td>
                                <td>${secretary.email || 'N/A'}</td>
                                <td>${secretary.phone || 'N/A'}</td>
                                <td>${branchNames[secretary.branch] || secretary.branch || 'N/A'}</td>
                                <td>${secretary.department || 'Secr√©tariat'}</td>
                                <td><span class="badge-modern ${secretary.status === 'active' ? 'badge-success' : 'badge-danger'}">${secretary.status === 'active' ? 'Actif' : 'Inactif'}</span></td>
                                <td>
                                    <button class="btn-modern btn-primary-modern btn-sm"><i class="fas fa-edit"></i></button>
                                    <button class="btn-modern btn-danger-modern btn-sm" onclick="deleteSecretary('${uid}')"><i class="fas fa-trash"></i></button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                });
            } catch (error) {
                console.error('Erreur:', error);
            }
        }
        
        // Charger les enseignants
        function loadTeachers() {
            try {
                const teachersRef = database.ref('teachers');
                teachersRef.on('value', (snapshot) => {
                    teachersData = [];
                    const tbody = document.getElementById('teachersTable');
                    
                    if (!tbody) return;
                    
                    tbody.innerHTML = '';
                    
                    if (snapshot.exists()) {
                        const teachers = snapshot.val();
                        Object.entries(teachers).forEach(([uid, teacher]) => {
                            teachersData.push({ uid, ...teacher });
                            
                            const branchNames = {
                                'kacyiru': 'KACYIRU',
                                'kimisagara': 'KIMISAGARA',
                                'gisozi_maternelle': 'GISOZI MATERNELLE',
                                'gisozi_primaire': 'GISOZI PRIMAIRE'
                            };
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${teacher.name || 'N/A'}</td>
                                <td>${teacher.email || 'N/A'}</td>
                                <td>${teacher.phone || 'N/A'}</td>
                                <td>${branchNames[teacher.branch] || teacher.branch || 'N/A'}</td>
                                <td>${teacher.section === 'maternelle' ? 'Maternelle' : 'Primaire'}</td>
                                <td>${teacher.class || 'N/A'}</td>
                                <td><span class="badge-modern ${teacher.status === 'active' ? 'badge-success' : 'badge-danger'}">${teacher.status === 'active' ? 'Actif' : 'Inactif'}</span></td>
                                <td>
                                    <button class="btn-modern btn-primary-modern btn-sm" onclick="editTeacher('${uid}')"><i class="fas fa-edit"></i></button>
                                    <button class="btn-modern btn-danger-modern btn-sm" onclick="deleteTeacher('${uid}')"><i class="fas fa-trash"></i></button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                });
            } catch (error) {
                console.error('Erreur:', error);
            }
        }
        
        // Charger les comptables
        function loadAccountants() {
            try {
                const accountantsRef = database.ref('accountants');
                accountantsRef.on('value', (snapshot) => {
                    accountantsData = [];
                    const tbody = document.getElementById('accountantsTable');
                    
                    if (!tbody) return;
                    
                    tbody.innerHTML = '';
                    
                    if (snapshot.exists()) {
                        const accountants = snapshot.val();
                        Object.entries(accountants).forEach(([uid, accountant]) => {
                            accountantsData.push({ uid, ...accountant });
                            
                            const branchNames = {
                                'kacyiru': 'KACYIRU',
                                'kimisagara': 'KIMISAGARA',
                                'gisozi_maternelle': 'GISOZI MATERNELLE',
                                'gisozi_primaire': 'GISOZI PRIMAIRE'
                            };
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${accountant.name || 'N/A'}</td>
                                <td>${accountant.email || 'N/A'}</td>
                                <td>${accountant.phone || 'N/A'}</td>
                                <td>${branchNames[accountant.branch] || accountant.branch || 'N/A'}</td>
                                <td>${accountant.department || 'Comptabilit√©'}</td>
                                <td><span class="badge-modern ${accountant.status === 'active' ? 'badge-success' : 'badge-danger'}">${accountant.status === 'active' ? 'Actif' : 'Inactif'}</span></td>
                                <td>
                                    <button class="btn-modern btn-primary-modern btn-sm"><i class="fas fa-edit"></i></button>
                                    <button class="btn-modern btn-danger-modern btn-sm" onclick="deleteAccountant('${uid}')"><i class="fas fa-trash"></i></button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                });
            } catch (error) {
                console.error('Erreur:', error);
            }
        }
        
        // Charger les √©l√®ves
        function loadStudents() {
            try {
                const studentsRef = database.ref('students');
                studentsRef.on('value', (snapshot) => {
                    studentsData = [];
                    const tbody = document.getElementById('studentsTable');
                    
                    if (!tbody) return;
                    
                    tbody.innerHTML = '';
                    
                    if (snapshot.exists()) {
                        const students = snapshot.val();
                        Object.entries(students).forEach(([key, student]) => {
                            studentsData.push({ key, ...student });
                            
                            const branchNames = {
                                'kacyiru': 'KACYIRU',
                                'kimisagara': 'KIMISAGARA',
                                'gisozi_maternelle': 'GISOZI MATERNELLE',
                                'gisozi_primaire': 'GISOZI PRIMAIRE'
                            };
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${student.matricule || 'N/A'}</td>
                                <td>${student.fullName || `${student.firstName || ''} ${student.lastName || ''}`.trim() || 'N/A'}</td>
                                <td>${student.dateOfBirth || 'N/A'}</td>
                                <td>${branchNames[student.branch] || student.branch || 'N/A'}</td>
                                <td>${student.class || 'N/A'}</td>
                                <td>${student.parentPhone1 || 'N/A'}</td>
                                <td><span class="badge-modern ${student.status === 'active' ? 'badge-success' : 'badge-danger'}">${student.status === 'active' ? 'Actif' : 'Inactif'}</span></td>
                                <td>
                                    <button class="btn-modern btn-primary-modern btn-sm"><i class="fas fa-edit"></i></button>
                                    <button class="btn-modern btn-danger-modern btn-sm" onclick="deleteStudent('${key}')"><i class="fas fa-trash"></i></button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                });
            } catch (error) {
                console.error('Erreur:', error);
            }
        }
        
        // Filtrer les √©l√®ves
        function filterStudents() {
            const branch = document.getElementById('filterStudentBranch').value;
            const studentClass = document.getElementById('filterStudentClass').value;
            const search = document.getElementById('searchStudents').value.toLowerCase();
            
            const tbody = document.getElementById('studentsTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            let filteredStudents = studentsData;
            
            if (branch) {
                filteredStudents = filteredStudents.filter(s => s.branch === branch);
            }
            
            if (studentClass) {
                filteredStudents = filteredStudents.filter(s => s.class === studentClass);
            }
            
            if (search) {
                filteredStudents = filteredStudents.filter(s => 
                    (s.fullName && s.fullName.toLowerCase().includes(search)) ||
                    (s.matricule && s.matricule.toLowerCase().includes(search)) ||
                    (s.parentPhone1 && s.parentPhone1.includes(search))
                );
            }
            
            if (filteredStudents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Aucun √©l√®ve trouv√©</td></tr>';
                return;
            }
            
            filteredStudents.forEach(student => {
                const branchNames = {
                    'kacyiru': 'KACYIRU',
                    'kimisagara': 'KIMISAGARA',
                    'gisozi_maternelle': 'GISOZI MATERNELLE',
                    'gisozi_primaire': 'GISOZI PRIMAIRE'
                };
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.matricule || 'N/A'}</td>
                    <td>${student.fullName || `${student.firstName || ''} ${student.lastName || ''}`.trim() || 'N/A'}</td>
                    <td>${student.dateOfBirth || 'N/A'}</td>
                    <td>${branchNames[student.branch] || student.branch || 'N/A'}</td>
                    <td>${student.class || 'N/A'}</td>
                    <td>${student.parentPhone1 || 'N/A'}</td>
                    <td><span class="badge-modern ${student.status === 'active' ? 'badge-success' : 'badge-danger'}">${student.status === 'active' ? 'Actif' : 'Inactif'}</span></td>
                    <td>
                        <button class="btn-modern btn-primary-modern btn-sm"><i class="fas fa-edit"></i></button>
                        <button class="btn-modern btn-danger-modern btn-sm" onclick="deleteStudent('${student.key}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Afficher les d√©tails d'une branche
        function viewBranchDetails(branch) {
            // Mettre √† jour la s√©lection visuelle
            document.querySelectorAll('.branch-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            const branchCard = document.getElementById(`branch${branch.charAt(0).toUpperCase() + branch.slice(1)}`);
            if (branchCard) {
                branchCard.classList.add('selected');
            }
            
            // Afficher les d√©tails
            const detailsDiv = document.getElementById('branchDetails');
            const title = document.getElementById('branchDetailsTitle');
            
            const branchNames = {
                'kacyiru': 'KACYIRU',
                'kimisagara': 'KIMISAGARA',
                'gisozi_maternelle': 'GISOZI MATERNELLE',
                'gisozi_primaire': 'GISOZI PRIMAIRE'
            };
            
            title.innerHTML = `<i class="fas fa-chart-bar"></i> D√©tails de la Branche - ${branchNames[branch] || branch}`;
            detailsDiv.style.display = 'block';
            
            // Mettre √† jour les statistiques
            updateBranchStatistics(branch);
        }
        
        // Mettre √† jour les statistiques de la branche
        function updateBranchStatistics(branch) {
            // Compter les utilisateurs
            const branchUsers = usersData.filter(u => u.branch === branch);
            const branchStudents = studentsData.filter(s => s.branch === branch);
            const branchTeachers = branchUsers.filter(u => u.role === 'teacher');
            
            document.getElementById('branchTotalUsers').textContent = branchUsers.length;
            document.getElementById('branchTotalStudents').textContent = branchStudents.length;
            document.getElementById('branchTotalTeachers').textContent = branchTeachers.length;
            
            // Calculer le revenu
            const paymentsRef = database.ref('payments');
            paymentsRef.once('value', (snapshot) => {
                let branchRevenue = 0;
                
                if (snapshot.exists()) {
                    const payments = snapshot.val();
                    Object.values(payments).forEach(payment => {
                        if (payment.branch === branch && payment.status === 'paid' && payment.amount) {
                            branchRevenue += parseInt(payment.amount) || 0;
                        }
                    });
                }
                
                document.getElementById('branchTotalRevenue').textContent = branchRevenue.toLocaleString() + ' RWF';
            });
            
            // Mettre √† jour le tableau des √©l√®ves
            updateBranchStudentsTable(branchStudents);
            
            // Initialiser le graphique des classes
            initializeBranchClassesChart(branchStudents, branch);
        }
        
        // Mettre √† jour le tableau des √©l√®ves de la branche
        function updateBranchStudentsTable(students) {
            const tbody = document.getElementById('branchStudentsTable');
            tbody.innerHTML = '';
            
            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Aucun √©l√®ve dans cette branche</td></tr>';
                return;
            }
            
            students.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.matricule || 'N/A'}</td>
                    <td>${student.fullName || `${student.firstName || ''} ${student.lastName || ''}`.trim() || 'N/A'}</td>
                    <td>${student.class || 'N/A'}</td>
                    <td>${student.parentPhone1 || 'N/A'}</td>
                    <td><span class="badge-modern ${student.status === 'active' ? 'badge-success' : 'badge-danger'}">${student.status === 'active' ? 'Actif' : 'Inactif'}</span></td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Initialiser le graphique des classes
        function initializeBranchClassesChart(students, branch) {
            const ctx = document.getElementById('branchClassesChart');
            if (!ctx) return;
            
            // Compter les √©l√®ves par classe
            const classCounts = {};
            students.forEach(student => {
                const className = student.class || 'Non sp√©cifi√©';
                classCounts[className] = (classCounts[className] || 0) + 1;
            });
            
            const labels = Object.keys(classCounts);
            const data = Object.values(classCounts);
            
            // Couleurs
            const colors = [
                '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#06b6d4',
                '#f97316', '#84cc16', '#ec4899', '#a855f7', '#6366f1', '#14b8a6'
            ];
            
            new Chart(ctx.getContext('2d'), {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length)
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // T√©l√©charger le rapport de la branche
        function downloadBranchReport() {
            showNotification('Info', 'Rapport en cours de g√©n√©ration...', 'success');
        }
        
        // Charger les donn√©es financi√®res
        function loadFinancialData() {
            try {
                // Charger les paiements
                const paymentsRef = database.ref('payments');
                paymentsRef.once('value', (snapshot) => {
                    let totalIncome = 0;
                    let pendingPayments = 0;
                    let paymentsByBranch = {
                        kacyiru: 0, kimisagara: 0, 
                        gisozi_maternelle: 0, gisozi_primaire: 0
                    };
                    
                    if (snapshot.exists()) {
                        const payments = snapshot.val();
                        Object.values(payments).forEach(payment => {
                            const amount = parseInt(payment.amount) || 0;
                            
                            if (payment.status === 'paid') {
                                totalIncome += amount;
                                if (payment.branch && paymentsByBranch.hasOwnProperty(payment.branch)) {
                                    paymentsByBranch[payment.branch] += amount;
                                }
                            } else if (payment.status === 'pending') {
                                pendingPayments++;
                            }
                        });
                    }
                    
                    document.getElementById('totalIncome').textContent = totalIncome.toLocaleString() + ' RWF';
                    document.getElementById('pendingPayments').textContent = pendingPayments;
                    
                    // Graphique des paiements par branche
                    const paymentsCtx = document.getElementById('paymentsByBranchChart');
                    if (paymentsCtx) {
                        new Chart(paymentsCtx.getContext('2d'), {
                            type: 'bar',
                            data: {
                                labels: ['KACYIRU', 'KIMISAGARA', 'GISOZI MAT', 'GISOZI PRI'],
                                datasets: [{
                                    label: 'Montant (RWF)',
                                    data: [
                                        paymentsByBranch.kacyiru,
                                        paymentsByBranch.kimisagara,
                                        paymentsByBranch.gisozi_maternelle,
                                        paymentsByBranch.gisozi_primaire
                                    ],
                                    backgroundColor: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b']
                                }]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            callback: function(value) {
                                                return (value / 1000) + 'K';
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                });
                
                // Charger les d√©penses
                const expensesRef = database.ref('expenses');
                expensesRef.once('value', (snapshot) => {
                    let totalExpenses = 0;
                    let expensesByCategory = {};
                    
                    if (snapshot.exists()) {
                        const expenses = snapshot.val();
                        Object.values(expenses).forEach(expense => {
                            const amount = parseInt(expense.amount) || 0;
                            const category = expense.category || 'Autre';
                            
                            totalExpenses += amount;
                            expensesByCategory[category] = (expensesByCategory[category] || 0) + amount;
                        });
                    }
                    
                    document.getElementById('totalExpenses').textContent = totalExpenses.toLocaleString() + ' RWF';
                    const netBalance = parseInt(document.getElementById('totalIncome').textContent.replace(/[^0-9]/g, '')) - totalExpenses;
                    document.getElementById('netBalance').textContent = netBalance.toLocaleString() + ' RWF';
                    
                    // Mettre √† jour le tableau des d√©penses
                    const tbody = document.getElementById('expensesTable');
                    if (tbody) {
                        tbody.innerHTML = '';
                        
                        Object.entries(expensesByCategory).forEach(([category, amount]) => {
                            const percentage = totalExpenses > 0 ? ((amount / totalExpenses) * 100).toFixed(2) : 0;
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${category}</td>
                                <td>${amount.toLocaleString()} RWF</td>
                                <td>${percentage}%</td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                    
                    // Graphique des d√©penses
                    const expensesCtx = document.getElementById('expensesChart');
                    if (expensesCtx) {
                        const labels = Object.keys(expensesByCategory);
                        const data = Object.values(expensesByCategory);
                        
                        new Chart(expensesCtx.getContext('2d'), {
                            type: 'doughnut',
                            data: {
                                labels: labels,
                                datasets: [{
                                    data: data,
                                    backgroundColor: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6']
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'bottom'
                                    }
                                }
                            }
                        });
                    }
                });
                
            } catch (error) {
                console.error('Erreur:', error);
            }
        }
        
        // Charger les derniers paiements
        function loadRecentPayments() {
            try {
                const tbody = document.getElementById('recentPaymentsTable');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                const paymentsRef = database.ref('payments');
                paymentsRef.limitToLast(10).once('value', (snapshot) => {
                    if (snapshot.exists()) {
                        const payments = snapshot.val();
                        const paymentsArray = Object.values(payments).reverse();
                        
                        paymentsArray.forEach(payment => {
                            const row = document.createElement('tr');
                            
                            const branchNames = {
                                'kacyiru': 'KACYIRU',
                                'kimisagara': 'KIMISAGARA',
                                'gisozi_maternelle': 'GISOZI MATERNELLE',
                                'gisozi_primaire': 'GISOZI PRIMAIRE'
                            };
                            
                            row.innerHTML = `
                                <td>${payment.studentName || '√âl√®ve'}</td>
                                <td>${parseInt(payment.amount || 0).toLocaleString()} RWF</td>
                                <td>${branchNames[payment.branch] || payment.branch || 'N/A'}</td>
                                <td>${payment.paymentDate || new Date().toLocaleDateString('fr-FR')}</td>
                                <td><span class="badge-modern ${payment.status === 'paid' ? 'badge-success' : 'badge-warning'}">${payment.status === 'paid' ? 'Pay√©' : 'En attente'}</span></td>
                            `;
                            tbody.appendChild(row);
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Aucun paiement trouv√©</td></tr>';
                    }
                });
            } catch (error) {
                console.error('Erreur:', error);
            }
        }
        
        // Charger la r√©partition des d√©penses
        function loadExpensesBreakdown() {
            // Cette fonction est d√©j√† appel√©e dans loadFinancialData
        }
        
        // Afficher l'onglet acad√©mique
        function showAcademicTab(tab) {
            // Masquer tous les onglets
            document.querySelectorAll('.academic-tab').forEach(t => {
                t.style.display = 'none';
            });
            
            // Afficher l'onglet s√©lectionn√©
            document.getElementById(`${tab}Tab`).style.display = 'block';
        }
        
        // Charger les donn√©es acad√©miques
        function loadAcademicData() {
            // Simulation de donn√©es acad√©miques
            // En production, vous chargeriez ces donn√©es depuis Firebase
            const homeworkTbody = document.getElementById('homeworkTable');
            if (homeworkTbody) {
                homeworkTbody.innerHTML = `
                    <tr>
                        <td>Math√©matiques</td>
                        <td>P1A</td>
                        <td>Jean Ndayisenga</td>
                        <td>2024-03-14</td>
                        <td>2024-03-18</td>
                        <td><span class="badge-modern badge-warning">En cours</span></td>
                        <td><button class="btn-modern btn-primary-modern btn-sm"><i class="fas fa-eye"></i></button></td>
                    </tr>
                `;
            }
        }
        
        // T√©l√©charger tous les bulletins
        function downloadAllReports() {
            showNotification('Info', 'T√©l√©chargement des bulletins en cours...', 'success');
        }
        
        // Charger la galerie
        function loadGallery() {
            // Simulation de donn√©es de galerie
            const grid = document.getElementById('galleryGrid');
            if (grid) {
                grid.innerHTML = `
                    <div class="gallery-item">
                        <img src="https://via.placeholder.com/400x300/3b82f6/ffffff?text=Activit%C3%A9+Acad%C3%A9mique" class="gallery-img">
                        <div class="gallery-info">
                            <h6 class="fw-bold">C√©r√©monie de remise des dipl√¥mes</h6>
                            <p class="text-muted mb-1"><i class="far fa-calendar"></i> 2024-02-15</p>
                            <p class="mb-0"><span class="badge-modern badge-primary">√âv√©nement</span></p>
                        </div>
                    </div>
                `;
            }
        }
        
        // Afficher l'onglet de la galerie
        function showGalleryTab(category) {
            // En production, vous filtreriez les donn√©es par cat√©gorie
            loadGallery();
        }
        
        // Charger les messages
        function loadMessages() {
            // Simulation de messages
            const list = document.getElementById('messagesList');
            if (list) {
                list.innerHTML = `
                    <div class="message-item unread">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="fw-bold mb-1">Parent d'√©l√®ve</h6>
                                <p class="mb-1 text-muted">parent@exemple.com</p>
                                <h6 class="mb-1">Demande de rendez-vous</h6>
                                <p class="mb-0 text-truncate" style="max-width: 500px;">Bonjour, je souhaiterais prendre rendez-vous...</p>
                            </div>
                            <div class="text-end">
                                <small class="text-muted">2024-03-15</small>
                                <br>
                                <small class="text-muted">09:30</small>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        // Envoyer un message
        function sendMessage() {
            showNotification('Succ√®s', 'Message envoy√© avec succ√®s', 'success');
            closeModal('newMessageModal');
        }
        
        // Uploader un √©l√©ment de galerie
        function uploadGalleryItem() {
            showNotification('Succ√®s', 'Photo ajout√©e √† la galerie', 'success');
            closeModal('uploadGalleryModal');
        }
        
        // G√©n√©rer un rapport
        function generateReport() {
            const type = document.getElementById('reportType').value;
            const branch = document.getElementById('reportBranch').value;
            const period = document.getElementById('reportPeriod').value;
            
            showNotification('Info', `G√©n√©ration du rapport ${type} pour ${branch} (${period})...`, 'success');
        }
        
        // G√©n√©rer rapport utilisateurs
        function generateUserReport() {
            showNotification('Info', 'Rapport utilisateurs g√©n√©r√©', 'success');
        }
        
        // G√©n√©rer rapport activit√©s
        function generateActivityReport() {
            showNotification('Info', 'Rapport activit√©s g√©n√©r√©', 'success');
        }
        
        // G√©n√©rer rapport financier
        function generateFinancialReport() {
            showNotification('Info', 'Rapport financier g√©n√©r√©', 'success');
        }
        
        // Sauvegarder les param√®tres g√©n√©raux
        function saveGeneralSettings() {
            showNotification('Succ√®s', 'Param√®tres g√©n√©raux sauvegard√©s', 'success');
        }
        
        // Sauvegarder les param√®tres de branche
        function saveBranchSettings() {
            showNotification('Succ√®s', 'Param√®tres de branche sauvegard√©s', 'success');
        }
        
        // Changer le mot de passe
        function changePassword() {
            const current = document.getElementById('currentPassword').value;
            const newPass = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;
            
            if (newPass !== confirm) {
                showNotification('Erreur', 'Les mots de passe ne correspondent pas', 'error');
                return;
            }
            
            if (newPass.length < 8) {
                showNotification('Erreur', 'Le mot de passe doit contenir au moins 8 caract√®res', 'error');
                return;
            }
            
            showNotification('Succ√®s', 'Mot de passe chang√© avec succ√®s', 'success');
            
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }
        
        // Afficher une notification
        function showNotification(title, message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'toast-notification';
            
            let borderColor = 'var(--primary)';
            if (type === 'success') borderColor = 'var(--success)';
            if (type === 'error') borderColor = 'var(--danger)';
            
            notification.style.borderLeftColor = borderColor;
            notification.innerHTML = `
                <div>
                    <div class="fw-bold">${title}</div>
                    <small>${message}</small>
                </div>
                <button class="btn-close" onclick="this.parentElement.remove()" style="margin-left: auto;"></button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
        
        // Fonctions de suppression
        function deleteUser(uid) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cet utilisateur ?')) {
                database.ref('users/' + uid).remove();
                showNotification('Succ√®s', 'Utilisateur supprim√©', 'success');
                
                // Ajouter une activit√©
                const activityData = {
                    user: currentUserData.name || 'Directeur',
                    action: 'Suppression d\'un utilisateur',
                    date: new Date().toLocaleDateString('fr-FR'),
                    time: new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'}),
                    timestamp: Date.now()
                };
                
                database.ref('activities').push().set(activityData);
            }
        }
        
        function deleteSecretary(uid) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce secr√©taire ?')) {
                database.ref('secretaries/' + uid).remove();
                database.ref('users/' + uid).remove();
                showNotification('Succ√®s', 'Secr√©taire supprim√©', 'success');
                
                // Ajouter une activit√©
                const activityData = {
                    user: currentUserData.name || 'Directeur',
                    action: 'Suppression d\'un secr√©taire',
                    date: new Date().toLocaleDateString('fr-FR'),
                    time: new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'}),
                    timestamp: Date.now()
                };
                
                database.ref('activities').push().set(activityData);
            }
        }
        
        function deleteTeacher(uid) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cet enseignant ?')) {
                database.ref('teachers/' + uid).remove();
                database.ref('users/' + uid).remove();
                showNotification('Succ√®s', 'Enseignant supprim√©', 'success');
                
                // Ajouter une activit√©
                const activityData = {
                    user: currentUserData.name || 'Directeur',
                    action: 'Suppression d\'un enseignant',
                    date: new Date().toLocaleDateString('fr-FR'),
                    time: new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'}),
                    timestamp: Date.now()
                };
                
                database.ref('activities').push().set(activityData);
            }
        }
        
        function deleteAccountant(uid) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce comptable ?')) {
                database.ref('accountants/' + uid).remove();
                database.ref('users/' + uid).remove();
                showNotification('Succ√®s', 'Comptable supprim√©', 'success');
                
                // Ajouter une activit√©
                const activityData = {
                    user: currentUserData.name || 'Directeur',
                    action: 'Suppression d\'un comptable',
                    date: new Date().toLocaleDateString('fr-FR'),
                    time: new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'}),
                    timestamp: Date.now()
                };
                
                database.ref('activities').push().set(activityData);
            }
        }
        
        function deleteStudent(key) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cet √©l√®ve ?')) {
                database.ref('students/' + key).remove();
                showNotification('Succ√®s', '√âl√®ve supprim√©', 'success');
                
                // Ajouter une activit√©
                const activityData = {
                    user: currentUserData.name || 'Directeur',
                    action: 'Suppression d\'un √©l√®ve',
                    date: new Date().toLocaleDateString('fr-FR'),
                    time: new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'}),
                    timestamp: Date.now()
                };
                
                database.ref('activities').push().set(activityData);
            }
        }
        
        // üîí V√âRIFICATION DE S√âCURIT√â - Prot√©ger la page
        if (typeof protectPage === 'function') {
            if (!protectPage('director.html')) {
                throw new Error('Acc√®s non autoris√©');
            }
        }

        // Initialiser l'application
        function initApp() {
            console.log('Application initialis√©e - Portail Directeur');
            // V√©rifier si l'utilisateur est d√©j√† connect√©
            const user = auth.currentUser;
            if (user) {
                console.log('Utilisateur d√©j√† connect√©:', user.email);
                loadDirectorData(user.uid);
            } else {
                console.log('Aucun utilisateur connect√©');
            }
        }
        
        // Initialiser au chargement
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>