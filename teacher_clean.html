<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eden Family School - Portail Enseignants & Parents</title>
    
    <!-- üîí S√âCURIT√â: Script d'authentification -->
    <script src="security-auth.js"></script>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Dropzone pour upload d'images -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.css">
    
    <!-- FullCalendar pour calendrier -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #3498db;
            --primary-dark: #2980b9;
            --secondary: #2ecc71;
            --secondary-dark: #27ae60;
            --accent: #e74c3c;
            --warning: #f39c12;
            --warning-dark: #d35400;
            --info: #9b59b6;
            --light: #f8f9fa;
            --dark: #2c3e50;
            --gray: #7f8c8d;
            --light-gray: #ecf0f1;
            --border-radius: 12px;
            --box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            --box-shadow-hover: 0 15px 35px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --gradient-primary: linear-gradient(135deg, var(--primary) 0%, #2980b9 100%);
            --gradient-secondary: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            --maternelle-color: #ff7eb3;
            --primaire-color: #42d395;
            --kimisagara-color: #4CAF50;
            --gisozi-color: #5d6afb;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            background-attachment: fixed;
            color: var(--dark);
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        /* Header am√©lior√© */
        .modern-header {
            background: var(--gradient-primary);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            background: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--primary);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.3);
            transition: var(--transition);
        }
        
        .logo:hover .logo-icon {
            transform: rotate(15deg);
            box-shadow: 0 6px 20px rgba(255, 255, 255, 0.4);
        }
        
        .logo-text h1 {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 1.6rem;
            margin: 0;
            color: white;
        }
        
        .logo-text p {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.9);
            margin: 0;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
            position: relative;
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 18px;
            color: var(--primary);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.4);
            transition: var(--transition);
            cursor: pointer;
        }
        
        .user-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(255, 255, 255, 0.5);
        }
        
        /* Navigation am√©lior√©e */
        .main-nav {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 0;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
            position: sticky;
            top: 80px;
            z-index: 999;
        }
        
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .nav-tabs {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        
        .nav-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: var(--gray);
            font-weight: 500;
            border-radius: 8px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            white-space: nowrap;
            flex-shrink: 0;
            position: relative;
        }
        
        .nav-btn:hover {
            background: rgba(52, 152, 219, 0.1);
            color: var(--primary);
            transform: translateY(-2px);
        }
        
        .nav-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        
        .nav-btn .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 0.7rem;
            padding: 3px 6px;
        }
        
        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 10px;
        }
        
        .quick-action-btn {
            padding: 8px 15px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
        }
        
        .quick-action-btn:hover {
            background: var(--secondary-dark);
            transform: translateY(-2px);
        }
        
        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        
        .section {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }
        
        .section.active {
            display: block;
        }
        
        /* Cards am√©lior√©es */
        .dashboard-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--box-shadow);
            margin-bottom: 1.5rem;
            transition: var(--transition);
            border: 1px solid #eef2ff;
            position: relative;
            overflow: hidden;
        }
        
        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
            transition: var(--transition);
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow-hover);
        }
        
        .dashboard-card:hover::before {
            width: 6px;
            background: var(--primary-dark);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #f1f1f1;
        }
        
        .card-title {
            font-weight: 600;
            color: var(--dark);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-title i {
            color: var(--primary);
        }
        
        /* Statistics Cards */
        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            border-left: 4px solid var(--primary);
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--box-shadow-hover);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            font-size: 24px;
            color: white;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
            margin: 0.5rem 0;
        }
        
        .stat-label {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        /* Gallery sp√©cifique par branche */
        .branch-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .branch-tab {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: var(--light-gray);
            color: var(--dark);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .branch-tab:hover {
            transform: translateY(-2px);
        }
        
        .branch-tab.active {
            color: white;
        }
        
        .branch-tab.maternelle.active {
            background: var(--maternelle-color);
        }
        
        .branch-tab.primaire.active {
            background: var(--primaire-color);
        }
        
        .branch-tab.kimisagara.active {
            background: var(--kimisagara-color);
        }
        
        .branch-tab.gisozi.active {
            background: var(--gisozi-color);
        }
        
        .branch-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .branch-badge.maternelle {
            background: rgba(255, 126, 179, 0.1);
            color: var(--maternelle-color);
            border: 1px solid rgba(255, 126, 179, 0.2);
        }
        
        .branch-badge.primaire {
            background: rgba(66, 211, 149, 0.1);
            color: var(--primaire-color);
            border: 1px solid rgba(66, 211, 149, 0.2);
        }
        
        .branch-badge.kimisagara {
            background: rgba(76, 175, 80, 0.1);
            color: var(--kimisagara-color);
            border: 1px solid rgba(76, 175, 80, 0.2);
        }
        
        .branch-badge.gisozi {
            background: rgba(93, 106, 251, 0.1);
            color: var(--gisozi-color);
            border: 1px solid rgba(93, 106, 251, 0.2);
        }
        
        /* Gallery Grid am√©lior√© */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }
        
        .gallery-item {
            position: relative;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            aspect-ratio: 1;
            cursor: pointer;
        }
        
        .gallery-item:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: var(--box-shadow-hover);
        }
        
        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .gallery-item-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            color: white;
            padding: 1rem;
            transform: translateY(100%);
            transition: var(--transition);
        }
        
        .gallery-item:hover .gallery-item-overlay {
            transform: translateY(0);
        }
        
        /* Section Bulletins */
        .bulletin-templates {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .bulletin-template {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .bulletin-template:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow-hover);
            border-color: var(--primary);
        }
        
        .template-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            font-size: 24px;
            color: var(--primary);
        }
        
        /* Responsive am√©lior√© */
        @media (max-width: 1200px) {
            .header-container, .nav-container, .main-content {
                padding: 0 1.5rem;
            }
        }
        
        @media (max-width: 992px) {
            .nav-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-tabs {
                width: 100%;
                justify-content: center;
            }
            
            .quick-actions {
                width: 100%;
                justify-content: center;
            }

            body {
                font-size: 14px;
            }

            input, select, textarea, button {
                font-size: 14px;
            }
        }
        
        @media (max-width: 768px) {
            .header-container, .nav-container, .main-content {
                padding: 0 1rem;
            }
            
            .logo-text h1 {
                font-size: 1.3rem;
            }
            
            .nav-btn {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
            
            .gallery-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 1rem;
            }
            
            .bulletin-templates {
                grid-template-columns: 1fr;
            }
        }

        /* T√©l√©phones petits (320px - 480px) */
        @media (max-width: 480px) {
            body {
                font-size: 12px;
                overflow-x: hidden;
            }

            .header-container {
                padding: 0 0.5rem;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .nav-container, .main-content {
                padding: 0 0.5rem;
            }

            .logo-text h1 {
                font-size: 1.1rem;
            }

            .user-info {
                gap: 8px;
            }

            .user-text {
                display: none;
            }

            .user-avatar {
                width: 35px;
                height: 35px;
                font-size: 0.8rem;
            }

            .nav-btn {
                padding: 8px 10px;
                font-size: 0.8rem;
                margin: 2px;
            }

            .nav-tabs {
                gap: 2px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .quick-actions {
                flex-direction: column;
                width: 100%;
                gap: 0.5rem;
            }

            .quick-action-btn {
                width: 100%;
                padding: 0.6rem;
                font-size: 0.85rem;
                border-radius: 6px;
            }

            .quick-action-btn span {
                display: inline;
            }

            h1, h2 {
                font-size: 1.2rem;
            }

            h3, h4, h5, h6 {
                font-size: 0.95rem;
            }
        }
        
        @media (max-width: 576px) {
            .user-info {
                gap: 10px;
            }
            
            .user-text {
                display: none;
            }
            
            .quick-action-btn span {
                display: none;
            }
            
            .quick-action-btn {
                padding: 8px;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="modern-header">
        <div class="header-container">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-school"></i>
                </div>
                <div class="logo-text">
                    <h1>Eden Family School</h1>
                    <p>Portail Enseignants & Parents</p>
                </div>
            </div>
            
            <div class="user-info">
                <div class="text-end text-white d-none d-md-block">
                    <div class="fw-bold" id="userName">Chargement...</div>
                    <small id="userRole" style="opacity: 0.9;">Enseignant</small>
                </div>
                <div class="user-avatar" id="userAvatar" onclick="toggleUserMenu()">
                    <i class="fas fa-user"></i>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="main-nav">
        <div class="nav-container">
            <div class="nav-tabs">
                <button class="nav-btn active" onclick="showSection('dashboard')">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Tableau de bord</span>
                </button>
                <button class="nav-btn" onclick="showSection('students')">
                    <i class="fas fa-users"></i>
                    <span>Mes √©l√®ves</span>
                </button>
                <button class="nav-btn" onclick="showSection('attendance')">
                    <i class="fas fa-calendar-check"></i>
                    <span>Pr√©sence</span>
                </button>
                <button class="nav-btn" onclick="showSection('gallery')">
                    <i class="fas fa-images"></i>
                    <span>Galerie</span>
                </button>
                <button class="nav-btn" onclick="showSection('activities')">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Activit√©s</span>
                </button>
                <button class="nav-btn" onclick="showSection('calendar')">
                    <i class="fas fa-calendar-day"></i>
                    <span>Calendrier</span>
                </button>
                <button class="nav-btn" onclick="showSection('bulletins')">
                    <i class="fas fa-file-alt"></i>
                    <span>Bulletins</span>
                </button>
                <button class="nav-btn" onclick="showSection('messages')">
                    <i class="fas fa-envelope"></i>
                    <span>Messagerie</span>
                    <span class="badge bg-danger" id="messageCount" style="display: none;">0</span>
                </button>
            </div>
            
            <div class="quick-actions">
                <button class="quick-action-btn" style="background: var(--warning);" onclick="showAddActivityModal()">
                    <i class="fas fa-calendar-plus"></i>
                    <span>Nouvelle Activit√©</span>
                </button>
                <button class="quick-action-btn" style="background: var(--info);" onclick="showUploadModal()">
                    <i class="fas fa-upload"></i>
                    <span>T√©l√©charger</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- User Menu Dropdown -->
    <div id="userMenu" class="dashboard-card" style="display: none; position: fixed; top: 80px; right: 20px; width: 250px; z-index: 1001;">
        <div class="text-center mb-3">
            <div class="user-avatar mx-auto" style="width: 80px; height: 80px; font-size: 24px;" id="menuUserAvatar"></div>
            <h6 class="mt-2" id="menuUserName"></h6>
            <small class="text-muted" id="menuUserRole"></small>
        </div>
        <hr>
        <div class="d-grid gap-2">
            <button class="btn-modern" onclick="showSection('profile')">
                <i class="fas fa-user-circle"></i>
                <span>Mon Profil</span>
            </button>
            <button class="btn-modern" onclick="showSettings()">
                <i class="fas fa-cog"></i>
                <span>Param√®tres</span>
            </button>
            <button class="btn-modern" onclick="showHelp()">
                <i class="fas fa-question-circle"></i>
                <span>Aide & Support</span>
            </button>
            <button class="btn-modern" style="background: #e74c3c; color: white;" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                <span>D√©connexion</span>
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Section -->
        <section id="dashboard" class="section active">
            <div class="dashboard-card">
                <h2 class="fw-bold mb-3">Bienvenue sur le portail Eden Family School</h2>
                <p class="text-muted mb-4">G√©rez vos classes, activit√©s et communiquez avec les parents</p>
                
                <!-- Search Bar -->
                <div class="search-bar">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" placeholder="Rechercher des √©l√®ves, activit√©s, documents..." id="globalSearch">
                </div>
                
                <!-- Statistics Cards -->
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--primary);">
                                <i class="fas fa-users"></i>
                            </div>
                            <h3 class="stat-value" id="myStudentsCount">0</h3>
                            <p class="stat-label">√âl√®ves assign√©s</p>
                            <div class="progress-container">
                                <div class="progress-label">
                                    <span>Actifs</span>
                                    <span id="activeStudentsPercent">0%</span>
                                </div>
                                <div class="progress-bar-modern">
                                    <div class="progress-fill" id="activeStudentsBar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--secondary);">
                                <i class="fas fa-tasks"></i>
                            </div>
                            <h3 class="stat-value" id="activitiesCount">0</h3>
                            <p class="stat-label">Activit√©s post√©es</p>
                            <div class="progress-container">
                                <div class="progress-label">
                                    <span>Aujourd'hui</span>
                                    <span id="todayActivities">0</span>
                                </div>
                                <div class="progress-bar-modern">
                                    <div class="progress-fill" id="todayActivitiesBar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--warning);">
                                <i class="fas fa-image"></i>
                            </div>
                            <h3 class="stat-value" id="galleryCount">0</h3>
                            <p class="stat-label">Photos galerie</p>
                            <div class="progress-container">
                                <div class="progress-label">
                                    <span>Cette semaine</span>
                                    <span id="weekGallery">0</span>
                                </div>
                                <div class="progress-bar-modern">
                                    <div class="progress-fill" id="weekGalleryBar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--info);">
                                <i class="fas fa-book"></i>
                            </div>
                            <h3 class="stat-value" id="libraryCount">0</h3>
                            <p class="stat-label">Livres biblioth√®que</p>
                            <div class="progress-container">
                                <div class="progress-label">
                                    <span>T√©l√©charg√©s</span>
                                    <span id="downloadsCount">0</span>
                                </div>
                                <div class="progress-bar-modern">
                                    <div class="progress-fill" id="downloadsBar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Charts Row -->
                <div class="row mt-4">
                    <div class="col-md-8">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h5 class="card-title"><i class="fas fa-chart-bar me-2"></i>Statistiques de pr√©sence</h5>
                                <select class="form-control-modern" style="width: auto;" id="attendanceChartPeriod">
                                    <option value="week">Cette semaine</option>
                                    <option value="month">Ce mois</option>
                                    <option value="year">Cette ann√©e</option>
                                </select>
                            </div>
                            <div id="attendanceChartContainer" style="height: 250px; display: flex; align-items: center; justify-content: center;">
                                <p class="text-muted">Graphique en cours de chargement...</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h5 class="card-title"><i class="fas fa-chart-pie me-2"></i>R√©partition par classe</h5>
                            </div>
                            <div id="classesChartContainer" style="height: 250px; display: flex; align-items: center; justify-content: center;">
                                <p class="text-muted">Graphique en cours de chargement...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Activity and Notifications -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h5 class="card-title"><i class="fas fa-bell me-2"></i>Notifications r√©centes</h5>
                                <button class="btn-modern btn-sm" onclick="markAllAsRead()">
                                    <i class="fas fa-check-double"></i>
                                    Tout marquer comme lu
                                </button>
                            </div>
                            <div id="recentNotifications">
                                <div class="text-center py-3">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p class="mt-2">Chargement des notifications...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h5 class="card-title"><i class="fas fa-history me-2"></i>Activit√©s r√©centes</h5>
                                <button class="btn-modern btn-sm" onclick="refreshActivities()">
                                    <i class="fas fa-sync-alt"></i>
                                    Actualiser
                                </button>
                            </div>
                            <div class="timeline" id="recentActivitiesTimeline">
                                <div class="timeline-item">
                                    <div class="timeline-content">
                                        <p class="text-muted mb-0">Aucune activit√© r√©cente</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Students Section (Enhanced) -->
        <section id="students" class="section">
            <div class="dashboard-card">
                <div class="card-header">
                    <h5 class="card-title"><i class="fas fa-users me-2"></i>Gestion des √©l√®ves</h5>
                    <div class="d-flex gap-2">
                        <button class="btn-modern" onclick="exportStudentsToExcel()">
                            <i class="fas fa-file-excel"></i>
                            Exporter Excel
                        </button>
                        <button class="btn-modern" onclick="showImportStudentsModal()">
                            <i class="fas fa-file-import"></i>
                            Importer
                        </button>
                        <button class="btn-modern btn-primary-modern" onclick="showAddStudentForm()">
                            <i class="fas fa-plus me-2"></i>
                            Ajouter un √©l√®ve
                        </button>
                    </div>
                </div>
                
                <!-- Student Search and Filters -->
                <div class="row mb-3">
                    <div class="col-md-8">
                        <div class="search-bar">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" placeholder="Rechercher un √©l√®ve..." id="studentSearch">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select class="form-control-modern" id="classFilter" onchange="filterStudents()">
                            <option value="">Toutes les classes</option>
                            <optgroup label="NURSERY">
                                <option value="N1A">N1A (Nursery 1A)</option>
                                <option value="N1B">N1B (Nursery 1B)</option>
                                <option value="N1C">N1C (Nursery 1C)</option>
                                <option value="N2A">N2A (Nursery 2A)</option>
                                <option value="N2B">N2B (Nursery 2B)</option>
                                <option value="N2C">N2C (Nursery 2C)</option>
                                <option value="N3A">N3A (Nursery 3A)</option>
                                <option value="N3B">N3B (Nursery 3B)</option>
                                <option value="N3C">N3C (Nursery 3C)</option>
                            </optgroup>
                            <optgroup label="PRIMAIRE">
                                <option value="P1A">P1A</option>
                                <option value="P1B">P1B</option>
                                <option value="P1C">P1C</option>
                                <option value="P2A">P2A</option>
                                <option value="P2B">P2B</option>
                                <option value="P2C">P2C</option>
                                <option value="P3A">P3A</option>
                                <option value="P3B">P3B</option>
                                <option value="P3C">P3C</option>
                                <option value="P4A">P4A</option>
                                <option value="P4B">P4B</option>
                                <option value="P4C">P4C</option>
                                <option value="P5A">P5A</option>
                                <option value="P5B">P5B</option>
                                <option value="P5C">P5C</option>
                                <option value="P6A">P6A</option>
                                <option value="P6B">P6B</option>
                                <option value="P6C">P6C</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                
                <!-- Student Statistics -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--primary);">
                                <i class="fas fa-user-check"></i>
                            </div>
                            <h4 class="stat-value" id="totalStudents">0</h4>
                            <p class="stat-label">Total √©l√®ves</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--secondary);">
                                <i class="fas fa-male"></i>
                            </div>
                            <h4 class="stat-value" id="maleStudents">0</h4>
                            <p class="stat-label">Gar√ßons</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--info);">
                                <i class="fas fa-female"></i>
                            </div>
                            <h4 class="stat-value" id="femaleStudents">0</h4>
                            <p class="stat-label">Filles</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--warning);">
                                <i class="fas fa-birthday-cake"></i>
                            </div>
                            <h4 class="stat-value" id="birthdaysThisMonth">0</h4>
                            <p class="stat-label">Anniversaires ce mois</p>
                        </div>
                    </div>
                </div>
                
                <!-- Students Table -->
                <div class="table-responsive">
                    <table class="table table-modern">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAllStudents" onchange="toggleSelectAllStudents()">
                                </th>
                                <th>Nom & Pr√©nom</th>
                                <th>Classe</th>
                                <th>√Çge</th>
                                <th>Parent/Tuteur</th>
                                <th>T√©l√©phone</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTable">
                            <tr>
                                <td colspan="8" class="text-center py-4">
                                    <i class="fas fa-spinner fa-spin fa-lg mb-3"></i>
                                    <p>Chargement des √©l√®ves...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Bulk Actions -->
                <div id="bulkActions" class="mt-3" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center">
                        <span id="selectedCount">0 √©l√®ves s√©lectionn√©s</span>
                        <div class="d-flex gap-2">
                            <button class="btn-modern" onclick="sendBulkMessage()">
                                <i class="fas fa-envelope"></i>
                                Envoyer message
                            </button>
                            <button class="btn-modern" onclick="exportSelectedStudents()">
                                <i class="fas fa-download"></i>
                                Exporter s√©lection
                            </button>
                            <button class="btn-modern" style="background: var(--accent); color: white;" onclick="clearSelection()">
                                <i class="fas fa-times"></i>
                                Annuler
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Gallery Section avec filtrage par branche -->
        <section id="gallery" class="section">
            <div class="dashboard-card">
                <div class="card-header">
                    <h5 class="card-title"><i class="fas fa-images me-2"></i>Galerie d'images</h5>
                    <div class="d-flex gap-2">
                        <button class="btn-modern" onclick="showUploadGallery()">
                            <i class="fas fa-upload me-2"></i>
                            Ajouter des photos
                        </button>
                    </div>
                </div>
                
                <!-- Filtres par branche -->
                <div class="branch-tabs">
                    <button class="branch-tab maternelle active" onclick="switchGalleryBranch('maternelle')">
                        <i class="fas fa-child"></i> Maternelle
                    </button>
                    <button class="branch-tab primaire" onclick="switchGalleryBranch('primaire')">
                        <i class="fas fa-graduation-cap"></i> Primaire
                    </button>
                    <button class="branch-tab kimisagara" onclick="switchGalleryBranch('kimisagara')">
                        <i class="fas fa-school"></i> Kimisagara
                    </button>
                    <button class="branch-tab gisozi" onclick="switchGalleryBranch('gisozi')">
                        <i class="fas fa-building"></i> Gisozi
                    </button>
                </div>
                
                <!-- Gallery Grid -->
                <div class="gallery-grid" id="galleryGrid">
                    <div class="text-center py-5">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>Chargement de la galerie...</p>
                    </div>
                </div>
                
                <!-- Gallery Stats -->
                <div class="row mt-4">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--maternelle-color);">
                                <i class="fas fa-child"></i>
                            </div>
                            <h4 class="stat-value" id="maternelleCount">0</h4>
                            <p class="stat-label">Photos Maternelle</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--primaire-color);">
                                <i class="fas fa-graduation-cap"></i>
                            </div>
                            <h4 class="stat-value" id="primaireCount">0</h4>
                            <p class="stat-label">Photos Primaire</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--kimisagara-color);">
                                <i class="fas fa-school"></i>
                            </div>
                            <h4 class="stat-value" id="kimisagaraCount">0</h4>
                            <p class="stat-label">Photos Kimisagara</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: var(--gisozi-color);">
                                <i class="fas fa-building"></i>
                            </div>
                            <h4 class="stat-value" id="gisoziCount">0</h4>
                            <p class="stat-label">Photos Gisozi</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Bulletins Section -->
        <section id="bulletins" class="section">
            <div class="dashboard-card">
                <div class="card-header">
                    <h5 class="card-title"><i class="fas fa-file-alt me-2"></i>Cr√©ation des bulletins</h5>
                    <div class="d-flex gap-2">
                        <button class="btn-modern btn-primary-modern" onclick="createNewBulletin()">
                            <i class="fas fa-plus me-2"></i>
                            Nouveau bulletin
                        </button>
                        <button class="btn-modern" onclick="importBulletinTemplate()">
                            <i class="fas fa-file-import"></i>
                            Importer mod√®le
                        </button>
                    </div>
                </div>
                
                <!-- Bulletin Templates -->
                <div class="bulletin-templates">
                    <div class="bulletin-template" onclick="useBulletinTemplate('academic')">
                        <div class="template-icon">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <h5>Bulletin Acad√©mique</h5>
                        <p class="text-muted">Mod√®le standard pour les notes acad√©miques</p>
                        <div class="d-flex justify-content-between mt-3">
                            <span class="badge bg-primary">Standard</span>
                            <small>Cliquez pour utiliser</small>
                        </div>
                    </div>
                    
                    <div class="bulletin-template" onclick="useBulletinTemplate('conduct')">
                        <div class="template-icon">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <h5>Bulletin de Conduite</h5>
                        <p class="text-muted">√âvaluation du comportement et participation</p>
                        <div class="d-flex justify-content-between mt-3">
                            <span class="badge bg-success">Conduite</span>
                            <small>Cliquez pour utiliser</small>
                        </div>
                    </div>
                    
                    <div class="bulletin-template" onclick="useBulletinTemplate('detailed')">
                        <div class="template-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <h5>Bulletin D√©taill√©</h5>
                        <p class="text-muted">Avec graphiques et commentaires d√©taill√©s</p>
                        <div class="d-flex justify-content-between mt-3">
                            <span class="badge bg-info">Complet</span>
                            <small>Cliquez pour utiliser</small>
                        </div>
                    </div>
                    
                    <div class="bulletin-template" onclick="useBulletinTemplate('bilingual')">
                        <div class="template-icon">
                            <i class="fas fa-language"></i>
                        </div>
                        <h5>Bulletin Bilingue</h5>
                        <p class="text-muted">Version en fran√ßais et anglais</p>
                        <div class="d-flex justify-content-between mt-3">
                            <span class="badge bg-warning">Bilingue</span>
                            <small>Cliquez pour utiliser</small>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Bulletins -->
                <div class="dashboard-card mt-4">
                    <div class="card-header">
                        <h5 class="card-title"><i class="fas fa-history me-2"></i>Bulletins r√©cents</h5>
                        <button class="btn-modern btn-sm" onclick="refreshBulletins()">
                            <i class="fas fa-sync-alt"></i>
                            Actualiser
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-modern">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Classe</th>
                                    <th>Trimestre</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recentBulletins">
                                <tr>
                                    <td colspan="6" class="text-center py-3">
                                        <i class="fas fa-spinner fa-spin me-2"></i>
                                        Chargement des bulletins...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Dropzone -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.js"></script>
    
    <!-- FullCalendar -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/fr.js"></script>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCx6kmJ59x0tLt4vh_3czvEEQrtw4aWFHs",
            authDomain: "edendatabase-7e1ed.firebaseapp.com",
            databaseURL: "https://edendatabase-7e1ed-default-rtdb.firebaseio.com",
            projectId: "edendatabase-7e1ed",
            storageBucket: "edendatabase-7e1ed.firebasestorage.app",
            messagingSenderId: "147248399046",
            appId: "1:147248399046:web:d0b433e755772bbe718dc7"
        };

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();

        // Variables globales
        let currentUser = null;
        let userRole = '';
        let currentTeacherId = '';
        let currentGalleryBranch = 'maternelle';
        let galleryImages = [];

        // V√©rifier d'abord la session dans sessionStorage (cr√©√©e par Auth.html)
        function checkStorageSession() {
            try {
                const userData = sessionStorage.getItem('eden_user_data');
                const session = sessionStorage.getItem('eden_secure_session');
                
                if (userData && session) {
                    const user = JSON.parse(userData);
                    const sessionData = JSON.parse(session);
                    
                    // V√©rifier que la session n'a pas expir√©
                    if (Date.now() < sessionData.expiresAt) {
                        console.log('‚úÖ Session valide trouv√©e dans sessionStorage');
                        return true;
                    } else {
                        console.log('‚è∞ Session expir√©e');
                        sessionStorage.clear();
                        return false;
                    }
                }
                return false;
            } catch (error) {
                console.error('Erreur v√©rification session:', error);
                return false;
            }
        }

        // V√©rifier l'authentification
        auth.onAuthStateChanged((user) => {
            // V√©rifier d'abord la session stock√©e
            const hasStorageSession = checkStorageSession();
            
            if (user && hasStorageSession) {
                currentUser = user;
                loadUserData(user.email);
                loadDashboardStats();
                loadRecentActivities();
                loadNotifications();
            } else if (!user && !hasStorageSession) {
                // Seulement rediriger si pas authentifi√© et pas de session
                console.log('‚ùå Non authentifi√© - redirection vers Auth.html');
                window.location.href = './Auth.html';
            } else {
                // User existe mais pas de session en storage - c'est normal, garder la page
                console.log('‚úÖ Utilisateur Firebase pr√©sent, session sera cr√©√©e');
                if (user) {
                    currentUser = user;
                    loadUserData(user.email);
                    loadDashboardStats();
                    loadRecentActivities();
                    loadNotifications();
                }
            }
        });

        // Charger les donn√©es utilisateur
        async function loadUserData(userEmail) {
            try {
                // Chercher dans les enseignants
                const teacherRef = database.ref('teachers').orderByChild('email').equalTo(userEmail);
                const teacherSnapshot = await teacherRef.once('value');
                
                if (teacherSnapshot.exists()) {
                    const teachers = teacherSnapshot.val();
                    const teacherId = Object.keys(teachers)[0];
                    const teacherData = teachers[teacherId];
                    
                    currentTeacherId = teacherId;
                    updateUserUI(teacherData, 'teacher');
                    return;
                }
                
                // Chercher dans les parents
                const parentRef = database.ref('parents').orderByChild('email').equalTo(userEmail);
                const parentSnapshot = await parentRef.once('value');
                
                if (parentSnapshot.exists()) {
                    const parents = parentSnapshot.val();
                    const parentId = Object.keys(parents)[0];
                    const parentData = parents[parentId];
                    
                    updateUserUI(parentData, 'parent');
                    adjustInterfaceForParent();
                    return;
                }
                
                // Utilisateur par d√©faut
                updateUserUI({ name: userEmail }, 'user');
                
            } catch (error) {
                console.error('Erreur chargement utilisateur:', error);
                showToast('Erreur de chargement des donn√©es utilisateur', 'error');
            }
        }

        // Mettre √† jour l'interface utilisateur
        function updateUserUI(data, role) {
            const fullName = `${data.firstName || ''} ${data.lastName || ''}`.trim() || data.name || currentUser.email;
            const roleDisplay = role === 'teacher' ? 'Enseignant' : 
                              role === 'parent' ? 'Parent' : 
                              'Utilisateur';
            
            document.getElementById('userName').textContent = fullName;
            document.getElementById('userRole').textContent = roleDisplay;
            
            const initials = getInitials(fullName);
            document.getElementById('userAvatar').innerHTML = initials;
            
            userRole = role;
        }

        // Ajuster l'interface pour les parents
        function adjustInterfaceForParent() {
            const elementsToHide = [
                'button[onclick="showAddStudentForm()"]',
                'button[onclick="showUploadGallery()"]',
                'button[onclick="exportStudentsToExcel()"]',
                'button[onclick="showImportStudentsModal()"]',
                'button[onclick="createNewBulletin()"]',
                'button[onclick="importBulletinTemplate()"]'
            ];
            
            elementsToHide.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(el => el.style.display = 'none');
            });
            
            document.querySelector('#students .card-title').innerHTML = '<i class="fas fa-users me-2"></i>Mes enfants';
            document.querySelector('#bulletins .card-title').innerHTML = '<i class="fas fa-file-alt me-2"></i>Bulletins de mon enfant';
        }

        // Navigation entre sections
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const navBtn = Array.from(document.querySelectorAll('.nav-btn')).find(btn => 
                btn.onclick && btn.onclick.toString().includes(sectionId)
            );
            
            if (navBtn) {
                navBtn.classList.add('active');
            }
            
            const sectionElement = document.getElementById(sectionId);
            if (sectionElement) {
                sectionElement.classList.add('active');
            }
            
            hideUserMenu();
            
            switch(sectionId) {
                case 'dashboard':
                    loadDashboardStats();
                    loadRecentActivities();
                    loadNotifications();
                    break;
                case 'students':
                    loadStudents();
                    break;
                case 'gallery':
                    loadGallery();
                    break;
                case 'bulletins':
                    loadRecentBulletins();
                    break;
            }
        }

        // === GALERIE PAR BRANCHE ===
        async function loadGallery() {
            try {
                const galleryRef = database.ref('gallery').orderByChild('branch').equalTo(currentGalleryBranch);
                const snapshot = await galleryRef.once('value');
                const galleryItems = snapshot.val() || {};
                galleryImages = Object.values(galleryItems).reverse();
                
                displayGallery(galleryImages);
                updateGalleryStats();
                
            } catch (error) {
                console.error('Erreur chargement galerie:', error);
                showToast('Erreur lors du chargement de la galerie', 'error');
            }
        }

        function switchGalleryBranch(branch) {
            currentGalleryBranch = branch;
            
            // Mettre √† jour les onglets actifs
            document.querySelectorAll('.branch-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelector(`.branch-tab.${branch}`).classList.add('active');
            
            // Recharger la galerie
            loadGallery();
        }

        function displayGallery(images) {
            const galleryGrid = document.getElementById('galleryGrid');
            
            if (images.length === 0) {
                galleryGrid.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-images fa-3x mb-3" style="color: #ddd;"></i>
                        <p>Aucune image dans cette section</p>
                        <p class="text-muted mt-2">Les photos appara√Ætront ici une fois ajout√©es</p>
                    </div>
                `;
                return;
            }
            
            galleryGrid.innerHTML = '';
            
            images.forEach(item => {
                const galleryItem = document.createElement('div');
                galleryItem.className = 'gallery-item';
                galleryItem.onclick = () => openImageModal(item);
                
                galleryItem.innerHTML = `
                    <img src="${item.url || 'https://via.placeholder.com/300'}" alt="${item.description || 'Image'}">
                    <div class="gallery-item-overlay">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <small class="fw-bold">${item.title || 'Sans titre'}</small>
                                <br>
                                <small>${item.description || ''}</small>
                            </div>
                            <span class="branch-badge ${currentGalleryBranch}">
                                ${currentGalleryBranch.toUpperCase()}
                            </span>
                        </div>
                        <small class="mt-2 d-block">${new Date(item.uploadedAt || Date.now()).toLocaleDateString('fr-FR')}</small>
                    </div>
                `;
                
                galleryGrid.appendChild(galleryItem);
            });
        }

        async function updateGalleryStats() {
            try {
                const stats = {
                    maternelle: 0,
                    primaire: 0,
                    kimisagara: 0,
                    gisozi: 0
                };
                
                // Compter les images par branche
                const galleryRef = database.ref('gallery');
                const snapshot = await galleryRef.once('value');
                const allItems = snapshot.val() || {};
                
                Object.values(allItems).forEach(item => {
                    if (item.branch && stats[item.branch] !== undefined) {
                        stats[item.branch]++;
                    }
                });
                
                document.getElementById('maternelleCount').textContent = stats.maternelle;
                document.getElementById('primaireCount').textContent = stats.primaire;
                document.getElementById('kimisagaraCount').textContent = stats.kimisagara;
                document.getElementById('gisoziCount').textContent = stats.gisozi;
                
            } catch (error) {
                console.error('Erreur mise √† jour statistiques galerie:', error);
            }
        }

        function openImageModal(item) {
            const modalHtml = `
                <div class="modal fade" id="imageModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">${item.title || 'Image'}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center">
                                <img src="${item.url}" alt="${item.description || 'Image'}" class="img-fluid rounded">
                                <p class="mt-3">${item.description || ''}</p>
                                <div class="text-muted">
                                    <small>Publi√© le: ${new Date(item.uploadedAt || Date.now()).toLocaleDateString('fr-FR')}</small>
                                    <br>
                                    <small>Branche: <span class="branch-badge ${item.branch || 'maternelle'}">${(item.branch || 'maternelle').toUpperCase()}</span></small>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                                <button class="btn btn-primary" onclick="downloadImage('${item.url}', '${item.title || 'image'}')">
                                    <i class="fas fa-download"></i> T√©l√©charger
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const modalContainer = document.getElementById('modalContainer') || (() => {
                const div = document.createElement('div');
                div.id = 'modalContainer';
                document.body.appendChild(div);
                return div;
            })();
            
            modalContainer.innerHTML = modalHtml;
            const modal = new bootstrap.Modal(document.getElementById('imageModal'));
            modal.show();
        }

        function downloadImage(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = `${filename}-${Date.now()}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('T√©l√©chargement commenc√©', 'success');
        }

        // === BULLETINS ===
        async function loadRecentBulletins() {
            try {
                const bulletinsRef = database.ref('bulletins').orderByChild('createdAt').limitToLast(10);
                const snapshot = await bulletinsRef.once('value');
                const bulletins = snapshot.val() || {};
                
                const tbody = document.getElementById('recentBulletins');
                
                if (Object.keys(bulletins).length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <i class="fas fa-file-alt fa-2x mb-3" style="color: #ddd;"></i>
                                <p>Aucun bulletin cr√©√©</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = '';
                
                Object.values(bulletins).reverse().forEach(bulletin => {
                    const row = document.createElement('tr');
                    
                    let statusBadge = '';
                    switch(bulletin.status) {
                        case 'draft':
                            statusBadge = '<span class="badge bg-warning">Brouillon</span>';
                            break;
                        case 'published':
                            statusBadge = '<span class="badge bg-success">Publi√©</span>';
                            break;
                        case 'archived':
                            statusBadge = '<span class="badge bg-secondary">Archiv√©</span>';
                            break;
                        default:
                            statusBadge = '<span class="badge bg-info">Inconnu</span>';
                    }
                    
                    row.innerHTML = `
                        <td>${new Date(bulletin.createdAt || Date.now()).toLocaleDateString('fr-FR')}</td>
                        <td>
                            <span class="badge bg-primary">${bulletin.type || 'Acad√©mique'}</span>
                        </td>
                        <td>${bulletin.class || 'Toutes classes'}</td>
                        <td>${bulletin.term || 'Non sp√©cifi√©'}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-primary" onclick="viewBulletin('${bulletin.id || ''}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="editBulletin('${bulletin.id || ''}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-success" onclick="downloadBulletin('${bulletin.id || ''}')">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
            } catch (error) {
                console.error('Erreur chargement bulletins:', error);
                showToast('Erreur lors du chargement des bulletins', 'error');
            }
        }

        function createNewBulletin() {
            showToast('Cr√©ation d\'un nouveau bulletin - Fonctionnalit√© en d√©veloppement', 'info');
        }

        function useBulletinTemplate(template) {
            const templates = {
                'academic': 'Bulletin Acad√©mique',
                'conduct': 'Bulletin de Conduite',
                'detailed': 'Bulletin D√©taill√©',
                'bilingual': 'Bulletin Bilingue'
            };
            
            showToast(`Utilisation du mod√®le: ${templates[template]}`, 'success');
        }

        function importBulletinTemplate() {
            showToast('Importation de mod√®le - Fonctionnalit√© en d√©veloppement', 'info');
        }

        function refreshBulletins() {
            loadRecentBulletins();
            showToast('Liste des bulletins actualis√©e', 'success');
        }

        // === √âTUDIANTS ===
        async function loadStudents() {
            try {
                const studentsRef = database.ref('students');
                const snapshot = await studentsRef.once('value');
                const students = snapshot.val() || {};
                
                const tbody = document.getElementById('studentsTable');
                
                if (Object.keys(students).length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-4">
                                <i class="fas fa-user-slash fa-2x mb-3" style="color: #ddd;"></i>
                                <p>Aucun √©tudiant enregistr√©</p>
                            </td>
                        </tr>
                    `;
                    updateStudentStats(students);
                    return;
                }
                
                tbody.innerHTML = '';
                let maleCount = 0;
                let femaleCount = 0;
                
                Object.entries(students).forEach(([id, student]) => {
                    if (student.gender === 'M') maleCount++;
                    if (student.gender === 'F') femaleCount++;
                    
                    const row = document.createElement('tr');
                    const fullName = `${student.firstName || ''} ${student.lastName || ''}`.trim();
                    const classLevel = student.class || 'Non d√©fini';
                    const status = student.status || 'Actif';
                    
                    row.innerHTML = `
                        <td>
                            <input type="checkbox" class="student-checkbox" data-id="${id}">
                        </td>
                        <td>${fullName || 'Inconnu'}</td>
                        <td>${classLevel}</td>
                        <td>
                            <span class="badge bg-${student.gender === 'M' ? 'primary' : 'info'}">
                                ${student.gender === 'M' ? 'Gar√ßon' : 'Fille'}
                            </span>
                        </td>
                        <td>${student.email || 'N/A'}</td>
                        <td>
                            <span class="badge ${status === 'Actif' ? 'bg-success' : 'bg-warning'}">
                                ${status}
                            </span>
                        </td>
                        <td>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-primary" onclick="editStudent('${id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteStudent('${id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
                updateStudentStats(students);
                
            } catch (error) {
                console.error('Erreur chargement √©tudiants:', error);
                showToast('Erreur lors du chargement des √©tudiants', 'error');
            }
        }

        function updateStudentStats(students) {
            let maleCount = 0;
            let femaleCount = 0;
            
            Object.values(students).forEach(student => {
                if (student.gender === 'M') maleCount++;
                if (student.gender === 'F') femaleCount++;
            });
            
            const total = Object.keys(students).length;
            document.getElementById('totalStudents').textContent = total;
            document.getElementById('maleStudents').textContent = maleCount;
            document.getElementById('femaleStudents').textContent = femaleCount;
            document.getElementById('myStudentsCount').textContent = total;
            
            if (total > 0) {
                const activePercent = Math.round((total / total) * 100);
                document.getElementById('activeStudentsPercent').textContent = activePercent + '%';
                document.getElementById('activeStudentsBar').style.width = activePercent + '%';
            }
        }

        function filterStudents() {
            const classFilter = document.getElementById('classFilter').value;
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
            
            const rows = document.querySelectorAll('#studentsTable tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const classCell = row.cells[2]?.textContent || '';
                
                const matchClass = !classFilter || classCell.includes(classFilter);
                const matchSearch = !searchTerm || text.includes(searchTerm);
                
                row.style.display = (matchClass && matchSearch) ? '' : 'none';
            });
        }

        function editStudent(studentId) {
            showToast(`Edition √©tudiant ${studentId} - Fonctionnalit√© en d√©veloppement`, 'info');
        }

        function deleteStudent(studentId) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cet √©tudiant ?')) {
                database.ref(`students/${studentId}`).remove()
                    .then(() => {
                        showToast('√âtudiant supprim√© avec succ√®s', 'success');
                        loadStudents();
                    })
                    .catch((error) => {
                        console.error('Erreur suppression:', error);
                        showToast('Erreur lors de la suppression', 'error');
                    });
            }
        }

        function showAddStudentForm() {
            showToast('Ajout d\'√©tudiant - Formulaire en d√©veloppement', 'info');
        }

        function exportStudentsToExcel() {
            showToast('Export Excel - Fonctionnalit√© en d√©veloppement', 'info');
        }

        function showImportStudentsModal() {
            showToast('Import d\'√©tudiants - Fonctionnalit√© en d√©veloppement', 'info');
        }

        function toggleSelectAllStudents() {
            const checkboxes = document.querySelectorAll('.student-checkbox');
            const selectAllCheckbox = document.getElementById('selectAllStudents');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }

        // === TABLEAU DE BORD ===
        async function loadDashboardStats() {
            try {
                const studentsRef = database.ref('students');
                const bullettinsRef = database.ref('bulletins');
                
                const [studentsSnapshot, bulletinsSnapshot] = await Promise.all([
                    studentsRef.once('value'),
                    bullettinsRef.once('value')
                ]);
                
                const students = studentsSnapshot.val() || {};
                const bulletins = bulletinsSnapshot.val() || {};
                
                const totalStudents = Object.keys(students).length;
                const totalBulletins = Object.keys(bulletins).length;
                
                document.getElementById('myStudentsCount').textContent = totalStudents;
                
                if (totalStudents > 0) {
                    document.getElementById('activeStudentsPercent').textContent = '100%';
                    document.getElementById('activeStudentsBar').style.width = '100%';
                }
                
                console.log('Stats charg√©es - √âtudiants:', totalStudents, 'Bulletins:', totalBulletins);
                
            } catch (error) {
                console.error('Erreur chargement stats:', error);
            }
        }

        async function loadRecentActivities() {
            try {
                const activitiesRef = database.ref('activities').limitToLast(5);
                const snapshot = await activitiesRef.once('value');
                const activities = snapshot.val() || {};
                
                const activityContainer = document.getElementById('recentActivitiesTimeline');
                if (!activityContainer) return;
                
                if (Object.keys(activities).length === 0) {
                    activityContainer.innerHTML = `
                        <div class="timeline-item">
                            <div class="timeline-content">
                                <p class="text-muted mb-0">Aucune activit√© r√©cente</p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                activityContainer.innerHTML = '';
                
                Object.values(activities).reverse().forEach(activity => {
                    const div = document.createElement('div');
                    div.className = 'timeline-item';
                    div.innerHTML = `
                        <div class="timeline-marker"></div>
                        <div class="timeline-content">
                            <p class="mb-1"><strong>${activity.title || 'Activit√©'}</strong></p>
                            <p class="text-muted mb-0"><small>${new Date(activity.date || Date.now()).toLocaleDateString('fr-FR')}</small></p>
                        </div>
                    `;
                    activityContainer.appendChild(div);
                });
                
            } catch (error) {
                console.error('Erreur chargement activit√©s:', error);
            }
        }

        async function loadNotifications() {
            try {
                const notificationsRef = database.ref('notifications').limitToLast(5);
                const snapshot = await notificationsRef.once('value');
                const notifications = snapshot.val() || {};
                
                const notifContainer = document.getElementById('recentNotifications');
                if (!notifContainer) return;
                
                if (Object.keys(notifications).length === 0) {
                    notifContainer.innerHTML = `
                        <div class="text-center py-3">
                            <i class="fas fa-inbox" style="font-size: 2rem; color: #ddd;"></i>
                            <p class="mt-2 text-muted">Aucune notification</p>
                        </div>
                    `;
                    return;
                }
                
                notifContainer.innerHTML = '';
                
                Object.values(notifications).reverse().forEach(notification => {
                    const div = document.createElement('div');
                    div.className = 'notification-item p-3 border-bottom';
                    div.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <p class="mb-1"><strong>${notification.message || 'Notification'}</strong></p>
                                <p class="text-muted mb-0"><small>${new Date(notification.date || Date.now()).toLocaleDateString('fr-FR')}</small></p>
                            </div>
                            <span class="badge bg-${notification.type === 'error' ? 'danger' : notification.type === 'warning' ? 'warning' : 'info'}">
                                ${notification.type || 'info'}
                            </span>
                        </div>
                    `;
                    notifContainer.appendChild(div);
                });
                
            } catch (error) {
                console.error('Erreur chargement notifications:', error);
            }
        }

        function showUploadGallery() {
            showToast('Upload galerie - Formulaire en d√©veloppement', 'info');
        }

        function markAllAsRead() {
            showToast('Toutes les notifications marqu√©es comme lues', 'success');
        }

        function refreshActivities() {
            loadRecentActivities();
            showToast('Activit√©s actualis√©es', 'success');
        }

        // === FONCTIONS UTILITAIRES ===
        function getInitials(name) {
            return name.split(' ')
                .map(n => n[0])
                .join('')
                .substring(0, 2)
                .toUpperCase() || '??';
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast-notification ${type}`;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${type === 'success' ? 'var(--secondary)' : 
                           type === 'error' ? 'var(--accent)' : 
                           type === 'warning' ? 'var(--warning)' : 'var(--primary)'};
                color: white;
                border-radius: 8px;
                box-shadow: var(--box-shadow-hover);
                z-index: 9999;
                animation: fadeIn 0.3s, fadeOut 0.3s 2.7s;
                display: flex;
                align-items: center;
                gap: 10px;
                max-width: 400px;
            `;
            
            const icon = type === 'success' ? 'fa-check-circle' :
                        type === 'error' ? 'fa-exclamation-circle' :
                        type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';
            
            toast.innerHTML = `
                <i class="fas ${icon} fa-lg"></i>
                <div>${message}</div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }

        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        function hideUserMenu() {
            document.getElementById('userMenu').style.display = 'none';
        }

        // Fermer le menu en cliquant √† l'ext√©rieur
        document.addEventListener('click', (event) => {
            const userMenu = document.getElementById('userMenu');
            const userAvatar = document.getElementById('userAvatar');
            
            if (userMenu && userAvatar) {
                if (!userMenu.contains(event.target) && !userAvatar.contains(event.target)) {
                    userMenu.style.display = 'none';
                }
            }
        });

        function logout() {
            if (confirm('√ätes-vous s√ªr de vouloir vous d√©connecter ?')) {
                auth.signOut().then(() => {
                    showToast('D√©connexion r√©ussie', 'success');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                }).catch((error) => {
                    console.error('Erreur d√©connexion:', error);
                    showToast('Erreur lors de la d√©connexion', 'error');
                });
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Gestionnaire de recherche globale
            const globalSearch = document.getElementById('globalSearch');
            if (globalSearch) {
                globalSearch.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    // Recherche √† impl√©menter
                });
            }
        });
    </script>
</body>
</html>