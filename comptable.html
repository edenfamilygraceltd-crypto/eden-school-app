<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EdenSmart - Gestion Financière</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Responsive CSS Global -->
    <link rel="stylesheet" href="responsive.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- SheetJS pour Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    
    <!-- jsPDF pour PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --primary: #2E8B57;
            --secondary: #1E6B4E;
            --success: #32CD32;
            --warning: #FFA500;
            --danger: #DC143C;
            --info: #20B2AA;
            --light: #f8f9fa;
            --dark: #2F4F4F;
            --border-radius: 12px;
            --box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
            --nav-border-radius: 0px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1E6B4E 0%, #2E8B57 100%);
            background-attachment: fixed;
            color: var(--dark);
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-50px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        .animate-slide-left {
            animation: slideInLeft 0.6s ease-out;
        }
        
        .animate-slide-right {
            animation: slideInRight 0.6s ease-out;
        }
        
        /* Header */
        .modern-header {
            background: rgba(255, 255, 255, 0.95);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            color: var(--dark);
            padding: 1.5rem 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            box-shadow: 0 4px 15px rgba(46, 139, 87, 0.3);
        }
        
        .logo-text h1 {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 1.8rem;
            margin: 0;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .logo-text p {
            font-size: 0.9rem;
            color: var(--dark);
            margin: 0;
        }
        
        /* Navigation */
        .main-nav {
            background: rgba(255, 255, 255, 0.95);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            padding: 1rem 0;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            width: 100%;
            z-index: 999;
            overflow: hidden;
        }
        
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            transition: max-width 0.3s ease;
        }
        
        .nav-tabs {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: var(--dark);
            font-weight: 500;
            border-radius: 8px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .nav-btn:hover {
            background: rgba(46, 139, 87, 0.1);
            color: var(--primary);
            transform: translateY(-2px);
        }
        
        .nav-btn.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(46, 139, 87, 0.3);
        }

        /* Navigation Scroll Animation */
        .main-nav.nav-scrolled {
            /* Keep same shape/position when scrolled; only subtle elevation */
            border-radius: var(--nav-border-radius, 0px) !important;
            margin: 0 !important;
            width: 100% !important;
            left: 0 !important;
            transform: none !important;
            top: 0 !important;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
            transition: box-shadow 0.25s ease;
            animation: none !important;
        }

        .main-nav.nav-scrolled .nav-container {
            max-width: 1400px;
        }

        /* Navigation cachée: translate up to hide (works on phones) */
        .main-nav.nav-hidden {
            transform: translateY(-120%) !important;
            opacity: 0 !important;
            transition: transform 0.35s ease, opacity 0.25s ease;
            pointer-events: none !important;
            animation: none !important;
            border-radius: var(--nav-border-radius, 20px) !important;
        }

        /* Animation de flottement */
        @keyframes navFloat {
            0% {
                transform: translateY(0);
                border-radius: 0px;
                width: 100%;
                left: 0;
                top: 0;
                margin: 0;
            }
            100% {
                transform: translateX(-50%) translateY(0);
                border-radius: 20px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                width: calc(100% - 4rem);
                left: 50%;
                top: 1rem;
            }
        }

        @keyframes navAppear {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-40px);
                border-radius: 0px;
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
                border-radius: 20px;
            }
        }

        @keyframes navExit {
            from {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
                border-radius: 20px;
            }
            to {
                opacity: 0;
                transform: translateX(-50%) translateY(-80px);
                border-radius: 0px;
            }
        }

        /* Navigation Header Wrapper - groups header + nav together */
        .nav-header-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            width: 100%;
            z-index: 999;
            background: rgba(255, 255, 255, 0.95);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }

        .nav-header-wrapper.nav-scrolled {
            /* Keep same header shape when scrolled; subtle shadow only */
            border-radius: var(--nav-border-radius, 0px) !important;
            margin: 0 !important;
            width: 100% !important;
            left: 0 !important;
            transform: none !important;
            top: 0 !important;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08) !important;
            background: rgba(255, 255, 255, 0.95) !important;
            transition: box-shadow 0.25s ease;
            animation: none !important;
        }

        .nav-header-wrapper.nav-hidden {
            transform: translateY(-110%) !important;
            opacity: 0 !important;
            transition: transform 0.35s ease, opacity 0.25s ease;
            pointer-events: none !important;
            animation: none !important;
            border-radius: var(--nav-border-radius, 20px) !important;
        }

        @keyframes navWrapperAppear {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-120px);
                border-radius: 0px;
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
                border-radius: 20px;
            }
        }

        @keyframes navWrapperExit {
            from {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
                border-radius: 20px;
            }
            to {
                opacity: 0;
                transform: translateX(-50%) translateY(-200px);
                border-radius: 0px;
            }
        }

        /* NAV: disable all animations/transitions and keep nav static */
        /* Make header and nav flow in document (not fixed) so they stack normally */
        .nav-header-wrapper,
        .main-nav {
            position: static !important;
            width: 100% !important;
            left: auto !important;
            top: auto !important;
            transform: none !important;
            animation: none !important;
            transition: none !important;
            box-shadow: none !important;
            border-radius: 0 !important;
            opacity: 1 !important;
            pointer-events: auto !important;
        }

        /* Neutralize scrolled/hidden modifiers so they don't change flow */
        .main-nav.nav-scrolled,
        .nav-header-wrapper.nav-scrolled,
        .main-nav.nav-hidden,
        .nav-header-wrapper.nav-hidden {
            position: static !important;
            transform: none !important;
            animation: none !important;
            transition: none !important;
            opacity: 1 !important;
        }

        /* Remove large top margin now header+nav are static */
        .main-content {
            margin-top: 0 !important;
        }

        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        
        .section {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s, transform 0.5s;
        }
        
        .section.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Dashboard */
        .dashboard-hero {
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.9) 100%);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 3rem;
            color: var(--dark);
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            box-shadow: var(--box-shadow);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            border: 1px solid #eef2ff;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.6s ease-out forwards;
        }
        
        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }
        .stat-card:nth-child(4) { animation-delay: 0.4s; }
        
        .stat-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 1rem;
            color: white;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 0.5rem 0;
            color: var(--dark);
        }
        
        /* Forms */
        .form-control-modern {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px 16px;
            transition: var(--transition);
            width: 100%;
            font-family: 'Inter', sans-serif;
        }
        
        .form-control-modern:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(46, 139, 87, 0.1);
            outline: none;
        }
        
        /* Buttons */
        .btn-modern {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary-modern {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }
        
        .btn-primary-modern:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(46, 139, 87, 0.4);
        }
        
        /* Tables */
        .modern-table {
            width: 100%;
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
        }
        
        .modern-table th {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }
        
        .modern-table td {
            padding: 1rem;
            border-bottom: 1px solid #f1f1f1;
        }
        
        .modern-table tbody tr {
            transition: var(--transition);
        }
        
        .modern-table tbody tr:hover {
            background: rgba(46, 139, 87, 0.05);
        }
        
        /* Badges */
        .badge-bank {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        .badge-momo {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            word-break: keep-all;
            white-space: nowrap;
        }
        
        .badge-cash {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        .badge-minervale {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        .badge-coaching {
            background: linear-gradient(135deg, #6f42c1, #4e2a9c);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        .badge-transport {
            background: linear-gradient(135deg, #17a2b8, #117a8b);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        /* Chart Container */
        .chart-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--box-shadow);
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 9999;
        }
        
        .toast-notification {
            background: white;
            border-radius: 8px;
            padding: 1rem 1.5rem;
            margin-bottom: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: slideInRight 0.3s ease-out;
            border-left: 4px solid var(--primary);
        }
        
        .toast-notification.success {
            border-left-color: #28a745;
        }
        
        .toast-notification.error {
            border-left-color: #dc3545;
        }
        
        .toast-notification.info {
            border-left-color: #17a2b8;
        }
        
        /* Ultra-Mobile Screens (320px - 374px) */
        @media (max-width: 374px) {
            body {
                font-size: 13px;
            }

            .header-container {
                flex-direction: column;
                gap: 0.5rem;
                padding: 0.75rem 0.5rem;
            }

            .logo-icon {
                width: 38px;
                height: 38px;
                font-size: 16px;
            }

            .logo-text h1 {
                font-size: 0.95rem;
            }

            .logo-text p {
                font-size: 0.65rem;
            }

            .nav-btn {
                padding: 6px 8px;
                font-size: 0.7rem;
                min-height: 40px;
            }

            .main-content {
                padding: 0 0.5rem;
                margin-top: 220px;
            }

            .dashboard-hero {
                padding: 0.75rem;
                margin-bottom: 1rem;
            }

            .hero-title {
                font-size: 0.95rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .stat-card {
                padding: 0.75rem;
            }

            .stat-value {
                font-size: 1.1rem;
            }

            .card-modern {
                padding: 0.75rem;
            }

            .modern-table {
                font-size: 0.65rem;
            }

            .modern-table th,
            .modern-table td {
                padding: 0.4rem;
            }

            .form-control-modern {
                padding: 8px 10px;
                font-size: 13px;
                min-height: 40px;
            }

            .btn-modern {
                padding: 8px 10px;
                font-size: 0.7rem;
                min-height: 40px;
            }
        }

        /* Mobile Screens (375px - 479px) */
        @media (max-width: 479px) {
            body {
                font-size: 13px;
            }

            .header-container {
                flex-wrap: wrap;
                gap: 0.75rem;
                padding: 0.75rem;
            }

            .logo-icon {
                width: 42px;
                height: 42px;
                font-size: 18px;
            }

            .logo-text h1 {
                font-size: 1.05rem;
            }

            .logo-text p {
                font-size: 0.7rem;
            }

            .nav-container {
                padding: 0 0.75rem;
            }

            .nav-btn {
                padding: 8px 10px;
                font-size: 0.75rem;
                margin: 2px;
                min-height: 44px;
            }

            .nav-tabs {
                gap: 2px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                flex-wrap: nowrap;
            }

            .main-content {
                padding: 0 0.75rem;
                margin-top: 220px;
            }

            .dashboard-hero {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .hero-title {
                font-size: 1.05rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }

            .stat-card {
                padding: 0.75rem;
                margin-bottom: 0.5rem;
            }

            .stat-value {
                font-size: 1.2rem;
            }

            .card-modern {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .badge-bank,
            .badge-cash,
            .badge-momo,
            .badge-minervale,
            .badge-coaching,
            .badge-transport {
                font-size: 0.75rem;
                padding: 4px 6px;
                white-space: normal;
                word-break: break-word;
            }

            .modern-table {
                font-size: 0.8rem;
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .modern-table thead,
            .modern-table tbody {
                display: table;
                width: 100%;
            }

            .modern-table th,
            .modern-table td {
                padding: 0.6rem;
            }

            .form-control-modern {
                padding: 10px 12px;
                font-size: 16px;
                min-height: 44px;
                width: 100%;
            }

            .btn-modern {
                padding: 10px 12px;
                font-size: 0.85rem;
                min-height: 44px;
                width: 100%;
                margin-bottom: 0.5rem;
            }

            .d-flex {
                flex-direction: column;
                gap: 0.5rem;
            }

            /* Keep header/nav areas horizontal on very small screens */
            .nav-header-wrapper .d-flex,
            .header-container .d-flex,
            .nav-container .d-flex {
                flex-direction: row !important;
                gap: 0.5rem !important;
                align-items: center !important;
            }

            [class*="col-"] {
                width: 100% !important;
            }

            h1 { font-size: 1.1rem; }
            h2 { font-size: 0.95rem; }
            h3 { font-size: 0.85rem; }

            .chart-container {
                height: 250px;
                margin-bottom: 1rem;
            }
        }

        /* Small Tablets (480px - 767px) */
        @media (min-width: 480px) and (max-width: 767px) {
            body {
                font-size: 14px;
            }

            .header-container {
                flex-wrap: wrap;
                gap: 1rem;
                padding: 1rem;
            }

            .logo-text h1 {
                font-size: 1.2rem;
            }

            .nav-btn {
                padding: 10px 12px;
                font-size: 0.9rem;
                min-height: 44px;
            }

            .nav-container, .main-content {
                padding: 0 1rem;
            }

            .dashboard-hero {
                padding: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .stat-card {
                padding: 1rem;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            input, select, textarea, button {
                font-size: 14px;
                min-height: 44px;
            }

            .modern-table {
                font-size: 0.85rem;
            }

            .modern-table th,
            .modern-table td {
                padding: 0.75rem;
            }

            .chart-container {
                height: 300px;
            }

            .col-md-6 {
                width: 50%;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-container, .nav-container, .main-content {
                padding: 0 1rem;
            }
            
            .dashboard-hero {
                padding: 2rem 1rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                justify-content: center;
            }
            
            .nav-btn {
                padding: 10px 15px;
                font-size: 0.9rem;
                min-height: 44px;
            }

            body {
                font-size: 14px;
            }

            input, select, textarea, button {
                font-size: 15px;
                min-height: 44px;
            }
        }
        
        /* Legal Badge */
        .legal-badge {
            background: linear-gradient(135deg, #2E8B57, #1E6B4E);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Teacher Avatar */
        .teacher-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        /* Tabs dans la section payroll */
        .payroll-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #eaeaea;
            padding-bottom: 10px;
        }
        
        .payroll-tab {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: var(--dark);
            font-weight: 500;
            border-radius: 6px;
            transition: var(--transition);
            cursor: pointer;
        }
        
        .payroll-tab:hover {
            background: rgba(46, 139, 87, 0.1);
        }
        
        .payroll-tab.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }
        
        /* Journal Financier Styles */
        .journal-table th {
            font-size: 0.85rem;
            padding: 0.75rem;
        }
        
        .journal-table td {
            font-size: 0.85rem;
            padding: 0.75rem;
        }
        
        .money-in {
            color: #28a745;
            font-weight: bold;
        }
        
        .money-out {
            color: #dc3545;
            font-weight: bold;
        }
        
        .balance {
            color: #007bff;
            font-weight: bold;
        }
        
        /* Rapport Styles */
        .report-summary {
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 100%);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 5px solid var(--primary);
        }
        
        .opening-balance-input {
            max-width: 200px;
            font-weight: bold;
            font-size: 1.1rem;
            text-align: center;
        }
        
        /* Nouveaux styles */
        .search-container {
            position: relative;
            width: 300px;
        }
        
        .search-results {
            position: absolute;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            max-height: 400px;
            overflow-y: auto;
            width: 100%;
            z-index: 1000;
            display: none;
        }
        
        .search-result-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .search-result-item:hover {
            background: rgba(46, 139, 87, 0.1);
        }
        
        .student-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            margin: 0 auto;
        }
        
        .debt-badge {
            background: linear-gradient(135deg, #DC143C, #B22222);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
        }
        
        .worker-type-badge {
            background: linear-gradient(135deg, #20B2AA, #008B8B);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        .announcement-type-badge {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 5px;
        }
        
        .financial-table th {
            font-size: 0.8rem;
            padding: 0.5rem;
            text-align: center;
        }
        
        .financial-table td {
            font-size: 0.8rem;
            padding: 0.5rem;
            text-align: center;
        }
        
        .justification-cell {
            min-width: 200px;
            max-width: 250px;
            font-size: 0.8rem;
        }
        
        /* Nouveaux styles pour les rapports */
        .expense-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid #dc3545;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: var(--transition);
        }
        
        .expense-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .report-form-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--box-shadow);
        }
        
        .report-field-group {
            margin-bottom: 1.5rem;
        }
        
        .report-field-group h6 {
            color: var(--primary);
            margin-bottom: 0.75rem;
            font-weight: 600;
        }
        
        /* Styles pour le tableau de rapport journalier */
        .report-summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .summary-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--box-shadow);
        }
        
        .summary-card.income {
            border-top: 4px solid #28a745;
        }
        
        .summary-card.expenses {
            border-top: 4px solid #dc3545;
        }
        
        .summary-card.balance {
            border-top: 4px solid #007bff;
        }
        
        .summary-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }
        
        .income .summary-value {
            color: #28a745;
        }
        
        .expenses .summary-value {
            color: #dc3545;
        }
        
        .balance .summary-value {
            color: #007bff;
        }
        
        /* Styles pour la section branches */
        .branch-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .branch-option {
            flex: 1;
            min-width: 250px;
        }
        
        .branch-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            border: 2px solid #eaeaea;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .branch-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
        }
        
        .branch-card.selected {
            border-color: var(--primary);
            background: rgba(46, 139, 87, 0.05);
        }
        
        .branch-card h6 {
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .branch-card small {
            color: #666;
        }
        
        /* CSS Classes pour remplacer les styles inline */
        .language-toggle-btn {
            background: #6c757d;
            color: white;
            margin-left: 10px;
        }
        
        .user-role-text {
            color: var(--dark);
        }
        
        .user-avatar-header {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2E8B57, #1E6B4E);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .stat-icon-primary {
            background: linear-gradient(135deg, #2E8B57, #1E6B4E) !important;
        }
        
        .stat-icon-danger {
            background: linear-gradient(135deg, #DC143C, #B22222) !important;
        }
        
        .stat-icon-warning {
            background: linear-gradient(135deg, #FFA500, #FF8C00) !important;
        }
        
        .stat-icon-info {
            background: linear-gradient(135deg, #20B2AA, #008B8B) !important;
        }
        
        .icon-text-primary {
            color: var(--primary) !important;
        }
        
        .btn-debt-modal {
            background: #DC143C;
            color: white;
        }
        
        .btn-payroll-success {
            background: #28a745;
            color: white;
        }
        
        .btn-payroll-danger {
            background: #DC143C;
            color: white;
        }
        
        .btn-payroll-history {
            background: #6f42c1;
            color: white;
        }
        
        .payroll-history-section {
            display: none;
        }
        
        .filter-select-width {
            width: 150px;
        }
        
        .filter-month-width {
            width: 200px;
        }
        
        .btn-student-fees-success {
            background: #28a745;
            color: white;
        }
        
        .btn-student-fees-danger {
            background: #DC143C;
            color: white;
        }
        
        .search-input-width {
            width: 300px;
        }
        
        .btn-student-search {
            background: #17a2b8;
            color: white;
        }
        
        .student-profile-section {
            display: none;
        }
        
        .btn-report-success {
            background: #28a745;
            color: white;
        }
        
        .btn-report-info {
            background: #20B2AA;
            color: white;
        }
        
        .report-daily-button {
            background: #28a745;
            color: white;
        }
        
        .report-daily-danger {
            background: #DC143C;
            color: white;
        }
        
        .weekly-report-section {
            display: none;
        }
        
        .weekly-report-button {
            background: #28a745;
            color: white;
        }
        
        .weekly-report-danger {
            background: #DC143C;
            color: white;
        }
        
        .monthly-report-section {
            display: none;
        }
        
        .monthly-report-button {
            background: #28a745;
            color: white;
        }
        
        .monthly-report-danger {
            background: #DC143C;
            color: white;
        }
        
        .btn-backup-data {
            background: #17a2b8;
            color: white;
        }
        
        .btn-reset-system {
            background: #6c757d;
            color: white;
        }
        
        .btn-logout {
            background: #dc3545;
            color: white;
        }
        
        .btn-export-pdf {
            background: #DC143C;
            color: white;
        }
        
        .delete-worker-btn {
            display: none;
        }
        
        .student-info-display {
            display: none;
        }
        
        /* Support Safari pour backdrop-filter */
        .modern-header,
        .main-nav,
        .nav-btn {
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }
        
        /* Support background-clip */
        .logo-text h1,
        .logo-icon {
            background-clip: padding-box;
            -webkit-background-clip: text;
            background-clip: text;
        }
        
    </style>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script>
        // Définir logout de manière précoce pour éviter les problèmes de timing
        let auth = null;
        function logout() {
            if (!auth) {
                console.error('Firebase auth not initialized yet. Please try again.');
                alert('Erreur: Authentification non initialisée. Veuillez réessayer.');
                return;
            }
            
                if (confirm('Êtes-vous sûr de vouloir vous déconnecter?')) {
                    auth.signOut().then(() => {
                        console.log('Déconnexion réussie');
                        if (typeof showToast === 'function') {
                            showToast('Déconnexion réussie', 'success');
                        }
                        // Rediriger directement vers Auth.html sans recharger la page
                        setTimeout(() => {
                            window.location.href = 'Auth.html';
                        }, 500);
                    }).catch((error) => {
                    console.error('Erreur déconnexion:', error);
                    if (typeof showToast === 'function') {
                        showToast('Erreur lors de la déconnexion: ' + error.message, 'error');
                    } else {
                        alert('Erreur: ' + error.message);
                    }
                });
            }
        }
    </script>
    <script>
        // Ajuste dynamiquement le margin-top de .main-content
        function adjustMainContentOffset() {
            const wrapper = document.querySelector('.nav-header-wrapper');
            const main = document.querySelector('.main-content');
            if (!wrapper || !main) return;
            const rect = wrapper.getBoundingClientRect();
            // ajouter une marge de sécurité
            const offset = Math.ceil(rect.height) + 16;
            main.style.marginTop = offset + 'px';
        }

        window.addEventListener('DOMContentLoaded', adjustMainContentOffset);
        window.addEventListener('load', adjustMainContentOffset);
        window.addEventListener('resize', () => {
            // petit délai pour laisser le layout se stabiliser
            clearTimeout(window._adjustMainContentTimeout);
            window._adjustMainContentTimeout = setTimeout(adjustMainContentOffset, 120);
        });
    </script>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Navigation & Header Wrapper -->
    <div class="nav-header-wrapper">
        <!-- Header -->
        <header class="modern-header">
            <div class="header-container">
                <div class="logo">
                    <div class="logo-icon">
                        <img src="asset/img/logo_eden.png" alt="Logo Eden Family School" style="height: 40px; width: auto; object-fit: contain;">
                    </div>
                    <div class="logo-text">
                        <h1>EdenSmart Finances</h1>
                        <p>Système conforme aux lois financières du Rwanda</p>
                    </div>
                </div>
                
                <div class="d-flex align-items-center gap-3">
                    <div class="search-container">
                        <input type="text" class="form-control-modern" id="globalSearch" 
                               placeholder="Rechercher dans tout le système..." 
                               onkeyup="performGlobalSearch(this.value)">
                        <div class="search-results" id="searchResults">
                            <!-- Résultats de recherche -->
                        </div>
                    </div>
                    
                    <span class="legal-badge">
                        <i class="fas fa-balance-scale"></i>
                        Conforme RRA
                    </span>
                    
                    <button id="languageToggle" class="btn-modern language-toggle-btn">
                        <i class="fas fa-language me-2"></i>
                        <span id="languageText">EN</span>
                    </button>
                    
                    <div class="text-end">
                        <div class="fw-bold" id="userName">Utilisateur</div>
                        <small id="userRole" class="user-role-text">Comptable Principal</small>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="main-nav">
            <div class="nav-container">
                <div class="nav-tabs">
                    <button class="nav-btn active" onclick="showSection('dashboard')">
                        <i class="fas fa-tachometer-alt"></i>
                        <span data-i18n="dashboard">Tableau de bord</span>
                    </button>
                    <button class="nav-btn" onclick="showSection('inscription-comptable')">
                        <i class="fas fa-pen-fancy"></i>
                        <span data-i18n="addStudent">Inscription</span>
                    </button>
                    <button class="nav-btn" onclick="showSection('travailleurs')">
                        <i class="fas fa-users"></i>
                        <span data-i18n="workers">Gestion Travailleurs</span>
                    </button>
                    <button class="nav-btn" onclick="showSection('payroll')">
                        <i class="fas fa-money-check-alt"></i>
                        <span data-i18n="payroll">Générer Payroll</span>
                    </button>
                    <button class="nav-btn" onclick="showSection('student-fees')">
                        <i class="fas fa-user-graduate"></i>
                        <span data-i18n="payments">Paiements</span>
                    </button>
                    <button class="nav-btn" onclick="showSection('students')">
                        <i class="fas fa-child"></i>
                        <span data-i18n="students">Élèves</span>
                    </button>
                    <button class="nav-btn" onclick="showSection('reports')">
                        <i class="fas fa-file-contract"></i>
                        <span>Rapports Financiers</span>
                    </button>
                    <button class="nav-btn" onclick="showSection('settings')">
                        <i class="fas fa-cog"></i>
                        <span>Paramètres</span>
                    </button>
                </div>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Section -->
        <section id="dashboard" class="section active">
            <div class="dashboard-hero">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h1 class="display-4 fw-bold mb-3">Tableau de Bord Financier</h1>
                        <p class="lead mb-4">Gestion conforme aux lois financières du Rwanda</p>
                        <div class="d-flex gap-3 flex-wrap">
                            <div class="bg-white px-3 py-2 rounded-pill shadow-sm">
                                <i class="fas fa-calendar me-2 text-primary"></i>
                                <span id="currentDate">Chargement...</span>
                            </div>
                            <div class="bg-white px-3 py-2 rounded-pill shadow-sm">
                                <i class="fas fa-clock me-2 text-primary"></i>
                                <span id="currentTime">--:--</span>
                            </div>
                            <div class="bg-white px-3 py-2 rounded-pill shadow-sm">
                                <i class="fas fa-money-bill-wave me-2 text-primary"></i>
                                <span id="currencyDisplay">Devise: RWF (Franc Rwandais)</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="legal-badge mb-2">
                            <i class="fas fa-gavel"></i>
                            Loi N° 123/2020
                        </div>
                        <small class="text-muted">Exercice: 2024-2025</small>
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon stat-icon-primary">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3 class="stat-value" id="totalTravailleurs">0</h3>
                    <p class="text-muted mb-0">Total Travailleurs</p>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon stat-icon-danger">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <h3 class="stat-value" id="monthlyPayroll">0 RWF</h3>
                    <p class="text-muted mb-0">Payroll du Mois</p>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon stat-icon-warning">
                        <i class="fas fa-university"></i>
                    </div>
                    <h3 class="stat-value" id="bankPayments">0</h3>
                    <p class="text-muted mb-0">Paiements Banque</p>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon stat-icon-info">
                        <i class="fas fa-user-graduate"></i>
                    </div>
                    <h3 class="stat-value" id="studentPayments">0</h3>
                    <p class="text-muted mb-0">Paiements Élèves</p>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-md-8">
                    <div class="chart-container">
                        <h5 class="fw-bold mb-3">
                            <i class="fas fa-chart-bar me-2 icon-text-primary"></i>
                            Statistiques Payroll Réelles
                        </h5>
                        <canvas id="realPayrollChart" height="250"></canvas>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card h-100">
                        <h5 class="fw-bold mb-3">
                            <i class="fas fa-bullhorn me-2 icon-text-primary"></i>
                            Annonces Directeur/Secrétaire
                        </h5>
                        <div class="list-group list-group-flush" id="filteredAnnouncementsList">
                            <div class="list-group-item border-0 px-0 py-2">
                                <small class="text-muted">Chargement...</small>
                                <p class="mb-0">Chargement des annonces...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Inscription Section -->
        <section id="inscription-comptable" class="section">
            <div style="max-width: 1100px; margin: 0 auto;">
                <h2 class="fw-bold mb-4">
                    <i class="fas fa-pen-fancy me-3" style="color: var(--primary);"></i>
                    Formulaire d'Inscription Scolaire - EDEN FAMILY SCHOOL
                </h2>
                
                <div style="background: white; border-radius: var(--border-radius); padding: 3rem 2rem; box-shadow: var(--box-shadow);">
                    <!-- En-tête -->
                    <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; padding: 2rem; border-radius: 12px; text-align: center; margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 0.5rem; font-size: 1.6em;">FORMULAIRE D'INSCRIPTION SCOLAIRE</h3>
                        <p style="margin-bottom: 0.3rem;">MATERNELLE (N1, N2, N3) ET PRIMAIRE (P1, P2, P3, P4, P5)</p>
                        <p style="margin: 0; font-size: 0.95em;">BRANCHE DE KACYIRU, GISOZI, KIMISAGARA</p>
                    </div>

                    <form id="inscriptionFormComptable">
                        <!-- Section 1: Information de l'enfant -->
                        <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; padding: 1.2rem; margin: 2rem 0 1.5rem 0; border-radius: 8px; font-weight: bold; font-size: 1.1em;">
                            <i class="fas fa-child me-2"></i>INFORMATION DE L'ENFANT
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold mb-2">Nom et prénom *</label>
                                <input type="text" id="nomPrenomComp" name="nomPrenom" class="form-control-modern" required style="border: 2px solid #ddd; padding: 0.8rem; border-radius: 8px; transition: all 0.3s ease;">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold mb-2">Date de naissance *</label>
                                <input type="date" id="dateNaissanceComp" name="dateNaissance" class="form-control-modern" required style="border: 2px solid #ddd; padding: 0.8rem; border-radius: 8px; transition: all 0.3s ease;">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold mb-2">École de provenance *</label>
                                <input type="text" id="ecoleProvenanceComp" name="ecoleProvenance" class="form-control-modern" required style="border: 2px solid #ddd; padding: 0.8rem; border-radius: 8px; transition: all 0.3s ease;">
                            </div>
                        </div>

                        <!-- Sexe -->
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold mb-2">Sexe *</label>
                                <div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" id="garconComp" name="sexe" value="GARÇON" required>
                                        <label class="form-check-label" for="garconComp"><i class="fas fa-male me-1"></i> GARÇON</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" id="filleComp" name="sexe" value="FILLE" required>
                                        <label class="form-check-label" for="filleComp"><i class="fas fa-female me-1"></i> FILLE</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Section 2: Niveau Scolaire -->
                        <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; padding: 1.2rem; margin: 2rem 0 1.5rem 0; border-radius: 8px; font-weight: bold; font-size: 1.1em;">
                            <i class="fas fa-graduation-cap me-2"></i>NIVEAU SCOLAIRE
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold mb-2">Section *</label>
                                <div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" id="materuelleComp" name="section" value="MATERNELLE" required onchange="updateSectionComp()">
                                        <label class="form-check-label" for="materuelleComp"><i class="fas fa-baby me-1"></i> MATERNELLE</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" id="primaireComp" name="section" value="PRIMAIRE" required onchange="updateSectionComp()">
                                        <label class="form-check-label" for="primaireComp"><i class="fas fa-child me-1"></i> PRIMAIRE</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3" id="niveauMaternelleGroupComp" style="display: none;">
                                <label class="form-label fw-bold mb-2">Niveau maternelle *</label>
                                <select id="niveauMaternelleComp" name="niveauMaternelle" class="form-control-modern" style="border: 2px solid #ddd; padding: 0.8rem; border-radius: 8px;">
                                    <option value="">Sélectionnez</option>
                                    <option value="N1">N1</option>
                                    <option value="N2">N2</option>
                                    <option value="N3">N3</option>
                                </select>
                            </div>
                            
                            <div class="col-md-4 mb-3" id="niveauPrimaireGroupComp" style="display: none;">
                                <label class="form-label fw-bold mb-2">Niveau primaire *</label>
                                <select id="niveauPrimaireComp" name="niveauPrimaire" class="form-control-modern" style="border: 2px solid #ddd; padding: 0.8rem; border-radius: 8px;">
                                    <option value="">Sélectionnez</option>
                                    <option value="P1">P1</option>
                                    <option value="P2">P2</option>
                                    <option value="P3">P3</option>
                                    <option value="P4">P4</option>
                                    <option value="P5">P5</option>
                                </select>
                            </div>
                            
                            <div class="col-md-4 mb-3" id="sdmsGroupComp" style="display: none;">
                                <label class="form-label fw-bold mb-2">SDMS Code *</label>
                                <input type="text" id="sdmsCodeComp" name="sdmsCode" class="form-control-modern" placeholder="Code SDMS" style="border: 2px solid #ddd; padding: 0.8rem; border-radius: 8px;">
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold mb-2">Classe affectée</label>
                                <select id="classeAffecteeComp" name="classeAffectee" class="form-control-modern" style="border: 2px solid #ddd; padding: 0.8rem; border-radius: 8px;">
                                    <option value="">À déterminer</option>
                                    <option value="N1">N1 - Maternelle 1</option>
                                    <option value="N2">N2 - Maternelle 2</option>
                                    <option value="N3">N3 - Maternelle 3</option>
                                    <option value="P1">P1 - Primaire 1</option>
                                    <option value="P2">P2 - Primaire 2</option>
                                    <option value="P3">P3 - Primaire 3</option>
                                    <option value="P4">P4 - Primaire 4</option>
                                    <option value="P5">P5 - Primaire 5</option>
                                </select>
                            </div>
                        </div>

                        <!-- Section 3: Branche -->
                        <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; padding: 1.2rem; margin: 2rem 0 1.5rem 0; border-radius: 8px; font-weight: bold; font-size: 1.1em;">
                            <i class="fas fa-map-marker-alt me-2"></i>BRANCHE
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold mb-2">Sélectionnez la branche *</label>
                            <div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" id="brancheKacyiruComp" name="branche" value="KACYIRU" required onchange="updateContactInfoComp()">
                                    <label class="form-check-label" for="brancheKacyiruComp"><i class="fas fa-school me-1" style="color: #9C27B0;"></i> KACYIRU</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" id="brancheGisoziComp" name="branche" value="GISOZI" required onchange="updateContactInfoComp()">
                                    <label class="form-check-label" for="brancheGisoziComp"><i class="fas fa-school me-1" style="color: #2196F3;"></i> GISOZI</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" id="brancheKimisagaraComp" name="branche" value="KIMISAGARA" required onchange="updateContactInfoComp()">
                                    <label class="form-check-label" for="brancheKimisagaraComp"><i class="fas fa-school me-1" style="color: #4CAF50;"></i> KIMISAGARA</label>
                                </div>
                            </div>
                        </div>

                        <!-- Contact Info -->
                        <div id="contactInfoComp" style="background: linear-gradient(135deg, rgba(46, 139, 87, 0.15), rgba(30, 107, 78, 0.15)); padding: 1.5rem; border-radius: 10px; margin: 2rem 0; border-left: 5px solid var(--primary); text-align: center; display: none;">
                            <p id="contactTextComp" style="margin: 0;"></p>
                        </div>

                        <!-- Section 4: Transport -->
                        <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; padding: 1.2rem; margin: 2rem 0 1.5rem 0; border-radius: 8px; font-weight: bold; font-size: 1.1em;">
                            <i class="fas fa-bus me-2"></i>TRANSPORT
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold mb-2">Transport bus *</label>
                            <div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" id="transportOuiComp" name="transport" value="OUI" required>
                                    <label class="form-check-label" for="transportOuiComp"><i class="fas fa-check-circle me-1"></i> OUI</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" id="transportNonComp" name="transport" value="NON" required>
                                    <label class="form-check-label" for="transportNonComp"><i class="fas fa-times-circle me-1"></i> NON</label>
                                </div>
                            </div>
                        </div>

                        <!-- Section 5: Chef de Famille -->
                        <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; padding: 1.2rem; margin: 2rem 0 1.5rem 0; border-radius: 8px; font-weight: bold; font-size: 1.1em;">
                            <i class="fas fa-user-tie me-2"></i>CHEF DE FAMILLE
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold mb-2">Nom et prénom *</label>
                                <input type="text" id="chefNomPrenomComp" name="chefNomPrenom" class="form-control-modern" required style="border: 2px solid #ddd; padding: 0.8rem; border-radius: 8px;">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold mb-2">Téléphone *</label>
                                <input type="tel" id="chefTelephoneComp" name="chefTelephone" pattern="[0-9]{10}" class="form-control-modern" required style="border: 2px solid #ddd; padding: 0.8rem; border-radius: 8px;">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold mb-2">Pièce d'identité *</label>
                                <input type="text" id="chefPieceIdentiteComp" name="chefPieceIdentite" class="form-control-modern" required style="border: 2px solid #ddd; padding: 0.8rem; border-radius: 8px;">
                            </div>
                        </div>

                        <!-- Section 6: Conjoint (Optionnel) -->
                        <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%)); color: white; padding: 1.2rem; margin: 2rem 0 1.5rem 0; border-radius: 8px; font-weight: bold; font-size: 1.1em;">
                            <i class="fas fa-users me-2"></i>CONJOINT(E) (Optionnel)
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold mb-2">Nom et prénom</label>
                                <input type="text" id="conjointNomPrenomComp" name="conjointNomPrenom" class="form-control-modern" style="border: 2px solid #ddd; padding: 0.8rem; border-radius: 8px;">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold mb-2">Téléphone</label>
                                <input type="tel" id="conjointTelephoneComp" name="conjointTelephone" pattern="[0-9]{10}" class="form-control-modern" style="border: 2px solid #ddd; padding: 0.8rem; border-radius: 8px;">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold mb-2">Pièce d'identité</label>
                                <input type="text" id="conjointPieceIdentiteComp" name="conjointPieceIdentite" class="form-control-modern" style="border: 2px solid #ddd; padding: 0.8rem; border-radius: 8px;">
                            </div>
                        </div>

                        <!-- Section 7: Adresse -->
                        <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%)); color: white; padding: 1.2rem; margin: 2rem 0 1.5rem 0; border-radius: 8px; font-weight: bold; font-size: 1.1em;">
                            <i class="fas fa-address-book me-2"></i>ADRESSE
                        </div>
                        
                        <div class="row">
                            <div class="col-md-2 mb-3">
                                <label class="form-label fw-bold mb-2">Ville *</label>
                                <select id="villeComp" name="ville" class="form-control-modern" required style="border: 2px solid #ddd; padding: 0.8rem; border-radius: 8px;">
                                    <option value="">Sélectionnez</option>
                                    <option value="Kigali">Kigali</option>
                                    <option value="Butare">Butare</option>
                                    <option value="Gisenyi">Gisenyi</option>
                                    <option value="Ruhengeri">Ruhengeri</option>
                                    <option value="Gitarama">Gitarama</option>
                                    <option value="Kibungo">Kibungo</option>
                                </select>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label fw-bold mb-2">Secteur *</label>
                                <input type="text" id="secteurComp" name="secteur" class="form-control-modern" required style="border: 2px solid #ddd; padding: 0.8rem; border-radius: 8px;">
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label fw-bold mb-2">Umurenge *</label>
                                <input type="text" id="umurengeComp" name="umurenge" class="form-control-modern" required style="border: 2px solid #ddd; padding: 0.8rem; border-radius: 8px;">
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label fw-bold mb-2">Akagari *</label>
                                <input type="text" id="akagariComp" name="akagari" class="form-control-modern" required style="border: 2px solid #ddd; padding: 0.8rem; border-radius: 8px;">
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label fw-bold mb-2">Umudugudu *</label>
                                <input type="text" id="umuduguduComp" name="umudugudu" class="form-control-modern" required style="border: 2px solid #ddd; padding: 0.8rem; border-radius: 8px;">
                            </div>
                        </div>

                        <!-- Boutons -->
                        <div class="text-center mt-5">
                            <button type="button" class="btn-modern btn-primary-modern btn-lg me-2" onclick="submitComptableInscription()" id="submitBtnComp">
                                <i class="fas fa-paper-plane me-2"></i> Soumettre l'inscription
                            </button>
                            <button type="button" class="btn-modern btn-lg" style="background-color: #6c757d; color: white;" onclick="resetFormComp()">
                                <i class="fas fa-redo me-2"></i> Réinitialiser
                            </button>
                        </div>
                    </form>

                    <!-- Message d'erreur -->
                    <div id="missingFieldMessageComp" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #DC143C; color: white; padding: 2rem; border-radius: 15px; z-index: 1000; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: none;">
                        <h3 id="errorTitleComp">Champ obligatoire manquant !</h3>
                        <p id="errorMessageComp">Veuillez remplir tous les champs obligatoires.</p>
                        <button class="btn-modern btn-primary-modern" onclick="hideErrorMessageComp()" style="margin-top: 1rem;">
                            <i class="fas fa-check me-2"></i> J'ai compris !
                        </button>
                    </div>

                    <!-- Message de succès -->
                    <div id="successMessageComp" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 1000;">
                        <div style="background: white; padding: 3rem; border-radius: 15px; text-align: center; max-width: 500px;">
                            <div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; font-size: 3em; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">✓</div>
                            <h3>Inscription enregistrée avec succès!</h3>
                            <p>Code unique de l'enfant: <strong id="studentCodeComp"></strong></p>
                            <p>Les données ont été enregistrées dans notre base de données.</p>
                            <button class="btn-modern btn-primary-modern" onclick="closeSuccessMessageComp()">
                                <i class="fas fa-times me-2"></i> Fermer
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Workers Management Section -->
        <section id="travailleurs" class="section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold">
                    <i class="fas fa-users me-3 icon-text-primary"></i>
                    Gestion des Travailleurs
                </h2>
                <div class="d-flex gap-2">
                    <div class="btn-group">
                        <button class="btn-modern" onclick="filterWorkers('all')">
                            Tous
                        </button>
                        <button class="btn-modern" onclick="filterWorkers('enseignant')">
                            Enseignants
                        </button>
                        <button class="btn-modern" onclick="filterWorkers('staff')">
                            Staff
                        </button>
                        <button class="btn-modern" onclick="filterWorkers('other')">
                            Autres
                        </button>
                    </div>
                    <button class="btn-modern btn-primary-modern" onclick="showWorkerModal()">
                        <i class="fas fa-plus me-2"></i> Ajouter Travailleur
                    </button>
                    <button class="btn-modern btn-debt-modal" onclick="showDebtModal()">
                        <i class="fas fa-money-bill-wave me-2"></i> Ajouter Dette
                    </button>
                </div>
            </div>

            <!-- Tableau des travailleurs -->
            <div class="stat-card">
                <div class="table-responsive">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>NO</th>
                                <th>NOM COMPLET</th>
                                <th>TYPE</th>
                                <th>TELEPHONE</th>
                                <th>MODE PAIEMENT</th>
                                <th>SALAIRE BASE</th>
                                <th>DETTES</th>
                                <th>STATUT</th>
                                <th>ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody id="workersTable">
                            <!-- Travailleurs chargés ici -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Payroll Generation Section -->
        <section id="payroll" class="section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold">
                    <i class="fas fa-money-check-alt me-3 icon-text-primary"></i>
                    Génération de Payroll
                </h2>
                <div class="d-flex gap-2">
                    <button class="btn-modern btn-payroll-success" onclick="generateMonthlyPayroll()">
                        <i class="fas fa-calculator me-2"></i> Générer Payroll
                    </button>
                    <button class="btn-modern btn-primary-modern" onclick="exportPayrollExcel()">
                        <i class="fas fa-file-excel me-2"></i> Exporter Excel
                    </button>
                    <button class="btn-modern btn-payroll-danger" onclick="exportPayrollPDF()">
                        <i class="fas fa-file-pdf me-2"></i> Exporter PDF
                    </button>
                    <button class="btn-modern btn-payroll-history" onclick="showPayrollHistory()">
                        <i class="fas fa-history me-2"></i> Historique
                    </button>
                </div>
            </div>

            <!-- Filters -->
            <div class="stat-card mb-4">
                <h5 class="fw-bold mb-3">
                    <i class="fas fa-filter me-2 icon-text-primary"></i>
                    Filtres de Payroll
                </h5>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Mois</label>
                        <select class="form-control-modern" id="payrollMonth" onchange="updateCurrentPeriod()">
                            <option value="1">Janvier</option>
                            <option value="2">Février</option>
                            <option value="3">Mars</option>
                            <option value="4">Avril</option>
                            <option value="5">Mai</option>
                            <option value="6">Juin</option>
                            <option value="7">Juillet</option>
                            <option value="8">Août</option>
                            <option value="9">Septembre</option>
                            <option value="10">Octobre</option>
                            <option value="11">Novembre</option>
                            <option value="12">Décembre</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Année</label>
                        <select class="form-control-modern" id="payrollYear" onchange="updateCurrentPeriod()">
                            <option value="2025">2025</option>
                            <option value="2026" selected>2026</option>
                            <option value="2027">2027</option>
                            <option value="2028">2028</option>
                            <option value="2029">2029</option>
                            <option value="2030">2030</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Mode Paiement</label>
                        <select class="form-control-modern" id="filterPaymentMode" onchange="filterPayroll()">
                            <option value="all">Tous les modes</option>
                            <option value="bank">Banque</option>
                            <option value="momo">Mobile Money</option>
                            <option value="cash">Espèces</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Statut</label>
                        <select class="form-control-modern" id="filterStatus" onchange="filterPayroll()">
                            <option value="all">Tous les statuts</option>
                            <option value="pending">En attente</option>
                            <option value="paid">Payé</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Dettes en cours -->
            <div class="stat-card mb-4">
                <h5 class="fw-bold mb-3">
                    <i class="fas fa-money-bill-wave me-2 icon-text-primary"></i>
                    Dettes en Cours pour ce Mois
                </h5>
                <div class="table-responsive">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Type</th>
                                <th>Montant Dette</th>
                                <th>Date</th>
                                <th>Motif</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="currentMonthDebtsTable">
                            <!-- Dettes du mois chargées depuis Firebase -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Payroll Table -->
            <div class="stat-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold mb-0">
                        PAYROLL - <span id="currentPeriod">Janvier 2026</span>
                    </h5>
                    <div class="text-end">
                        <h5 class="fw-bold text-primary" id="totalPayrollAmount">Total: 0 RWF</h5>
                        <small class="text-muted">Préparé par <span id="preparedBy">Utilisateur</span></small>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>NO</th>
                                <th>NOM COMPLET</th>
                                <th>TYPE</th>
                                <th>TELEPHONE</th>
                                <th>MODE PAIEMENT</th>
                                <th>SALAIRE BASE</th>
                                <th>DETTES</th>
                                <th>STATUT</th>
                                <th>ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody id="payrollTable">
                            <!-- Payroll data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Historique des Payrolls -->
            <div class="stat-card mt-4 payroll-history-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold mb-0">
                        <i class="fas fa-history me-2 icon-text-primary"></i>
                        Historique des Payrolls
                    </h5>
                    <button class="btn btn-sm btn-danger" onclick="hidePayrollHistory()">
                        <i class="fas fa-times me-1"></i> Fermer
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>Mois/Année</th>
                                <th>Nombre Travailleurs</th>
                                <th>Total Payroll</th>
                                <th>Statut</th>
                                <th>Généré par</th>
                                <th>Date Génération</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="payrollHistoryTable">
                            <!-- Historique des payrolls -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Student Fees Section -->
        <section id="student-fees" class="section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold">
                    <i class="fas fa-user-graduate me-3 icon-text-primary"></i>
                    Paiements des Élèves
                </h2>
                <div class="d-flex gap-2 align-items-center">
                    <!-- Filtres -->
                    <select class="form-control-modern filter-select-width" id="filterClass" onchange="filterStudentPayments()">
                        <option value="">Toutes classes</option>
                        <optgroup label="NURSERY">
                            <option value="N1A">N1A (Nursery 1A)</option>
                            <option value="N1B">N1B (Nursery 1B)</option>
                            <option value="N1C">N1C (Nursery 1C)</option>
                            <option value="N2A">N2A (Nursery 2A)</option>
                            <option value="N2B">N2B (Nursery 2B)</option>
                            <option value="N2C">N2C (Nursery 2C)</option>
                            <option value="N3A">N3A (Nursery 3A)</option>
                            <option value="N3B">N3B (Nursery 3B)</option>
                            <option value="N3C">N3C (Nursery 3C)</option>
                        </optgroup>
                        <optgroup label="PRIMAIRE">
                            <option value="P1A">P1A</option>
                            <option value="P1B">P1B</option>
                            <option value="P1C">P1C</option>
                            <option value="P2A">P2A</option>
                            <option value="P2B">P2B</option>
                            <option value="P2C">P2C</option>
                            <option value="P3A">P3A</option>
                            <option value="P3B">P3B</option>
                            <option value="P3C">P3C</option>
                            <option value="P4A">P4A</option>
                            <option value="P4B">P4B</option>
                            <option value="P4C">P4C</option>
                            <option value="P5A">P5A</option>
                            <option value="P5B">P5B</option>
                            <option value="P5C">P5C</option>
                            <option value="P6A">P6A</option>
                            <option value="P6B">P6B</option>
                            <option value="P6C">P6C</option>
                        </optgroup>
                    </select>
                    <input type="month" class="form-control-modern filter-month-width" id="filterMonth" onchange="filterStudentPayments()">
                    <button class="btn-modern btn-primary-modern" onclick="showStudentFeeModal()">
                        <i class="fas fa-plus me-2"></i> Nouveau Paiement
                    </button>
                    <button class="btn-modern btn-student-fees-success" onclick="exportStudentFeesExcel()">
                        <i class="fas fa-file-excel me-2"></i> Exporter Excel
                    </button>
                    <button class="btn-modern btn-student-fees-danger" onclick="exportStudentFeesPDF()">
                        <i class="fas fa-file-pdf me-2"></i> Exporter PDF
                    </button>
                </div>
            </div>

            <div class="stat-card">
                <div class="table-responsive">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>NO</th>
                                <th>RÉFÉRENCE</th>
                                <th>NOM ÉLÈVE</th>
                                <th>CLASSE</th>
                                <th>TYPE</th>
                                <th>MONTANT/FRW</th>
                                <th>DATE</th>
                                <th>MODE PAIEMENT</th>
                                <th>SOLDE RESTANT</th>
                                <th>REÇU PAR</th>
                                <th>ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody id="studentFeesTable">
                            <!-- Données élèves seront chargées ici -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Students Section -->
        <section id="students" class="section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold">
                    <i class="fas fa-child me-3 icon-text-primary"></i>
                    Gestion des Élèves
                </h2>
                <div class="d-flex gap-2">
                    <div class="input-group search-input-width">
                        <input type="text" class="form-control-modern" id="searchStudent" placeholder="Rechercher un élève...">
                        <button class="btn-modern" onclick="searchStudent()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <button class="btn-modern btn-student-search" onclick="loadStudentsFromDatabase()">
                        <i class="fas fa-sync me-2"></i> Actualiser
                    </button>
                    <button class="btn-modern btn-primary-modern" onclick="showStudentModal()">
                        <i class="fas fa-plus me-2"></i> Ajouter Élève
                    </button>
                    <!-- Import buttons -->
                    <input type="file" id="importExcelInput" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleImportExcel(event)">
                    <button class="btn-modern btn-outline-primary" onclick="document.getElementById('importExcelInput').click()">
                        <i class="fas fa-file-excel me-2"></i> Importer Excel
                    </button>
                    <input type="file" id="importPdfInput" accept=".pdf" style="display:none" onchange="handleImportPdf(event)">
                    <button class="btn-modern btn-outline-secondary" onclick="document.getElementById('importPdfInput').click()">
                        <i class="fas fa-file-pdf me-2"></i> Importer PDF
                    </button>
                </div>
            </div>

            <!-- Profil élève -->
            <div class="stat-card mb-4 student-profile-section">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="student-avatar mb-3">
                                <i class="fas fa-user-graduate fa-3x"></i>
                            </div>
                            <h5 id="studentNameProfile"></h5>
                            <p id="studentClassProfile"></p>
                            <p id="studentAgeProfile"></p>
                            <p id="studentReferenceProfile" class="fw-bold"></p>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-bold mb-0">Historique des Paiements</h6>
                            <button class="btn btn-sm btn-primary" onclick="addPaymentForCurrentStudent()">
                                <i class="fas fa-money-bill-wave me-1"></i> Ajouter Paiement
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="modern-table">
                                <thead>
                                    <tr>
                                        <th>Référence</th>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th>Montant</th>
                                        <th>Mode</th>
                                        <th>Reçu par</th>
                                    </tr>
                                </thead>
                                <tbody id="studentPaymentsHistory">
                                    <!-- Historique chargé depuis Firebase -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-3 row">
                            <div class="col-md-6">
                                <h6>Total Payé: <span id="totalPaid" class="text-success fw-bold">0 RWF</span></h6>
                                <h6>Solde Restant: <span id="remainingBalance" class="text-danger fw-bold">0 RWF</span></h6>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-sm btn-info" onclick="updateStudentReference()">
                                    <i class="fas fa-qrcode me-1"></i> Générer Référence
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Liste des élèves -->
            <div class="stat-card">
                <div class="table-responsive">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>NO</th>
                                <th>RÉFÉRENCE</th>
                                <th>NOM COMPLET</th>
                                <th>CLASSE</th>
                                <th>DATE NAISSANCE</th>
                                <th>TOTAL PAYÉ</th>
                                <th>ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTable">
                            <!-- Élèves chargés depuis Firebase -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Reports Section -->
        <section id="reports" class="section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold">
                    <i class="fas fa-file-contract me-3 icon-text-primary"></i>
                    Rapports Financiers
                </h2>
                <div class="d-flex gap-2">
                    <div class="btn-group">
                        <button class="btn-modern btn-primary-modern" onclick="showDailyReport()">
                            <i class="fas fa-calendar-day me-2"></i> Journalier
                        </button>
                        <button class="btn-modern btn-report-success" onclick="showWeeklyReport()">
                            <i class="fas fa-calendar-week me-2"></i> Hebdomadaire
                        </button>
                        <button class="btn-modern btn-report-info" onclick="showMonthlyReport()">
                            <i class="fas fa-calendar-alt me-2"></i> Mensuel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Rapport Journalier -->
            <div class="stat-card" id="dailyReportSection">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold mb-0">
                        <i class="fas fa-calendar-day me-2 icon-text-primary"></i>
                        Rapport Financier Journalier
                    </h5>
                    <div class="d-flex gap-2">
                        <label class="form-label fw-bold">Date:</label>
                        <input type="date" class="form-control form-control-sm d-inline-block w-auto" id="dailyReportDate" value="<?php echo date('Y-m-d'); ?>" onchange="loadDailyReport()">
                    </div>
                </div>

                <!-- Résumé du jour -->
                <div class="report-summary-cards" id="daySummary">
                    <!-- Les cartes de résumé seront ajoutées ici dynamiquement -->
                </div>

                <div class="table-responsive">
                    <table class="modern-table financial-table">
                        <thead>
                            <tr>
                                <th rowspan="2">Solde d'Ouverture</th>
                                <th colspan="5" class="text-center">INCOME</th>
                                <th colspan="2" class="text-center">EXPENSES</th>
                                <th rowspan="2">Total Expenses</th>
                                <th rowspan="2">Solde Final</th>
                                <th rowspan="2">Différence</th>
                            </tr>
                            <tr>
                                <th>Minerval</th>
                                <th>Transport</th>
                                <th>Coaching</th>
                                <th>Uniforme</th>
                                <th>Autres</th>
                                <th>Justification</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody id="dailyReportBody">
                            <!-- Données calculées automatiquement -->
                        </tbody>
                    </table>
                </div>

                <!-- Formulaire pour ajouter des dépenses -->
                <div class="report-form-section">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-plus-circle me-2 text-primary"></i>
                        Ajouter une Dépense
                    </h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Justification de la dépense *</label>
                            <select class="form-control-modern" id="expenseCategory">
                                <option value="">Sélectionnez une catégorie</option>
                                <option value="Salaires">Salaires du personnel</option>
                                <option value="Loyer">Loyer</option>
                                <option value="Electricité">Électricité</option>
                                <option value="Eau">Eau</option>
                                <option value="Internet">Internet</option>
                                <option value="Nourriture">Nourriture</option>
                                <option value="Transport">Transport</option>
                                <option value="Fournitures">Fournitures de bureau</option>
                                <option value="Materiel">Matériel pédagogique</option>
                                <option value="Maintenance">Maintenance</option>
                                <option value="Autre">Autre dépense</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Montant (RWF) *</label>
                            <input type="number" class="form-control-modern" id="expenseAmount" placeholder="Montant">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn-modern btn-primary-modern w-100" onclick="addDailyExpense()">
                                <i class="fas fa-plus me-2"></i> Ajouter
                            </button>
                        </div>
                    </div>
                    
                    <!-- Liste des dépenses ajoutées -->
                    <div class="mt-3" id="expensesList">
                        <!-- Les dépenses seront ajoutées ici dynamiquement -->
                    </div>
                </div>

                <!-- Actions du rapport -->
                <div class="report-form-section">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-file-alt me-2 text-primary"></i>
                        Actions du Rapport
                    </h6>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Préparé par *</label>
                            <input type="text" class="form-control-modern" id="reportPreparedBy" value="Utilisateur" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Date du rapport *</label>
                            <input type="date" class="form-control-modern" id="reportDate" value="<?php echo date('Y-m-d'); ?>">
                        </div>
                        
                        <div class="col-md-12">
                            <label class="form-label">Observations générales</label>
                            <textarea class="form-control-modern" id="generalObservations" rows="2" placeholder="Observations sur la journée..."></textarea>
                        </div>
                        
                        <div class="col-md-12 mt-3">
                            <div class="d-grid gap-2">
                                <button class="btn-modern btn-primary-modern" onclick="saveDailyReport()">
                                    <i class="fas fa-save me-2"></i> Enregistrer Rapport
                                </button>
                                <button class="btn-modern btn-report-daily-button" onclick="exportDailyReportExcel()">
                                    <i class="fas fa-file-excel me-2"></i> Exporter Excel
                                </button>
                                <button class="btn-modern btn-report-daily-danger" onclick="exportDailyReportPDF()">
                                    <i class="fas fa-file-pdf me-2"></i> Exporter PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rapport Hebdomadaire -->
            <div class="stat-card mt-4 weekly-report-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold mb-0">
                        <i class="fas fa-calendar-week me-2 icon-text-primary"></i>
                        Rapport Financier Hebdomadaire
                    </h5>
                    <div class="d-flex gap-2">
                        <label class="form-label fw-bold">Semaine:</label>
                        <input type="week" class="form-control form-control-sm d-inline-block w-auto" id="weeklyReportDate" onchange="loadWeeklyReport()">
                    </div>
                </div>

                <div class="chart-container mb-4">
                    <canvas id="weeklyChart" height="150"></canvas>
                </div>

                <div class="table-responsive">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>Jour</th>
                                <th>Solde Ouverture</th>
                                <th>Total Income</th>
                                <th>Total Expenses</th>
                                <th>Solde Final</th>
                                <th>Différence</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="weeklyReportTable">
                            <!-- Données hebdomadaires -->
                        </tbody>
                    </table>
                </div>

                <div class="report-form-section">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-file-alt me-2 text-primary"></i>
                        Actions du Rapport Hebdomadaire
                    </h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Préparé par *</label>
                            <input type="text" class="form-control-modern" id="weeklyReportPreparedBy" value="Utilisateur" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Période *</label>
                            <input type="text" class="form-control-modern" id="weeklyPeriod" readonly>
                        </div>
                        
                        <div class="col-md-12">
                            <label class="form-label">Résumé de la semaine</label>
                            <textarea class="form-control-modern" id="weeklySummary" rows="3" placeholder="Résumé des activités et observations de la semaine..."></textarea>
                        </div>
                        
                        <div class="col-md-12 mt-3">
                            <div class="d-grid gap-2">
                                <button class="btn-modern btn-primary-modern" onclick="generateWeeklyReport()">
                                    <i class="fas fa-calculator me-2"></i> Générer Rapport Hebdomadaire
                                </button>
                                <button class="btn-modern btn-weekly-report-button" onclick="exportWeeklyReportExcel()">
                                    <i class="fas fa-file-excel me-2"></i> Exporter Excel
                                </button>
                                <button class="btn-modern btn-weekly-report-danger" onclick="exportWeeklyReportPDF()">
                                    <i class="fas fa-file-pdf me-2"></i> Exporter PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rapport Mensuel -->
            <div class="stat-card mt-4 monthly-report-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold mb-0">
                        <i class="fas fa-calendar-alt me-2 icon-text-primary"></i>
                        Rapport Financier Mensuel
                    </h5>
                    <div class="d-flex gap-2">
                        <label class="form-label fw-bold">Mois:</label>
                        <input type="month" class="form-control form-control-sm d-inline-block w-auto" id="monthlyReportDate" onchange="loadMonthlyReport()">
                    </div>
                </div>

                <div class="chart-container mb-4">
                    <canvas id="monthlyChart" height="150"></canvas>
                </div>

                <div class="table-responsive">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>Semaine</th>
                                <th>Total Income</th>
                                <th>Total Expenses</th>
                                <th>Solde Final</th>
                                <th>Différence</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="monthlyReportTable">
                            <!-- Données mensuelles -->
                        </tbody>
                    </table>
                </div>

                <div class="report-form-section">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-file-alt me-2 text-primary"></i>
                        Actions du Rapport Mensuel
                    </h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Préparé par *</label>
                            <input type="text" class="form-control-modern" id="monthlyReportPreparedBy" value="Utilisateur" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Mois/Année *</label>
                            <input type="text" class="form-control-modern" id="monthlyPeriod" readonly>
                        </div>
                        
                        <div class="col-md-12">
                            <label class="form-label">Analyse mensuelle</label>
                            <textarea class="form-control-modern" id="monthlyAnalysis" rows="3" placeholder="Analyse des performances financières du mois..."></textarea>
                        </div>
                        
                        <div class="col-md-12 mt-3">
                            <div class="d-grid gap-2">
                                <button class="btn-modern btn-primary-modern" onclick="generateMonthlyReport()">
                                    <i class="fas fa-calculator me-2"></i> Générer Rapport Mensuel
                                </button>
                                <button class="btn-modern btn-monthly-report-button" onclick="exportMonthlyReportExcel()">
                                    <i class="fas fa-file-excel me-2"></i> Exporter Excel
                                </button>
                                <button class="btn-modern btn-monthly-report-danger" onclick="exportMonthlyReportPDF()">
                                    <i class="fas fa-file-pdf me-2"></i> Exporter PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historique des Rapports -->
            <div class="stat-card mt-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold mb-0">
                        <i class="fas fa-history me-2 icon-text-primary"></i>
                        Historique des Rapports
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadReportHistory()">
                        <i class="fas fa-sync me-1"></i> Actualiser
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Période</th>
                                <th>Total Income</th>
                                <th>Total Expenses</th>
                                <th>Différence</th>
                                <th>Généré par</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reportHistoryTable">
                            <!-- Historique des rapports -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Settings Section -->
        <section id="settings" class="section">
            <div class="mb-4">
                <h2 class="fw-bold mb-2">
                    <i class="fas fa-cog me-3 icon-text-primary"></i>
                    Paramètres du Système
                </h2>
                <p class="text-muted">Configuration et préférences du système</p>
            </div>

            <div class="row g-4">
                <!-- Account Settings -->
                <div class="col-md-6">
                    <div class="stat-card">
                        <h5 class="fw-bold mb-3">
                            <i class="fas fa-user-cog me-2 icon-text-primary"></i>
                            Informations Comptable
                        </h5>
                        <div class="mb-3">
                            <label class="form-label">Nom Complet</label>
                            <input type="text" class="form-control-modern" id="accountantName" value="Utilisateur">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Titre/Poste</label>
                            <input type="text" class="form-control-modern" id="accountantTitle" value="COMPTABLE PRINCIPAL">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control-modern" id="accountantEmail" placeholder="email@exemple.com">
                        </div>
                        <div class="d-grid">
                            <button class="btn-modern btn-primary-modern" onclick="saveAccountantInfo()">
                                <i class="fas fa-save me-2"></i>
                                Enregistrer
                            </button>
                        </div>
                    </div>
                </div>

                <!-- System Settings -->
                <div class="col-md-6">
                    <div class="stat-card">
                        <h5 class="fw-bold mb-3">
                            <i class="fas fa-sliders-h me-2 icon-text-primary"></i>
                            Configuration Payroll
                        </h5>
                        <div class="mb-3">
                            <label class="form-label">Jour de Paiement</label>
                            <select class="form-control-modern" id="paymentDay">
                                <option value="9" selected>9 du mois</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Devise</label>
                            <select class="form-control-modern" id="currency">
                                <option value="RWF" selected>Franc Rwandais (RWF)</option>
                                <option value="USD">Dollar US</option>
                            </select>
                        </div>
                        <div class="d-grid">
                            <button class="btn-modern btn-primary-modern" onclick="saveSettings()">
                                <i class="fas fa-save me-2"></i>
                                Enregistrer les Paramètres
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Branches Configuration -->
                <div class="col-md-12">
                    <div class="stat-card">
                        <h5 class="fw-bold mb-3">
                            <i class="fas fa-school me-2 icon-text-primary"></i>
                            Configuration des Branches
                        </h5>
                        
                        <div class="branch-options">
                            <div class="branch-option">
                                <div class="branch-card" onclick="selectBranch('kacyiru')" id="branchKacyiru">
                                    <h6>EDEN FAMILY SCHOOL KACYIRU</h6>
                                    <small>École principale - Kacyiru</small>
                                </div>
                            </div>
                            <div class="branch-option">
                                <div class="branch-card" onclick="selectBranch('kimisagara')" id="branchKimisagara">
                                    <h6>EDEN FAMILY SCHOOL KIMISAGARA</h6>
                                    <small>Branche Kimisagara</small>
                                </div>
                            </div>
                            <div class="branch-option">
                                <div class="branch-card" onclick="selectBranch('gisozimaternelle')" id="branchGisozimaternelle">
                                    <h6>EDEN FAMILY SCHOOL GISOZI MATERNELLE</h6>
                                    <small>Section maternelle - Gisozi</small>
                                </div>
                            </div>
                            <div class="branch-option">
                                <div class="branch-card" onclick="selectBranch('gisoziprimaire')" id="branchGisoziprimaire">
                                    <h6>EDEN FAMILY SCHOOL GISOZI PRIMAIRE</h6>
                                    <small>Section primaire - Gisozi</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <input type="hidden" id="selectedBranch" value="kacyiru">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Branche sélectionnée: <strong id="currentBranchText">EDEN FAMILY SCHOOL KACYIRU</strong>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Fee Configuration -->
                <div class="col-md-12">
                    <div class="stat-card">
                        <h5 class="fw-bold mb-3">
                            <i class="fas fa-money-bill-wave me-2 icon-text-primary"></i>
                            Configuration des Frais par Trimestre
                        </h5>
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Branche *</label>
                                <input type="text" class="form-control-modern" id="feeBranch" value="EDEN FAMILY SCHOOL KACYIRU" readonly>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Trimestre *</label>
                                <select class="form-control-modern" id="feeQuarter" onchange="loadFeeConfiguration()">
                                    <option value="1">Trimestre 1</option>
                                    <option value="2">Trimestre 2</option>
                                    <option value="3">Trimestre 3</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Année Scolaire *</label>
                                <select class="form-control-modern" id="feeYear" onchange="loadFeeConfiguration()">
                                    <option value="2024-2025">2024-2025</option>
                                    <option value="2025-2026">2025-2026</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <h6>Frais Scolaires (RWF)</h6>
                                <div class="mb-3">
                                    <label class="form-label">Minervale</label>
                                    <input type="number" class="form-control-modern" id="feeMinervale" value="150000">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Transport</label>
                                    <input type="number" class="form-control-modern" id="feeTransport" value="50000">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Coaching</label>
                                    <input type="number" class="form-control-modern" id="feeCoaching" value="80000">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Uniforme</label>
                                    <input type="number" class="form-control-modern" id="feeUniform" value="30000">
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <h6>Frais Supplémentaires (RWF)</h6>
                                <div class="mb-3">
                                    <label class="form-label">Lunch</label>
                                    <input type="number" class="form-control-modern" id="feeLunch" value="20000">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Breakfast</label>
                                    <input type="number" class="form-control-modern" id="feeBreakfast" value="10000">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Matériel Scolaire</label>
                                    <input type="number" class="form-control-modern" id="feeMaterial" value="15000">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Assurance</label>
                                    <input type="number" class="form-control-modern" id="feeInsurance" value="10000">
                                </div>
                            </div>
                        </div>

                        <div class="d-grid">
                            <button class="btn-modern btn-primary-modern" onclick="saveFeeConfiguration()">
                                <i class="fas fa-save me-2"></i>
                                Enregistrer la Configuration
                            </button>
                        </div>
                    </div>
                </div>

                <!-- System Actions -->
                <div class="col-md-12">
                    <div class="stat-card">
                        <h5 class="fw-bold mb-3">
                            <i class="fas fa-shield-alt me-2 icon-text-primary"></i>
                            Actions Système
                        </h5>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <button class="btn-modern w-100 btn-backup-data" onclick="backupData()">
                                    <i class="fas fa-database me-2"></i>
                                    Sauvegarde Données
                                </button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button class="btn-modern w-100 btn-primary-modern" onclick="exportAllDataExcel()">
                                    <i class="fas fa-file-excel me-2"></i>
                                    Exporter Excel
                                </button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button class="btn-modern w-100 btn-payroll-danger" onclick="exportAllDataPDF()">
                                    <i class="fas fa-file-pdf me-2"></i>
                                    Exporter PDF
                                </button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button class="btn-modern w-100 btn-reset-system" onclick="resetSystem()">
                                    <i class="fas fa-redo me-2"></i>
                                    Réinitialiser
                                </button>
                            </div>
                            <div class="col-md-12 mb-3">
                                <button class="btn-modern w-100 btn-logout" onclick="logout()">
                                    <i class="fas fa-sign-out-alt me-2"></i>
                                    Déconnexion
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Worker Modal -->
    <div class="modal fade" id="workerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Gestion Travailleur</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>
                <div class="modal-body">
                    <form id="workerForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Type de Travailleur *</label>
                                <select class="form-control-modern" id="workerType" required onchange="validateWorkerType()">
                                    <option value="">Sélectionnez</option>
                                    <option value="enseignant">Enseignant</option>
                                    <option value="staff">Staff</option>
                                    <option value="directeur">Directeur</option>
                                    <option value="secretaire">Secrétaire</option>
                                    <option value="autre">Autre</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">NO *</label>
                                <input type="text" class="form-control-modern" id="workerNo" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Nom Complet *</label>
                                <input type="text" class="form-control-modern" id="workerName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Numéro Téléphone *</label>
                                <input type="tel" class="form-control-modern" id="workerPhone" required pattern="07[0-9]{8}" placeholder="0781234567">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Salaire Base (RWF) *</label>
                                <input type="number" class="form-control-modern" id="workerSalary" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Mode de Paiement *</label>
                                <select class="form-control-modern" id="workerPaymentMode" required onchange="togglePaymentInfo()">
                                    <option value="">Sélectionnez</option>
                                    <option value="bank">Banque</option>
                                    <option value="momo">Mobile Money</option>
                                    <option value="cash">Espèces</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Bank Information -->
                        <div id="bankInfo" class="d-none">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Numéro de Compte *</label>
                                    <input type="text" class="form-control-modern" id="workerAccountNo">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nom de la Banque *</label>
                                    <select class="form-control-modern" id="workerBankName">
                                        <option value="">Sélectionnez</option>
                                        <option value="BK">Bank of Kigali (BK)</option>
                                        <option value="I&M">I&M Bank Rwanda</option>
                                        <option value="GT">GT Bank Rwanda</option>
                                        <option value="COGE">Cogebanque</option>
                                        <option value="ACCESS">Access Bank Rwanda</option>
                                        <option value="ECOBANK">Ecobank Rwanda</option>
                                        <option value="EQUITY">Equity Bank</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Mobile Money Information -->
                        <div id="momoInfo" class="d-none">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Numéro Mobile Money *</label>
                                    <input type="tel" class="form-control-modern" id="workerMomoNumber">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Opérateur Mobile Money *</label>
                                    <select class="form-control-modern" id="workerMomoOperator">
                                        <option value="">Sélectionnez</option>
                                        <option value="MTN">MTN Mobile Money</option>
                                        <option value="AIRTEL">Airtel Money</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Date d'Embauche</label>
                            <input type="date" class="form-control-modern" id="workerHireDate">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Branche *</label>
                            <select class="form-control-modern" id="workerBranch" required>
                                <option value="kacyiru">EDEN FAMILY SCHOOL KACYIRU</option>
                                <option value="kimisagara">EDEN FAMILY SCHOOL KIMISAGARA</option>
                                <option value="gisozimaternelle">EDEN FAMILY SCHOOL GISOZI MATERNELLE</option>
                                <option value="gisoziprimaire">EDEN FAMILY SCHOOL GISOZI PRIMAIRE</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i> Annuler
                    </button>
                    <button type="button" class="btn btn-outline-danger delete-worker-btn" id="deleteWorkerBtn" onclick="deleteWorker()">
                        <i class="fas fa-trash me-2"></i> Supprimer
                    </button>
                    <button type="button" class="btn btn-outline-info" id="resetWorkerBtn" onclick="resetWorkerForm()">
                        <i class="fas fa-redo me-2"></i> Réinitialiser
                    </button>
                    <button type="button" class="btn-modern btn-primary-modern" onclick="saveWorker()">
                        <i class="fas fa-save me-2"></i> Enregistrer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Debt Modal -->
    <div class="modal fade" id="debtModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Enregistrer une Dette</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>
                <div class="modal-body">
                    <form id="debtForm">
                        <div class="mb-3">
                            <label class="form-label">Travailleur *</label>
                            <select class="form-control-modern" id="debtWorker" required>
                                <!-- Options chargées depuis Firebase -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Montant (RWF) *</label>
                            <input type="number" class="form-control-modern" id="debtAmount" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Motif *</label>
                            <textarea class="form-control-modern" id="debtReason" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Date *</label>
                            <input type="date" class="form-control-modern" id="debtDate" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Statut</label>
                            <select class="form-control-modern" id="debtStatus">
                                <option value="pending">En attente</option>
                                <option value="paid">Payé</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn-modern btn-primary-modern" onclick="saveDebt()">
                        <i class="fas fa-save me-2"></i> Enregistrer Dette
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Modal -->
    <div class="modal fade" id="studentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ajouter un Élève</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>
                <div class="modal-body">
                    <form id="studentForm">
                        <div class="mb-3">
                            <label class="form-label">Code Référence *</label>
                            <div class="input-group">
                                <input type="text" class="form-control-modern" id="studentReference" placeholder="EDU-20260118-120000" readonly>
                                <button type="button" class="btn-modern" onclick="generateStudentReference()" title="Générer référence">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nom Complet *</label>
                            <input type="text" class="form-control-modern" id="studentFullName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Date de Naissance *</label>
                            <input type="date" class="form-control-modern" id="studentBirthDate" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Classe *</label>
                            <select class="form-control-modern" id="studentClass" required>
                                <option value="">Sélectionnez</option>
                                <optgroup label="NURSERY">
                                    <option value="N1A">N1A (Nursery 1A)</option>
                                    <option value="N1B">N1B (Nursery 1B)</option>
                                    <option value="N1C">N1C (Nursery 1C)</option>
                                    <option value="N2A">N2A (Nursery 2A)</option>
                                    <option value="N2B">N2B (Nursery 2B)</option>
                                    <option value="N2C">N2C (Nursery 2C)</option>
                                    <option value="N3A">N3A (Nursery 3A)</option>
                                    <option value="N3B">N3B (Nursery 3B)</option>
                                    <option value="N3C">N3C (Nursery 3C)</option>
                                </optgroup>
                                <optgroup label="PRIMAIRE">
                                    <option value="P1A">P1A</option>
                                    <option value="P1B">P1B</option>
                                    <option value="P1C">P1C</option>
                                    <option value="P2A">P2A</option>
                                    <option value="P2B">P2B</option>
                                    <option value="P2C">P2C</option>
                                    <option value="P3A">P3A</option>
                                    <option value="P3B">P3B</option>
                                    <option value="P3C">P3C</option>
                                    <option value="P4A">P4A</option>
                                    <option value="P4B">P4B</option>
                                    <option value="P4C">P4C</option>
                                    <option value="P5A">P5A</option>
                                    <option value="P5B">P5B</option>
                                    <option value="P5C">P5C</option>
                                    <option value="P6A">P6A</option>
                                    <option value="P6B">P6B</option>
                                    <option value="P6C">P6C</option>
                                </optgroup>
                                    <option value="P4">Primaire 4</option>
                                    <option value="P5">Primaire 5</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nom du Parent</label>
                            <input type="text" class="form-control-modern" id="studentParent">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Téléphone du Parent</label>
                            <input type="tel" class="form-control-modern" id="studentParentPhone">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Branche *</label>
                            <select class="form-control-modern" id="studentBranch" required>
                                <option value="kacyiru">EDEN FAMILY SCHOOL KACYIRU</option>
                                <option value="kimisagara">EDEN FAMILY SCHOOL KIMISAGARA</option>
                                <option value="gisozimaternelle">EDEN FAMILY SCHOOL GISOZI MATERNELLE</option>
                                <option value="gisoziprimaire">EDEN FAMILY SCHOOL GISOZI PRIMAIRE</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn-modern btn-primary-modern" onclick="saveStudent()">
                        <i class="fas fa-save me-2"></i> Enregistrer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Fee Modal -->
    <div class="modal fade" id="studentFeeModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Enregistrement Paiement Élève</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>
                <div class="modal-body">
                    <form id="studentFeeForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Classe *</label>
                                <select class="form-control-modern" id="studentClassFilter" required onchange="loadStudentsByClass()">
                                    <option value="">Sélectionnez une classe</option>
                                    <optgroup label="NURSERY">
                                        <option value="N1A">N1A (Nursery 1A)</option>
                                        <option value="N1B">N1B (Nursery 1B)</option>
                                        <option value="N1C">N1C (Nursery 1C)</option>
                                        <option value="N2A">N2A (Nursery 2A)</option>
                                        <option value="N2B">N2B (Nursery 2B)</option>
                                        <option value="N2C">N2C (Nursery 2C)</option>
                                        <option value="N3A">N3A (Nursery 3A)</option>
                                        <option value="N3B">N3B (Nursery 3B)</option>
                                        <option value="N3C">N3C (Nursery 3C)</option>
                                    </optgroup>
                                    <optgroup label="PRIMAIRE">
                                        <option value="P1A">P1A</option>
                                        <option value="P1B">P1B</option>
                                        <option value="P1C">P1C</option>
                                        <option value="P2A">P2A</option>
                                        <option value="P2B">P2B</option>
                                        <option value="P2C">P2C</option>
                                        <option value="P3A">P3A</option>
                                        <option value="P3B">P3B</option>
                                        <option value="P3C">P3C</option>
                                        <option value="P4A">P4A</option>
                                        <option value="P4B">P4B</option>
                                        <option value="P4C">P4C</option>
                                        <option value="P5A">P5A</option>
                                        <option value="P5B">P5B</option>
                                        <option value="P5C">P5C</option>
                                        <option value="P6A">P6A</option>
                                        <option value="P6B">P6B</option>
                                        <option value="P6C">P6C</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Élève *</label>
                                <select class="form-control-modern" id="studentSelect" required onchange="loadStudentDetails()">
                                    <option value="">Sélectionnez d'abord une classe</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Student Info Display -->
                        <div class="row mb-3 student-info-display" id="studentInfoDisplay">
                            <div class="col-md-4">
                                <label class="form-label">Code Référence</label>
                                <input type="text" class="form-control-modern" id="studentReferenceDisplay" readonly>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Date Naissance</label>
                                <input type="text" class="form-control-modern" id="studentBirthDateDisplay" readonly>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Parent</label>
                                <input type="text" class="form-control-modern" id="studentParentDisplay" readonly>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Type de Paiement *</label>
                                <select class="form-control-modern" id="studentPaymentType" required>
                                    <option value="">Sélectionnez</option>
                                    <option value="minervale">Minervale</option>
                                    <option value="coaching">Coaching</option>
                                    <option value="transport">Transport</option>
                                    <option value="uniforme">Uniforme</option>
                                    <option value="lunch">Lunch</option>
                                    <option value="breakfast">Breakfast</option>
                                    <option value="material">Matériel scolaire</option>
                                    <option value="insurance">Assurance</option>
                                    <option value="autre">Autre</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Montant (RWF) *</label>
                                <input type="number" class="form-control-modern" id="studentAmount" required>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Mode de Paiement *</label>
                                <select class="form-control-modern" id="studentPaymentMode" required>
                                    <option value="cash">Espèces</option>
                                    <option value="momo">Mobile Money</option>
                                    <option value="bank">Virement Bancaire</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Date du Paiement *</label>
                                <input type="date" class="form-control-modern" id="studentPaymentDate" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Référence de Transaction</label>
                            <input type="text" class="form-control-modern" id="studentTransactionRef" placeholder="Numéro de transaction MOMO/Banque">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Notes supplémentaires</label>
                            <textarea class="form-control-modern" id="studentPaymentNotes" rows="2" placeholder="Notes supplémentaires..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn-modern btn-primary-modern" onclick="saveStudentFee()">
                        <i class="fas fa-save me-2"></i> Enregistrer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCx6kmJ59x0tLt4vh_3czvEEQrtw4aWFHs",
            authDomain: "edendatabase-7e1ed.firebaseapp.com",
            databaseURL: "https://edendatabase-7e1ed-default-rtdb.firebaseio.com",
            projectId: "edendatabase-7e1ed",
            storageBucket: "edendatabase-7e1ed.firebasestorage.app",
            messagingSenderId: "147248399046",
            appId: "1:147248399046:web:d0b433e755772bbe718dc7",
            measurementId: "G-XB192PCMV7"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();  // Assigner à la variable globale définie en haut
        const db = firebase.database();
        const storage = firebase.storage();

        // Check authentication
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUserName = user.displayName || user.email || "Utilisateur";
                document.getElementById('userName').textContent = currentUserName;
                document.getElementById('preparedBy').textContent = currentUserName;
                document.getElementById('reportPreparedBy').value = currentUserName;
                document.getElementById('accountantName').value = currentUserName;
                console.log('Utilisateur connecté:', currentUserName);
                loadAllData();
            } else {
                console.log('Aucun utilisateur connecté - Accès temporaire autorisé pour diagnostic');
                currentUser = {
                    name: "Utilisateur",
                    email: "utilisateur@edensmart.com",
                    role: "comptable",
                    branch: "kacyiru"
                };
                currentUserName = "Utilisateur";
                updateUIWithUserInfo();
                loadAllData();
            }
        });

        // Références Firebase
        const travailleursRef = db.ref('Travailleurs'); // collection des employés/travailleurs
        const studentFeesRef = db.ref('studentFees');
        const payrollRef = db.ref('payroll');
        const reportsRef = db.ref('reports');
        const announcementsRef = db.ref('announcements');
        const debtsRef = db.ref('debts');
        const studentsRef = db.ref('students');
        const dailyReportsRef = db.ref('dailyReports');
        const weeklyReportsRef = db.ref('weeklyReports');
        const monthlyReportsRef = db.ref('monthlyReports');
        const payrollHistoryRef = db.ref('payrollHistory');
        const reportHistoryRef = db.ref('reportHistory');
        const feeConfigRef = db.ref('feeConfiguration');
        const dailyExpensesRef = db.ref('dailyExpenses');
        const receiptsRef = db.ref('receipts');
        const accountantRef = db.ref('accountant');
        const settingsRef = db.ref('settings');

        // Variables globales
        let travailleurs = [];
        let studentFees = [];
        let payrollData = [];
        let announcements = [];
        let debts = [];
        let students = [];
        let dailyReports = [];
        let weeklyReports = [];
        let monthlyReports = [];
        let payrollHistory = [];
        let reportHistory = [];
        let feeConfigurations = [];
        let dailyExpenses = [];
        let currentTeacherId = null;
        let currentStudentFeeId = null;
        let currentStudentId = null;
        let currentUserName = "Utilisateur";
        let realPayrollChart = null;
        let weeklyChart = null;
        let monthlyChart = null;
        let currentLanguage = 'fr';
        let selectedBranch = 'kacyiru';

        // Translations
        const translations = {
            fr: {
                dashboard: 'Tableau de bord',
                workers: 'Gestion Travailleurs',
                payroll: 'Générer Payroll',
                payments: 'Paiements',
                students: 'Élèves',
                reports: 'Rapports Financiers',
                settings: 'Paramètres',
                financialDashboard: 'Tableau de Bord Financier',
                totalWorkers: 'Total Travailleurs',
                monthlyPayroll: 'Payroll du Mois',
                bankPayments: 'Paiements Banque',
                studentPayments: 'Paiements Élèves',
                workerManagement: 'Gestion des Travailleurs',
                addWorker: 'Ajouter Travailleur',
                addDebt: 'Ajouter Dette',
                generatePayroll: 'Générer Payroll',
                currentDebts: 'Dettes en Cours pour ce Mois',
                studentManagement: 'Gestion des Élèves',
                addStudent: 'Ajouter Élève',
                searchStudent: 'Rechercher un élève...',
                financialReports: 'Rapports Financiers',
                daily: 'Journalier',
                weekly: 'Hebdomadaire',
                monthly: 'Mensuel',
                systemSettings: 'Paramètres du Système',
                accountantInfo: 'Informations Comptable',
                logout: 'Déconnexion'
            },
            en: {
                dashboard: 'Dashboard',
                workers: 'Workers Management',
                payroll: 'Generate Payroll',
                payments: 'Payments',
                students: 'Students',
                reports: 'Financial Reports',
                settings: 'Settings',
                financialDashboard: 'Financial Dashboard',
                totalWorkers: 'Total Workers',
                monthlyPayroll: 'Monthly Payroll',
                bankPayments: 'Bank Payments',
                studentPayments: 'Student Payments',
                workerManagement: 'Workers Management',
                addWorker: 'Add Worker',
                addDebt: 'Add Debt',
                generatePayroll: 'Generate Payroll',
                currentDebts: 'Current Debts for This Month',
                studentManagement: 'Students Management',
                addStudent: 'Add Student',
                searchStudent: 'Search a student...',
                financialReports: 'Financial Reports',
                daily: 'Daily',
                weekly: 'Weekly',
                monthly: 'Monthly',
                systemSettings: 'System Settings',
                accountantInfo: 'Accountant Information',
                logout: 'Logout'
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
            setInterval(updateDateTime, 60000);
            updateCurrentPeriod();
            
            document.getElementById('userRole').textContent = "Comptable Principal";
            
            setupFirebaseListeners();
            // Charger les configurations de frais avec un petit délai pour s'assurer que Firebase est prêt
            setTimeout(() => {
                loadFeeConfiguration();
            }, 500);
            initializeCharts();
            selectBranch('kacyiru'); // Sélectionner la branche par défaut
            // Apply initial translations
            try { applyTranslations(); } catch (e) { /* ignore if not ready */ }
        });

        // Setup Firebase listeners
        function setupFirebaseListeners() {
            // Écouter les changements d'annonces
            announcementsRef.orderByChild('timestamp').limitToLast(10).on('value', (snapshot) => {
                announcements = [];
                snapshot.forEach((childSnapshot) => {
                    const announcement = childSnapshot.val();
                    announcements.push({
                        id: childSnapshot.key,
                        ...announcement
                    });
                });
                announcements.sort((a, b) => b.timestamp - a.timestamp);
                updateFilteredAnnouncements();
            });

            // Écouter les changements de travailleurs
            travailleursRef.on('value', (snapshot) => {
                travailleurs = [];
                snapshot.forEach((childSnapshot) => {
                    const worker = {
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    };
                    travailleurs.push(worker);
                });
                updateStats();
                if (document.getElementById('travailleurs').classList.contains('active')) {
                    loadWorkers();
                }
                updateDebtWorkerSelect();
            });

            // Écouter les changements de dettes
            debtsRef.on('value', (snapshot) => {
                debts = [];
                snapshot.forEach((childSnapshot) => {
                    const debt = {
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    };
                    debts.push(debt);
                });
                if (document.getElementById('travailleurs').classList.contains('active')) {
                    loadCurrentMonthDebts();
                }
            });

            // Écouter les changements d'élèves
            studentsRef.on('value', (snapshot) => {
                students = [];
                snapshot.forEach((childSnapshot) => {
                    const student = {
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    };
                    students.push(student);
                });
                if (document.getElementById('students').classList.contains('active')) {
                    loadStudents();
                }
            });

            // Écouter les changements de paiements élèves
            studentFeesRef.on('value', (snapshot) => {
                studentFees = [];
                snapshot.forEach((childSnapshot) => {
                    const fee = {
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    };
                    studentFees.push(fee);
                });
                updateStats();
                if (document.getElementById('student-fees').classList.contains('active')) {
                    loadStudentFees();
                }
                if (document.getElementById('students').classList.contains('active')) {
                    loadStudents();
                }
                
                // Si la section rapports est active, mettre à jour le tableau
                if (document.getElementById('reports').classList.contains('active')) {
                    updateDailyReportTable();
                }
            });

            // Écouter les configurations de frais
            feeConfigRef.on('value', (snapshot) => {
                feeConfigurations = [];
                snapshot.forEach((childSnapshot) => {
                    const config = {
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    };
                    feeConfigurations.push(config);
                });
            });

            // Écouter les rapports journaliers
            dailyReportsRef.on('value', (snapshot) => {
                dailyReports = [];
                snapshot.forEach((childSnapshot) => {
                    const report = {
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    };
                    dailyReports.push(report);
                });
            });

            // Écouter l'historique des payrolls
            payrollHistoryRef.on('value', (snapshot) => {
                payrollHistory = [];
                snapshot.forEach((childSnapshot) => {
                    const payroll = {
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    };
                    payrollHistory.push(payroll);
                });
                payrollHistory.sort((a, b) => b.timestamp - a.timestamp);
            });

            // Écouter l'historique des rapports
            reportHistoryRef.on('value', (snapshot) => {
                reportHistory = [];
                snapshot.forEach((childSnapshot) => {
                    const report = {
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    };
                    reportHistory.push(report);
                });
                reportHistory.sort((a, b) => b.timestamp - a.timestamp);
            });

            // Écouter les dépenses journalières
            dailyExpensesRef.on('value', (snapshot) => {
                dailyExpenses = [];
                snapshot.forEach((childSnapshot) => {
                    const expense = {
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    };
                    dailyExpenses.push(expense);
                });
                if (document.getElementById('reports').classList.contains('active')) {
                    updateExpensesList();
                    updateDailyReportTable();
                }
            });
            
            // Charger les paramètres du système
            settingsRef.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const settings = snapshot.val();
                    if (settings.paymentDay) document.getElementById('paymentDay').value = settings.paymentDay;
                    if (settings.currency) document.getElementById('currency').value = settings.currency;
                }
            });
            
            // Charger les informations du comptable
            accountantRef.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const accountant = snapshot.val();
                    if (accountant.name) {
                        document.getElementById('accountantName').value = accountant.name;
                        currentUserName = accountant.name;
                        document.getElementById('userName').textContent = accountant.name;
                        document.getElementById('preparedBy').textContent = accountant.name;
                        document.getElementById('reportPreparedBy').value = accountant.name;
                    }
                    if (accountant.title) document.getElementById('accountantTitle').value = accountant.title;
                    if (accountant.email) document.getElementById('accountantEmail').value = accountant.email;
                }
            });
            
            // Observer pour charger automatiquement le rapport quand la section est active
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        const reportsSection = document.getElementById('reports');
                        if (reportsSection.classList.contains('active')) {
                            // Définir la date d'aujourd'hui par défaut
                            const today = new Date().toISOString().split('T')[0];
                            document.getElementById('dailyReportDate').value = today;
                            
                            // Charger le rapport après un délai
                            setTimeout(() => {
                                loadDailyReport();
                            }, 300);
                        }
                    }
                });
            });
            
            observer.observe(document.getElementById('reports'), {
                attributes: true
            });
        }

        // Update date and time
        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('fr-FR', options);
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        }

        // Load all initial data
        async function loadAllData() {
            console.log('Début du chargement des données...');
            try {
                await Promise.all([
                    loadWorkers(),
                    loadStudentFees(),
                    loadCurrentMonthDebts(),
                    loadStudents(),
                    updateFilteredAnnouncements()
                ]);
                console.log('Données chargées avec succès');
                updateStats();
                updateRealPayrollChart();
            } catch (error) {
                console.error('Erreur lors du chargement des données:', error);
            }
        }

        // Update stats from Firebase
        function updateStats() {
            // Filtrer les travailleurs par branche sélectionnée
            const branchTravailleurs = travailleurs.filter(w => w.branch === selectedBranch);
            document.getElementById('totalTravailleurs').textContent = branchTravailleurs.length;
            
            const currentMonth = new Date().getMonth() + 1;
            const currentYear = new Date().getFullYear();
            
            // Calculer le payroll pour la branche sélectionnée
            const monthlyPayroll = branchTravailleurs.reduce((total, w) => {
                if (w.salary) {
                    return total + parseFloat(w.salary);
                }
                return total;
            }, 0);
            document.getElementById('monthlyPayroll').textContent = formatCurrencyRWF(monthlyPayroll);
            
            const bankCount = branchTravailleurs.filter(t => t.paymentMode === 'bank').length;
            document.getElementById('bankPayments').textContent = bankCount;
            
            // Filtrer les paiements élèves par branche
            const branchStudentFees = studentFees.filter(fee => {
                const student = students.find(s => s.id === fee.studentId);
                return student && student.branch === selectedBranch;
            });
            document.getElementById('studentPayments').textContent = branchStudentFees.length;
        }

        // Update filtered announcements (only director and secretary)
        function updateFilteredAnnouncements() {
            const container = document.getElementById('filteredAnnouncementsList');
            container.innerHTML = '';
            
            const filtered = announcements.filter(announcement => 
                announcement.author === 'directeur' || announcement.author === 'secretaire'
            );
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="list-group-item border-0 px-0 py-2">
                        <p class="mb-0">Aucune annonce du directeur ou de la secrétaire</p>
                    </div>
                `;
                return;
            }
            
            filtered.slice(0, 5).forEach(announcement => {
                const date = new Date(announcement.timestamp);
                const authorBadge = announcement.author === 'directeur' ? 
                    '<span class="announcement-type-badge">Directeur</span>' : 
                    '<span class="announcement-type-badge" style="background: #6c757d;">Secrétaire</span>';
                
                const item = document.createElement('div');
                item.className = 'list-group-item border-0 px-0 py-2';
                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <small class="text-muted">${date.toLocaleDateString('fr-FR')}</small>
                        ${authorBadge}
                    </div>
                    <p class="mb-0 mt-1">${announcement.message}</p>
                `;
                container.appendChild(item);
            });
        }

        // Format currency in RWF
        function formatCurrencyRWF(amount) {
            if (isNaN(amount)) amount = 0;
            return new Intl.NumberFormat('fr-RW', {
                style: 'currency',
                currency: 'RWF',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        // Navigation
        function showSection(sectionId) {
            const currentSection = document.querySelector('.section.active');
            if (currentSection) {
                currentSection.classList.remove('active');
            }
            
            setTimeout(() => {
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.remove('active');
                });
                
                document.getElementById(sectionId).classList.add('active');
                
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });

                // Marquer le bouton actif. Si l'objet 'event' n'est pas disponible (appel direct),
                // chercher le bouton ayant l'attribut onclick correspondant.
                let activeBtn = null;
                try {
                    if (event && event.target) activeBtn = event.target.closest('.nav-btn');
                } catch (e) {
                    activeBtn = null;
                }
                if (!activeBtn) {
                    activeBtn = Array.from(document.querySelectorAll('.nav-btn')).find(b => {
                        const handler = b.getAttribute('onclick') || '';
                        return handler.includes(`showSection('${sectionId}')`);
                    });
                }
                if (activeBtn) activeBtn.classList.add('active');
                
                if (sectionId === 'travailleurs') {
                    loadWorkers();
                    loadCurrentMonthDebts();
                } else if (sectionId === 'payroll') {
                    loadPayroll();
                    loadCurrentMonthDebts();
                } else if (sectionId === 'student-fees') {
                    loadStudentFees();
                } else if (sectionId === 'students') {
                    loadStudents();
                } else if (sectionId === 'reports') {
                    showDailyReport();
                }
            }, 300);
        }

        // Update current period
        function updateCurrentPeriod() {
            const monthSelect = document.getElementById('payrollMonth');
            const month = monthSelect.options[monthSelect.selectedIndex].text;
            const year = document.getElementById('payrollYear').value;
            document.getElementById('currentPeriod').textContent = `${month} ${year}`;
            displayPayrollTable();
        }
        
        // Display payroll table with workers data
        function displayPayrollTable() {
            try {
                const tbody = document.getElementById('payrollTable');
                if (!tbody) return; // no payroll section loaded
                
                tbody.innerHTML = '';
                
                // Filter workers by selected branch
                const branchTravailleurs = travailleurs.filter(w => w.branch === selectedBranch);
                
                if (branchTravailleurs.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="fas fa-users fa-2x mb-3"></i>
                                    <p>Aucun travailleur dans cette branche</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let totalPayroll = 0;
                branchTravailleurs.forEach((w, index) => {
                    // Calculate debts for this worker
                    const workerDebts = debts.filter(d => d.workerId === w.id);
                    const totalDebt = workerDebts.reduce((sum, d) => sum + (d.amount || 0), 0);
                    
                    const salary = parseFloat(w.salary) || 0;
                    totalPayroll += salary;
                    
                    const type = w.type || 'Worker';
                    const typeBadge = type.toLowerCase().includes('director') ? 'badge bg-danger' : 
                                     type.toLowerCase().includes('admin') || type.toLowerCase().includes('administrator') ? 'badge bg-warning' : 'badge bg-info';
                    const typeText = type;
                    
                    const paymentMode = w.paymentMode || 'bank';
                    const paymentText = paymentMode.charAt(0).toUpperCase() + paymentMode.slice(1);
                    
                    const badgeClass = paymentMode === 'bank' ? 'badge bg-primary' :
                                     paymentMode === 'momo' ? 'badge bg-success' : 'badge bg-secondary';
                    
                    const status = w.status || 'active';
                    const statusBadge = status === 'active' ? 'bg-success' : status === 'leave' ? 'bg-warning' : 'bg-secondary';
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td><strong>${w.name || 'Inconnu'}</strong></td>
                        <td><span class="${typeBadge}">${typeText}</span></td>
                        <td>${w.phone || '-'}</td>
                        <td><span class="${badgeClass}">${paymentText}</span></td>
                        <td>${formatCurrencyRWF(salary)}</td>
                        <td>${totalDebt > 0 ? formatCurrencyRWF(totalDebt) : 'Aucune'}</td>
                        <td><span class="badge ${statusBadge}">${status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-info me-1" onclick="downloadWorkerPaymentHistory('${w.id}')" title="T\u00e9l\u00e9charger historique">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="updatePaymentStatus('${w.id}')" title="Mettre \u00e0 jour">
                                <i class="fas fa-check"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                
                document.getElementById('totalPayrollAmount').textContent = `Total: ${formatCurrencyRWF(totalPayroll)} RWF`;
                
            } catch (error) {
                console.error('Erreur affichage payroll:', error);
                showToast('Erreur lors de l\'affichage du payroll', 'error');
            }
        }

        // Sélectionner une branche
        function selectBranch(branchId) {
            selectedBranch = branchId;
            document.getElementById('selectedBranch').value = branchId;
            
            // Mettre à jour l'interface
            document.querySelectorAll('.branch-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById('branch' + branchId.charAt(0).toUpperCase() + branchId.slice(1)).classList.add('selected');
            
            // Mettre à jour le texte affiché
            const branchNames = {
                kacyiru: 'EDEN FAMILY SCHOOL KACYIRU',
                kimisagara: 'EDEN FAMILY SCHOOL KIMISAGARA',
                gisozimaternelle: 'EDEN FAMILY SCHOOL GISOZI MATERNELLE',
                gisoziprimaire: 'EDEN FAMILY SCHOOL GISOZI PRIMAIRE'
            };
            document.getElementById('currentBranchText').textContent = branchNames[branchId];
            document.getElementById('feeBranch').value = branchNames[branchId];
            
            // Recharger la configuration des frais pour la nouvelle branche
            loadFeeConfiguration();
            
            // Mettre à jour les statistiques
            updateStats();
            
            showToast(`Branche ${branchNames[branchId]} sélectionnée`, 'success');
        }

        // Load workers
        async function loadWorkers() {
            try {
                const snapshot = await travailleursRef.orderByChild('no').once('value');
                const tbody = document.getElementById('workersTable');
                tbody.innerHTML = '';
                
                if (!snapshot.exists()) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="fas fa-users fa-2x mb-3"></i>
                                    <p>Aucun travailleur trouvé</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                travailleurs = [];
                snapshot.forEach((childSnapshot) => {
                    const w = {
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    };
                    travailleurs.push(w);
                });
                
                // Filtrer par branche sélectionnée
                const branchTravailleurs = travailleurs.filter(w => w.branch === selectedBranch);
                branchTravailleurs.sort((a, b) => parseInt(a.no) - parseInt(b.no));
                
                if (branchTravailleurs.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="fas fa-users fa-2x mb-3"></i>
                                    <p>Aucun travailleur trouvé dans cette branche</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                branchTravailleurs.forEach((w, index) => {
                    const badgeClass = w.paymentMode === 'bank' ? 'badge-bank' :
                                     w.paymentMode === 'momo' ? 'badge-momo' : 'badge-cash';
                    const paymentText = w.paymentMode === 'bank' ? 'Banque' :
                                      w.paymentMode === 'momo' ? 'Mobile Money' : 'Espèces';
                    
                    const typeBadge = w.type === 'enseignant' ? 'badge bg-success' :
                                    w.type === 'staff' ? 'badge bg-info' : 'badge bg-secondary';
                    const typeText = w.type === 'enseignant' ? 'Enseignant' :
                                   w.type === 'staff' ? 'Staff' : 'Autre';
                    
                    const workerDebts = debts.filter(d => d.workerId === w.id && d.status === 'pending');
                    const totalDebt = workerDebts.reduce((sum, debt) => sum + (debt.amount || 0), 0);
                    
                    const tr = document.createElement('tr');
                    tr.className = 'animate-fade-in';
                    tr.innerHTML = `
                        <td>${w.no}</td>
                        <td><strong>${w.name}</strong></td>
                        <td><span class="${typeBadge}">${typeText}</span></td>
                        <td>${w.phone || ''}</td>
                        <td><span class="${badgeClass}">${paymentText}</span></td>
                        <td>${formatCurrencyRWF(w.salary || 0)}</td>
                        <td>
                            ${totalDebt > 0 ? 
                                `<span class="debt-badge" onclick="showDebtDetails('${w.id}')">${formatCurrencyRWF(totalDebt)}</span>` : 
                                'Aucune'}
                        </td>
                        <td><span class="badge bg-success">${w.status || 'active'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editWorker('${w.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info me-1" onclick="addDebtForWorker('${w.id}')">
                                <i class="fas fa-money-bill-wave"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteWorkerPrompt('${w.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                
            } catch (error) {
                console.error('Erreur chargement travailleurs:', error);
                showToast('Erreur lors du chargement des travailleurs', 'error');
            }
        }

        // Filter workers
        function filterWorkers(type) {
            // Filtrer d'abord par branche
            const branchTravailleurs = travailleurs.filter(w => w.branch === selectedBranch);
            
            // Puis par type
            const filtered = type === 'all' 
                ? branchTravailleurs 
                : branchTravailleurs.filter(w => w.type === type);
            
            const tbody = document.getElementById('workersTable');
            tbody.innerHTML = '';
            
            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-4">
                            <div class="text-muted">
                                <i class="fas fa-users fa-2x mb-3"></i>
                                <p>Aucun travailleur trouvé</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            filtered.forEach((teacher, index) => {
                const badgeClass = teacher.paymentMode === 'bank' ? 'badge-bank' :
                                 teacher.paymentMode === 'momo' ? 'badge-momo' : 'badge-cash';
                const paymentText = teacher.paymentMode === 'bank' ? 'Banque' :
                                  teacher.paymentMode === 'momo' ? 'Mobile Money' : 'Espèces';
                
                const typeBadge = teacher.type === 'enseignant' ? 'badge bg-success' :
                                teacher.type === 'staff' ? 'badge bg-info' : 'badge bg-secondary';
                const typeText = teacher.type === 'enseignant' ? 'Enseignant' :
                               teacher.type === 'staff' ? 'Staff' : 'Autre';
                
                const workerDebts = debts.filter(d => d.workerId === teacher.id && d.status === 'pending');
                const totalDebt = workerDebts.reduce((sum, debt) => sum + (debt.amount || 0), 0);
                
                const tr = document.createElement('tr');
                tr.className = 'animate-fade-in';
                tr.innerHTML = `
                    <td>${teacher.no}</td>
                    <td><strong>${teacher.name}</strong></td>
                    <td><span class="${typeBadge}">${typeText}</span></td>
                    <td>${teacher.phone || ''}</td>
                    <td><span class="${badgeClass}">${paymentText}</span></td>
                    <td>${formatCurrencyRWF(teacher.salary || 0)}</td>
                    <td>
                        ${totalDebt > 0 ? 
                            `<span class="debt-badge" onclick="showDebtDetails('${teacher.id}')">${formatCurrencyRWF(totalDebt)}</span>` : 
                            'Aucune'}
                    </td>
                    <td><span class="badge bg-success">${teacher.status || 'active'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editWorker('${teacher.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info me-1" onclick="addDebtForWorker('${teacher.id}')">
                            <i class="fas fa-money-bill-wave"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteWorkerPrompt('${teacher.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Load current month debts
        async function loadCurrentMonthDebts() {
            try {
                const tbody = document.getElementById('currentMonthDebtsTable');
                tbody.innerHTML = '';
                
                const currentMonth = new Date().getMonth() + 1;
                const currentYear = new Date().getFullYear();
                
                const monthDebts = debts.filter(debt => {
                    if (debt.status !== 'pending') return false;
                    const debtDate = new Date(debt.date);
                    return debtDate.getMonth() + 1 === currentMonth && 
                           debtDate.getFullYear() === currentYear;
                });
                
                if (monthDebts.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="fas fa-money-bill-wave fa-2x mb-3"></i>
                                    <p>Aucune dette pour ce mois</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                monthDebts.forEach((debt, index) => {
                    const worker = travailleurs.find(t => t.id === debt.workerId);
                    if (!worker || worker.branch !== selectedBranch) return;
                    
                    const tr = document.createElement('tr');
                    tr.className = 'animate-fade-in';
                    tr.innerHTML = `
                        <td>${worker ? worker.name : 'Inconnu'}</td>
                        <td>${worker ? (worker.type === 'enseignant' ? 'Enseignant' : worker.type === 'staff' ? 'Staff' : 'Autre') : ''}</td>
                        <td><strong class="text-danger">${formatCurrencyRWF(debt.amount)}</strong></td>
                        <td>${new Date(debt.date).toLocaleDateString('fr-FR')}</td>
                        <td>${debt.reason}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-success me-1" onclick="markDebtPaid('${debt.id}')">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteDebt('${debt.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                
            } catch (error) {
                console.error('Erreur chargement dettes:', error);
            }
        }

        // Show worker modal
        function showWorkerModal() {
            document.getElementById('workerForm').reset();
            currentTeacherId = null;
            document.getElementById('workerHireDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('workerBranch').value = selectedBranch;
            document.getElementById('deleteWorkerBtn').style.display = 'none';
            const modal = new bootstrap.Modal(document.getElementById('workerModal'));
            modal.show();
        }

        // Toggle payment info
        function togglePaymentInfo() {
            const mode = document.getElementById('workerPaymentMode').value;
            
            document.getElementById('bankInfo').classList.add('d-none');
            document.getElementById('momoInfo').classList.add('d-none');
            
            if (mode === 'bank') {
                document.getElementById('bankInfo').classList.remove('d-none');
            } else if (mode === 'momo') {
                document.getElementById('momoInfo').classList.remove('d-none');
            }
        }

        // Save worker
        function resetWorkerForm() {
            document.getElementById('workerForm').reset();
            currentTeacherId = null;
            document.getElementById('deleteWorkerBtn').style.display = 'none';
            document.getElementById('bankInfo').classList.add('d-none');
            document.getElementById('momoInfo').classList.add('d-none');
            document.getElementById('workerHireDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('workerBranch').value = selectedBranch;
        }

        async function saveWorker() {
            const form = document.getElementById('workerForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const workerData = {
                no: document.getElementById('workerNo').value,
                name: document.getElementById('workerName').value,
                type: document.getElementById('workerType').value,
                phone: document.getElementById('workerPhone').value,
                salary: parseFloat(document.getElementById('workerSalary').value),
                paymentMode: document.getElementById('workerPaymentMode').value,
                accountNo: document.getElementById('workerAccountNo').value || '',
                bankName: document.getElementById('workerBankName').value || '',
                momoOperator: document.getElementById('workerMomoOperator').value || '',
                momoNumber: document.getElementById('workerMomoNumber').value || '',
                status: 'active',
                hireDate: document.getElementById('workerHireDate').value || '',
                branch: document.getElementById('workerBranch').value,
                timestamp: Date.now(),
                createdBy: currentUserName
            };
            
            try {
                if (currentTeacherId) {
                    await travailleursRef.child(currentTeacherId).update(workerData);
                    showToast('Travailleur mis à jour avec succès!', 'success');
                    
                    await announcementsRef.push({
                        timestamp: Date.now(),
                        message: `Travailleur ${workerData.name} mis à jour`,
                        author: 'system',
                        type: 'worker_update'
                    });
                } else {
                    const existingSnapshot = await travailleursRef
                        .orderByChild('no')
                        .equalTo(workerData.no)
                        .once('value');
                    
                    if (existingSnapshot.exists()) {
                        showToast('Ce numéro de travailleur existe déjà!', 'error');
                        return;
                    }
                    
                    await travailleursRef.push(workerData);
                    showToast('Travailleur ajouté avec succès!', 'success');
                    
                    await announcementsRef.push({
                        timestamp: Date.now(),
                        message: `Nouveau travailleur ajouté: ${workerData.name}`,
                        author: 'system',
                        type: 'worker_add'
                    });
                }
                
                bootstrap.Modal.getInstance(document.getElementById('workerModal')).hide();
                resetWorkerForm();
                
            } catch (error) {
                console.error('Erreur sauvegarde travailleur:', error);
                showToast('Erreur lors de la sauvegarde: ' + error.message, 'error');
            }
        }

        // Edit worker
        function editWorker(id) {
            const worker = travailleurs.find(t => t.id === id);
            if (!worker) return;
            
            currentTeacherId = id;
            
            document.getElementById('workerNo').value = worker.no || '';
            document.getElementById('workerName').value = worker.name || '';
            document.getElementById('workerType').value = worker.type || '';
            document.getElementById('workerPhone').value = worker.phone || '';
            document.getElementById('workerSalary').value = worker.salary || '';
            document.getElementById('workerPaymentMode').value = worker.paymentMode || '';
            document.getElementById('workerAccountNo').value = worker.accountNo || '';
            document.getElementById('workerBankName').value = worker.bankName || '';
            document.getElementById('workerMomoOperator').value = worker.momoOperator || '';
            document.getElementById('workerMomoNumber').value = worker.momoNumber || '';
            document.getElementById('workerHireDate').value = worker.hireDate || '';
            document.getElementById('workerBranch').value = worker.branch || selectedBranch;
            
            // Afficher le bouton supprimer en mode édition
            document.getElementById('deleteWorkerBtn').style.display = 'block';
            
            togglePaymentInfo();
            
            const modal = new bootstrap.Modal(document.getElementById('workerModal'));
            modal.show();
        }

        // Prompt for worker deletion
        function deleteWorkerPrompt(workerId) {
            const worker = travailleurs.find(t => t.id === workerId);
            if (!worker) return;
            
            if (confirm(`Êtes-vous sûr de vouloir supprimer le travailleur ${worker.name}?`)) {
                deleteWorker(workerId);
            }
        }

        // Delete worker
        async function deleteWorker(workerId) {
            try {
                const worker = travailleurs.find(t => t.id === workerId);
                if (!worker) return;
                
                await travailleursRef.child(workerId).remove();
                showToast('Travailleur supprimé avec succès!', 'success');
                
                await announcementsRef.push({
                    timestamp: Date.now(),
                    message: `Travailleur ${worker.name} supprimé`,
                    author: 'system',
                    type: 'worker_delete'
                });
                
                // Fermer le modal si ouvert
                const modal = bootstrap.Modal.getInstance(document.getElementById('workerModal'));
                if (modal) modal.hide();
                
            } catch (error) {
                console.error('Erreur suppression travailleur:', error);
                showToast('Erreur lors de la suppression', 'error');
            }
        }

        // Add debt for worker
        function addDebtForWorker(workerId) {
            currentTeacherId = workerId;
            showDebtModal();
        }

        // Show debt modal
        function showDebtModal() {
            updateDebtWorkerSelect();
            document.getElementById('debtForm').reset();
            document.getElementById('debtDate').value = new Date().toISOString().split('T')[0];
            
            if (currentTeacherId) {
                document.getElementById('debtWorker').value = currentTeacherId;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('debtModal'));
            modal.show();
        }

        // Update debt worker select
        function updateDebtWorkerSelect() {
            const select = document.getElementById('debtWorker');
            select.innerHTML = '<option value="">Sélectionnez un travailleur</option>';
            
            // Filtrer par branche
            const branchTravailleurs = travailleurs.filter(w => w.branch === selectedBranch);
            
            branchTravailleurs.forEach(worker => {
                const option = document.createElement('option');
                option.value = worker.id;
                option.textContent = `${worker.no} - ${worker.name} (${worker.type})`;
                select.appendChild(option);
            });
        }

        // Save debt
        async function saveDebt() {
            const form = document.getElementById('debtForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const workerId = document.getElementById('debtWorker').value;
            const worker = travailleurs.find(t => t.id === workerId);
            
            if (!worker) {
                showToast('Veuillez sélectionner un travailleur', 'error');
                return;
            }
            
            const debtData = {
                workerId: workerId,
                workerName: worker.name,
                amount: parseFloat(document.getElementById('debtAmount').value),
                reason: document.getElementById('debtReason').value,
                date: document.getElementById('debtDate').value,
                status: document.getElementById('debtStatus').value,
                timestamp: Date.now(),
                addedBy: currentUserName
            };
            
            try {
                await debtsRef.push(debtData);
                showToast('Dette enregistrée avec succès!', 'success');
                
                await announcementsRef.push({
                    timestamp: Date.now(),
                    message: `Dette enregistrée pour ${worker.name}: ${formatCurrencyRWF(debtData.amount)}`,
                    author: 'system',
                    type: 'debt_added'
                });
                
                bootstrap.Modal.getInstance(document.getElementById('debtModal')).hide();
                loadCurrentMonthDebts();
                
            } catch (error) {
                console.error('Erreur enregistrement dette:', error);
                showToast('Erreur lors de l\'enregistrement', 'error');
            }
        }

        // Show debt details
        function showDebtDetails(workerId) {
            const workerDebts = debts.filter(d => d.workerId === workerId && d.status === 'pending');
            const worker = travailleurs.find(t => t.id === workerId);
            
            if (workerDebts.length === 0) {
                showToast('Aucune dette pour ce travailleur', 'info');
                return;
            }
            
            let details = `Dettes pour ${worker.name}:\n\n`;
            workerDebts.forEach((debt, index) => {
                details += `${index + 1}. ${formatCurrencyRWF(debt.amount)} - ${debt.reason} (${new Date(debt.date).toLocaleDateString('fr-FR')})\n`;
            });
            
            const total = workerDebts.reduce((sum, debt) => sum + (debt.amount || 0), 0);
            details += `\nTotal: ${formatCurrencyRWF(total)}`;
            
            alert(details);
        }

        // Mark debt as paid
        async function markDebtPaid(debtId) {
            try {
                await debtsRef.child(debtId).update({
                    status: 'paid',
                    paidDate: new Date().toISOString().split('T')[0],
                    paidBy: currentUserName
                });
                
                showToast('Dette marquée comme payée!', 'success');
                loadCurrentMonthDebts();
                
            } catch (error) {
                console.error('Erreur mise à jour dette:', error);
                showToast('Erreur lors de la mise à jour', 'error');
            }
        }

        // Delete debt
        async function deleteDebt(debtId) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer cette dette?')) return;
            
            try {
                await debtsRef.child(debtId).remove();
                showToast('Dette supprimée avec succès!', 'success');
                loadCurrentMonthDebts();
                
            } catch (error) {
                console.error('Erreur suppression dette:', error);
                showToast('Erreur lors de la suppression', 'error');
            }
        }

        // Load students
        async function loadStudents() {
            try {
                const tbody = document.getElementById('studentsTable');
                tbody.innerHTML = '';
                
                // Filtrer par branche
                const branchStudents = students.filter(student => student.branch === selectedBranch);
                
                if (branchStudents.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="fas fa-child fa-2x mb-3"></i>
                                    <p>Aucun élève trouvé dans cette branche</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                branchStudents.forEach((student, index) => {
                    // Calculer le total payé par cet élève
                    const studentPayments = studentFees.filter(fee => fee.studentId === student.id);
                    const totalPaid = studentPayments.reduce((sum, payment) => sum + (payment.amount || 0), 0);
                    
                    const tr = document.createElement('tr');
                    tr.className = 'animate-fade-in';
                    tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td><strong>${student.reference || 'N/A'}</strong></td>
                        <td>${student.fullName}</td>
                        <td>${student.class || ''}</td>
                        <td>${student.birthDate ? new Date(student.birthDate).toLocaleDateString('fr-FR') : ''}</td>
                        <td>${formatCurrencyRWF(totalPaid)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="viewStudentProfile('${student.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info me-1" onclick="editStudent('${student.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteStudentPrompt('${student.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                
            } catch (error) {
                console.error('Erreur chargement élèves:', error);
                showToast('Erreur lors du chargement des élèves', 'error');
            }
        }

        // Load students from database (actualiser)
        function loadStudentsFromDatabase() {
            loadStudents();
            showToast('Liste des élèves actualisée', 'success');
        }

        // Search student
        function searchStudent() {
            const query = document.getElementById('searchStudent').value.toLowerCase().trim();
            if (!query) {
                loadStudents();
                return;
            }
            
            // Filtrer par branche d'abord
            const branchStudents = students.filter(student => student.branch === selectedBranch);
            
            const found = branchStudents.filter(s => 
                s.fullName.toLowerCase().includes(query) || 
                (s.reference && s.reference.toLowerCase().includes(query)) ||
                (s.class && s.class.toLowerCase().includes(query))
            );
            
            const tbody = document.getElementById('studentsTable');
            tbody.innerHTML = '';
            
            if (found.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <div class="text-muted">
                                <i class="fas fa-search fa-2x mb-3"></i>
                                <p>Aucun élève trouvé</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            found.forEach((student, index) => {
                const studentPayments = studentFees.filter(fee => fee.studentId === student.id);
                const totalPaid = studentPayments.reduce((sum, payment) => sum + (payment.amount || 0), 0);
                
                const tr = document.createElement('tr');
                tr.className = 'animate-fade-in';
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td><strong>${student.reference || 'N/A'}</strong></td>
                    <td>${student.fullName}</td>
                    <td>${student.class || ''}</td>
                    <td>${student.birthDate ? new Date(student.birthDate).toLocaleDateString('fr-FR') : ''}</td>
                    <td>${formatCurrencyRWF(totalPaid)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="viewStudentProfile('${student.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info me-1" onclick="editStudent('${student.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteStudentPrompt('${student.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // View student profile
        function viewStudentProfile(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            currentStudentId = studentId;
            
            // Afficher les informations de base
            document.getElementById('studentNameProfile').textContent = student.fullName;
            document.getElementById('studentClassProfile').textContent = `Classe: ${student.class || 'Non spécifiée'}`;
            
            // Calculer l'âge
            if (student.birthDate) {
                const birthDate = new Date(student.birthDate);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                document.getElementById('studentAgeProfile').textContent = `Âge: ${age} ans`;
            } else {
                document.getElementById('studentAgeProfile').textContent = 'Âge: Non spécifié';
            }
            
            document.getElementById('studentReferenceProfile').textContent = `Réf: ${student.reference || 'N/A'}`;
            
            // Charger l'historique des paiements
            loadStudentPaymentsHistory(studentId);
            
            // Afficher la section profil
            document.getElementById('studentProfile').style.display = 'block';
        }

        // Handle Excel import for students
        function handleImportExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = e.target.result;
                let workbook;
                try {
                    workbook = XLSX.read(data, { type: 'array' });
                } catch (err) {
                    console.error('Erreur lecture Excel:', err);
                    showToast('Fichier Excel invalide', 'error');
                    return;
                }
                const firstSheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[firstSheetName];
                const rows = XLSX.utils.sheet_to_json(sheet, { defval: '' });
                if (!rows || rows.length === 0) {
                    showToast('Fichier Excel vide ou format non reconnu', 'error');
                    return;
                }

                // Map rows to student objects. Support multiple header names.
                const Normalize = (s) => (s || '').toString().trim().toLowerCase();
                const uploadPromises = [];
                rows.forEach(r => {
                    const keys = Object.keys(r);
                    // Attempt to find common columns
                    const refKey = keys.find(k => /ref|reference|réf|id/i.test(k));
                    const nameKey = keys.find(k => /name|nom|full/i.test(k));
                    const classKey = keys.find(k => /class|classe|niveau/i.test(k));
                    const birthKey = keys.find(k => /birth|date|naiss/i.test(k));
                    const branchKey = keys.find(k => /branch|branche/i.test(k));

                    const studentObj = {
                        reference: refKey ? r[refKey] : (r.reference || ''),
                        fullName: nameKey ? r[nameKey] : (r.fullName || r.nom || r.Name || ''),
                        class: classKey ? r[classKey] : (r.class || r.Classe || ''),
                        birthDate: birthKey ? (new Date(r[birthKey]).toISOString().split('T')[0]) : (r.birthDate || ''),
                        branch: branchKey ? r[branchKey] : (r.branch || selectedBranch || ''),
                        timestamp: Date.now(),
                    };

                    // Basic validation
                    if (!studentObj.fullName) return; // skip incomplete rows

                    // Push to Firebase
                    uploadPromises.push(studentsRef.push(studentObj));
                });

                Promise.all(uploadPromises).then(() => {
                    showToast(`Import terminé (${uploadPromises.length} élèves)`, 'success');
                    // Refresh students
                    loadStudents();
                }).catch(err => {
                    console.error('Erreur upload élèves:', err);
                    showToast('Erreur lors de l\'import des élèves', 'error');
                });
            };
            reader.readAsArrayBuffer(file);
        }

        // Simple PDF import handler (inform user PDF import is not supported automatically)
        function handleImportPdf(event) {
            const file = event.target.files[0];
            if (!file) return;
            showToast('Import PDF non pris en charge. Convertissez le PDF en Excel/CSV puis importez.', 'info');
        }

        // Language toggle: switch EN/FR and update UI
        function applyTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    el.textContent = translations[currentLanguage][key];
                }
            });
        }

        document.getElementById('languageToggle').addEventListener('click', function() {
            currentLanguage = currentLanguage === 'fr' ? 'en' : 'fr';
            document.getElementById('languageText').textContent = currentLanguage.toUpperCase();
            applyTranslations();
            showToast(currentLanguage === 'fr' ? 'Langue: Français' : 'Language: English', 'success');
        });

        // Load student payments history
        function loadStudentPaymentsHistory(studentId) {
            const tbody = document.getElementById('studentPaymentsHistory');
            tbody.innerHTML = '';
            
            const studentPayments = studentFees.filter(fee => fee.studentId === studentId);
            
            if (studentPayments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-3">
                            <div class="text-muted">
                                <i class="fas fa-money-bill-wave fa-2x mb-2"></i>
                                <p>Aucun paiement enregistré</p>
                            </div>
                        </td>
                    </tr>
                `;
                document.getElementById('totalPaid').textContent = '0 RWF';
                document.getElementById('remainingBalance').textContent = '0 RWF';
                return;
            }
            
            studentPayments.sort((a, b) => new Date(b.paymentDate) - new Date(a.paymentDate));
            
            studentPayments.forEach((payment, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${payment.reference || 'N/A'}</td>
                    <td>${new Date(payment.paymentDate).toLocaleDateString('fr-FR')}</td>
                    <td><span class="badge-minervale">${getPaymentTypeText(payment.paymentType)}</span></td>
                    <td><strong>${formatCurrencyRWF(payment.amount)}</strong></td>
                    <td><span class="badge ${payment.paymentMode === 'bank' ? 'badge-bank' : payment.paymentMode === 'momo' ? 'badge-momo' : 'badge-cash'}">${payment.paymentMode === 'bank' ? 'Banque' : payment.paymentMode === 'momo' ? 'Mobile Money' : 'Espèces'}</span></td>
                    <td>${payment.receivedBy || 'N/A'}</td>
                `;
                tbody.appendChild(tr);
            });
            
            // Calculer les totaux
            const totalPaid = studentPayments.reduce((sum, payment) => sum + (payment.amount || 0), 0);
            document.getElementById('totalPaid').textContent = formatCurrencyRWF(totalPaid);
            
            // Ici vous pourriez ajouter la logique pour calculer le solde restant
            // basé sur les frais configurés pour la classe
            document.getElementById('remainingBalance').textContent = formatCurrencyRWF(0);
        }

        // Get payment type text
        function getPaymentTypeText(type) {
            const types = {
                'minervale': 'Minervale',
                'coaching': 'Coaching',
                'transport': 'Transport',
                'uniforme': 'Uniforme',
                'lunch': 'Lunch',
                'breakfast': 'Breakfast',
                'material': 'Matériel',
                'insurance': 'Assurance',
                'autre': 'Autre'
            };
            return types[type] || type;
        }

        // Edit student
        function editStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            currentStudentId = studentId;
            
            document.getElementById('studentReference').value = student.reference || '';
            document.getElementById('studentFullName').value = student.fullName || '';
            document.getElementById('studentBirthDate').value = student.birthDate || '';
            document.getElementById('studentClass').value = student.class || '';
            document.getElementById('studentParent').value = student.parent || '';
            document.getElementById('studentParentPhone').value = student.parentPhone || '';
            document.getElementById('studentBranch').value = student.branch || selectedBranch;
            
            const modal = new bootstrap.Modal(document.getElementById('studentModal'));
            modal.show();
        }

        // Save student
        async function saveStudent() {
            const form = document.getElementById('studentForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const studentData = {
                reference: document.getElementById('studentReference').value,
                fullName: document.getElementById('studentFullName').value,
                birthDate: document.getElementById('studentBirthDate').value,
                class: document.getElementById('studentClass').value,
                parent: document.getElementById('studentParent').value || '',
                parentPhone: document.getElementById('studentParentPhone').value || '',
                branch: document.getElementById('studentBranch').value,
                status: 'active',
                timestamp: Date.now(),
                createdBy: currentUserName
            };
            
            try {
                if (currentStudentId) {
                    await studentsRef.child(currentStudentId).update(studentData);
                    showToast('Élève mis à jour avec succès!', 'success');
                } else {
                    // Vérifier si la référence existe déjà
                    const existingSnapshot = await studentsRef
                        .orderByChild('reference')
                        .equalTo(studentData.reference)
                        .once('value');
                    
                    if (existingSnapshot.exists()) {
                        showToast('Cette référence existe déjà!', 'error');
                        return;
                    }
                    
                    await studentsRef.push(studentData);
                    showToast('Élève ajouté avec succès!', 'success');
                }
                
                bootstrap.Modal.getInstance(document.getElementById('studentModal')).hide();
                document.getElementById('studentForm').reset();
                currentStudentId = null;
                
                // Générer une nouvelle référence
                generateStudentReference();
                
            } catch (error) {
                console.error('Erreur sauvegarde élève:', error);
                showToast('Erreur lors de la sauvegarde', 'error');
            }
        }

        // Generate student reference
        function generateStudentReference() {
            const now = new Date();
            const timestamp = now.getTime();
            const random = Math.floor(Math.random() * 1000);
            document.getElementById('studentReference').value = `EDU-${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}-${timestamp.toString().slice(-6)}${random.toString().padStart(3, '0')}`;
        }

        // Show student modal for adding a new student
        function showStudentModal() {
            const form = document.getElementById('studentForm');
            if (form) form.reset();
            currentStudentId = null;
            // Generate a fresh reference
            generateStudentReference();
            // Preselect branch
            if (document.getElementById('studentBranch')) {
                document.getElementById('studentBranch').value = selectedBranch;
            }
            const modalEl = document.getElementById('studentModal');
            if (modalEl) {
                const modal = new bootstrap.Modal(modalEl);
                modal.show();
            }
        }

        // Delete student prompt
        function deleteStudentPrompt(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            if (confirm(`Êtes-vous sûr de vouloir supprimer l'élève ${student.fullName}?`)) {
                deleteStudent(studentId);
            }
        }

        // Delete student
        async function deleteStudent(studentId) {
            try {
                const student = students.find(s => s.id === studentId);
                if (!student) return;
                
                await studentsRef.child(studentId).remove();
                showToast('Élève supprimé avec succès!', 'success');
                
            } catch (error) {
                console.error('Erreur suppression élève:', error);
                showToast('Erreur lors de la suppression', 'error');
            }
        }

        // Show student fee modal
        function showStudentFeeModal() {
            document.getElementById('studentFeeForm').reset();
            currentStudentFeeId = null;
            document.getElementById('studentPaymentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('studentInfoDisplay').style.display = 'none';
            
            // Charger les élèves de la branche sélectionnée
            loadStudentsByClass();
            
            const modal = new bootstrap.Modal(document.getElementById('studentFeeModal'));
            modal.show();
        }

        // Load students by class
        function loadStudentsByClass() {
            const selectedClass = document.getElementById('studentClassFilter').value;
            const select = document.getElementById('studentSelect');
            select.innerHTML = '<option value="">Sélectionnez un élève</option>';
            
            if (!selectedClass) return;
            
            // Filtrer par branche et classe
            const classStudents = students.filter(student => 
                student.branch === selectedBranch && 
                student.class === selectedClass
            );
            
            classStudents.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.reference} - ${student.fullName}`;
                select.appendChild(option);
            });
        }

        // Load student details when selected
        function loadStudentDetails() {
            const studentId = document.getElementById('studentSelect').value;
            const student = students.find(s => s.id === studentId);
            
            if (!student) {
                document.getElementById('studentInfoDisplay').style.display = 'none';
                return;
            }
            
            document.getElementById('studentReferenceDisplay').value = student.reference || 'N/A';
            document.getElementById('studentBirthDateDisplay').value = student.birthDate ? new Date(student.birthDate).toLocaleDateString('fr-FR') : 'N/A';
            document.getElementById('studentParentDisplay').value = student.parent || 'N/A';
            
            document.getElementById('studentInfoDisplay').style.display = 'flex';
        }

        // Save student fee
        async function saveStudentFee() {
            const form = document.getElementById('studentFeeForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const studentId = document.getElementById('studentSelect').value;
            const student = students.find(s => s.id === studentId);
            
            if (!student) {
                showToast('Veuillez sélectionner un élève', 'error');
                return;
            }
            
            const feeData = {
                studentId: studentId,
                studentName: student.fullName,
                studentClass: student.class,
                reference: document.getElementById('studentTransactionRef').value || `PAY-${Date.now()}`,
                paymentType: document.getElementById('studentPaymentType').value,
                amount: parseFloat(document.getElementById('studentAmount').value),
                paymentMode: document.getElementById('studentPaymentMode').value,
                paymentDate: document.getElementById('studentPaymentDate').value,
                notes: document.getElementById('studentPaymentNotes').value || '',
                receivedBy: currentUserName,
                timestamp: Date.now(),
                branch: student.branch
            };
            
            try {
                await studentFeesRef.push(feeData);
                showToast('Paiement enregistré avec succès!', 'success');
                
                await announcementsRef.push({
                    timestamp: Date.now(),
                    message: `Paiement enregistré pour ${student.fullName}: ${formatCurrencyRWF(feeData.amount)}`,
                    author: 'system',
                    type: 'student_payment'
                });
                
                bootstrap.Modal.getInstance(document.getElementById('studentFeeModal')).hide();
                document.getElementById('studentFeeForm').reset();
                
            } catch (error) {
                console.error('Erreur enregistrement paiement:', error);
                showToast('Erreur lors de l\'enregistrement', 'error');
            }
        }

        // Load student fees
        async function loadStudentFees() {
            try {
                const tbody = document.getElementById('studentFeesTable');
                tbody.innerHTML = '';
                
                // Filtrer par branche
                const branchFees = studentFees.filter(fee => {
                    const student = students.find(s => s.id === fee.studentId);
                    return student && student.branch === selectedBranch;
                });
                
                if (branchFees.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="11" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="fas fa-money-bill-wave fa-2x mb-3"></i>
                                    <p>Aucun paiement trouvé dans cette branche</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                branchFees.sort((a, b) => new Date(b.paymentDate) - new Date(a.paymentDate));
                
                branchFees.forEach((fee, index) => {
                    const student = students.find(s => s.id === fee.studentId);
                    const paymentTypeBadge = fee.paymentType === 'minervale' ? 'badge-minervale' :
                                           fee.paymentType === 'coaching' ? 'badge-coaching' :
                                           fee.paymentType === 'transport' ? 'badge-transport' :
                                           'badge bg-secondary';
                    
                    const tr = document.createElement('tr');
                    tr.className = 'animate-fade-in';
                    tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td><strong>${fee.reference || 'N/A'}</strong></td>
                        <td>${fee.studentName || 'N/A'}</td>
                        <td>${fee.studentClass || 'N/A'}</td>
                        <td><span class="${paymentTypeBadge}">${getPaymentTypeText(fee.paymentType)}</span></td>
                        <td><strong>${formatCurrencyRWF(fee.amount)}</strong></td>
                        <td>${new Date(fee.paymentDate).toLocaleDateString('fr-FR')}</td>
                        <td><span class="${fee.paymentMode === 'bank' ? 'badge-bank' : fee.paymentMode === 'momo' ? 'badge-momo' : 'badge-cash'}">${fee.paymentMode === 'bank' ? 'Banque' : fee.paymentMode === 'momo' ? 'Mobile Money' : 'Espèces'}</span></td>
                        <td>${formatCurrencyRWF(0)}</td>
                        <td>${fee.receivedBy || 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteStudentFeePrompt('${fee.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                
            } catch (error) {
                console.error('Erreur chargement paiements:', error);
                showToast('Erreur lors du chargement des paiements', 'error');
            }
        }

        // Delete student fee prompt
        function deleteStudentFeePrompt(feeId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer ce paiement?')) {
                deleteStudentFee(feeId);
            }
        }

        // Delete student fee
        async function deleteStudentFee(feeId) {
            try {
                await studentFeesRef.child(feeId).remove();
                showToast('Paiement supprimé avec succès!', 'success');
                
            } catch (error) {
                console.error('Erreur suppression paiement:', error);
                showToast('Erreur lors de la suppression', 'error');
            }
        }

        // Filter student payments
        function filterStudentPayments() {
            const selectedClass = document.getElementById('filterClass').value;
            const selectedMonth = document.getElementById('filterMonth').value;
            
            const tbody = document.getElementById('studentFeesTable');
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach(row => {
                let showRow = true;
                
                // Filtrer par classe
                if (selectedClass) {
                    const classCell = row.cells[3]; // Index de la cellule classe
                    if (classCell && !classCell.textContent.includes(selectedClass)) {
                        showRow = false;
                    }
                }
                
                // Filtrer par mois
                if (selectedMonth) {
                    const dateCell = row.cells[6]; // Index de la cellule date
                    if (dateCell) {
                        const rowDate = new Date(dateCell.textContent);
                        const rowMonth = `${rowDate.getFullYear()}-${(rowDate.getMonth() + 1).toString().padStart(2, '0')}`;
                        if (rowMonth !== selectedMonth) {
                            showRow = false;
                        }
                    }
                }
                
                row.style.display = showRow ? '' : 'none';
            });
        }

        // Update daily report table with automatic calculation
        function updateDailyReportTable() {
            const date = document.getElementById('dailyReportDate').value;
            
            if (!date) {
                console.error('Date non spécifiée');
                return;
            }
            
            // Calculer les paiements du jour par catégorie (filtrer par branche)
            const dayFees = studentFees.filter(fee => {
                const feeDate = new Date(fee.paymentDate);
                const feeDateStr = feeDate.toISOString().split('T')[0];
                
                // Vérifier aussi la branche
                const student = students.find(s => s.id === fee.studentId);
                return feeDateStr === date && student && student.branch === selectedBranch;
            });
            
            // Initialiser les totaux par catégorie
            let minerval = 0;
            let transport = 0;
            let coaching = 0;
            let uniforme = 0;
            let autres = 0;
            
            // Calculer les totaux par catégorie
            dayFees.forEach(fee => {
                const amount = parseFloat(fee.amount) || 0;
                switch(fee.paymentType) {
                    case 'minervale':
                        minerval += amount;
                        break;
                    case 'transport':
                        transport += amount;
                        break;
                    case 'coaching':
                        coaching += amount;
                        break;
                    case 'uniforme':
                        uniforme += amount;
                        break;
                    default:
                        autres += amount;
                        break;
                }
            });
            
            // Calculer les dépenses du jour (depuis dailyExpenses) - filtrer par branche
            const dayExpenses = dailyExpenses.filter(expense => expense.date === date && expense.branch === selectedBranch);
            const totalDepenses = dayExpenses.reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
            
            // Préparer les justifications (catégories des dépenses)
            const justifications = dayExpenses.length > 0 
                ? dayExpenses.map(exp => `${exp.category}: ${formatCurrencyRWF(exp.amount)}`).join('<br>')
                : 'Aucune dépense enregistrée';
            
            // Récupérer le solde d'ouverture (depuis localStorage ou 0)
            const soldeOuverture = parseFloat(localStorage.getItem(`openingBalance_${date}_${selectedBranch}`)) || 0;
            
            // Calculer les totaux
            const totalEntrees = minerval + transport + coaching + uniforme + autres;
            const soldeFinal = soldeOuverture + totalEntrees - totalDepenses;
            const difference = totalEntrees - totalDepenses;
            
            // Mettre à jour le tableau
            const tbody = document.getElementById('dailyReportBody');
            tbody.innerHTML = `
                <tr>
                    <td>
                        <input type="number" class="form-control opening-balance-input" 
                               id="openingBalance" value="${soldeOuverture}" 
                               onchange="saveOpeningBalance('${date}')">
                    </td>
                    <td><strong class="money-in">${formatCurrencyRWF(minerval).replace('RWF', '')}</strong></td>
                    <td><strong class="money-in">${formatCurrencyRWF(transport).replace('RWF', '')}</strong></td>
                    <td><strong class="money-in">${formatCurrencyRWF(coaching).replace('RWF', '')}</strong></td>
                    <td><strong class="money-in">${formatCurrencyRWF(uniforme).replace('RWF', '')}</strong></td>
                    <td><strong class="money-in">${formatCurrencyRWF(autres).replace('RWF', '')}</strong></td>
                    <td class="justification-cell"><small>${justifications}</small></td>
                    <td><strong class="money-out">${formatCurrencyRWF(totalDepenses).replace('RWF', '')}</strong></td>
                    <td><strong class="money-out">${formatCurrencyRWF(totalDepenses).replace('RWF', '')}</strong></td>
                    <td><strong class="balance">${formatCurrencyRWF(soldeFinal).replace('RWF', '')}</strong></td>
                    <td><strong class="${difference >= 0 ? 'money-in' : 'money-out'}">
                        ${formatCurrencyRWF(difference).replace('RWF', '')}
                    </strong></td>
                </tr>
            `;
            
            // Mettre à jour le résumé des paiements du jour
            updateDaySummary(dayFees, dayExpenses, soldeOuverture, soldeFinal, difference);
        }

        // Sauvegarder le solde d'ouverture
        function saveOpeningBalance(date) {
            const openingBalance = parseFloat(document.getElementById('openingBalance').value) || 0;
            localStorage.setItem(`openingBalance_${date}_${selectedBranch}`, openingBalance);
            updateDailyReportTable(); // Recalculer tout
        }

        // Mettre à jour le résumé de la journée
        function updateDaySummary(fees, expenses, soldeOuverture, soldeFinal, difference) {
            const totalEntrees = fees.reduce((sum, fee) => sum + (parseFloat(fee.amount) || 0), 0);
            const totalDepenses = expenses.reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
            
            const summaryHTML = `
                <div class="report-summary-cards">
                    <div class="summary-card income">
                        <h6><i class="fas fa-money-bill-wave me-2"></i>Total Entrées</h6>
                        <div class="summary-value">${formatCurrencyRWF(totalEntrees)}</div>
                        <small>${fees.length} paiement(s) reçu(s)</small>
                    </div>
                    <div class="summary-card expenses">
                        <h6><i class="fas fa-shopping-cart me-2"></i>Total Dépenses</h6>
                        <div class="summary-value">${formatCurrencyRWF(totalDepenses)}</div>
                        <small>${expenses.length} dépense(s) enregistrée(s)</small>
                    </div>
                    <div class="summary-card balance">
                        <h6><i class="fas fa-wallet me-2"></i>Solde Ouverture</h6>
                        <div class="summary-value">${formatCurrencyRWF(soldeOuverture)}</div>
                        <small>Solde initial</small>
                    </div>
                    <div class="summary-card ${difference >= 0 ? 'income' : 'expenses'}">
                        <h6><i class="fas fa-balance-scale me-2"></i>Différence</h6>
                        <div class="summary-value">${formatCurrencyRWF(difference)}</div>
                        <small>${difference >= 0 ? 'Bénéfice' : 'Déficit'}</small>
                    </div>
                </div>
            `;
            
            // Ajouter le résumé au-dessus du tableau
            const existingSummary = document.getElementById('daySummary');
            if (existingSummary) {
                existingSummary.innerHTML = summaryHTML;
            } else {
                const summaryDiv = document.createElement('div');
                summaryDiv.id = 'daySummary';
                summaryDiv.innerHTML = summaryHTML;
                document.querySelector('#dailyReportSection .table-responsive').insertAdjacentElement('beforebegin', summaryDiv);
            }
        }

        // Charger le rapport journalier avec données réelles
        function loadDailyReport() {
            const date = document.getElementById('dailyReportDate').value;
            
            if (!date) {
                // Définir la date d'aujourd'hui par défaut
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('dailyReportDate').value = today;
            }
            
            // Charger les dépenses pour cette date
            loadExpensesForDate(date || document.getElementById('dailyReportDate').value);
            
            // Mettre à jour le tableau avec les données réelles
            updateDailyReportTable();
            
            // Charger un rapport existant s'il y en a un
            loadExistingReport(date);
        }

        // Charger les dépenses depuis Firebase pour une date spécifique
        async function loadExpensesForDate(date) {
            try {
                const snapshot = await dailyExpensesRef
                    .orderByChild('date')
                    .equalTo(date)
                    .once('value');
                
                dailyExpenses = [];
                snapshot.forEach(childSnapshot => {
                    const expense = {
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    };
                    dailyExpenses.push(expense);
                });
                
                console.log(`${dailyExpenses.length} dépenses chargées pour ${date}`);
                
            } catch (error) {
                console.error('Erreur chargement dépenses:', error);
            }
        }

        // Mettre à jour la liste des dépenses (affichée sous le formulaire)
        function updateExpensesList() {
            const container = document.getElementById('expensesList');
            container.innerHTML = '';
            
            const date = document.getElementById('dailyReportDate').value;
            const dayExpenses = dailyExpenses.filter(exp => exp.date === date && exp.branch === selectedBranch);
            
            if (dayExpenses.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Aucune dépense enregistrée pour le ${new Date(date).toLocaleDateString('fr-FR')}
                    </div>
                `;
                return;
            }
            
            // Créer une carte pour chaque dépense
            dayExpenses.forEach(expense => {
                const expenseCard = document.createElement('div');
                expenseCard.className = 'expense-item';
                expenseCard.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${expense.category}</strong>
                            <div class="text-muted">${expense.addedBy} - ${new Date(expense.timestamp).toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'})}</div>
                        </div>
                        <div class="text-end">
                            <div class="text-danger fw-bold">${formatCurrencyRWF(expense.amount)}</div>
                            <button class="btn btn-sm btn-outline-danger mt-1" onclick="removeExpense('${expense.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(expenseCard);
            });
            
            // Ajouter le total
            const total = dayExpenses.reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
            const totalDiv = document.createElement('div');
            totalDiv.className = 'mt-3 p-3 bg-light rounded';
            totalDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <strong>Total des dépenses pour cette journée:</strong>
                    <strong class="text-danger fs-5">${formatCurrencyRWF(total)}</strong>
                </div>
            `;
            container.appendChild(totalDiv);
        }

        // Ajouter une dépense avec enregistrement Firebase
        async function addDailyExpense() {
            const category = document.getElementById('expenseCategory').value;
            const amountInput = document.getElementById('expenseAmount').value;
            const amount = parseFloat(amountInput);
            const date = document.getElementById('dailyReportDate').value;
            
            if (!category || !amount || amount <= 0 || !date) {
                showToast('Veuillez remplir correctement tous les champs', 'error');
                return;
            }
            
            try {
                const expenseData = {
                    category: category,
                    amount: amount,
                    date: date,
                    addedBy: currentUserName,
                    branch: selectedBranch,
                    timestamp: Date.now()
                };
                
                // Enregistrer dans Firebase
                await dailyExpensesRef.push(expenseData);
                
                // Mettre à jour l'affichage
                await loadExpensesForDate(date);
                updateExpensesList();
                updateDailyReportTable();
                
                // Réinitialiser le formulaire
                document.getElementById('expenseCategory').value = '';
                document.getElementById('expenseAmount').value = '';
                
                showToast('Dépense enregistrée avec succès', 'success');
                
            } catch (error) {
                console.error('Erreur enregistrement dépense:', error);
                showToast('Erreur lors de l\'enregistrement de la dépense', 'error');
            }
        }

        // Supprimer une dépense
        async function removeExpense(expenseId) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer cette dépense?')) return;
            
            try {
                await dailyExpensesRef.child(expenseId).remove();
                
                const date = document.getElementById('dailyReportDate').value;
                await loadExpensesForDate(date);
                updateExpensesList();
                updateDailyReportTable();
                
                showToast('Dépense supprimée avec succès', 'success');
            } catch (error) {
                console.error('Erreur suppression dépense:', error);
                showToast('Erreur lors de la suppression', 'error');
            }
        }

        // Sauvegarder le rapport journalier
        async function saveDailyReport() {
            try {
                const date = document.getElementById('dailyReportDate').value;
                const openingBalance = parseFloat(document.getElementById('openingBalance').value) || 0;
                
                // Calculer les totaux (filtrer par branche)
                const dayFees = studentFees.filter(fee => {
                    const feeDate = new Date(fee.paymentDate);
                    const feeDateStr = feeDate.toISOString().split('T')[0];
                    const student = students.find(s => s.id === fee.studentId);
                    return feeDateStr === date && student && student.branch === selectedBranch;
                });
                
                const totalIncome = dayFees.reduce((sum, fee) => sum + (fee.amount || 0), 0);
                const branchExpenses = dailyExpenses.filter(exp => exp.date === date && exp.branch === selectedBranch);
                const totalExpenses = branchExpenses.reduce((sum, exp) => sum + (exp.amount || 0), 0);
                const difference = totalIncome - totalExpenses;
                const closingBalance = openingBalance + difference;
                
                // Préparer les données du rapport
                const reportData = {
                    date: date,
                    openingBalance: openingBalance,
                    totalIncome: totalIncome,
                    totalExpenses: totalExpenses,
                    difference: difference,
                    closingBalance: closingBalance,
                    branch: selectedBranch,
                    
                    // Données du formulaire
                    generalObservations: document.getElementById('generalObservations').value,
                    status: 'draft',
                    
                    preparedBy: document.getElementById('reportPreparedBy').value,
                    generatedBy: currentUserName,
                    timestamp: Date.now(),
                    type: 'daily'
                };
                
                // Sauvegarder dans Firebase
                await dailyReportsRef.push(reportData);
                
                // Ajouter à l'historique
                await reportHistoryRef.push(reportData);
                
                showToast('Rapport journalier enregistré avec succès!', 'success');
                
            } catch (error) {
                console.error('Erreur sauvegarde rapport:', error);
                showToast('Erreur lors de l\'enregistrement du rapport', 'error');
            }
        }

        // Load existing report
        async function loadExistingReport(date) {
            try {
                const snapshot = await dailyReportsRef
                    .orderByChild('date')
                    .equalTo(date)
                    .once('value');
                
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const report = childSnapshot.val();
                        if (report.branch === selectedBranch) {
                            // Remplir le formulaire avec les données du rapport
                            document.getElementById('generalObservations').value = report.generalObservations || '';
                            document.getElementById('openingBalance').value = report.openingBalance || 0;
                            
                            showToast('Rapport existant chargé', 'info');
                        }
                    });
                }
            } catch (error) {
                console.error('Erreur chargement rapport:', error);
            }
        }

        // Show daily report
        function showDailyReport() {
            document.getElementById('dailyReportSection').style.display = 'block';
            document.getElementById('weeklyReportSection').style.display = 'none';
            document.getElementById('monthlyReportSection').style.display = 'none';
            loadDailyReport();
        }

        // Show weekly report
        function showWeeklyReport() {
            document.getElementById('dailyReportSection').style.display = 'none';
            document.getElementById('weeklyReportSection').style.display = 'block';
            document.getElementById('monthlyReportSection').style.display = 'none';
            loadWeeklyReport();
        }

        // Show monthly report
        function showMonthlyReport() {
            document.getElementById('dailyReportSection').style.display = 'none';
            document.getElementById('weeklyReportSection').style.display = 'none';
            document.getElementById('monthlyReportSection').style.display = 'block';
            loadMonthlyReport();
        }

        // Initialize charts
        function initializeCharts() {
            // Weekly chart
            const weeklyCtx = document.getElementById('weeklyChart');
            if (weeklyCtx) {
                weeklyChart = new Chart(weeklyCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'],
                        datasets: [{
                            label: 'Income (RWF)',
                            data: [0, 0, 0, 0, 0, 0, 0],
                            borderColor: 'rgba(46, 139, 87, 1)',
                            backgroundColor: 'rgba(46, 139, 87, 0.2)',
                            tension: 0.4
                        }, {
                            label: 'Expenses (RWF)',
                            data: [0, 0, 0, 0, 0, 0, 0],
                            borderColor: 'rgba(220, 20, 60, 1)',
                            backgroundColor: 'rgba(220, 20, 60, 0.2)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        }
                    }
                });
            }
            
            // Monthly chart
            const monthlyCtx = document.getElementById('monthlyChart');
            if (monthlyCtx) {
                monthlyChart = new Chart(monthlyCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'],
                        datasets: [{
                            label: 'Income (RWF)',
                            data: [0, 0, 0, 0],
                            backgroundColor: 'rgba(46, 139, 87, 0.7)',
                            borderColor: 'rgba(46, 139, 87, 1)',
                            borderWidth: 1
                        }, {
                            label: 'Expenses (RWF)',
                            data: [0, 0, 0, 0],
                            backgroundColor: 'rgba(220, 20, 60, 0.7)',
                            borderColor: 'rgba(220, 20, 60, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        // Update real payroll chart
        function updateRealPayrollChart() {
            const ctx = document.getElementById('realPayrollChart');
            if (!ctx) return;
            
            if (realPayrollChart) {
                realPayrollChart.destroy();
            }
            
            const currentYear = new Date().getFullYear();
            const monthlyData = Array(12).fill(0);
            
            // Filtrer par branche
            const branchTravailleurs = travailleurs.filter(w => w.branch === selectedBranch);
            
            // Pour l'instant, utiliser les salaires des travailleurs comme données
            monthlyData[new Date().getMonth()] = branchTravailleurs.reduce((sum, w) => sum + (w.salary || 0), 0);
            
            const monthNames = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Août', 'Sep', 'Oct', 'Nov', 'Déc'];
            
            realPayrollChart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: monthNames,
                    datasets: [{
                        label: 'Payroll Total (RWF)',
                        data: monthlyData,
                        backgroundColor: 'rgba(46, 139, 87, 0.7)',
                        borderColor: 'rgba(46, 139, 87, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    animation: {
                        duration: 2000,
                        easing: 'easeOutQuart'
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return (value / 1000000).toFixed(1) + 'M RWF';
                                    } else if (value >= 1000) {
                                        return (value / 1000).toFixed(0) + 'K RWF';
                                    }
                                    return value + ' RWF';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Save settings
        async function saveSettings() {
            const settingsData = {
                paymentDay: document.getElementById('paymentDay').value,
                currency: document.getElementById('currency').value,
                updatedBy: currentUserName,
                updatedAt: Date.now()
            };
            
            try {
                await settingsRef.set(settingsData);
                showToast('Paramètres enregistrés avec succès!', 'success');
            } catch (error) {
                console.error('Erreur sauvegarde paramètres:', error);
                showToast('Erreur lors de l\'enregistrement des paramètres', 'error');
            }
        }

        // Save accountant info
        async function saveAccountantInfo() {
            const accountantData = {
                name: document.getElementById('accountantName').value,
                title: document.getElementById('accountantTitle').value,
                email: document.getElementById('accountantEmail').value,
                updatedAt: Date.now()
            };
            
            try {
                await accountantRef.set(accountantData);
                currentUserName = accountantData.name;
                document.getElementById('userName').textContent = accountantData.name;
                document.getElementById('preparedBy').textContent = accountantData.name;
                document.getElementById('reportPreparedBy').value = accountantData.name;
                showToast('Informations comptable enregistrées avec succès!', 'success');
            } catch (error) {
                console.error('Erreur sauvegarde informations comptable:', error);
                showToast('Erreur lors de l\'enregistrement', 'error');
            }
        }

        // Load fee configuration
        function loadFeeConfiguration() {
            const branch = document.getElementById('feeBranch').value;
            const quarter = document.getElementById('feeQuarter').value;
            const year = document.getElementById('feeYear').value;
            
            // Créer la clé unique pour chercher la configuration
            const configKey = `${branch.replace(/\s+/g, '_')}_${quarter}_${year}`;
            
            // Chercher dans les configurations chargées
            const config = feeConfigurations.find(c => c.id === configKey);
            
            if (config) {
                // Remplir les champs avec les données existantes
                document.getElementById('feeMinervale').value = config.minervale || 150000;
                document.getElementById('feeTransport').value = config.transport || 50000;
                document.getElementById('feeCoaching').value = config.coaching || 80000;
                document.getElementById('feeUniform').value = config.uniform || 30000;
                document.getElementById('feeLunch').value = config.lunch || 20000;
                document.getElementById('feeBreakfast').value = config.breakfast || 10000;
                document.getElementById('feeMaterial').value = config.material || 15000;
                document.getElementById('feeInsurance').value = config.insurance || 10000;
            } else {
                // Utiliser les valeurs par défaut si pas de configuration existante
                document.getElementById('feeMinervale').value = 150000;
                document.getElementById('feeTransport').value = 50000;
                document.getElementById('feeCoaching').value = 80000;
                document.getElementById('feeUniform').value = 30000;
                document.getElementById('feeLunch').value = 20000;
                document.getElementById('feeBreakfast').value = 10000;
                document.getElementById('feeMaterial').value = 15000;
                document.getElementById('feeInsurance').value = 10000;
            }
        }

        // Save fee configuration
        async function saveFeeConfiguration() {
            const feeConfigData = {
                branch: document.getElementById('feeBranch').value,
                quarter: document.getElementById('feeQuarter').value,
                year: document.getElementById('feeYear').value,
                minervale: parseFloat(document.getElementById('feeMinervale').value) || 0,
                transport: parseFloat(document.getElementById('feeTransport').value) || 0,
                coaching: parseFloat(document.getElementById('feeCoaching').value) || 0,
                uniform: parseFloat(document.getElementById('feeUniform').value) || 0,
                lunch: parseFloat(document.getElementById('feeLunch').value) || 0,
                breakfast: parseFloat(document.getElementById('feeBreakfast').value) || 0,
                material: parseFloat(document.getElementById('feeMaterial').value) || 0,
                insurance: parseFloat(document.getElementById('feeInsurance').value) || 0,
                updatedBy: currentUserName,
                updatedAt: Date.now()
            };
            
            try {
                // Créer une clé unique basée sur la branche, trimestre et année
                const configKey = `${feeConfigData.branch.replace(/\s+/g, '_')}_${feeConfigData.quarter}_${feeConfigData.year}`;
                await feeConfigRef.child(configKey).set(feeConfigData);
                showToast('Configuration des frais enregistrée avec succès!', 'success');
            } catch (error) {
                console.error('Erreur sauvegarde configuration frais:', error);
                showToast('Erreur lors de l\'enregistrement', 'error');
            }
        }

        // Backup data
        async function backupData() {
            try {
                // Récupérer toutes les données
                const allData = {
                    travailleurs: travailleurs,
                    students: students,
                    studentFees: studentFees,
                    debts: debts,
                    dailyExpenses: dailyExpenses,
                    payrollHistory: payrollHistory,
                    timestamp: Date.now(),
                    backedUpBy: currentUserName
                };
                
                // Créer un blob JSON
                const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // Créer un lien de téléchargement
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_edensmart_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast('Sauvegarde créée avec succès!', 'success');
            } catch (error) {
                console.error('Erreur sauvegarde:', error);
                showToast('Erreur lors de la sauvegarde', 'error');
            }
        }

        // Export all data Excel
        async function exportAllDataExcel() {
            try {
                // Préparer les données pour l'export
                const exportData = {
                    Travailleurs: travailleurs.filter(t => t.branch === selectedBranch).map(t => ({
                        NO: t.no,
                        Nom: t.name,
                        Type: t.type,
                        Téléphone: t.phone,
                        'Mode Paiement': t.paymentMode,
                        'Salaire Base': t.salary,
                        'Date Embauche': t.hireDate,
                        Statut: t.status
                    })),
                    
                    Élèves: students.filter(s => s.branch === selectedBranch).map(s => ({
                        Référence: s.reference,
                        'Nom Complet': s.fullName,
                        Classe: s.class,
                        'Date Naissance': s.birthDate,
                        Parent: s.parent,
                        'Téléphone Parent': s.parentPhone,
                        Statut: s.status
                    })),
                    
                    'Paiements Élèves': studentFees.filter(f => {
                        const student = students.find(s => s.id === f.studentId);
                        return student && student.branch === selectedBranch;
                    }).map(f => ({
                        Référence: f.reference,
                        Élève: f.studentName,
                        Classe: f.studentClass,
                        Type: f.paymentType,
                        Montant: f.amount,
                        'Mode Paiement': f.paymentMode,
                        Date: f.paymentDate,
                        'Reçu par': f.receivedBy
                    })),
                    
                    Dettes: debts.filter(d => {
                        const worker = travailleurs.find(t => t.id === d.workerId);
                        return worker && worker.branch === selectedBranch;
                    }).map(d => ({
                        Travailleur: d.workerName,
                        Montant: d.amount,
                        Motif: d.reason,
                        Date: d.date,
                        Statut: d.status
                    }))
                };
                
                // Créer le classeur Excel
                const wb = XLSX.utils.book_new();
                
                // Ajouter chaque feuille
                Object.keys(exportData).forEach(sheetName => {
                    if (exportData[sheetName].length > 0) {
                        const ws = XLSX.utils.json_to_sheet(exportData[sheetName]);
                        XLSX.utils.book_append_sheet(wb, ws, sheetName);
                    }
                });
                
                // Générer le fichier
                XLSX.writeFile(wb, `export_edensmart_${selectedBranch}_${new Date().toISOString().split('T')[0]}.xlsx`);
                
                showToast('Données exportées en Excel avec succès!', 'success');
            } catch (error) {
                console.error('Erreur export Excel:', error);
                showToast('Erreur lors de l\'export', 'error');
            }
        }

        // [Old logout function removed - now defined in <head> section]

        // Toast notification
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast-notification ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <div class="flex-grow-1">
                    <div class="fw-bold">${type === 'success' ? 'Succès' : type === 'error' ? 'Erreur' : 'Information'}</div>
                    <div>${message}</div>
                </div>
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;
            
            container.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }

        // Perform global search
        function performGlobalSearch(query) {
            if (!query || query.length < 2) {
                document.getElementById('searchResults').style.display = 'none';
                return;
            }
            
            const searchTerm = query.toLowerCase();
            const results = [];
            
            // Rechercher dans les travailleurs
            travailleurs.forEach(teacher => {
                if (teacher.branch === selectedBranch && 
                    (teacher.name.toLowerCase().includes(searchTerm) || 
                     teacher.no.toLowerCase().includes(searchTerm) ||
                     teacher.phone.includes(searchTerm))) {
                    results.push({
                        type: 'Travailleur',
                        name: teacher.name,
                        id: teacher.id,
                        action: () => {
                            showSection('travailleurs');
                            setTimeout(() => editWorker(teacher.id), 500);
                        }
                    });
                }
            });
            
            // Rechercher dans les élèves
            students.forEach(student => {
                if (student.branch === selectedBranch && 
                    (student.fullName.toLowerCase().includes(searchTerm) || 
                     student.reference.toLowerCase().includes(searchTerm) ||
                     student.parent.toLowerCase().includes(searchTerm))) {
                    results.push({
                        type: 'Élève',
                        name: student.fullName,
                        id: student.id,
                        action: () => {
                            showSection('students');
                            setTimeout(() => viewStudentProfile(student.id), 500);
                        }
                    });
                }
            });
            
            // Afficher les résultats
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '';
            
            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="search-result-item">
                        <div class="text-muted">Aucun résultat trouvé</div>
                    </div>
                `;
            } else {
                results.slice(0, 10).forEach(result => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.innerHTML = `
                        <div class="fw-bold">${result.type}: ${result.name}</div>
                        <small class="text-muted">Cliquez pour voir les détails</small>
                    `;
                    item.onclick = result.action;
                    resultsContainer.appendChild(item);
                });
            }
            
            resultsContainer.style.display = 'block';
        }

        // Close search results when clicking outside
        document.addEventListener('click', function(event) {
            const searchContainer = document.getElementById('searchResults');
            const searchInput = document.getElementById('globalSearch');
            
            if (searchContainer && searchInput && 
                !searchContainer.contains(event.target) && 
                !searchInput.contains(event.target)) {
                searchContainer.style.display = 'none';
            }
        });

        // Download worker payment history
        async function downloadWorkerPaymentHistory(workerId) {
            try {
                const worker = travailleurs.find(t => t.id === workerId);
                if (!worker) {
                    showToast('Travailleur non trouvé', 'error');
                    return;
                }
                
                // Récupérer l'historique des paiements du travailleur
                const workerPayments = payrollHistory.filter(p => p.workerId === workerId);
                
                // Créer le contenu CSV
                let csvContent = `Historique des Paiements - ${worker.name}\nGénéré le: ${new Date().toLocaleDateString('fr-FR')}\n\n`;
                csvContent += `Mois,Année,Salaire Base,Dettes,Statut,Date Paiement\n`;
                
                workerPayments.forEach(payment => {
                    const month = payment.month || '-';
                    const year = payment.year || '-';
                    const salary = payment.salary || 0;
                    const debts = payment.debts || 0;
                    const status = payment.status || 'pending';
                    const paymentDate = payment.paymentDate ? new Date(payment.paymentDate).toLocaleDateString('fr-FR') : '-';
                    csvContent += `${month},${year},${salary},${debts},${status},${paymentDate}\n`;
                });
                
                // Créer et télécharger le fichier
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `payroll_${worker.name.replace(/\\s+/g, '_')}_${Date.now()}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showToast(`Historique de ${worker.name} téléchargé!`, 'success');
            } catch (error) {
                console.error('Erreur téléchargement historique:', error);
                showToast('Erreur lors du téléchargement', 'error');
            }
        }
        
        // Update payment status
        async function updatePaymentStatus(workerId) {
            try {
                const worker = travailleurs.find(t => t.id === workerId);
                if (!worker) {
                    showToast('Travailleur non trouvé', 'error');
                    return;
                }
                
                const month = document.getElementById('payrollMonth').value;
                const year = document.getElementById('payrollYear').value;
                
                // Créer entry de paiement
                const paymentEntry = {
                    workerId: workerId,
                    workerName: worker.name,
                    month: month,
                    year: year,
                    salary: worker.salary || 0,
                    status: 'paid',
                    paymentDate: Date.now(),
                    receivedBy: currentUserName,
                    paymentMode: worker.paymentMode || 'bank'
                };
                
                // Sauvegarder dans payrollHistory
                const key = payrollHistoryRef.push().key;
                await payrollHistoryRef.child(key).set(paymentEntry);
                
                showToast(`Paiement enregistré pour ${worker.name}`, 'success');
                displayPayrollTable(); // Rafraîchir l'affichage
                
            } catch (error) {
                console.error('Erreur mise à jour paiement:', error);
                showToast('Erreur lors de la mise à jour du statut', 'error');
            }
        }

        // ===== INSCRIPTION COMPTABLE =====
        const BRANCHES_DATA_COMP = {
            KACYIRU: { name: "Kacyiru", phone: "0791639766 / 0792570074", email: "sergetumbwe@gmail.com", address: "KG 17 Ave, Kacyiru, Kigali" },
            GISOZI: { name: "Gisozi", phone: "0788410242 / 0796145647", email: "gisozi@edenfamily.edu.rw", address: "KG 11 Ave, Gisozi, Kigali" },
            KIMISAGARA: { name: "Kimisagara", phone: "0785892018 / 0791826950", email: "kimisagara@edenfamily.edu.rw", address: "KG 7 Ave, Kimisagara, Kigali" }
        };

        function updateSectionComp() {
            const section = document.querySelector('input[name="section"]:checked').value;
            if (section === 'MATERNELLE') {
                document.getElementById('niveauMaternelleGroupComp').style.display = 'block';
                document.getElementById('niveauPrimaireGroupComp').style.display = 'none';
                document.getElementById('sdmsGroupComp').style.display = 'none';
            } else {
                document.getElementById('niveauMaternelleGroupComp').style.display = 'none';
                document.getElementById('niveauPrimaireGroupComp').style.display = 'block';
                document.getElementById('sdmsGroupComp').style.display = 'block';
            }
        }

        function updateContactInfoComp() {
            const branche = document.querySelector('input[name="branche"]:checked').value;
            const contactInfo = document.getElementById('contactInfoComp');
            const contactText = document.getElementById('contactTextComp');
            const branchData = BRANCHES_DATA_COMP[branche];
            
            if (branchData) {
                contactText.innerHTML = `
                    <strong>Contact ${branchData.name}:</strong><br>
                    <i class="fas fa-phone"></i> ${branchData.phone}<br>
                    <i class="fas fa-envelope"></i> ${branchData.email}<br>
                    <i class="fas fa-map-marker-alt"></i> ${branchData.address}
                `;
                contactInfo.style.display = 'block';
            }
        }

        function generateStudentCodeComp() {
            const now = new Date();
            const timestamp = now.getTime();
            const random = Math.floor(Math.random() * 1000);
            return `EDU-${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}-${timestamp.toString().slice(-6)}${random.toString().padStart(3, '0')}`;
        }

        function validateComptableInscription() {
            let isValid = true;
            const requiredFields = ['nomPrenomComp', 'dateNaissanceComp', 'ecoleProvenanceComp', 'villeComp', 'secteurComp', 'umurengeComp', 'akagariComp', 'umuduguduComp', 'chefNomPrenomComp', 'chefTelephoneComp', 'chefPieceIdentiteComp'];
            
            // Reset border colors first
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) field.style.borderColor = '#ddd';
            });
            
            // Validate required fields
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && !field.value.trim()) {
                    isValid = false;
                    field.style.borderColor = '#DC143C';
                }
            });
            
            if (!document.querySelector('input[name="sexe"]:checked')) {
                isValid = false;
                showErrorMessageComp('Sexe obligatoire', 'Veuillez sélectionner le sexe de l\'enfant');
            }
            
            const section = document.querySelector('input[name="section"]:checked');
            if (!section) {
                isValid = false;
                showErrorMessageComp('Section obligatoire', 'Veuillez sélectionner la section (Maternelle ou Primaire)');
            } else {
                // Validate section-dependent fields
                if (section.value === 'MATERNELLE') {
                    const niveauMaternelle = document.getElementById('niveauMaternelleComp').value;
                    if (!niveauMaternelle) {
                        isValid = false;
                        document.getElementById('niveauMaternelleComp').style.borderColor = '#DC143C';
                        showErrorMessageComp('Niveau obligatoire', 'Veuillez sélectionner le niveau maternelle');
                    }
                } else if (section.value === 'PRIMAIRE') {
                    const niveauPrimaire = document.getElementById('niveauPrimaireComp').value;
                    const sdmsCode = document.getElementById('sdmsCodeComp').value;
                    if (!niveauPrimaire) {
                        isValid = false;
                        document.getElementById('niveauPrimaireComp').style.borderColor = '#DC143C';
                        showErrorMessageComp('Niveau obligatoire', 'Veuillez sélectionner le niveau primaire');
                    }
                    if (!sdmsCode.trim()) {
                        isValid = false;
                        document.getElementById('sdmsCodeComp').style.borderColor = '#DC143C';
                        showErrorMessageComp('SDMS obligatoire', 'Le code SDMS est obligatoire pour le primaire');
                    }
                }
            }
            
            if (!document.querySelector('input[name="branche"]:checked')) {
                isValid = false;
                showErrorMessageComp('Branche obligatoire', 'Veuillez sélectionner une branche');
            }
            
            if (!document.querySelector('input[name="transport"]:checked')) {
                isValid = false;
                showErrorMessageComp('Transport obligatoire', 'Veuillez spécifier si l\'enfant utilise le transport');
            }
            
            // Validate phone format
            const chefPhone = document.getElementById('chefTelephoneComp').value;
            if (chefPhone && !/^\d{10}/.test(chefPhone)) {
                isValid = false;
                document.getElementById('chefTelephoneComp').style.borderColor = '#DC143C';
                showErrorMessageComp('Téléphone invalide', 'Le numéro de téléphone doit contenir au moins 10 chiffres');
            }
            
            const conjointPhone = document.getElementById('conjointTelephoneComp').value;
            if (conjointPhone && !/^\d{10}/.test(conjointPhone)) {
                isValid = false;
                document.getElementById('conjointTelephoneComp').style.borderColor = '#DC143C';
                showErrorMessageComp('Téléphone invalide', 'Le numéro de téléphone du conjoint doit contenir au moins 10 chiffres');
            }
            
            return isValid;
        }

        async function submitComptableInscription() {
            if (!validateComptableInscription()) {
                showToast('Veuillez remplir tous les champs obligatoires', 'error');
                return;
            }
            
            const formData = {
                nomPrenom: document.getElementById('nomPrenomComp').value,
                dateNaissance: document.getElementById('dateNaissanceComp').value,
                ecoleProvenance: document.getElementById('ecoleProvenanceComp').value,
                sexe: document.querySelector('input[name="sexe"]:checked').value,
                section: document.querySelector('input[name="section"]:checked').value,
                niveau: document.querySelector('input[name="section"]:checked').value === 'MATERNELLE' ? document.getElementById('niveauMaternelleComp').value : document.getElementById('niveauPrimaireComp').value,
                sdmsCode: document.getElementById('sdmsCodeComp').value || null,
                branche: document.querySelector('input[name="branche"]:checked').value,
                transport: document.querySelector('input[name="transport"]:checked').value,
                chefNomPrenom: document.getElementById('chefNomPrenomComp').value,
                chefTelephone: document.getElementById('chefTelephoneComp').value,
                chefPieceIdentite: document.getElementById('chefPieceIdentiteComp').value,
                conjointNomPrenom: document.getElementById('conjointNomPrenomComp').value || null,
                conjointTelephone: document.getElementById('conjointTelephoneComp').value || null,
                conjointPieceIdentite: document.getElementById('conjointPieceIdentiteComp').value || null,
                ville: document.getElementById('villeComp').value,
                secteur: document.getElementById('secteurComp').value,
                umurenge: document.getElementById('umurengeComp').value,
                akagari: document.getElementById('akagariComp').value,
                umudugudu: document.getElementById('umuduguduComp').value,
                codeUnique: generateStudentCodeComp(),
                dateInscription: new Date().toISOString(),
                timestamp: Date.now(),
                statut: 'En attente de validation'
            };
            
            try {
                await db.ref('inscriptions-scolaires').push(formData);
                document.getElementById('studentCodeComp').textContent = formData.codeUnique;
                document.getElementById('successMessageComp').style.display = 'flex';
                document.getElementById('inscriptionFormComptable').reset();
            } catch (error) {
                showErrorMessageComp('Erreur lors de l\'enregistrement', error.message);
            }
        }

        function hideErrorMessageComp() {
            document.getElementById('missingFieldMessageComp').style.display = 'none';
        }

        function closeSuccessMessageComp() {
            document.getElementById('successMessageComp').style.display = 'none';
        }

        function resetFormComp() {
            document.getElementById('inscriptionFormComptable').reset();
            document.getElementById('contactInfoComp').style.display = 'none';
            document.getElementById('niveauMaternelleGroupComp').style.display = 'none';
            document.getElementById('niveauPrimaireGroupComp').style.display = 'none';
            document.getElementById('sdmsGroupComp').style.display = 'none';
            // Reset input border colors
            const inputs = document.querySelectorAll('#inscriptionFormComptable input, #inscriptionFormComptable select');
            inputs.forEach(input => {
                input.style.borderColor = '#ddd';
            });
        }

        function showErrorMessageComp(title, message) {
            document.getElementById('errorTitleComp').textContent = title;
            document.getElementById('errorMessageComp').textContent = message;
            document.getElementById('missingFieldMessageComp').style.display = 'block';
        }

        // ===== Navigation Scroll Animation =====
        let lastScrollTop = 0;
        let scrollDirection = 'down';
        const navWrapper = document.querySelector('.nav-header-wrapper');
        let isNavScrolled = false;
        let isNavHidden = false;
        // Thresholds for when header/nav becomes "scrolled" and when it should hide
        // Use smaller thresholds on small screens so the nav hides quickly on phones
        let scrollThresholdStart = window.innerWidth < 768 ? 10 : 100;
        let scrollThresholdHide = window.innerWidth < 768 ? 80 : 300;

        // Update thresholds on resize
        window.addEventListener('resize', () => {
            scrollThresholdStart = window.innerWidth < 768 ? 10 : 100;
            scrollThresholdHide = window.innerWidth < 768 ? 80 : 300;
        });

        window.addEventListener('scroll', function() {
            const currentScroll = window.pageYOffset || document.documentElement.scrollTop;
            
            // Determine scroll direction
            if (currentScroll > lastScrollTop) {
                scrollDirection = 'down';
            } else {
                scrollDirection = 'up';
            }
            
            // Calculate progressive border radius on both scroll down and up
            let borderRadius = 0;
            if (currentScroll > scrollThresholdStart && currentScroll <= scrollThresholdHide) {
                // Calculate progress from 0 to 1 based on scroll position
                const progress = (currentScroll - scrollThresholdStart) / (scrollThresholdHide - scrollThresholdStart);
                // Border radius goes from 0 to 20px progressively (works on both down and up scroll)
                borderRadius = Math.min(20 * progress, 20);
            } else if (currentScroll > scrollThresholdHide) {
                // Full border radius when scrolling past hide threshold
                borderRadius = 20;
            }
            
            // Set the CSS variable for border radius - applies to both scroll directions
            navWrapper.style.setProperty('--nav-border-radius', borderRadius + 'px');
            
            // At the top - reset everything
            if (currentScroll <= scrollThresholdStart) {
                if (isNavScrolled || isNavHidden) {
                    navWrapper.classList.remove('nav-scrolled', 'nav-hidden');
                    navWrapper.style.setProperty('--nav-border-radius', '0px');
                    isNavScrolled = false;
                    isNavHidden = false;
                }
            }
            // After scrolling past threshold - make nav scrolled
            else if (currentScroll > scrollThresholdStart && currentScroll <= scrollThresholdHide) {
                if (!isNavScrolled && !isNavHidden) {
                    navWrapper.classList.remove('nav-hidden');
                    navWrapper.classList.add('nav-scrolled');
                    isNavScrolled = true;
                    isNavHidden = false;
                } else if (isNavHidden && scrollDirection === 'up') {
                    navWrapper.classList.remove('nav-hidden');
                    navWrapper.classList.add('nav-scrolled');
                    isNavHidden = false;
                    isNavScrolled = true;
                }
            }
            // Far down - hide nav when scrolling down
            else if (currentScroll > scrollThresholdHide) {
                if (scrollDirection === 'down' && !isNavHidden) {
                    navWrapper.classList.remove('nav-scrolled');
                    navWrapper.classList.add('nav-hidden');
                    isNavHidden = true;
                    isNavScrolled = false;
                } else if (scrollDirection === 'up' && isNavHidden) {
                    navWrapper.classList.remove('nav-hidden');
                    navWrapper.classList.add('nav-scrolled');
                    isNavHidden = false;
                    isNavScrolled = true;
                }
            }
            
            lastScrollTop = currentScroll <= 0 ? 0 : currentScroll;
        });
    </script>
</body>
</html>