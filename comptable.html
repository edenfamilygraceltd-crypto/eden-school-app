<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EdenSmart - Gestion Financi√®re</title>
    
    <!-- üîí S√âCURIT√â: Script d'authentification -->
    <script src="security-auth.js"></script>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Responsive CSS Global -->
    <link rel="stylesheet" href="responsive.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- SheetJS pour Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    
    <!-- jsPDF pour PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --primary: #2E8B57;
            --secondary: #1E6B4E;
            --success: #32CD32;
            --warning: #FFA500;
            --danger: #DC143C;
            --info: #20B2AA;
            --light: #f8f9fa;
            --dark: #2F4F4F;
            --border-radius: 12px;
            --box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1E6B4E 0%, #2E8B57 100%);
            background-attachment: fixed;
            color: var(--dark);
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-50px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        .animate-slide-left {
            animation: slideInLeft 0.6s ease-out;
        }
        
        .animate-slide-right {
            animation: slideInRight 0.6s ease-out;
        }
        
        /* Header */
        .modern-header {
            background: rgba(255, 255, 255, 0.95);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            color: var(--dark);
            padding: 1.5rem 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            width: 100%;
            flex-wrap: wrap;
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .header-container {
                padding: 0 1rem;
            }
        }

        @media (max-width: 480px) {
            .header-container {
                padding: 0 0.5rem;
                justify-content: center;
            }
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        @media (max-width: 480px) {
            .logo {
                gap: 10px;
            }
        }
        
        .logo-icon {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            box-shadow: 0 4px 15px rgba(46, 139, 87, 0.3);
        }
        
        .logo-text h1 {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 1.8rem;
            margin: 0;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .logo-text p {
            font-size: 0.9rem;
            color: var(--dark);
            margin: 0;
        }
        
        /* Navigation */
        .main-nav {
            background: rgba(255, 255, 255, 0.95);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            padding: 1rem 0;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 80px;
            z-index: 999;
        }
        
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }
        
        .nav-tabs {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: var(--dark);
            font-weight: 500;
            border-radius: 8px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .nav-btn:hover {
            background: rgba(46, 139, 87, 0.1);
            color: var(--primary);
            transform: translateY(-2px);
        }
        
        .nav-btn.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(46, 139, 87, 0.3);
        }
        
        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
            width: 100%;
        }

        @media (max-width: 768px) {
            .main-content {
                margin: 1rem auto;
                padding: 0 1rem;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                margin: 0.5rem auto;
                padding: 0 0.5rem;
            }
        }
        
        .section {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s, transform 0.5s;
        }
        
        .section.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Dashboard */
        .dashboard-hero {
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.9) 100%);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 3rem;
            color: var(--dark);
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            box-shadow: var(--box-shadow);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            border: 1px solid #eef2ff;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.6s ease-out forwards;
        }
        
        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }
        .stat-card:nth-child(4) { animation-delay: 0.4s; }
        
        .stat-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 1rem;
            color: white;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 0.5rem 0;
            color: var(--dark);
        }
        
        /* Forms */
        .form-control-modern {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px 16px;
            transition: var(--transition);
            width: 100%;
            font-family: 'Inter', sans-serif;
        }
        
        .form-control-modern:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(46, 139, 87, 0.1);
            outline: none;
        }
        
        /* Buttons */
        .btn-modern {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary-modern {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }
        
        .btn-primary-modern:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(46, 139, 87, 0.4);
        }
        
        /* Tables */
        .modern-table {
            width: 100%;
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
        }
        
        .modern-table th {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }
        
        .modern-table td {
            padding: 1rem;
            border-bottom: 1px solid #f1f1f1;
        }
        
        .modern-table tbody tr {
            transition: var(--transition);
        }
        
        .modern-table tbody tr:hover {
            background: rgba(46, 139, 87, 0.05);
        }
        
        /* Badges */
        .badge-bank {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        .badge-momo {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            word-break: keep-all;
            white-space: nowrap;
        }
        
        .badge-cash {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        .badge-minervale {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        .badge-coaching {
            background: linear-gradient(135deg, #6f42c1, #4e2a9c);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        .badge-transport {
            background: linear-gradient(135deg, #17a2b8, #117a8b);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        /* Chart Container */
        .chart-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--box-shadow);
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 9999;
        }
        
        .toast-notification {
            background: white;
            border-radius: 8px;
            padding: 1rem 1.5rem;
            margin-bottom: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: slideInRight 0.3s ease-out;
            border-left: 4px solid var(--primary);
        }
        
        .toast-notification.success {
            border-left-color: #28a745;
        }
        
        .toast-notification.error {
            border-left-color: #dc3545;
        }
        
        .toast-notification.info {
            border-left-color: #17a2b8;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-container, .nav-container, .main-content {
                padding: 0 1rem;
            }
            
            .dashboard-hero {
                padding: 2rem 1rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                justify-content: center;
            }
            
            .nav-btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }

            /* Responsive pour tablettes */
            .search-container {
                width: 100%;
                max-width: 250px;
            }

            .modern-header {
                padding: 1rem 0;
            }

            .d-flex.justify-content-between {
                flex-direction: column;
                gap: 1rem;
            }

            .row.g-4 {
                gap: 1rem !important;
            }

            .table-responsive {
                font-size: 0.9rem;
            }

            .btn-modern {
                padding: 0.5rem 0.75rem;
                font-size: 0.9rem;
            }

            .stat-card {
                padding: 1rem;
            }

            .form-control-modern, .form-control-modern-small {
                font-size: 1rem;
                padding: 0.75rem;
            }

            input[type="text"], input[type="email"], input[type="tel"], input[type="date"],
            select, textarea {
                font-size: 16px;
            }
        }

        /* Petits √©crans - T√©l√©phones (320px - 480px) */
        @media (max-width: 480px) {
            body {
                font-size: 14px;
            }

            .header-container {
                padding: 0.5rem;
            }

            .modern-header {
                padding: 0.75rem 0;
            }

            .container-fluid {
                padding: 0.5rem;
            }

            h1, h2 {
                font-size: 1.5rem !important;
            }

            h3, h4, h5, h6 {
                font-size: 1.1rem !important;
            }

            .nav-btn {
                padding: 8px 10px !important;
                font-size: 0.8rem !important;
                margin: 2px !important;
            }

            .nav-tabs {
                gap: 2px;
                overflow-x: auto;
                padding-bottom: 0.5rem;
            }

            .search-container {
                width: 100%;
                max-width: 100%;
            }

            .input-group {
                flex-wrap: wrap;
            }

            .btn-modern {
                padding: 0.5rem 0.6rem !important;
                font-size: 0.85rem !important;
                width: 100%;
            }

            .d-grid, .d-flex {
                flex-direction: column;
            }

            .row {
                margin: 0 !important;
            }

            .col-md-12, .col-md-6, .col-md-4, .col-md-3 {
                padding: 0.25rem !important;
                margin-bottom: 0.5rem;
            }

            .stat-card {
                padding: 0.75rem !important;
                margin-bottom: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .form-label {
                font-size: 0.9rem;
                margin-bottom: 0.25rem;
            }

            .form-control-modern {
                padding: 0.6rem 0.5rem;
                font-size: 1rem;
                border-radius: 6px;
            }

            input[type="text"],
            input[type="email"],
            input[type="tel"],
            input[type="date"],
            input[type="number"],
            select,
            textarea {
                width: 100% !important;
                font-size: 16px !important;
                padding: 0.75rem !important;
                border-radius: 6px;
            }

            table {
                font-size: 0.8rem;
            }

            th {
                padding: 0.5rem !important;
                font-size: 0.8rem !important;
            }

            td {
                padding: 0.4rem !important;
                font-size: 0.8rem !important;
            }

            .modal-dialog {
                margin: 0.5rem;
            }

            .modal-content {
                border-radius: 8px;
            }

            .search-input-width {
                width: 100% !important;
                max-width: 100%;
            }

            .d-flex.gap-2 {
                gap: 0.5rem !important;
                flex-wrap: wrap;
            }

            .student-avatar {
                width: 60px !important;
                height: 60px !important;
                font-size: 2rem;
            }

            .teacher-avatar {
                width: 35px !important;
                height: 35px !important;
                font-size: 0.8rem;
            }

            .dashboard-hero {
                padding: 1.5rem 0.5rem !important;
            }

            .dashboard-hero h1 {
                font-size: 1.75rem !important;
            }

            .dashboard-hero p {
                font-size: 0.9rem;
            }

            .alert {
                padding: 0.75rem !important;
                margin-bottom: 0.75rem;
                font-size: 0.9rem;
            }

            .badge {
                font-size: 0.75rem;
                padding: 0.35em 0.6em;
            }

            .import-section {
                padding: 1rem !important;
                margin-bottom: 1rem;
            }

            .import-section i {
                font-size: 2rem !important;
                margin-bottom: 0.5rem;
            }

            .import-section h5 {
                font-size: 1rem !important;
                margin-bottom: 0.5rem;
            }

            .btn-group {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }

            .btn-group > .btn-modern {
                width: 100%;
            }

            .text-end {
                text-align: left !important;
            }

            .text-center {
                text-align: center !important;
            }

            /* Cartes de statistiques */
            .stat-value {
                font-size: 1.5rem !important;
            }

            .stat-label {
                font-size: 0.85rem !important;
            }

            /* Tableaux scrollables */
            .table-responsive {
                margin-bottom: 0.5rem;
            }

            table.modern-table {
                font-size: 0.75rem;
            }

            /* Icons responsifs */
            .fa-3x {
                font-size: 2rem !important;
            }

            .fa-2x {
                font-size: 1.5rem !important;
            }

            .icon-text-primary {
                margin-right: 0.25rem !important;
            }

            /* Espacement responsive */
            .mb-3 {
                margin-bottom: 0.75rem !important;
            }

            .mb-4 {
                margin-bottom: 1rem !important;
            }

            .mt-3 {
                margin-top: 0.75rem !important;
            }

            .mt-4 {
                margin-top: 1rem !important;
            }

            .p-3 {
                padding: 0.75rem !important;
            }

            .p-4 {
                padding: 1rem !important;
            }
        }

        /* √âcrans moyens - Tablettes (481px - 768px) */
        @media (min-width: 481px) and (max-width: 768px) {
            h2 {
                font-size: 1.75rem !important;
            }

            .nav-btn {
                padding: 10px 12px;
                font-size: 0.95rem;
            }

            .btn-modern {
                padding: 0.6rem 0.8rem;
                font-size: 0.95rem;
            }

            .stat-card {
                padding: 1.25rem;
            }

            .form-control-modern {
                font-size: 0.95rem;
            }

            table {
                font-size: 0.9rem;
            }

            .d-flex.gap-2 {
                flex-wrap: wrap;
            }

            .row.g-4 > [class*="col-"] {
                margin-bottom: 1rem;
            }
        }

        /* Grands √©crans - Bureau (769px+) */
        @media (min-width: 769px) {
            .search-container {
                width: 300px;
            }

            .nav-btn {
                padding: 12px 20px;
                font-size: 1rem;
            }

            .stat-card {
                padding: 1.5rem;
            }

            .form-control-modern {
                font-size: 1rem;
            }

            table {
                font-size: 1rem;
            }
        }
        
        /* Legal Badge */
        .legal-badge {
            background: linear-gradient(135deg, #2E8B57, #1E6B4E);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Teacher Avatar */
        .teacher-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        /* Tabs dans la section payroll */
        .payroll-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #eaeaea;
            padding-bottom: 10px;
        }
        
        .payroll-tab {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: var(--dark);
            font-weight: 500;
            border-radius: 6px;
            transition: var(--transition);
            cursor: pointer;
        }
        
        .payroll-tab:hover {
            background: rgba(46, 139, 87, 0.1);
        }
        
        .payroll-tab.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }
        
        /* Journal Financier Styles */
        .journal-table th {
            font-size: 0.85rem;
            padding: 0.75rem;
        }
        
        .journal-table td {
            font-size: 0.85rem;
            padding: 0.75rem;
        }
        
        .money-in {
            color: #28a745;
            font-weight: bold;
        }
        
        .money-out {
            color: #dc3545;
            font-weight: bold;
        }
        
        .balance {
            color: #007bff;
            font-weight: bold;
        }
        
        /* Rapport Styles */
        .report-summary {
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 100%);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 5px solid var(--primary);
        }
        
        .opening-balance-input {
            max-width: 200px;
            font-weight: bold;
            font-size: 1.1rem;
            text-align: center;
        }
        
        /* Nouveaux styles */
        .search-container {
            position: relative;
            width: 300px;
            max-width: 100%;
        }

        @media (max-width: 768px) {
            .search-container {
                width: 100%;
                max-width: 250px;
            }
        }

        @media (max-width: 480px) {
            .search-container {
                width: 100%;
                max-width: 100%;
            }
        }
        
        .search-results {
            position: absolute;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            max-height: 400px;
            overflow-y: auto;
            width: 100%;
            z-index: 1000;
            display: none;
        }
        
        .search-result-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .search-result-item:hover {
            background: rgba(46, 139, 87, 0.1);
        }
        
        .student-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            margin: 0 auto;
        }
        
        .debt-badge {
            background: linear-gradient(135deg, #DC143C, #B22222);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
        }
        
        .worker-type-badge {
            background: linear-gradient(135deg, #20B2AA, #008B8B);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        .announcement-type-badge {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 5px;
        }
        
        .financial-table th {
            font-size: 0.8rem;
            padding: 0.5rem;
            text-align: center;
        }
        
        .financial-table td {
            font-size: 0.8rem;
            padding: 0.5rem;
            text-align: center;
        }
        
        .justification-cell {
            min-width: 200px;
            max-width: 250px;
            font-size: 0.8rem;
        }
        
        /* Nouveaux styles pour les rapports */
        .expense-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid #dc3545;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: var(--transition);
        }
        
        .expense-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .report-form-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--box-shadow);
        }
        
        .report-field-group {
            margin-bottom: 1.5rem;
        }
        
        .report-field-group h6 {
            color: var(--primary);
            margin-bottom: 0.75rem;
            font-weight: 600;
        }
        
        /* Styles pour le tableau de rapport journalier */
        .report-summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .summary-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--box-shadow);
        }
        
        .summary-card.income {
            border-top: 4px solid #28a745;
        }
        
        .summary-card.expenses {
            border-top: 4px solid #dc3545;
        }
        
        .summary-card.balance {
            border-top: 4px solid #007bff;
        }
        
        .summary-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }
        
        .income .summary-value {
            color: #28a745;
        }
        
        .expenses .summary-value {
            color: #dc3545;
        }
        
        .balance .summary-value {
            color: #007bff;
        }
        
        /* Styles pour la section branches */
        .branch-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .branch-option {
            flex: 1;
            min-width: 250px;
        }
        
        .branch-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            border: 2px solid #eaeaea;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .branch-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
        }
        
        .branch-card.selected {
            border-color: var(--primary);
            background: rgba(46, 139, 87, 0.05);
        }
        
        .branch-card h6 {
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .branch-card small {
            color: #666;
        }
        
        /* CSS Classes pour remplacer les styles inline */
        .language-toggle-btn {
            background: #6c757d;
            color: white;
            margin-left: 10px;
        }
        
        .user-role-text {
            color: var(--dark);
        }
        
        .user-avatar-header {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2E8B57, #1E6B4E);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .stat-icon-primary {
            background: linear-gradient(135deg, #2E8B57, #1E6B4E) !important;
        }
        
        .stat-icon-danger {
            background: linear-gradient(135deg, #DC143C, #B22222) !important;
        }
        
        .stat-icon-warning {
            background: linear-gradient(135deg, #FFA500, #FF8C00) !important;
        }
        
        .stat-icon-info {
            background: linear-gradient(135deg, #20B2AA, #008B8B) !important;
        }
        
        .icon-text-primary {
            color: var(--primary) !important;
        }
        
        .btn-debt-modal {
            background: #DC143C;
            color: white;
        }
        
        .btn-payroll-success {
            background: #28a745;
            color: white;
        }
        
        .btn-payroll-danger {
            background: #DC143C;
            color: white;
        }
        
        .btn-payroll-history {
            background: #6f42c1;
            color: white;
        }
        
        .payroll-history-section {
            display: none;
        }
        
        .filter-select-width {
            width: 150px;
        }
        
        .filter-month-width {
            width: 200px;
        }
        
        .btn-student-fees-success {
            background: #28a745;
            color: white;
        }
        
        .btn-student-fees-danger {
            background: #DC143C;
            color: white;
        }
        
        .search-input-width {
            width: 300px;
        }
        
        .btn-student-search {
            background: #17a2b8;
            color: white;
        }
        
        .student-profile-section {
            display: none;
        }
        
        .btn-report-success {
            background: #28a745;
            color: white;
        }
        
        .btn-report-info {
            background: #20B2AA;
            color: white;
        }
        
        .report-daily-button {
            background: #28a745;
            color: white;
        }
        
        .report-daily-danger {
            background: #DC143C;
            color: white;
        }
        
        .weekly-report-section {
            display: none;
        }
        
        .weekly-report-button {
            background: #28a745;
            color: white;
        }
        
        .weekly-report-danger {
            background: #DC143C;
            color: white;
        }
        
        .monthly-report-section {
            display: none;
        }
        
        .monthly-report-button {
            background: #28a745;
            color: white;
        }
        
        .monthly-report-danger {
            background: #DC143C;
            color: white;
        }
        
        .btn-backup-data {
            background: #17a2b8;
            color: white;
        }
        
        .btn-reset-system {
            background: #6c757d;
            color: white;
        }
        
        .btn-logout {
            background: #dc3545;
            color: white;
        }
        
        .btn-export-pdf {
            background: #DC143C;
            color: white;
        }
        
        .delete-worker-btn {
            display: none;
        }
        
        .student-info-display {
            display: none;
        }

        /* Styles pour le formulaire d'ajout d'√©l√®ve */
        .form-label.required::after {
            content: " *";
            color: #DC143C;
        }

        .student-form-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--box-shadow);
        }

        .medical-condition-alert {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border-radius: 4px;
        }

        .import-section {
            border: 2px dashed #dee2e6;
            border-radius: var(--border-radius);
            padding: 2rem;
            text-align: center;
            margin-bottom: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .import-section:hover {
            border-color: var(--primary);
            background: rgba(46, 139, 87, 0.05);
        }

        .import-section i {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .student-preview-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary);
        }

        .student-preview-card h6 {
            margin-bottom: 0.5rem;
            color: var(--dark);
        }

        .student-preview-card small {
            color: #6c757d;
        }
        
        /* Support Safari pour backdrop-filter */
        .modern-header,
        .main-nav,
        .nav-btn {
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }
        
        /* Support background-clip */
        .logo-text h1,
        .logo-icon {
            background-clip: padding-box;
            -webkit-background-clip: text;
            background-clip: text;
        }

        /* Am√©liorations Responsive Inputs & Selects */
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        input[type="number"],
        input[type="password"],
        select,
        textarea {
            width: 100%;
            max-width: 100%;
            font-size: 16px;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            transition: var(--transition);
            font-family: 'Inter', sans-serif;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus,
        input[type="number"]:focus,
        input[type="password"]:focus,
        select:focus,
        textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(46, 139, 87, 0.1);
            outline: none;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Responsive Tables */
        .modern-table {
            width: 100%;
            border-collapse: collapse;
        }

        .modern-table th,
        .modern-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .modern-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--dark);
        }

        @media (max-width: 768px) {
            .modern-table th,
            .modern-table td {
                padding: 8px 6px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .modern-table th,
            .modern-table td {
                padding: 6px 4px;
                font-size: 0.8rem;
            }

            .table-responsive {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                white-space: nowrap;
            }

            table {
                min-width: 320px;
            }
        }

        /* Responsive Buttons Layout */
        .d-grid {
            display: grid;
            grid-template-columns: 1fr;
        }

        @media (min-width: 769px) {
            .d-md-flex {
                display: flex !important;
            }

            .justify-content-md-end {
                justify-content: flex-end !important;
            }

            .gap-2 {
                gap: 0.5rem;
            }
        }

        @media (max-width: 768px) {
            .d-grid.gap-2.d-md-flex.justify-content-md-end {
                grid-template-columns: 1fr;
                gap: 0.5rem !important;
            }

            .d-grid.gap-2.d-md-flex.justify-content-md-end .btn-modern {
                width: 100%;
            }
        }

        /* Responsive Modals */
        @media (max-width: 768px) {
            .modal-dialog {
                margin: 0.5rem;
            }

            .modal-dialog.modal-lg {
                max-width: 95vw;
            }

            .modal-header {
                padding: 1rem;
            }

            .modal-body {
                padding: 1rem;
            }

            .modal-footer {
                padding: 1rem;
            }
        }

        /* Responsive Cards in Rows */
        @media (max-width: 768px) {
            .row.g-4 > [class*="col-"] {
                margin-bottom: 1rem;
            }

            .row.g-4 {
                gap: 1rem !important;
            }
        }

        @media (max-width: 480px) {
            .row.g-4 {
                gap: 0.5rem !important;
            }

            .row.g-4 > [class*="col-"] {
                margin-bottom: 0.5rem;
            }
        }

        /* Responsive Flex Layout */
        @media (max-width: 480px) {
            .d-flex.justify-content-between {
                flex-direction: column;
                gap: 1rem;
            }

            .d-flex.justify-content-between.align-items-center {
                align-items: flex-start;
            }

            .d-flex.gap-2 {
                flex-wrap: wrap;
                gap: 0.5rem !important;
            }

            .d-flex > .btn-modern {
                flex: 1 1 auto;
                min-width: 100px;
            }
        }

        /* Icons Responsive */
        .fa-3x {
            font-size: clamp(1.5rem, 4vw, 3rem);
        }

        .fa-2x {
            font-size: clamp(1rem, 3vw, 2rem);
        }

        /* Text Responsive */
        h1 {
            font-size: clamp(1.5rem, 5vw, 2.5rem);
        }

        h2 {
            font-size: clamp(1.25rem, 4vw, 2rem);
        }

        h3 {
            font-size: clamp(1.1rem, 3vw, 1.75rem);
        }

        h4, h5, h6 {
            font-size: clamp(1rem, 2vw, 1.5rem);
        }

        /* Padding and Margin Responsive */
        .p-3 {
            padding: clamp(0.75rem, 2vw, 1.5rem);
        }

        .p-4 {
            padding: clamp(1rem, 3vw, 2rem);
        }

        .mb-3 {
            margin-bottom: clamp(0.75rem, 2vw, 1.5rem);
        }

        .mb-4 {
            margin-bottom: clamp(1rem, 3vw, 2rem);
        }

        .mt-3 {
            margin-top: clamp(0.75rem, 2vw, 1.5rem);
        }

        .mt-4 {
            margin-top: clamp(1rem, 3vw, 2rem);
        }
        
    </style>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Header -->
    <header class="modern-header">
        <div class="header-container">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-seedling"></i>
                </div>
                <div class="logo-text">
                    <h1>EdenSmart Finances</h1>
                    <p>Syst√®me conforme aux lois financi√®res du Rwanda</p>
                </div>
            </div>
            
            <div class="d-flex align-items-center gap-3">
                <div class="search-container">
                    <input type="text" class="form-control-modern" id="globalSearch" 
                           placeholder="Rechercher dans tout le syst√®me..." 
                           onkeyup="performGlobalSearch(this.value)">
                    <div class="search-results" id="searchResults">
                        <!-- R√©sultats de recherche -->
                    </div>
                </div>
                
                <span class="legal-badge">
                    <i class="fas fa-balance-scale"></i>
                    Conforme RRA
                </span>
                
                <button id="languageToggle" class="btn-modern language-toggle-btn">
                    <i class="fas fa-language me-2"></i>
                    <span id="languageText">EN</span>
                </button>
                
                <div class="text-end">
                    <div class="fw-bold" id="userName">Utilisateur</div>
                    <small id="userRole" class="user-role-text">Comptable Principal</small>
                </div>
                <div class="user-avatar-header">
                    IA
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="main-nav">
        <div class="nav-container">
            <div class="nav-tabs">
                <button class="nav-btn active" onclick="showSection('dashboard')">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Tableau de bord</span>
                </button>
                <button class="nav-btn" onclick="showSection('teachers')">
                    <i class="fas fa-users"></i>
                    <span>Gestion Travailleurs</span>
                </button>
                <button class="nav-btn" onclick="showSection('payroll')">
                    <i class="fas fa-money-check-alt"></i>
                    <span>G√©n√©rer Payroll</span>
                </button>
                <button class="nav-btn" onclick="showSection('student-fees')">
                    <i class="fas fa-user-graduate"></i>
                    <span>Paiements</span>
                </button>
                <button class="nav-btn" onclick="showSection('students')">
                    <i class="fas fa-child"></i>
                    <span>√âl√®ves</span>
                </button>
                <button class="nav-btn" onclick="showSection('reports')">
                    <i class="fas fa-file-contract"></i>
                    <span>Rapports Financiers</span>
                </button>
                <button class="nav-btn" onclick="showSection('settings')">
                    <i class="fas fa-cog"></i>
                    <span>Param√®tres</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Section -->
        <section id="dashboard" class="section active">
            <div class="dashboard-hero">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h1 class="display-4 fw-bold mb-3">Tableau de Bord Financier</h1>
                        <p class="lead mb-4">Gestion conforme aux lois financi√®res du Rwanda</p>
                        <div class="d-flex gap-3 flex-wrap">
                            <div class="bg-white px-3 py-2 rounded-pill shadow-sm">
                                <i class="fas fa-calendar me-2 text-primary"></i>
                                <span id="currentDate">Chargement...</span>
                            </div>
                            <div class="bg-white px-3 py-2 rounded-pill shadow-sm">
                                <i class="fas fa-clock me-2 text-primary"></i>
                                <span id="currentTime">--:--</span>
                            </div>
                            <div class="bg-white px-3 py-2 rounded-pill shadow-sm">
                                <i class="fas fa-money-bill-wave me-2 text-primary"></i>
                                <span id="currencyDisplay">Devise: RWF (Franc Rwandais)</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="legal-badge mb-2">
                            <i class="fas fa-gavel"></i>
                            Loi N¬∞ 123/2020
                        </div>
                        <small class="text-muted">Exercice: 2024-2025</small>
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon stat-icon-primary">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3 class="stat-value" id="totalTeachers">0</h3>
                    <p class="text-muted mb-0">Total Travailleurs</p>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon stat-icon-danger">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <h3 class="stat-value" id="monthlyPayroll">0 RWF</h3>
                    <p class="text-muted mb-0">Payroll du Mois</p>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon stat-icon-warning">
                        <i class="fas fa-university"></i>
                    </div>
                    <h3 class="stat-value" id="bankPayments">0</h3>
                    <p class="text-muted mb-0">Paiements Banque</p>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon stat-icon-info">
                        <i class="fas fa-user-graduate"></i>
                    </div>
                    <h3 class="stat-value" id="studentPayments">0</h3>
                    <p class="text-muted mb-0">Paiements √âl√®ves</p>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-md-8">
                    <div class="chart-container">
                        <h5 class="fw-bold mb-3">
                            <i class="fas fa-chart-bar me-2 icon-text-primary"></i>
                            Statistiques Payroll R√©elles
                        </h5>
                        <canvas id="realPayrollChart" height="250"></canvas>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card h-100">
                        <h5 class="fw-bold mb-3">
                            <i class="fas fa-bullhorn me-2 icon-text-primary"></i>
                            Annonces Directeur/Secr√©taire
                        </h5>
                        <div class="list-group list-group-flush" id="filteredAnnouncementsList">
                            <div class="list-group-item border-0 px-0 py-2">
                                <small class="text-muted">Chargement...</small>
                                <p class="mb-0">Chargement des annonces...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Workers Management Section -->
        <section id="teachers" class="section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold">
                    <i class="fas fa-users me-3 icon-text-primary"></i>
                    Gestion des Travailleurs
                </h2>
                <div class="d-flex gap-2">
                    <div class="btn-group">
                        <button class="btn-modern" onclick="filterWorkers('all')">
                            Tous
                        </button>
                        <button class="btn-modern" onclick="filterWorkers('enseignant')">
                            Enseignants
                        </button>
                        <button class="btn-modern" onclick="filterWorkers('staff')">
                            Staff
                        </button>
                        <button class="btn-modern" onclick="filterWorkers('other')">
                            Autres
                        </button>
                    </div>
                    <button class="btn-modern btn-primary-modern" onclick="showWorkerModal()">
                        <i class="fas fa-plus me-2"></i> Ajouter Travailleur
                    </button>
                    <button class="btn-modern btn-debt-modal" onclick="showDebtModal()">
                        <i class="fas fa-money-bill-wave me-2"></i> Ajouter Dette
                    </button>
                </div>
            </div>

            <!-- Tableau des travailleurs -->
            <div class="stat-card">
                <div class="table-responsive">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>NO</th>
                                <th>NOM COMPLET</th>
                                <th>TYPE</th>
                                <th>TELEPHONE</th>
                                <th>MODE PAIEMENT</th>
                                <th>SALAIRE BASE</th>
                                <th>DETTES</th>
                                <th>STATUT</th>
                                <th>ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody id="workersTable">
                            <!-- Travailleurs charg√©s ici -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Payroll Generation Section -->
        <section id="payroll" class="section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold">
                    <i class="fas fa-money-check-alt me-3 icon-text-primary"></i>
                    G√©n√©ration de Payroll
                </h2>
                <div class="d-flex gap-2">
                    <button class="btn-modern btn-payroll-success" onclick="generateMonthlyPayroll()">
                        <i class="fas fa-calculator me-2"></i> G√©n√©rer Payroll
                    </button>
                    <button class="btn-modern btn-primary-modern" onclick="exportPayrollExcel()">
                        <i class="fas fa-file-excel me-2"></i> Exporter Excel
                    </button>
                    <button class="btn-modern btn-payroll-danger" onclick="exportPayrollPDF()">
                        <i class="fas fa-file-pdf me-2"></i> Exporter PDF
                    </button>
                    <button class="btn-modern btn-payroll-history" onclick="showPayrollHistory()">
                        <i class="fas fa-history me-2"></i> Historique
                    </button>
                </div>
            </div>

            <!-- Filters -->
            <div class="stat-card mb-4">
                <h5 class="fw-bold mb-3">
                    <i class="fas fa-filter me-2 icon-text-primary"></i>
                    Filtres de Payroll
                </h5>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Mois</label>
                        <select class="form-control-modern" id="payrollMonth" onchange="updateCurrentPeriod()">
                            <option value="1">Janvier</option>
                            <option value="2">F√©vrier</option>
                            <option value="3">Mars</option>
                            <option value="4">Avril</option>
                            <option value="5">Mai</option>
                            <option value="6">Juin</option>
                            <option value="7">Juillet</option>
                            <option value="8">Ao√ªt</option>
                            <option value="9">Septembre</option>
                            <option value="10">Octobre</option>
                            <option value="11">Novembre</option>
                            <option value="12">D√©cembre</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Ann√©e</label>
                        <select class="form-control-modern" id="payrollYear" onchange="updateCurrentPeriod()">
                            <option value="2025">2025</option>
                            <option value="2026" selected>2026</option>
                            <option value="2027">2027</option>
                            <option value="2028">2028</option>
                            <option value="2029">2029</option>
                            <option value="2030">2030</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Mode Paiement</label>
                        <select class="form-control-modern" id="filterPaymentMode" onchange="filterPayroll()">
                            <option value="all">Tous les modes</option>
                            <option value="bank">Banque</option>
                            <option value="momo">Mobile Money</option>
                            <option value="cash">Esp√®ces</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Statut</label>
                        <select class="form-control-modern" id="filterStatus" onchange="filterPayroll()">
                            <option value="all">Tous les statuts</option>
                            <option value="pending">En attente</option>
                            <option value="paid">Pay√©</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Dettes en cours -->
            <div class="stat-card mb-4">
                <h5 class="fw-bold mb-3">
                    <i class="fas fa-money-bill-wave me-2 icon-text-primary"></i>
                    Dettes en Cours pour ce Mois
                </h5>
                <div class="table-responsive">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Type</th>
                                <th>Montant Dette</th>
                                <th>Date</th>
                                <th>Motif</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="currentMonthDebtsTable">
                            <!-- Dettes du mois charg√©es depuis Firebase -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Payroll Table -->
            <div class="stat-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold mb-0">
                        PAYROLL - <span id="currentPeriod">Janvier 2026</span>
                    </h5>
                    <div class="text-end">
                        <h5 class="fw-bold text-primary" id="totalPayrollAmount">Total: 0 RWF</h5>
                        <small class="text-muted">Pr√©par√© par <span id="preparedBy">Utilisateur</span></small>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>NO</th>
                                <th>NOMS</th>
                                <th>TYPE</th>
                                <th>MODE PAIEMENT</th>
                                <th>SALAIRE BASE</th>
                                <th>DETTES</th>
                                <th>SALAIRE NET</th>
                                <th>STATUT</th>
                                <th>ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody id="payrollTable">
                            <!-- Payroll data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Historique des Payrolls -->
            <div class="stat-card mt-4 payroll-history-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold mb-0">
                        <i class="fas fa-history me-2 icon-text-primary"></i>
                        Historique des Payrolls
                    </h5>
                    <button class="btn btn-sm btn-danger" onclick="hidePayrollHistory()">
                        <i class="fas fa-times me-1"></i> Fermer
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>Mois/Ann√©e</th>
                                <th>Nombre Travailleurs</th>
                                <th>Total Payroll</th>
                                <th>Statut</th>
                                <th>G√©n√©r√© par</th>
                                <th>Date G√©n√©ration</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="payrollHistoryTable">
                            <!-- Historique des payrolls -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Student Fees Section -->
        <section id="student-fees" class="section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold">
                    <i class="fas fa-user-graduate me-3 icon-text-primary"></i>
                    Paiements des √âl√®ves
                </h2>
                <div class="d-flex gap-2 align-items-center">
                    <!-- Filtres -->
                    <select class="form-control-modern filter-select-width" id="filterClass" onchange="filterStudentPayments()">
                        <option value="">Toutes classes</option>
                        <optgroup label="NURSERY">
                            <option value="N1A">N1A (Nursery 1A)</option>
                            <option value="N1B">N1B (Nursery 1B)</option>
                            <option value="N1C">N1C (Nursery 1C)</option>
                            <option value="N2A">N2A (Nursery 2A)</option>
                            <option value="N2B">N2B (Nursery 2B)</option>
                            <option value="N2C">N2C (Nursery 2C)</option>
                            <option value="N3A">N3A (Nursery 3A)</option>
                            <option value="N3B">N3B (Nursery 3B)</option>
                            <option value="N3C">N3C (Nursery 3C)</option>
                        </optgroup>
                        <optgroup label="PRIMAIRE">
                            <option value="P1A">P1A</option>
                            <option value="P1B">P1B</option>
                            <option value="P1C">P1C</option>
                            <option value="P2A">P2A</option>
                            <option value="P2B">P2B</option>
                            <option value="P2C">P2C</option>
                            <option value="P3A">P3A</option>
                            <option value="P3B">P3B</option>
                            <option value="P3C">P3C</option>
                            <option value="P4A">P4A</option>
                            <option value="P4B">P4B</option>
                            <option value="P4C">P4C</option>
                            <option value="P5A">P5A</option>
                            <option value="P5B">P5B</option>
                            <option value="P5C">P5C</option>
                            <option value="P6A">P6A</option>
                            <option value="P6B">P6B</option>
                            <option value="P6C">P6C</option>
                        </optgroup>
                    </select>
                    <input type="month" class="form-control-modern filter-month-width" id="filterMonth" onchange="filterStudentPayments()">
                    <button class="btn-modern btn-primary-modern" onclick="showStudentFeeModal()">
                        <i class="fas fa-plus me-2"></i> Nouveau Paiement
                    </button>
                    <button class="btn-modern btn-student-fees-success" onclick="exportStudentFeesExcel()">
                        <i class="fas fa-file-excel me-2"></i> Exporter Excel
                    </button>
                    <button class="btn-modern btn-student-fees-danger" onclick="exportStudentFeesPDF()">
                        <i class="fas fa-file-pdf me-2"></i> Exporter PDF
                    </button>
                </div>
            </div>

            <div class="stat-card">
                <div class="table-responsive">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>NO</th>
                                <th>R√âF√âRENCE</th>
                                <th>NOM √âL√àVE</th>
                                <th>CLASSE</th>
                                <th>TYPE</th>
                                <th>MONTANT/FRW</th>
                                <th>DATE</th>
                                <th>MODE PAIEMENT</th>
                                <th>SOLDE RESTANT</th>
                                <th>RE√áU PAR</th>
                                <th>ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody id="studentFeesTable">
                            <!-- Donn√©es √©l√®ves seront charg√©es ici -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Students Section -->
        <section id="students" class="section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold">
                    <i class="fas fa-child me-3 icon-text-primary"></i>
                    Gestion des √âl√®ves
                </h2>
                <div class="d-flex gap-2">
                    <div class="input-group search-input-width">
                        <input type="text" class="form-control-modern" id="searchStudent" placeholder="Rechercher un √©l√®ve...">
                        <button class="btn-modern" onclick="searchStudent()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <button class="btn-modern btn-student-search" onclick="loadStudentsFromDatabase()">
                        <i class="fas fa-sync me-2"></i> Actualiser
                    </button>
                    <button class="btn-modern btn-primary-modern" onclick="showStudentModal()">
                        <i class="fas fa-plus me-2"></i> Ajouter √âl√®ve
                    </button>
                </div>
            </div>

            <!-- Profil √©l√®ve -->
            <div class="stat-card mb-4 student-profile-section">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="student-avatar mb-3">
                                <i class="fas fa-user-graduate fa-3x"></i>
                            </div>
                            <h5 id="studentNameProfile"></h5>
                            <p id="studentClassProfile"></p>
                            <p id="studentAgeProfile"></p>
                            <p id="studentReferenceProfile" class="fw-bold"></p>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-bold mb-0">Historique des Paiements</h6>
                            <button class="btn btn-sm btn-primary" onclick="addPaymentForCurrentStudent()">
                                <i class="fas fa-money-bill-wave me-1"></i> Ajouter Paiement
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="modern-table">
                                <thead>
                                    <tr>
                                        <th>R√©f√©rence</th>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th>Montant</th>
                                        <th>Mode</th>
                                        <th>Re√ßu par</th>
                                    </tr>
                                </thead>
                                <tbody id="studentPaymentsHistory">
                                    <!-- Historique charg√© depuis Firebase -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-3 row">
                            <div class="col-md-6">
                                <h6>Total Pay√©: <span id="totalPaid" class="text-success fw-bold">0 RWF</span></h6>
                                <h6>Solde Restant: <span id="remainingBalance" class="text-danger fw-bold">0 RWF</span></h6>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-sm btn-info" onclick="updateStudentReference()">
                                    <i class="fas fa-qrcode me-1"></i> G√©n√©rer R√©f√©rence
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Liste des √©l√®ves -->
            <div class="stat-card">
                <div class="table-responsive">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>NO</th>
                                <th>R√âF√âRENCE</th>
                                <th>NOM COMPLET</th>
                                <th>CLASSE</th>
                                <th>DATE NAISSANCE</th>
                                <th>TOTAL PAY√â</th>
                                <th>ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTable">
                            <!-- √âl√®ves charg√©s depuis Firebase -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Reports Section -->
        <section id="reports" class="section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold">
                    <i class="fas fa-file-contract me-3 icon-text-primary"></i>
                    Rapports Financiers
                </h2>
                <div class="d-flex gap-2">
                    <div class="btn-group">
                        <button class="btn-modern btn-primary-modern" onclick="showDailyReport()">
                            <i class="fas fa-calendar-day me-2"></i> Journalier
                        </button>
                        <button class="btn-modern btn-report-success" onclick="showWeeklyReport()">
                            <i class="fas fa-calendar-week me-2"></i> Hebdomadaire
                        </button>
                        <button class="btn-modern btn-report-info" onclick="showMonthlyReport()">
                            <i class="fas fa-calendar-alt me-2"></i> Mensuel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Rapport Journalier -->
            <div class="stat-card" id="dailyReportSection">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold mb-0">
                        <i class="fas fa-calendar-day me-2 icon-text-primary"></i>
                        Rapport Financier Journalier
                    </h5>
                    <div class="d-flex gap-2">
                        <label class="form-label fw-bold">Date:</label>
                        <input type="date" class="form-control form-control-sm d-inline-block w-auto" id="dailyReportDate" value="<?php echo date('Y-m-d'); ?>" onchange="loadDailyReport()">
                    </div>
                </div>

                <!-- R√©sum√© du jour -->
                <div class="report-summary-cards" id="daySummary">
                    <!-- Les cartes de r√©sum√© seront ajout√©es ici dynamiquement -->
                </div>

                <div class="table-responsive">
                    <table class="modern-table financial-table">
                        <thead>
                            <tr>
                                <th rowspan="2">Solde d'Ouverture</th>
                                <th colspan="5" class="text-center">INCOME</th>
                                <th colspan="2" class="text-center">EXPENSES</th>
                                <th rowspan="2">Total Expenses</th>
                                <th rowspan="2">Solde Final</th>
                                <th rowspan="2">Diff√©rence</th>
                            </tr>
                            <tr>
                                <th>Minerval</th>
                                <th>Transport</th>
                                <th>Coaching</th>
                                <th>Uniforme</th>
                                <th>Autres</th>
                                <th>Justification</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody id="dailyReportBody">
                            <!-- Donn√©es calcul√©es automatiquement -->
                        </tbody>
                    </table>
                </div>

                <!-- Formulaire pour ajouter des d√©penses -->
                <div class="report-form-section">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-plus-circle me-2 text-primary"></i>
                        Ajouter une D√©pense
                    </h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Justification de la d√©pense *</label>
                            <select class="form-control-modern" id="expenseCategory">
                                <option value="">S√©lectionnez une cat√©gorie</option>
                                <option value="Salaires">Salaires du personnel</option>
                                <option value="Loyer">Loyer</option>
                                <option value="Electricit√©">√âlectricit√©</option>
                                <option value="Eau">Eau</option>
                                <option value="Internet">Internet</option>
                                <option value="Nourriture">Nourriture</option>
                                <option value="Transport">Transport</option>
                                <option value="Fournitures">Fournitures de bureau</option>
                                <option value="Materiel">Mat√©riel p√©dagogique</option>
                                <option value="Maintenance">Maintenance</option>
                                <option value="Autre">Autre d√©pense</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Montant (RWF) *</label>
                            <input type="number" class="form-control-modern" id="expenseAmount" placeholder="Montant">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn-modern btn-primary-modern w-100" onclick="addDailyExpense()">
                                <i class="fas fa-plus me-2"></i> Ajouter
                            </button>
                        </div>
                    </div>
                    
                    <!-- Liste des d√©penses ajout√©es -->
                    <div class="mt-3" id="expensesList">
                        <!-- Les d√©penses seront ajout√©es ici dynamiquement -->
                    </div>
                </div>

                <!-- Actions du rapport -->
                <div class="report-form-section">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-file-alt me-2 text-primary"></i>
                        Actions du Rapport
                    </h6>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Pr√©par√© par *</label>
                            <input type="text" class="form-control-modern" id="reportPreparedBy" value="Utilisateur" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Date du rapport *</label>
                            <input type="date" class="form-control-modern" id="reportDate" value="<?php echo date('Y-m-d'); ?>">
                        </div>
                        
                        <div class="col-md-12">
                            <label class="form-label">Observations g√©n√©rales</label>
                            <textarea class="form-control-modern" id="generalObservations" rows="2" placeholder="Observations sur la journ√©e..."></textarea>
                        </div>
                        
                        <div class="col-md-12 mt-3">
                            <div class="d-grid gap-2">
                                <button class="btn-modern btn-primary-modern" onclick="saveDailyReport()">
                                    <i class="fas fa-save me-2"></i> Enregistrer Rapport
                                </button>
                                <button class="btn-modern btn-report-daily-button" onclick="exportDailyReportExcel()">
                                    <i class="fas fa-file-excel me-2"></i> Exporter Excel
                                </button>
                                <button class="btn-modern btn-report-daily-danger" onclick="exportDailyReportPDF()">
                                    <i class="fas fa-file-pdf me-2"></i> Exporter PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rapport Hebdomadaire -->
            <div class="stat-card mt-4 weekly-report-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold mb-0">
                        <i class="fas fa-calendar-week me-2 icon-text-primary"></i>
                        Rapport Financier Hebdomadaire
                    </h5>
                    <div class="d-flex gap-2">
                        <label class="form-label fw-bold">Semaine:</label>
                        <input type="week" class="form-control form-control-sm d-inline-block w-auto" id="weeklyReportDate" onchange="loadWeeklyReport()">
                    </div>
                </div>

                <div class="chart-container mb-4">
                    <canvas id="weeklyChart" height="150"></canvas>
                </div>

                <div class="table-responsive">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>Jour</th>
                                <th>Solde Ouverture</th>
                                <th>Total Income</th>
                                <th>Total Expenses</th>
                                <th>Solde Final</th>
                                <th>Diff√©rence</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="weeklyReportTable">
                            <!-- Donn√©es hebdomadaires -->
                        </tbody>
                    </table>
                </div>

                <div class="report-form-section">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-file-alt me-2 text-primary"></i>
                        Actions du Rapport Hebdomadaire
                    </h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Pr√©par√© par *</label>
                            <input type="text" class="form-control-modern" id="weeklyReportPreparedBy" value="Utilisateur" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">P√©riode *</label>
                            <input type="text" class="form-control-modern" id="weeklyPeriod" readonly>
                        </div>
                        
                        <div class="col-md-12">
                            <label class="form-label">R√©sum√© de la semaine</label>
                            <textarea class="form-control-modern" id="weeklySummary" rows="3" placeholder="R√©sum√© des activit√©s et observations de la semaine..."></textarea>
                        </div>
                        
                        <div class="col-md-12 mt-3">
                            <div class="d-grid gap-2">
                                <button class="btn-modern btn-primary-modern" onclick="generateWeeklyReport()">
                                    <i class="fas fa-calculator me-2"></i> G√©n√©rer Rapport Hebdomadaire
                                </button>
                                <button class="btn-modern btn-weekly-report-button" onclick="exportWeeklyReportExcel()">
                                    <i class="fas fa-file-excel me-2"></i> Exporter Excel
                                </button>
                                <button class="btn-modern btn-weekly-report-danger" onclick="exportWeeklyReportPDF()">
                                    <i class="fas fa-file-pdf me-2"></i> Exporter PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rapport Mensuel -->
            <div class="stat-card mt-4 monthly-report-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold mb-0">
                        <i class="fas fa-calendar-alt me-2 icon-text-primary"></i>
                        Rapport Financier Mensuel
                    </h5>
                    <div class="d-flex gap-2">
                        <label class="form-label fw-bold">Mois:</label>
                        <input type="month" class="form-control form-control-sm d-inline-block w-auto" id="monthlyReportDate" onchange="loadMonthlyReport()">
                    </div>
                </div>

                <div class="chart-container mb-4">
                    <canvas id="monthlyChart" height="150"></canvas>
                </div>

                <div class="table-responsive">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>Semaine</th>
                                <th>Total Income</th>
                                <th>Total Expenses</th>
                                <th>Solde Final</th>
                                <th>Diff√©rence</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="monthlyReportTable">
                            <!-- Donn√©es mensuelles -->
                        </tbody>
                    </table>
                </div>

                <div class="report-form-section">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-file-alt me-2 text-primary"></i>
                        Actions du Rapport Mensuel
                    </h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Pr√©par√© par *</label>
                            <input type="text" class="form-control-modern" id="monthlyReportPreparedBy" value="Utilisateur" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Mois/Ann√©e *</label>
                            <input type="text" class="form-control-modern" id="monthlyPeriod" readonly>
                        </div>
                        
                        <div class="col-md-12">
                            <label class="form-label">Analyse mensuelle</label>
                            <textarea class="form-control-modern" id="monthlyAnalysis" rows="3" placeholder="Analyse des performances financi√®res du mois..."></textarea>
                        </div>
                        
                        <div class="col-md-12 mt-3">
                            <div class="d-grid gap-2">
                                <button class="btn-modern btn-primary-modern" onclick="generateMonthlyReport()">
                                    <i class="fas fa-calculator me-2"></i> G√©n√©rer Rapport Mensuel
                                </button>
                                <button class="btn-modern btn-monthly-report-button" onclick="exportMonthlyReportExcel()">
                                    <i class="fas fa-file-excel me-2"></i> Exporter Excel
                                </button>
                                <button class="btn-modern btn-monthly-report-danger" onclick="exportMonthlyReportPDF()">
                                    <i class="fas fa-file-pdf me-2"></i> Exporter PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historique des Rapports -->
            <div class="stat-card mt-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold mb-0">
                        <i class="fas fa-history me-2 icon-text-primary"></i>
                        Historique des Rapports
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadReportHistory()">
                        <i class="fas fa-sync me-1"></i> Actualiser
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>P√©riode</th>
                                <th>Total Income</th>
                                <th>Total Expenses</th>
                                <th>Diff√©rence</th>
                                <th>G√©n√©r√© par</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reportHistoryTable">
                            <!-- Historique des rapports -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Settings Section -->
        <section id="settings" class="section">
            <div class="mb-4">
                <h2 class="fw-bold mb-2">
                    <i class="fas fa-cog me-3 icon-text-primary"></i>
                    Param√®tres du Syst√®me
                </h2>
                <p class="text-muted">Configuration et pr√©f√©rences du syst√®me</p>
            </div>

            <div class="row g-4">
                <!-- Account Settings -->
                <div class="col-md-6">
                    <div class="stat-card">
                        <h5 class="fw-bold mb-3">
                            <i class="fas fa-user-cog me-2 icon-text-primary"></i>
                            Informations Comptable
                        </h5>
                        <div class="mb-3">
                            <label class="form-label">Nom Complet</label>
                            <input type="text" class="form-control-modern" id="accountantName" value="Utilisateur">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Titre/Poste</label>
                            <input type="text" class="form-control-modern" id="accountantTitle" value="COMPTABLE PRINCIPAL">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control-modern" id="accountantEmail" placeholder="email@exemple.com">
                        </div>
                        <div class="d-grid">
                            <button class="btn-modern btn-primary-modern" onclick="saveAccountantInfo()">
                                <i class="fas fa-save me-2"></i>
                                Enregistrer
                            </button>
                        </div>
                    </div>
                </div>

                <!-- System Settings -->
                <div class="col-md-6">
                    <div class="stat-card">
                        <h5 class="fw-bold mb-3">
                            <i class="fas fa-sliders-h me-2 icon-text-primary"></i>
                            Configuration Payroll
                        </h5>
                        <div class="mb-3">
                            <label class="form-label">Taux Heures Suppl√©mentaires</label>
                            <div class="input-group">
                                <input type="number" class="form-control-modern" value="5000" id="overtimeRate">
                                <span class="input-group-text">RWF/heure</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Taux Cotisations Sociales</label>
                            <div class="input-group">
                                <input type="number" class="form-control-modern" value="8" id="socialRate">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Jour de Paiement</label>
                            <select class="form-control-modern" id="paymentDay">
                                <option value="25">25 du mois</option>
                                <option value="30">30 du mois</option>
                                <option value="28">Dernier jour ouvrable</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Devise</label>
                            <select class="form-control-modern" id="currency">
                                <option value="RWF" selected>Franc Rwandais (RWF)</option>
                                <option value="USD">Dollar US</option>
                            </select>
                        </div>
                        <div class="d-grid">
                            <button class="btn-modern btn-primary-modern" onclick="saveSettings()">
                                <i class="fas fa-save me-2"></i>
                                Enregistrer les Param√®tres
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Branches Configuration -->
                <div class="col-md-12">
                    <div class="stat-card">
                        <h5 class="fw-bold mb-3">
                            <i class="fas fa-school me-2 icon-text-primary"></i>
                            Configuration des Branches
                        </h5>
                        
                        <div class="branch-options">
                            <div class="branch-option">
                                <div class="branch-card" onclick="selectBranch('kacyiru')" id="branchKacyiru">
                                    <h6>EDEN FAMILY SCHOOL KACYIRU</h6>
                                    <small>√âcole principale - Kacyiru</small>
                                </div>
                            </div>
                            <div class="branch-option">
                                <div class="branch-card" onclick="selectBranch('kimisagara')" id="branchKimisagara">
                                    <h6>EDEN FAMILY SCHOOL KIMISAGARA</h6>
                                    <small>Branche Kimisagara</small>
                                </div>
                            </div>
                            <div class="branch-option">
                                <div class="branch-card" onclick="selectBranch('gisozimaternelle')" id="branchGisozimaternelle">
                                    <h6>EDEN FAMILY SCHOOL GISOZI MATERNELLE</h6>
                                    <small>Section maternelle - Gisozi</small>
                                </div>
                            </div>
                            <div class="branch-option">
                                <div class="branch-card" onclick="selectBranch('gisoziprimaire')" id="branchGisoziprimaire">
                                    <h6>EDEN FAMILY SCHOOL GISOZI PRIMAIRE</h6>
                                    <small>Section primaire - Gisozi</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <input type="hidden" id="selectedBranch" value="kacyiru">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Branche s√©lectionn√©e: <strong id="currentBranchText">EDEN FAMILY SCHOOL KACYIRU</strong>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Fee Configuration -->
                <div class="col-md-12">
                    <div class="stat-card">
                        <h5 class="fw-bold mb-3">
                            <i class="fas fa-money-bill-wave me-2 icon-text-primary"></i>
                            Configuration des Frais par Trimestre
                        </h5>
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Branche *</label>
                                <input type="text" class="form-control-modern" id="feeBranch" value="EDEN FAMILY SCHOOL KACYIRU" readonly>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Trimestre *</label>
                                <select class="form-control-modern" id="feeQuarter">
                                    <option value="1">Trimestre 1</option>
                                    <option value="2">Trimestre 2</option>
                                    <option value="3">Trimestre 3</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Ann√©e Scolaire *</label>
                                <select class="form-control-modern" id="feeYear">
                                    <option value="2024-2025">2024-2025</option>
                                    <option value="2025-2026">2025-2026</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <h6>Frais Scolaires (RWF)</h6>
                                <div class="mb-3">
                                    <label class="form-label">Minervale</label>
                                    <input type="number" class="form-control-modern" id="feeMinervale" value="150000">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Transport</label>
                                    <input type="number" class="form-control-modern" id="feeTransport" value="50000">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Coaching</label>
                                    <input type="number" class="form-control-modern" id="feeCoaching" value="80000">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Uniforme</label>
                                    <input type="number" class="form-control-modern" id="feeUniform" value="30000">
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <h6>Frais Suppl√©mentaires (RWF)</h6>
                                <div class="mb-3">
                                    <label class="form-label">Lunch</label>
                                    <input type="number" class="form-control-modern" id="feeLunch" value="20000">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Breakfast</label>
                                    <input type="number" class="form-control-modern" id="feeBreakfast" value="10000">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Mat√©riel Scolaire</label>
                                    <input type="number" class="form-control-modern" id="feeMaterial" value="15000">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Assurance</label>
                                    <input type="number" class="form-control-modern" id="feeInsurance" value="10000">
                                </div>
                            </div>
                        </div>

                        <div class="d-grid">
                            <button class="btn-modern btn-primary-modern" onclick="saveFeeConfiguration()">
                                <i class="fas fa-save me-2"></i>
                                Enregistrer la Configuration
                            </button>
                        </div>
                    </div>
                </div>

                <!-- System Actions -->
                <div class="col-md-12">
                    <div class="stat-card">
                        <h5 class="fw-bold mb-3">
                            <i class="fas fa-shield-alt me-2 icon-text-primary"></i>
                            Actions Syst√®me
                        </h5>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <button class="btn-modern w-100 btn-backup-data" onclick="backupData()">
                                    <i class="fas fa-database me-2"></i>
                                    Sauvegarde Donn√©es
                                </button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button class="btn-modern w-100 btn-primary-modern" onclick="exportAllDataExcel()">
                                    <i class="fas fa-file-excel me-2"></i>
                                    Exporter Excel
                                </button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button class="btn-modern w-100 btn-payroll-danger" onclick="exportAllDataPDF()">
                                    <i class="fas fa-file-pdf me-2"></i>
                                    Exporter PDF
                                </button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button class="btn-modern w-100 btn-reset-system" onclick="resetSystem()">
                                    <i class="fas fa-redo me-2"></i>
                                    R√©initialiser
                                </button>
                            </div>
                            <div class="col-md-12 mb-3">
                                <button class="btn-modern w-100 btn-logout" onclick="logout()">
                                    <i class="fas fa-sign-out-alt me-2"></i>
                                    D√©connexion
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Student Management Section -->
                <div class="col-md-12">
                    <div class="stat-card">
                        <h5 class="fw-bold mb-3">
                            <i class="fas fa-user-plus me-2 icon-text-primary"></i>
                            Ajout d'√âl√®ve (Administrateur)
                        </h5>
                        
                        <form id="studentFormAdmin">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Code R√©f√©rence *</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control-modern" id="studentReferenceAdmin" 
                                               placeholder="EDU-20260118-120000" readonly>
                                        <button type="button" class="btn-modern" onclick="generateStudentReferenceAdmin()" 
                                                title="G√©n√©rer r√©f√©rence">
                                            <i class="fas fa-sync"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nom Complet *</label>
                                    <input type="text" class="form-control-modern" id="studentFullNameAdmin" 
                                           placeholder="Pr√©nom et Nom" required>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Date de Naissance *</label>
                                    <input type="date" class="form-control-modern" id="studentBirthDateAdmin" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Classe *</label>
                                    <select class="form-control-modern" id="studentClassAdmin" required>
                                        <option value="">S√©lectionnez</option>
                                        <optgroup label="NURSERY">
                                            <option value="N1A">N1A (Nursery 1A)</option>
                                            <option value="N1B">N1B (Nursery 1B)</option>
                                            <option value="N1C">N1C (Nursery 1C)</option>
                                            <option value="N2A">N2A (Nursery 2A)</option>
                                            <option value="N2B">N2B (Nursery 2B)</option>
                                            <option value="N2C">N2C (Nursery 2C)</option>
                                            <option value="N3A">N3A (Nursery 3A)</option>
                                            <option value="N3B">N3B (Nursery 3B)</option>
                                            <option value="N3C">N3C (Nursery 3C)</option>
                                        </optgroup>
                                        <optgroup label="PRIMAIRE">
                                            <option value="P1A">P1A</option>
                                            <option value="P1B">P1B</option>
                                            <option value="P1C">P1C</option>
                                            <option value="P2A">P2A</option>
                                            <option value="P2B">P2B</option>
                                            <option value="P2C">P2C</option>
                                            <option value="P3A">P3A</option>
                                            <option value="P3B">P3B</option>
                                            <option value="P3C">P3C</option>
                                            <option value="P4A">P4A</option>
                                            <option value="P4B">P4B</option>
                                            <option value="P4C">P4C</option>
                                            <option value="P5A">P5A</option>
                                            <option value="P5B">P5B</option>
                                            <option value="P5C">P5C</option>
                                            <option value="P6A">P6A</option>
                                            <option value="P6B">P6B</option>
                                            <option value="P6C">P6C</option>
                                        </optgroup>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nom du Parent/Tuteur *</label>
                                    <input type="text" class="form-control-modern" id="studentParentAdmin" 
                                           placeholder="Nom du parent/tuteur" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">T√©l√©phone du Parent *</label>
                                    <input type="tel" class="form-control-modern" id="studentParentPhoneAdmin" 
                                           placeholder="0781234567" pattern="07[0-9]{8}" required>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Email du Parent</label>
                                    <input type="email" class="form-control-modern" id="studentParentEmailAdmin" 
                                           placeholder="parent@email.com">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Branche *</label>
                                    <select class="form-control-modern" id="studentBranchAdmin" required>
                                        <option value="kacyiru">EDEN FAMILY SCHOOL KACYIRU</option>
                                        <option value="kimisagara">EDEN FAMILY SCHOOL KIMISAGARA</option>
                                        <option value="gisozimaternelle">EDEN FAMILY SCHOOL GISOZI MATERNELLE</option>
                                        <option value="gisoziprimaire">EDEN FAMILY SCHOOL GISOZI PRIMAIRE</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Adresse du Domicile</label>
                                    <textarea class="form-control-modern" id="studentAddressAdmin" 
                                              rows="2" placeholder="Adresse compl√®te"></textarea>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Date d'Inscription *</label>
                                    <input type="date" class="form-control-modern" id="studentEnrollmentDateAdmin" 
                                           value="<?php echo date('Y-m-d'); ?>" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Type d'Inscription</label>
                                    <select class="form-control-modern" id="studentEnrollmentTypeAdmin">
                                        <option value="regular">R√©gulier</option>
                                        <option value="new">Nouveau</option>
                                        <option value="transfer">Transfert</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="studentHasMedicalCondition">
                                        <label class="form-check-label" for="studentHasMedicalCondition">
                                            Conditions m√©dicales sp√©cifiques
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row" id="medicalConditionInfo" style="display: none;">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">D√©tails des conditions m√©dicales</label>
                                    <textarea class="form-control-modern" id="studentMedicalDetails" 
                                              rows="2" placeholder="D√©crire les conditions m√©dicales, allergies, etc."></textarea>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                                <button type="button" class="btn-modern btn-secondary" onclick="resetStudentFormAdmin()">
                                    <i class="fas fa-redo me-2"></i> R√©initialiser
                                </button>
                                <button type="button" class="btn-modern btn-primary-modern" onclick="saveStudentAdmin()">
                                    <i class="fas fa-save me-2"></i> Enregistrer l'√âl√®ve
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Section d'importation (optionnelle) -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="import-section" onclick="importStudents()">
                            <i class="fas fa-file-import"></i>
                            <h5>Importer plusieurs √©l√®ves</h5>
                            <p class="text-muted mb-2">Cliquez pour importer un fichier CSV ou Excel</p>
                            <small class="text-muted">Format requis: Nom Complet, Date Naissance, Classe, Parent, T√©l√©phone, Email, Adresse</small>
                        </div>
                    </div>
                </div>

                <!-- Template de fichier CSV (lien de t√©l√©chargement) -->
                <div class="row mt-3">
                    <div class="col-md-12 text-center">
                        <a href="#" onclick="downloadCSVTemplate()" class="text-decoration-none">
                            <i class="fas fa-download me-2"></i>
                            T√©l√©charger le template CSV
                        </a>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Worker Modal -->
    <div class="modal fade" id="workerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Gestion Travailleur</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>
                <div class="modal-body">
                    <form id="workerForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Type de Travailleur *</label>
                                <select class="form-control-modern" id="workerType" required onchange="validateWorkerType()">
                                    <option value="">S√©lectionnez</option>
                                    <option value="enseignant">Enseignant</option>
                                    <option value="staff">Staff</option>
                                    <option value="directeur">Directeur</option>
                                    <option value="secretaire">Secr√©taire</option>
                                    <option value="autre">Autre</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">NO *</label>
                                <input type="text" class="form-control-modern" id="workerNo" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Nom Complet *</label>
                                <input type="text" class="form-control-modern" id="workerName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Num√©ro T√©l√©phone *</label>
                                <input type="tel" class="form-control-modern" id="workerPhone" required pattern="07[0-9]{8}" placeholder="0781234567">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Salaire Base (RWF) *</label>
                                <input type="number" class="form-control-modern" id="workerSalary" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Mode de Paiement *</label>
                                <select class="form-control-modern" id="workerPaymentMode" required onchange="togglePaymentInfo()">
                                    <option value="">S√©lectionnez</option>
                                    <option value="bank">Banque</option>
                                    <option value="momo">Mobile Money</option>
                                    <option value="cash">Esp√®ces</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Bank Information -->
                        <div id="bankInfo" class="d-none">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Num√©ro de Compte *</label>
                                    <input type="text" class="form-control-modern" id="workerAccountNo">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nom de la Banque *</label>
                                    <select class="form-control-modern" id="workerBankName">
                                        <option value="">S√©lectionnez</option>
                                        <option value="BK">Bank of Kigali (BK)</option>
                                        <option value="I&M">I&M Bank Rwanda</option>
                                        <option value="GT">GT Bank Rwanda</option>
                                        <option value="COGE">Cogebanque</option>
                                        <option value="ACCESS">Access Bank Rwanda</option>
                                        <option value="ECOBANK">Ecobank Rwanda</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Mobile Money Information -->
                        <div id="momoInfo" class="d-none">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Num√©ro Mobile Money *</label>
                                    <input type="tel" class="form-control-modern" id="workerMomoNumber">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Op√©rateur Mobile Money *</label>
                                    <select class="form-control-modern" id="workerMomoOperator">
                                        <option value="">S√©lectionnez</option>
                                        <option value="MTN">MTN Mobile Money</option>
                                        <option value="AIRTEL">Airtel Money</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Date d'Embauche</label>
                            <input type="date" class="form-control-modern" id="workerHireDate">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Branche *</label>
                            <select class="form-control-modern" id="workerBranch" required>
                                <option value="kacyiru">EDEN FAMILY SCHOOL KACYIRU</option>
                                <option value="kimisagara">EDEN FAMILY SCHOOL KIMISAGARA</option>
                                <option value="gisozimaternelle">EDEN FAMILY SCHOOL GISOZI MATERNELLE</option>
                                <option value="gisoziprimaire">EDEN FAMILY SCHOOL GISOZI PRIMAIRE</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i> Annuler
                    </button>
                    <button type="button" class="btn btn-outline-danger delete-worker-btn" id="deleteWorkerBtn" onclick="deleteWorker()">
                        <i class="fas fa-trash me-2"></i> Supprimer
                    </button>
                    <button type="button" class="btn btn-outline-info" id="resetWorkerBtn" onclick="resetWorkerForm()">
                        <i class="fas fa-redo me-2"></i> R√©initialiser
                    </button>
                    <button type="button" class="btn-modern btn-primary-modern" onclick="saveWorker()">
                        <i class="fas fa-save me-2"></i> Enregistrer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Debt Modal -->
    <div class="modal fade" id="debtModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Enregistrer une Dette</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>
                <div class="modal-body">
                    <form id="debtForm">
                        <div class="mb-3">
                            <label class="form-label">Travailleur *</label>
                            <select class="form-control-modern" id="debtWorker" required>
                                <!-- Options charg√©es depuis Firebase -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Montant (RWF) *</label>
                            <input type="number" class="form-control-modern" id="debtAmount" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Motif *</label>
                            <textarea class="form-control-modern" id="debtReason" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Date *</label>
                            <input type="date" class="form-control-modern" id="debtDate" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Statut</label>
                            <select class="form-control-modern" id="debtStatus">
                                <option value="pending">En attente</option>
                                <option value="paid">Pay√©</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn-modern btn-primary-modern" onclick="saveDebt()">
                        <i class="fas fa-save me-2"></i> Enregistrer Dette
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Modal -->
    <div class="modal fade" id="studentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ajouter Nouvel √âl√®ve</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>
                <div class="modal-body">
                    <form id="studentForm">
                        <!-- Code R√©f√©rence - Auto-generated and read-only -->
                        <div class="mb-3">
                            <label class="form-label">Code R√©f√©rence *</label>
                            <input type="text" class="form-control-modern" id="studentReference" placeholder="Auto-g√©n√©r√©" readonly style="background-color: #f0f0f0; cursor: not-allowed;">
                        </div>
                        
                        <!-- Nom Complet -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Nom *</label>
                                <input type="text" class="form-control-modern" id="studentLastName" placeholder="Nom de famille" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Pr√©nom *</label>
                                <input type="text" class="form-control-modern" id="studentFirstName" placeholder="Pr√©nom" required>
                            </div>
                        </div>
                        
                        <!-- Date de Naissance -->
                        <div class="mb-3">
                            <label class="form-label">Date de Naissance *</label>
                            <input type="date" class="form-control-modern" id="studentBirthDate" required>
                        </div>
                        
                        <!-- Classe et Branche -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Classe *</label>
                                <select class="form-control-modern" id="studentClass" required>
                                    <option value="">S√©lectionnez</option>
                                    <optgroup label="NURSERY (MATERNELLE)">
                                        <option value="N1A">N1A (Nursery 1A)</option>
                                        <option value="N1B">N1B (Nursery 1B)</option>
                                        <option value="N1C">N1C (Nursery 1C)</option>
                                        <option value="N2A">N2A (Nursery 2A)</option>
                                        <option value="N2B">N2B (Nursery 2B)</option>
                                        <option value="N2C">N2C (Nursery 2C)</option>
                                        <option value="N3A">N3A (Nursery 3A)</option>
                                        <option value="N3B">N3B (Nursery 3B)</option>
                                        <option value="N3C">N3C (Nursery 3C)</option>
                                    </optgroup>
                                    <optgroup label="PRIMAIRE">
                                        <option value="P1A">P1A</option>
                                        <option value="P1B">P1B</option>
                                        <option value="P1C">P1C</option>
                                        <option value="P2A">P2A</option>
                                        <option value="P2B">P2B</option>
                                        <option value="P2C">P2C</option>
                                        <option value="P3A">P3A</option>
                                        <option value="P3B">P3B</option>
                                        <option value="P3C">P3C</option>
                                        <option value="P4A">P4A</option>
                                        <option value="P4B">P4B</option>
                                        <option value="P4C">P4C</option>
                                        <option value="P5A">P5A</option>
                                        <option value="P5B">P5B</option>
                                        <option value="P5C">P5C</option>
                                        <option value="P6A">P6A</option>
                                        <option value="P6B">P6B</option>
                                        <option value="P6C">P6C</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Branche *</label>
                                <select class="form-control-modern" id="studentBranch" required>
                                    <option value="">S√©lectionnez</option>
                                    <option value="kacyiru">EDEN FAMILY SCHOOL KACYIRU</option>
                                    <option value="kimisagara">EDEN FAMILY SCHOOL KIMISAGARA</option>
                                    <option value="gisozi_maternelle">EDEN FAMILY SCHOOL GISOZI MATERNELLE</option>
                                    <option value="gisozi_primaire">EDEN FAMILY SCHOOL GISOZI PRIMAIRE</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Nom du Parent/Tuteur -->
                        <div class="mb-3">
                            <label class="form-label">Nom du Parent/Tuteur *</label>
                            <input type="text" class="form-control-modern" id="studentParent" placeholder="Nom du parent/tuteur" required>
                        </div>
                        
                        <!-- T√©l√©phones -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">T√©l√©phone du Parent *</label>
                                <input type="tel" class="form-control-modern" id="studentParentPhone" placeholder="0781234567" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">T√©l√©phone du Parent 2</label>
                                <input type="tel" class="form-control-modern" id="studentParentPhone2" placeholder="0781234567">
                            </div>
                        </div>
                        
                        <!-- Email Parent -->
                        <div class="mb-3">
                            <label class="form-label">Email du Parent</label>
                            <input type="email" class="form-control-modern" id="studentParentEmail" placeholder="parent@email.com">
                        </div>
                        
                        <!-- Adresse -->
                        <div class="mb-3">
                            <label class="form-label">Adresse du Domicile</label>
                            <input type="text" class="form-control-modern" id="studentAddress" placeholder="Adresse compl√®te">
                        </div>
                        
                        <!-- Date d'Inscription -->
                        <div class="mb-3">
                            <label class="form-label">Date d'Inscription *</label>
                            <input type="date" class="form-control-modern" id="studentEnrollmentDate" required>
                        </div>
                        
                        <!-- Type d'Inscription -->
                        <div class="mb-3">
                            <label class="form-label">Type d'Inscription</label>
                            <select class="form-control-modern" id="studentEnrollmentType">
                                <option value="R√©gulier">R√©gulier</option>
                                <option value="Sp√©cial">Sp√©cial</option>
                                <option value="Transfert">Transfert</option>
                            </select>
                        </div>
                        
                        <!-- Conditions M√©dicales -->
                        <div class="mb-3">
                            <label class="form-label">Conditions M√©dicales Sp√©cifiques</label>
                            <textarea class="form-control-modern" id="studentMedicalConditions" placeholder="Allergie, asthme, diab√®te, etc." rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="resetStudentFormComptable()">R√©initialiser</button>
                    <button type="button" class="btn-close-btn" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn-modern btn-primary-modern" onclick="saveStudent()">
                        <i class="fas fa-save me-2"></i> Enregistrer l'√âl√®ve
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Fee Modal -->
    <div class="modal fade" id="studentFeeModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Enregistrement Paiement √âl√®ve</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>
                <div class="modal-body">
                    <form id="studentFeeForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Classe *</label>
                                <select class="form-control-modern" id="studentClassFilter" required onchange="loadStudentsByClass()">
                                    <option value="">S√©lectionnez une classe</option>
                                    <optgroup label="NURSERY">
                                        <option value="N1A">N1A (Nursery 1A)</option>
                                        <option value="N1B">N1B (Nursery 1B)</option>
                                        <option value="N1C">N1C (Nursery 1C)</option>
                                        <option value="N2A">N2A (Nursery 2A)</option>
                                        <option value="N2B">N2B (Nursery 2B)</option>
                                        <option value="N2C">N2C (Nursery 2C)</option>
                                        <option value="N3A">N3A (Nursery 3A)</option>
                                        <option value="N3B">N3B (Nursery 3B)</option>
                                        <option value="N3C">N3C (Nursery 3C)</option>
                                    </optgroup>
                                    <optgroup label="PRIMAIRE">
                                        <option value="P1A">P1A</option>
                                        <option value="P1B">P1B</option>
                                        <option value="P1C">P1C</option>
                                        <option value="P2A">P2A</option>
                                        <option value="P2B">P2B</option>
                                        <option value="P2C">P2C</option>
                                        <option value="P3A">P3A</option>
                                        <option value="P3B">P3B</option>
                                        <option value="P3C">P3C</option>
                                        <option value="P4A">P4A</option>
                                        <option value="P4B">P4B</option>
                                        <option value="P4C">P4C</option>
                                        <option value="P5A">P5A</option>
                                        <option value="P5B">P5B</option>
                                        <option value="P5C">P5C</option>
                                        <option value="P6A">P6A</option>
                                        <option value="P6B">P6B</option>
                                        <option value="P6C">P6C</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">√âl√®ve *</label>
                                <select class="form-control-modern" id="studentSelect" required onchange="loadStudentDetails()">
                                    <option value="">S√©lectionnez d'abord une classe</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Student Info Display -->
                        <div class="row mb-3 student-info-display" id="studentInfoDisplay">
                            <div class="col-md-4">
                                <label class="form-label">Code R√©f√©rence</label>
                                <input type="text" class="form-control-modern" id="studentReferenceDisplay" readonly>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Date Naissance</label>
                                <input type="text" class="form-control-modern" id="studentBirthDateDisplay" readonly>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Parent</label>
                                <input type="text" class="form-control-modern" id="studentParentDisplay" readonly>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Type de Paiement *</label>
                                <select class="form-control-modern" id="studentPaymentType" required>
                                    <option value="">S√©lectionnez</option>
                                    <option value="minervale">Minervale</option>
                                    <option value="coaching">Coaching</option>
                                    <option value="transport">Transport</option>
                                    <option value="uniforme">Uniforme</option>
                                    <option value="lunch">Lunch</option>
                                    <option value="breakfast">Breakfast</option>
                                    <option value="material">Mat√©riel scolaire</option>
                                    <option value="insurance">Assurance</option>
                                    <option value="autre">Autre</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Montant (RWF) *</label>
                                <input type="number" class="form-control-modern" id="studentAmount" required>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Mode de Paiement *</label>
                                <select class="form-control-modern" id="studentPaymentMode" required>
                                    <option value="cash">Esp√®ces</option>
                                    <option value="momo">Mobile Money</option>
                                    <option value="bank">Virement Bancaire</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Date du Paiement *</label>
                                <input type="date" class="form-control-modern" id="studentPaymentDate" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">R√©f√©rence de Transaction</label>
                            <input type="text" class="form-control-modern" id="studentTransactionRef" placeholder="Num√©ro de transaction MOMO/Banque">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Notes suppl√©mentaires</label>
                            <textarea class="form-control-modern" id="studentPaymentNotes" rows="2" placeholder="Notes suppl√©mentaires..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn-modern btn-primary-modern" onclick="saveStudentFee()">
                        <i class="fas fa-save me-2"></i> Enregistrer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Firebase (Modern SDK) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getDatabase } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
        import { getStorage } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyApUFNELOfgIe7rWEek9GLS9EIphNW09-A",
            authDomain: "edensmart-app.firebaseapp.com",
            projectId: "edensmart-app",
            storageBucket: "edensmart-app.firebasestorage.app",
            messagingSenderId: "1093120876724",
            appId: "1:1093120876724:web:bc37448cadd18d651c77e1",
            measurementId: "G-1FL70PZZSW"
        };

        window.firebaseApp = initializeApp(firebaseConfig);
        window.auth = getAuth(window.firebaseApp);
        window.db = getDatabase(window.firebaseApp);
        window.storage = getStorage(window.firebaseApp);
    </script>
        const auth = firebase.auth();
        const db = firebase.database();
        const storage = firebase.storage();

        // Check authentication
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUserName = user.displayName || user.email || "Utilisateur";
                document.getElementById('userName').textContent = currentUserName;
                document.getElementById('preparedBy').textContent = currentUserName;
                document.getElementById('reportPreparedBy').value = currentUserName;
                document.getElementById('accountantName').value = currentUserName;
                console.log('Utilisateur connect√©:', currentUserName);
                loadAllData();
            } else {
                console.log('Aucun utilisateur connect√© - Acc√®s temporaire autoris√© pour diagnostic');
                currentUserName = "Utilisateur";
                document.getElementById('userName').textContent = currentUserName;
                document.getElementById('preparedBy').textContent = currentUserName;
                document.getElementById('reportPreparedBy').value = currentUserName;
                document.getElementById('accountantName').value = currentUserName;
                loadAllData();
            }
        });

        // R√©f√©rences Firebase
        const teachersRef = db.ref('teachers');
        const studentFeesRef = db.ref('studentFees');
        const payrollRef = db.ref('payroll');
        const reportsRef = db.ref('reports');
        const announcementsRef = db.ref('announcements');
        const debtsRef = db.ref('debts');
        const studentsRef = db.ref('students');
        const dailyReportsRef = db.ref('dailyReports');
        const weeklyReportsRef = db.ref('weeklyReports');
        const monthlyReportsRef = db.ref('monthlyReports');
        const payrollHistoryRef = db.ref('payrollHistory');
        const reportHistoryRef = db.ref('reportHistory');
        const feeConfigRef = db.ref('feeConfiguration');
        const dailyExpensesRef = db.ref('dailyExpenses');
        const receiptsRef = db.ref('receipts');
        const accountantRef = db.ref('accountant');
        const settingsRef = db.ref('settings');

        // Variables globales
        let teachers = [];
        let studentFees = [];
        let payrollData = [];
        let announcements = [];
        let debts = [];
        let students = [];
        let dailyReports = [];
        let weeklyReports = [];
        let monthlyReports = [];
        let payrollHistory = [];
        let reportHistory = [];
        let feeConfigurations = [];
        let dailyExpenses = [];
        let currentTeacherId = null;
        let currentStudentFeeId = null;
        let currentStudentId = null;
        let currentUserName = "Utilisateur";
        let realPayrollChart = null;
        let weeklyChart = null;
        let monthlyChart = null;
        let currentLanguage = 'fr';
        let selectedBranch = 'kacyiru';

        // Translations
        const translations = {
            fr: {
                dashboard: 'Tableau de bord',
                workers: 'Gestion Travailleurs',
                payroll: 'G√©n√©rer Payroll',
                payments: 'Paiements',
                students: '√âl√®ves',
                reports: 'Rapports Financiers',
                settings: 'Param√®tres',
                financialDashboard: 'Tableau de Bord Financier',
                totalWorkers: 'Total Travailleurs',
                monthlyPayroll: 'Payroll du Mois',
                bankPayments: 'Paiements Banque',
                studentPayments: 'Paiements √âl√®ves',
                workerManagement: 'Gestion des Travailleurs',
                addWorker: 'Ajouter Travailleur',
                addDebt: 'Ajouter Dette',
                generatePayroll: 'G√©n√©rer Payroll',
                currentDebts: 'Dettes en Cours pour ce Mois',
                studentManagement: 'Gestion des √âl√®ves',
                addStudent: 'Ajouter √âl√®ve',
                searchStudent: 'Rechercher un √©l√®ve...',
                financialReports: 'Rapports Financiers',
                daily: 'Journalier',
                weekly: 'Hebdomadaire',
                monthly: 'Mensuel',
                systemSettings: 'Param√®tres du Syst√®me',
                accountantInfo: 'Informations Comptable',
                logout: 'D√©connexion'
            },
            en: {
                dashboard: 'Dashboard',
                workers: 'Workers Management',
                payroll: 'Generate Payroll',
                payments: 'Payments',
                students: 'Students',
                reports: 'Financial Reports',
                settings: 'Settings',
                financialDashboard: 'Financial Dashboard',
                totalWorkers: 'Total Workers',
                monthlyPayroll: 'Monthly Payroll',
                bankPayments: 'Bank Payments',
                studentPayments: 'Student Payments',
                workerManagement: 'Workers Management',
                addWorker: 'Add Worker',
                addDebt: 'Add Debt',
                generatePayroll: 'Generate Payroll',
                currentDebts: 'Current Debts for This Month',
                studentManagement: 'Students Management',
                addStudent: 'Add Student',
                searchStudent: 'Search a student...',
                financialReports: 'Financial Reports',
                daily: 'Daily',
                weekly: 'Weekly',
                monthly: 'Monthly',
                systemSettings: 'System Settings',
                accountantInfo: 'Accountant Information',
                logout: 'Logout'
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
            setInterval(updateDateTime, 60000);
            updateCurrentPeriod();
            
            document.getElementById('userRole').textContent = "Comptable Principal";
            
            setupFirebaseListeners();
            initializeCharts();
            selectBranch('kacyiru'); // S√©lectionner la branche par d√©faut
        });

        // Setup Firebase listeners
        function setupFirebaseListeners() {
            // √âcouter les changements d'annonces
            announcementsRef.orderByChild('timestamp').limitToLast(10).on('value', (snapshot) => {
                announcements = [];
                snapshot.forEach((childSnapshot) => {
                    const announcement = childSnapshot.val();
                    announcements.push({
                        id: childSnapshot.key,
                        ...announcement
                    });
                });
                announcements.sort((a, b) => b.timestamp - a.timestamp);
                updateFilteredAnnouncements();
            });

            // √âcouter les changements de travailleurs
            teachersRef.on('value', (snapshot) => {
                teachers = [];
                snapshot.forEach((childSnapshot) => {
                    const teacher = {
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    };
                    teachers.push(teacher);
                });
                updateStats();
                if (document.getElementById('teachers').classList.contains('active')) {
                    loadWorkers();
                }
                updateDebtWorkerSelect();
            });

            // √âcouter les changements de dettes
            debtsRef.on('value', (snapshot) => {
                debts = [];
                snapshot.forEach((childSnapshot) => {
                    const debt = {
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    };
                    debts.push(debt);
                });
                if (document.getElementById('teachers').classList.contains('active')) {
                    loadCurrentMonthDebts();
                }
            });

            // √âcouter les changements d'√©l√®ves
            studentsRef.on('value', (snapshot) => {
                students = [];
                snapshot.forEach((childSnapshot) => {
                    const student = {
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    };
                    students.push(student);
                });
                if (document.getElementById('students').classList.contains('active')) {
                    loadStudents();
                }
            });

            // √âcouter les changements de paiements √©l√®ves
            studentFeesRef.on('value', (snapshot) => {
                studentFees = [];
                snapshot.forEach((childSnapshot) => {
                    const fee = {
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    };
                    studentFees.push(fee);
                });
                updateStats();
                if (document.getElementById('student-fees').classList.contains('active')) {
                    loadStudentFees();
                }
                if (document.getElementById('students').classList.contains('active')) {
                    loadStudents();
                }
                
                // Si la section rapports est active, mettre √† jour le tableau
                if (document.getElementById('reports').classList.contains('active')) {
                    updateDailyReportTable();
                }
            });

            // √âcouter les configurations de frais
            feeConfigRef.on('value', (snapshot) => {
                feeConfigurations = [];
                snapshot.forEach((childSnapshot) => {
                    const config = {
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    };
                    feeConfigurations.push(config);
                });
            });

            // √âcouter les rapports journaliers
            dailyReportsRef.on('value', (snapshot) => {
                dailyReports = [];
                snapshot.forEach((childSnapshot) => {
                    const report = {
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    };
                    dailyReports.push(report);
                });
            });

            // √âcouter l'historique des payrolls
            payrollHistoryRef.on('value', (snapshot) => {
                payrollHistory = [];
                snapshot.forEach((childSnapshot) => {
                    const payroll = {
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    };
                    payrollHistory.push(payroll);
                });
                payrollHistory.sort((a, b) => b.timestamp - a.timestamp);
            });

            // √âcouter l'historique des rapports
            reportHistoryRef.on('value', (snapshot) => {
                reportHistory = [];
                snapshot.forEach((childSnapshot) => {
                    const report = {
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    };
                    reportHistory.push(report);
                });
                reportHistory.sort((a, b) => b.timestamp - a.timestamp);
            });

            // √âcouter les d√©penses journali√®res
            dailyExpensesRef.on('value', (snapshot) => {
                dailyExpenses = [];
                snapshot.forEach((childSnapshot) => {
                    const expense = {
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    };
                    dailyExpenses.push(expense);
                });
                if (document.getElementById('reports').classList.contains('active')) {
                    updateExpensesList();
                    updateDailyReportTable();
                }
            });
            
            // Charger les param√®tres du syst√®me
            settingsRef.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const settings = snapshot.val();
                    if (settings.overtimeRate) document.getElementById('overtimeRate').value = settings.overtimeRate;
                    if (settings.socialRate) document.getElementById('socialRate').value = settings.socialRate;
                    if (settings.paymentDay) document.getElementById('paymentDay').value = settings.paymentDay;
                    if (settings.currency) document.getElementById('currency').value = settings.currency;
                }
            });
            
            // Charger les informations du comptable
            accountantRef.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const accountant = snapshot.val();
                    if (accountant.name) {
                        document.getElementById('accountantName').value = accountant.name;
                        currentUserName = accountant.name;
                        document.getElementById('userName').textContent = accountant.name;
                        document.getElementById('preparedBy').textContent = accountant.name;
                        document.getElementById('reportPreparedBy').value = accountant.name;
                    }
                    if (accountant.title) document.getElementById('accountantTitle').value = accountant.title;
                    if (accountant.email) document.getElementById('accountantEmail').value = accountant.email;
                }
            });
            
            // Observer pour charger automatiquement le rapport quand la section est active
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        const reportsSection = document.getElementById('reports');
                        if (reportsSection.classList.contains('active')) {
                            // D√©finir la date d'aujourd'hui par d√©faut
                            const today = new Date().toISOString().split('T')[0];
                            document.getElementById('dailyReportDate').value = today;
                            
                            // Charger le rapport apr√®s un d√©lai
                            setTimeout(() => {
                                loadDailyReport();
                            }, 300);
                        }
                    }
                });
            });
            
            observer.observe(document.getElementById('reports'), {
                attributes: true
            });
        }

        // Update date and time
        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('fr-FR', options);
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        }

        // Load all initial data
        async function loadAllData() {
            console.log('D√©but du chargement des donn√©es...');
            try {
                await Promise.all([
                    loadWorkers(),
                    loadStudentFees(),
                    loadCurrentMonthDebts(),
                    loadStudents(),
                    updateFilteredAnnouncements()
                ]);
                console.log('Donn√©es charg√©es avec succ√®s');
                updateStats();
                updateRealPayrollChart();
            } catch (error) {
                console.error('Erreur lors du chargement des donn√©es:', error);
            }
        }

        // Update stats from Firebase
        function updateStats() {
            // Filtrer les travailleurs par branche s√©lectionn√©e
            const branchTeachers = teachers.filter(teacher => teacher.branch === selectedBranch);
            document.getElementById('totalTeachers').textContent = branchTeachers.length;
            
            const currentMonth = new Date().getMonth() + 1;
            const currentYear = new Date().getFullYear();
            
            // Calculer le payroll pour la branche s√©lectionn√©e
            const monthlyPayroll = branchTeachers.reduce((total, teacher) => {
                if (teacher.salary) {
                    return total + parseFloat(teacher.salary);
                }
                return total;
            }, 0);
            document.getElementById('monthlyPayroll').textContent = formatCurrencyRWF(monthlyPayroll);
            
            const bankTeachers = branchTeachers.filter(t => t.paymentMode === 'bank').length;
            document.getElementById('bankPayments').textContent = bankTeachers;
            
            // Filtrer les paiements √©l√®ves par branche
            const branchStudentFees = studentFees.filter(fee => {
                const student = students.find(s => s.id === fee.studentId);
                return student && student.branch === selectedBranch;
            });
            document.getElementById('studentPayments').textContent = branchStudentFees.length;
        }

        // Update filtered announcements (only director and secretary)
        async function updateFilteredAnnouncements() {
            try {
                const snapshot = await announcementsRef.orderByChild('timestamp').limitToLast(10).once('value');
                const container = document.getElementById('filteredAnnouncementsList');
                container.innerHTML = '';
                
                const filtered = [];
                snapshot.forEach(childSnapshot => {
                    const announcement = childSnapshot.val();
                    if (announcement.author === 'directeur' || announcement.author === 'secretaire') {
                        filtered.push({
                            id: childSnapshot.key,
                            ...announcement
                        });
                    }
                });
                
                filtered.sort((a, b) => b.timestamp - a.timestamp);
                
                if (filtered.length === 0) {
                    const noAnnouncements = document.createElement('div');
                    noAnnouncements.className = 'list-group-item border-0 px-0 py-2';
                    noAnnouncements.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <small class="text-muted">${new Date().toLocaleDateString('fr-FR')}</small>
                            <span class="announcement-type-badge">Syst√®me</span>
                        </div>
                        <p class="mb-0 mt-1">Aucune nouvelle annonce du directeur ou de la secr√©taire. Les annonces appara√Ætront ici automatiquement.</p>
                    `;
                    container.appendChild(noAnnouncements);
                    return;
                }
                
                filtered.slice(0, 5).forEach(announcement => {
                    const date = new Date(announcement.timestamp);
                    const authorBadge = announcement.author === 'directeur' ? 
                        '<span class="announcement-type-badge" style="background: linear-gradient(135deg, #2E8B57, #1E6B4E);">Directeur</span>' : 
                        '<span class="announcement-type-badge" style="background: linear-gradient(135deg, #6c757d, #495057);">Secr√©taire</span>';
                    
                    const item = document.createElement('div');
                    item.className = 'list-group-item border-0 px-0 py-2 animate-fade-in';
                    item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <small class="text-muted">${date.toLocaleDateString('fr-FR')} ${date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'})}</small>
                            ${authorBadge}
                        </div>
                        <p class="mb-0 mt-1">${announcement.message}</p>
                        ${announcement.read ? '' : '<span class="badge bg-primary mt-1" style="font-size: 0.6rem;">Nouveau</span>'}
                    `;
                    
                    // Marquer comme lu au clic
                    item.addEventListener('click', async () => {
                        if (!announcement.read) {
                            await announcementsRef.child(announcement.id).update({ read: true });
                        }
                    });
                    
                    container.appendChild(item);
                });
                
                // Ajouter un indicateur de nouvelles annonces
                const unreadCount = filtered.filter(a => !a.read).length;
                if (unreadCount > 0) {
                    const badge = document.createElement('span');
                    badge.className = 'badge bg-danger position-absolute top-0 start-100 translate-middle';
                    badge.textContent = unreadCount;
                    badge.style.fontSize = '0.7rem';
                    
                    const announcementTab = document.querySelector('.nav-btn[onclick="showSection(\'dashboard\')"]');
                    announcementTab.style.position = 'relative';
                    announcementTab.appendChild(badge);
                }
                
            } catch (error) {
                console.error('Erreur chargement annonces:', error);
            }
        }

        // Format currency in RWF
        function formatCurrencyRWF(amount) {
            if (isNaN(amount)) amount = 0;
            return new Intl.NumberFormat('fr-RW', {
                style: 'currency',
                currency: 'RWF',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        // Navigation
        function showSection(sectionId) {
            const currentSection = document.querySelector('.section.active');
            if (currentSection) {
                currentSection.classList.remove('active');
            }
            
            setTimeout(() => {
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.remove('active');
                });
                
                document.getElementById(sectionId).classList.add('active');
                
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                event.target.closest('.nav-btn').classList.add('active');
                
                if (sectionId === 'teachers') {
                    loadWorkers();
                    loadCurrentMonthDebts();
                } else if (sectionId === 'payroll') {
                    loadPayroll();
                    loadCurrentMonthDebts();
                } else if (sectionId === 'student-fees') {
                    loadStudentFees();
                } else if (sectionId === 'students') {
                    loadStudents();
                } else if (sectionId === 'reports') {
                    showDailyReport();
                }
            }, 300);
        }

        // Update current period
        function updateCurrentPeriod() {
            const monthSelect = document.getElementById('payrollMonth');
            const month = monthSelect.options[monthSelect.selectedIndex].text;
            const year = document.getElementById('payrollYear').value;
            document.getElementById('currentPeriod').textContent = `${month} ${year}`;
        }

        // Variables globales pour le payroll
        let currentPayrollData = [];
        let generatedPayroll = false;

        async function loadPayroll() {
            try {
                const month = document.getElementById('payrollMonth').value;
                const year = document.getElementById('payrollYear').value;
                const monthYear = `${month}/${year}`;
                
                // V√©rifier si un payroll existe d√©j√† pour ce mois
                const payrollSnapshot = await payrollRef
                    .orderByChild('monthYear')
                    .equalTo(monthYear)
                    .once('value');
                
                const tbody = document.getElementById('payrollTable');
                tbody.innerHTML = '';
                
                if (payrollSnapshot.exists()) {
                    generatedPayroll = true;
                    
                    // Afficher le payroll existant
                    payrollSnapshot.forEach(childSnapshot => {
                        const payroll = childSnapshot.val();
                        currentPayrollData = payroll.workers || [];
                        
                        if (currentPayrollData.length === 0) {
                            tbody.innerHTML = `
                                <tr>
                                    <td colspan="9" class="text-center py-4">
                                        <div class="text-muted">
                                            <i class="fas fa-money-bill-wave fa-2x mb-3"></i>
                                            <p>Aucun travailleur dans le payroll pour ${getMonthName(month)} ${year}</p>
                                        </div>
                                    </td>
                                </tr>
                            `;
                            return;
                        }
                        
                        let totalPayroll = 0;
                        currentPayrollData.forEach((worker, index) => {
                            // Calculer les dettes du travailleur
                            const workerDebts = debts.filter(d => d.workerId === worker.id && d.status === 'pending');
                            const totalDebt = workerDebts.reduce((sum, debt) => sum + (parseFloat(debt.amount) || 0), 0);
                            const netSalary = (parseFloat(worker.salary) || 0) - totalDebt;
                            totalPayroll += netSalary;
                            
                            const tr = document.createElement('tr');
                            tr.className = 'animate-fade-in';
                            tr.innerHTML = `
                                <td>${worker.no || index + 1}</td>
                                <td><strong>${worker.name}</strong></td>
                                <td><span class="badge ${worker.type === 'enseignant' ? 'bg-success' : worker.type === 'staff' ? 'bg-info' : 'bg-secondary'}">
                                    ${worker.type === 'enseignant' ? 'Enseignant' : worker.type === 'staff' ? 'Staff' : 'Autre'}
                                </span></td>
                                <td><span class="badge ${worker.paymentMode === 'bank' ? 'badge-bank' : worker.paymentMode === 'momo' ? 'badge-momo' : 'badge-cash'}">
                                    ${worker.paymentMode === 'bank' ? 'Banque' : worker.paymentMode === 'momo' ? 'Mobile Money' : 'Esp√®ces'}
                                </span></td>
                                <td>${formatCurrencyRWF(worker.salary)}</td>
                                <td>${totalDebt > 0 ? `<span class="text-danger fw-bold">${formatCurrencyRWF(totalDebt)}</span>` : 'Aucune'}</td>
                                <td><strong class="text-success">${formatCurrencyRWF(netSalary)}</strong></td>
                                <td>
                                    <span class="badge ${worker.payrollStatus === 'paid' ? 'bg-success' : 'bg-warning'}">
                                        ${worker.payrollStatus === 'paid' ? 'Pay√©' : 'En attente'}
                                    </span>
                                </td>
                                <td>
                                    ${worker.payrollStatus === 'paid' ? 
                                        '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Pay√©</span>' :
                                        `<button class="btn btn-sm btn-success me-1" onclick="markAsPaid('${worker.id}', '${monthYear}')">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="removeFromPayroll('${worker.id}', '${monthYear}')">
                                            <i class="fas fa-trash"></i>
                                        </button>`
                                    }
                                </td>
                            `;
                            tbody.appendChild(tr);
                        });
                        
                        document.getElementById('totalPayrollAmount').textContent = `Total: ${formatCurrencyRWF(totalPayroll)}`;
                    });
                    
                } else {
                    generatedPayroll = false;
                    
                    // Afficher la liste des travailleurs pour g√©n√©rer le payroll
                    const branchTeachers = teachers.filter(teacher => teacher.branch === selectedBranch);
                    
                    if (branchTeachers.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="9" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="fas fa-users fa-2x mb-3"></i>
                                        <p>Aucun travailleur trouv√© dans cette branche</p>
                                    </div>
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    branchTeachers.forEach((teacher, index) => {
                        // Calculer les dettes du travailleur
                        const workerDebts = debts.filter(d => d.workerId === teacher.id && d.status === 'pending');
                        const totalDebt = workerDebts.reduce((sum, debt) => sum + (parseFloat(debt.amount) || 0), 0);
                        const netSalary = (parseFloat(teacher.salary) || 0) - totalDebt;
                        
                        const tr = document.createElement('tr');
                        tr.className = 'animate-fade-in';
                        tr.innerHTML = `
                            <td>${teacher.no || index + 1}</td>
                            <td><strong>${teacher.name}</strong></td>
                            <td><span class="badge ${teacher.type === 'enseignant' ? 'bg-success' : teacher.type === 'staff' ? 'bg-info' : 'bg-secondary'}">
                                ${teacher.type === 'enseignant' ? 'Enseignant' : teacher.type === 'staff' ? 'Staff' : 'Autre'}
                            </span></td>
                            <td><span class="badge ${teacher.paymentMode === 'bank' ? 'badge-bank' : teacher.paymentMode === 'momo' ? 'badge-momo' : 'badge-cash'}">
                                ${teacher.paymentMode === 'bank' ? 'Banque' : teacher.paymentMode === 'momo' ? 'Mobile Money' : 'Esp√®ces'}
                            </span></td>
                            <td>${formatCurrencyRWF(teacher.salary)}</td>
                            <td>${totalDebt > 0 ? `<span class="text-danger fw-bold">${formatCurrencyRWF(totalDebt)}</span>` : 'Aucune'}</td>
                            <td><strong class="text-success">${formatCurrencyRWF(netSalary)}</strong></td>
                            <td>
                                <span class="badge bg-secondary">
                                    Non g√©n√©r√©
                                </span>
                            </td>
                            <td>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="${teacher.id}" id="includeWorker${teacher.id}" checked>
                                    <label class="form-check-label" for="includeWorker${teacher.id}">
                                        Inclure
                                    </label>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
                
            } catch (error) {
                console.error('Erreur chargement payroll:', error);
                showToast('Erreur lors du chargement du payroll', 'error');
            }
        }

        async function generateMonthlyPayroll() {
            try {
                const month = document.getElementById('payrollMonth').value;
                const year = document.getElementById('payrollYear').value;
                const monthYear = `${month}/${year}`;
                const monthName = getMonthName(month);
                
                // V√©rifier si un payroll existe d√©j√†
                const existingSnapshot = await payrollRef
                    .orderByChild('monthYear')
                    .equalTo(monthYear)
                    .once('value');
                
                if (existingSnapshot.exists()) {
                    if (!confirm(`Un payroll existe d√©j√† pour ${monthName} ${year}. Voulez-vous le reg√©n√©rer?`)) {
                        return;
                    }
                    // Supprimer l'ancien payroll
                    existingSnapshot.forEach(childSnapshot => {
                        payrollRef.child(childSnapshot.key).remove();
                    });
                }
                
                // Collecter les travailleurs s√©lectionn√©s
                const selectedWorkers = [];
                const checkboxes = document.querySelectorAll('#payrollTable input[type="checkbox"]:checked');
                
                if (checkboxes.length === 0) {
                    showToast('Veuillez s√©lectionner au moins un travailleur', 'error');
                    return;
                }
                
                checkboxes.forEach(checkbox => {
                    const workerId = checkbox.value;
                    const worker = teachers.find(t => t.id === workerId);
                    if (worker && worker.branch === selectedBranch) {
                        selectedWorkers.push({
                            id: worker.id,
                            no: worker.no,
                            name: worker.name,
                            type: worker.type,
                            paymentMode: worker.paymentMode,
                            accountNo: worker.accountNo || worker.momoNumber || '',
                            bankName: worker.bankName || worker.momoOperator || '',
                            salary: parseFloat(worker.salary) || 0,
                            payrollStatus: 'pending'
                        });
                    }
                });
                
                // Enregistrer le payroll
                const payrollData = {
                    month: month,
                    year: year,
                    monthYear: monthYear,
                    monthName: monthName,
                    workers: selectedWorkers,
                    totalAmount: selectedWorkers.reduce((sum, w) => sum + w.salary, 0),
                    generatedBy: currentUserName,
                    timestamp: Date.now(),
                    status: 'pending',
                    branch: selectedBranch
                };
                
                await payrollRef.push(payrollData);
                
                // Enregistrer dans l'historique
                await payrollHistoryRef.push({
                    ...payrollData,
                    workersCount: selectedWorkers.length,
                    type: 'monthly'
                });
                
                showToast(`Payroll g√©n√©r√© avec succ√®s pour ${monthName} ${year}`, 'success');
                
                // Recharger le payroll
                loadPayroll();
                
            } catch (error) {
                console.error('Erreur g√©n√©ration payroll:', error);
                showToast('Erreur lors de la g√©n√©ration du payroll', 'error');
            }
        }

        function exportPayrollExcel() {
            try {
                if (currentPayrollData.length === 0) {
                    showToast('Aucune donn√©e de payroll √† exporter', 'error');
                    return;
                }
                
                const month = document.getElementById('payrollMonth').value;
                const year = document.getElementById('payrollYear').value;
                const monthName = getMonthName(month);
                
                // Pr√©parer les donn√©es pour Excel
                const exportData = currentPayrollData.map(worker => ({
                    'NO': worker.no,
                    'NOMS': worker.name,
                    'MODE': worker.paymentMode === 'bank' ? 'Banque' : worker.paymentMode === 'momo' ? 'Mobile Money' : 'Esp√®ces',
                    'NUM√âRO BANQUE': worker.accountNo || worker.momoNumber || 'N/A',
                    'SALAIRE': formatCurrencyRWF(worker.salary).replace('RWF', '').trim(),
                    'PREPARED BY/SIGNED BY: ACCOUNTANT': currentUserName
                }));
                
                // Ajouter une ligne de total
                exportData.push({
                    'NO': '',
                    'NOMS': 'TOTAL',
                    'MODE': '',
                    'NUM√âRO BANQUE': '',
                    'SALAIRE': formatCurrencyRWF(currentPayrollData.reduce((sum, w) => sum + w.salary, 0)).replace('RWF', '').trim(),
                    'PREPARED BY/SIGNED BY: ACCOUNTANT': ''
                });
                
                // Cr√©er le fichier Excel
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Payroll");
                
                // Ajuster la largeur des colonnes
                const wscols = [
                    {wch: 5},  // NO
                    {wch: 30}, // NOMS
                    {wch: 15}, // MODE
                    {wch: 20}, // NUM√âRO BANQUE
                    {wch: 15}, // SALAIRE
                    {wch: 30}  // PREPARED BY
                ];
                ws['!cols'] = wscols;
                
                // Exporter
                XLSX.writeFile(wb, `Payroll_${monthName}_${year}_${selectedBranch}.xlsx`);
                showToast('Payroll export√© avec succ√®s', 'success');
                
            } catch (error) {
                console.error('Erreur export Excel:', error);
                showToast('Erreur lors de l\'export Excel', 'error');
            }
        }

        async function markAsPaid(workerId, monthYear) {
            try {
                const payrollSnapshot = await payrollRef
                    .orderByChild('monthYear')
                    .equalTo(monthYear)
                    .once('value');
                
                payrollSnapshot.forEach(childSnapshot => {
                    const payroll = childSnapshot.val();
                    const updatedWorkers = payroll.workers.map(worker => {
                        if (worker.id === workerId) {
                            return { ...worker, payrollStatus: 'paid', paidDate: new Date().toISOString().split('T')[0] };
                        }
                        return worker;
                    });
                    
                    payrollRef.child(childSnapshot.key).update({
                        workers: updatedWorkers,
                        lastUpdated: Date.now(),
                        updatedBy: currentUserName
                    });
                });
                
                showToast('Travailleur marqu√© comme pay√©', 'success');
                loadPayroll();
                
            } catch (error) {
                console.error('Erreur marquage pay√©:', error);
                showToast('Erreur lors du marquage', 'error');
            }
        }

        function getMonthName(monthNumber) {
            const months = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                           'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
            return months[parseInt(monthNumber) - 1] || '';
        }

        // S√©lectionner une branche
        function selectBranch(branchId) {
            selectedBranch = branchId;
            document.getElementById('selectedBranch').value = branchId;
            
            // Mettre √† jour l'interface
            document.querySelectorAll('.branch-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById('branch' + branchId.charAt(0).toUpperCase() + branchId.slice(1)).classList.add('selected');
            
            // Mettre √† jour le texte affich√©
            const branchNames = {
                kacyiru: 'EDEN FAMILY SCHOOL KACYIRU',
                kimisagara: 'EDEN FAMILY SCHOOL KIMISAGARA',
                gisozimaternelle: 'EDEN FAMILY SCHOOL GISOZI MATERNELLE',
                gisoziprimaire: 'EDEN FAMILY SCHOOL GISOZI PRIMAIRE'
            };
            document.getElementById('currentBranchText').textContent = branchNames[branchId];
            document.getElementById('feeBranch').value = branchNames[branchId];
            
            // Mettre √† jour les statistiques
            updateStats();
            
            showToast(`Branche ${branchNames[branchId]} s√©lectionn√©e`, 'success');
        }

        // Load workers
        async function loadWorkers() {
            try {
                const snapshot = await teachersRef.orderByChild('no').once('value');
                const tbody = document.getElementById('workersTable');
                tbody.innerHTML = '';
                
                if (!snapshot.exists()) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="fas fa-users fa-2x mb-3"></i>
                                    <p>Aucun travailleur trouv√©</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                teachers = [];
                snapshot.forEach((childSnapshot) => {
                    const teacher = {
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    };
                    teachers.push(teacher);
                });
                
                // Filtrer par branche s√©lectionn√©e
                const branchTeachers = teachers.filter(teacher => teacher.branch === selectedBranch);
                branchTeachers.sort((a, b) => parseInt(a.no) - parseInt(b.no));
                
                if (branchTeachers.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="fas fa-users fa-2x mb-3"></i>
                                    <p>Aucun travailleur trouv√© dans cette branche</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                branchTeachers.forEach((teacher, index) => {
                    const badgeClass = teacher.paymentMode === 'bank' ? 'badge-bank' :
                                     teacher.paymentMode === 'momo' ? 'badge-momo' : 'badge-cash';
                    const paymentText = teacher.paymentMode === 'bank' ? 'Banque' :
                                      teacher.paymentMode === 'momo' ? 'Mobile Money' : 'Esp√®ces';
                    
                    const typeBadge = teacher.type === 'enseignant' ? 'badge bg-success' :
                                    teacher.type === 'staff' ? 'badge bg-info' : 'badge bg-secondary';
                    const typeText = teacher.type === 'enseignant' ? 'Enseignant' :
                                   teacher.type === 'staff' ? 'Staff' : 'Autre';
                    
                    const workerDebts = debts.filter(d => d.workerId === teacher.id && d.status === 'pending');
                    const totalDebt = workerDebts.reduce((sum, debt) => sum + (debt.amount || 0), 0);
                    
                    const tr = document.createElement('tr');
                    tr.className = 'animate-fade-in';
                    tr.innerHTML = `
                        <td>${teacher.no}</td>
                        <td><strong>${teacher.name}</strong></td>
                        <td><span class="${typeBadge}">${typeText}</span></td>
                        <td>${teacher.phone || ''}</td>
                        <td><span class="${badgeClass}">${paymentText}</span></td>
                        <td>${formatCurrencyRWF(teacher.salary || 0)}</td>
                        <td>
                            ${totalDebt > 0 ? 
                                `<span class="debt-badge" onclick="showDebtDetails('${teacher.id}')">${formatCurrencyRWF(totalDebt)}</span>` : 
                                'Aucune'}
                        </td>
                        <td><span class="badge bg-success">${teacher.status || 'active'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editWorker('${teacher.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info me-1" onclick="addDebtForWorker('${teacher.id}')">
                                <i class="fas fa-money-bill-wave"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteWorkerPrompt('${teacher.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                
            } catch (error) {
                console.error('Erreur chargement travailleurs:', error);
                showToast('Erreur lors du chargement des travailleurs', 'error');
            }
        }

        // Filter workers
        function filterWorkers(type) {
            // Filtrer d'abord par branche
            const branchTeachers = teachers.filter(teacher => teacher.branch === selectedBranch);
            
            // Puis par type
            const filtered = type === 'all' 
                ? branchTeachers 
                : branchTeachers.filter(teacher => teacher.type === type);
            
            const tbody = document.getElementById('workersTable');
            tbody.innerHTML = '';
            
            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-4">
                            <div class="text-muted">
                                <i class="fas fa-users fa-2x mb-3"></i>
                                <p>Aucun travailleur trouv√©</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            filtered.forEach((teacher, index) => {
                const badgeClass = teacher.paymentMode === 'bank' ? 'badge-bank' :
                                 teacher.paymentMode === 'momo' ? 'badge-momo' : 'badge-cash';
                const paymentText = teacher.paymentMode === 'bank' ? 'Banque' :
                                  teacher.paymentMode === 'momo' ? 'Mobile Money' : 'Esp√®ces';
                
                const typeBadge = teacher.type === 'enseignant' ? 'badge bg-success' :
                                teacher.type === 'staff' ? 'badge bg-info' : 'badge bg-secondary';
                const typeText = teacher.type === 'enseignant' ? 'Enseignant' :
                               teacher.type === 'staff' ? 'Staff' : 'Autre';
                
                const workerDebts = debts.filter(d => d.workerId === teacher.id && d.status === 'pending');
                const totalDebt = workerDebts.reduce((sum, debt) => sum + (debt.amount || 0), 0);
                
                const tr = document.createElement('tr');
                tr.className = 'animate-fade-in';
                tr.innerHTML = `
                    <td>${teacher.no}</td>
                    <td><strong>${teacher.name}</strong></td>
                    <td><span class="${typeBadge}">${typeText}</span></td>
                    <td>${teacher.phone || ''}</td>
                    <td><span class="${badgeClass}">${paymentText}</span></td>
                    <td>${formatCurrencyRWF(teacher.salary || 0)}</td>
                    <td>
                        ${totalDebt > 0 ? 
                            `<span class="debt-badge" onclick="showDebtDetails('${teacher.id}')">${formatCurrencyRWF(totalDebt)}</span>` : 
                            'Aucune'}
                    </td>
                    <td><span class="badge bg-success">${teacher.status || 'active'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editWorker('${teacher.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info me-1" onclick="addDebtForWorker('${teacher.id}')">
                            <i class="fas fa-money-bill-wave"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteWorkerPrompt('${teacher.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Load current month debts
        async function loadCurrentMonthDebts() {
            try {
                const tbody = document.getElementById('currentMonthDebtsTable');
                tbody.innerHTML = '';
                
                const currentMonth = new Date().getMonth() + 1;
                const currentYear = new Date().getFullYear();
                
                // Filtrer les dettes du mois courant et de la branche
                const monthDebts = debts.filter(debt => {
                    if (debt.status !== 'pending') return false;
                    
                    const debtDate = new Date(debt.date);
                    const isCurrentMonth = debtDate.getMonth() + 1 === currentMonth && 
                                          debtDate.getFullYear() === currentYear;
                    
                    // V√©rifier aussi la branche du travailleur
                    const worker = teachers.find(t => t.id === debt.workerId);
                    return isCurrentMonth && worker && worker.branch === selectedBranch;
                });
                
                if (monthDebts.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="fas fa-money-bill-wave fa-2x mb-3"></i>
                                    <p>Aucune dette enregistr√©e pour ${getMonthName(currentMonth)} ${currentYear}</p>
                                    <small class="text-muted">Les dettes appara√Ætront ici automatiquement</small>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let totalDebts = 0;
                monthDebts.forEach((debt, index) => {
                    const worker = teachers.find(t => t.id === debt.workerId);
                    if (!worker) return;
                    
                    totalDebts += parseFloat(debt.amount) || 0;
                    
                    const tr = document.createElement('tr');
                    tr.className = 'animate-fade-in';
                    tr.innerHTML = `
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="teacher-avatar me-2">
                                    ${worker.name.charAt(0)}
                                </div>
                                <div>
                                    <strong>${worker.name}</strong><br>
                                    <small class="text-muted">${worker.no}</small>
                                </div>
                            </div>
                        </td>
                        <td><span class="badge ${worker.type === 'enseignant' ? 'bg-success' : 'bg-info'}">
                            ${worker.type === 'enseignant' ? 'Enseignant' : 'Staff'}
                        </span></td>
                        <td><strong class="text-danger">${formatCurrencyRWF(debt.amount)}</strong></td>
                        <td>${new Date(debt.date).toLocaleDateString('fr-FR')}</td>
                        <td>${debt.reason || 'Non sp√©cifi√©'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-success me-1" onclick="markDebtPaid('${debt.id}')" title="Marquer comme pay√©">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteDebt('${debt.id}')" title="Supprimer la dette">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                
                // Ajouter la ligne de total
                const totalRow = document.createElement('tr');
                totalRow.className = 'table-warning';
                totalRow.innerHTML = `
                    <td colspan="2"><strong>TOTAL DES DETTES DU MOIS:</strong></td>
                    <td colspan="4" class="text-end">
                        <strong class="text-danger fs-5">${formatCurrencyRWF(totalDebts)}</strong>
                    </td>
                `;
                tbody.appendChild(totalRow);
                
            } catch (error) {
                console.error('Erreur chargement dettes:', error);
            }
        }

        // Show worker modal
        function showWorkerModal() {
            document.getElementById('workerForm').reset();
            currentTeacherId = null;
            document.getElementById('workerHireDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('workerBranch').value = selectedBranch;
            document.getElementById('deleteWorkerBtn').style.display = 'none';
            const modal = new bootstrap.Modal(document.getElementById('workerModal'));
            modal.show();
        }

        // Toggle payment info
        function togglePaymentInfo() {
            const mode = document.getElementById('workerPaymentMode').value;
            
            document.getElementById('bankInfo').classList.add('d-none');
            document.getElementById('momoInfo').classList.add('d-none');
            
            if (mode === 'bank') {
                document.getElementById('bankInfo').classList.remove('d-none');
            } else if (mode === 'momo') {
                document.getElementById('momoInfo').classList.remove('d-none');
            }
        }

        // Save worker
        function resetWorkerForm() {
            document.getElementById('workerForm').reset();
            currentTeacherId = null;
            document.getElementById('deleteWorkerBtn').style.display = 'none';
            document.getElementById('bankInfo').classList.add('d-none');
            document.getElementById('momoInfo').classList.add('d-none');
            document.getElementById('workerHireDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('workerBranch').value = selectedBranch;
        }

        async function saveWorker() {
            const form = document.getElementById('workerForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const workerData = {
                no: document.getElementById('workerNo').value,
                name: document.getElementById('workerName').value,
                type: document.getElementById('workerType').value,
                phone: document.getElementById('workerPhone').value,
                salary: parseFloat(document.getElementById('workerSalary').value),
                paymentMode: document.getElementById('workerPaymentMode').value,
                accountNo: document.getElementById('workerAccountNo').value || '',
                bankName: document.getElementById('workerBankName').value || '',
                momoOperator: document.getElementById('workerMomoOperator').value || '',
                momoNumber: document.getElementById('workerMomoNumber').value || '',
                status: 'active',
                hireDate: document.getElementById('workerHireDate').value || '',
                branch: document.getElementById('workerBranch').value,
                timestamp: Date.now(),
                createdBy: currentUserName
            };
            
            try {
                if (currentTeacherId) {
                    await teachersRef.child(currentTeacherId).update(workerData);
                    showToast('Travailleur mis √† jour avec succ√®s!', 'success');
                    
                    await announcementsRef.push({
                        timestamp: Date.now(),
                        message: `Travailleur ${workerData.name} mis √† jour`,
                        author: 'system',
                        type: 'worker_update'
                    });
                } else {
                    const existingSnapshot = await teachersRef
                        .orderByChild('no')
                        .equalTo(workerData.no)
                        .once('value');
                    
                    if (existingSnapshot.exists()) {
                        showToast('Ce num√©ro de travailleur existe d√©j√†!', 'error');
                        return;
                    }
                    
                    await teachersRef.push(workerData);
                    showToast('Travailleur ajout√© avec succ√®s!', 'success');
                    
                    await announcementsRef.push({
                        timestamp: Date.now(),
                        message: `Nouveau travailleur ajout√©: ${workerData.name}`,
                        author: 'system',
                        type: 'worker_add'
                    });
                }
                
                bootstrap.Modal.getInstance(document.getElementById('workerModal')).hide();
                resetWorkerForm();
                
            } catch (error) {
                console.error('Erreur sauvegarde travailleur:', error);
                showToast('Erreur lors de la sauvegarde: ' + error.message, 'error');
            }
        }

        // Edit worker
        function editWorker(id) {
            const worker = teachers.find(t => t.id === id);
            if (!worker) return;
            
            currentTeacherId = id;
            
            document.getElementById('workerNo').value = worker.no || '';
            document.getElementById('workerName').value = worker.name || '';
            document.getElementById('workerType').value = worker.type || '';
            document.getElementById('workerPhone').value = worker.phone || '';
            document.getElementById('workerSalary').value = worker.salary || '';
            document.getElementById('workerPaymentMode').value = worker.paymentMode || '';
            document.getElementById('workerAccountNo').value = worker.accountNo || '';
            document.getElementById('workerBankName').value = worker.bankName || '';
            document.getElementById('workerMomoOperator').value = worker.momoOperator || '';
            document.getElementById('workerMomoNumber').value = worker.momoNumber || '';
            document.getElementById('workerHireDate').value = worker.hireDate || '';
            document.getElementById('workerBranch').value = worker.branch || selectedBranch;
            
            // Afficher le bouton supprimer en mode √©dition
            document.getElementById('deleteWorkerBtn').style.display = 'block';
            
            togglePaymentInfo();
            
            const modal = new bootstrap.Modal(document.getElementById('workerModal'));
            modal.show();
        }

        // Prompt for worker deletion
        function deleteWorkerPrompt(workerId) {
            const worker = teachers.find(t => t.id === workerId);
            if (!worker) return;
            
            if (confirm(`√ätes-vous s√ªr de vouloir supprimer le travailleur ${worker.name}?`)) {
                deleteWorker(workerId);
            }
        }

        // Delete worker
        async function deleteWorker(workerId) {
            try {
                const worker = teachers.find(t => t.id === workerId);
                if (!worker) return;
                
                await teachersRef.child(workerId).remove();
                showToast('Travailleur supprim√© avec succ√®s!', 'success');
                
                await announcementsRef.push({
                    timestamp: Date.now(),
                    message: `Travailleur ${worker.name} supprim√©`,
                    author: 'system',
                    type: 'worker_delete'
                });
                
                // Fermer le modal si ouvert
                const modal = bootstrap.Modal.getInstance(document.getElementById('workerModal'));
                if (modal) modal.hide();
                
            } catch (error) {
                console.error('Erreur suppression travailleur:', error);
                showToast('Erreur lors de la suppression', 'error');
            }
        }

        // Add debt for worker
        function addDebtForWorker(workerId) {
            currentTeacherId = workerId;
            showDebtModal();
        }

        // Show debt modal
        function showDebtModal() {
            updateDebtWorkerSelect();
            document.getElementById('debtForm').reset();
            document.getElementById('debtDate').value = new Date().toISOString().split('T')[0];
            
            if (currentTeacherId) {
                document.getElementById('debtWorker').value = currentTeacherId;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('debtModal'));
            modal.show();
        }

        // Update debt worker select
        function updateDebtWorkerSelect() {
            const select = document.getElementById('debtWorker');
            select.innerHTML = '<option value="">S√©lectionnez un travailleur</option>';
            
            // Filtrer par branche
            const branchTeachers = teachers.filter(teacher => teacher.branch === selectedBranch);
            
            branchTeachers.forEach(worker => {
                const option = document.createElement('option');
                option.value = worker.id;
                option.textContent = `${worker.no} - ${worker.name} (${worker.type})`;
                select.appendChild(option);
            });
        }

        // Save debt
        async function saveDebt() {
            const form = document.getElementById('debtForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const workerId = document.getElementById('debtWorker').value;
            const worker = teachers.find(t => t.id === workerId);
            
            if (!worker) {
                showToast('Veuillez s√©lectionner un travailleur', 'error');
                return;
            }
            
            const debtData = {
                workerId: workerId,
                workerName: worker.name,
                amount: parseFloat(document.getElementById('debtAmount').value),
                reason: document.getElementById('debtReason').value,
                date: document.getElementById('debtDate').value,
                status: document.getElementById('debtStatus').value,
                timestamp: Date.now(),
                addedBy: currentUserName
            };
            
            try {
                await debtsRef.push(debtData);
                showToast('Dette enregistr√©e avec succ√®s!', 'success');
                
                await announcementsRef.push({
                    timestamp: Date.now(),
                    message: `Dette enregistr√©e pour ${worker.name}: ${formatCurrencyRWF(debtData.amount)}`,
                    author: 'system',
                    type: 'debt_added'
                });
                
                bootstrap.Modal.getInstance(document.getElementById('debtModal')).hide();
                loadCurrentMonthDebts();
                
            } catch (error) {
                console.error('Erreur enregistrement dette:', error);
                showToast('Erreur lors de l\'enregistrement', 'error');
            }
        }

        // Show debt details
        function showDebtDetails(workerId) {
            const workerDebts = debts.filter(d => d.workerId === workerId && d.status === 'pending');
            const worker = teachers.find(t => t.id === workerId);
            
            if (workerDebts.length === 0) {
                showToast('Aucune dette pour ce travailleur', 'info');
                return;
            }
            
            let details = `Dettes pour ${worker.name}:\n\n`;
            workerDebts.forEach((debt, index) => {
                details += `${index + 1}. ${formatCurrencyRWF(debt.amount)} - ${debt.reason} (${new Date(debt.date).toLocaleDateString('fr-FR')})\n`;
            });
            
            const total = workerDebts.reduce((sum, debt) => sum + (debt.amount || 0), 0);
            details += `\nTotal: ${formatCurrencyRWF(total)}`;
            
            alert(details);
        }

        // Mark debt as paid
        async function markDebtPaid(debtId) {
            try {
                await debtsRef.child(debtId).update({
                    status: 'paid',
                    paidDate: new Date().toISOString().split('T')[0],
                    paidBy: currentUserName
                });
                
                showToast('Dette marqu√©e comme pay√©e!', 'success');
                loadCurrentMonthDebts();
                
            } catch (error) {
                console.error('Erreur mise √† jour dette:', error);
                showToast('Erreur lors de la mise √† jour', 'error');
            }
        }

        // Delete debt
        async function deleteDebt(debtId) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette dette?')) return;
            
            try {
                await debtsRef.child(debtId).remove();
                showToast('Dette supprim√©e avec succ√®s!', 'success');
                loadCurrentMonthDebts();
                
            } catch (error) {
                console.error('Erreur suppression dette:', error);
                showToast('Erreur lors de la suppression', 'error');
            }
        }

        // Load students
        async function loadStudents() {
            try {
                const tbody = document.getElementById('studentsTable');
                tbody.innerHTML = '';
                
                // Filtrer par branche
                const branchStudents = students.filter(student => student.branch === selectedBranch);
                
                if (branchStudents.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="fas fa-child fa-2x mb-3"></i>
                                    <p>Aucun √©l√®ve trouv√© dans cette branche</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                branchStudents.forEach((student, index) => {
                    // Calculer le total pay√© par cet √©l√®ve
                    const studentPayments = studentFees.filter(fee => fee.studentId === student.id);
                    const totalPaid = studentPayments.reduce((sum, payment) => sum + (payment.amount || 0), 0);
                    
                    const tr = document.createElement('tr');
                    tr.className = 'animate-fade-in';
                    tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td><strong>${student.reference || 'N/A'}</strong></td>
                        <td>${student.fullName}</td>
                        <td>${student.class || ''}</td>
                        <td>${student.birthDate ? new Date(student.birthDate).toLocaleDateString('fr-FR') : ''}</td>
                        <td>${formatCurrencyRWF(totalPaid)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="viewStudentProfile('${student.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info me-1" onclick="editStudent('${student.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteStudentPrompt('${student.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                
            } catch (error) {
                console.error('Erreur chargement √©l√®ves:', error);
                showToast('Erreur lors du chargement des √©l√®ves', 'error');
            }
        }

        // Load students from database (actualiser)
        function loadStudentsFromDatabase() {
            loadStudents();
            showToast('Liste des √©l√®ves actualis√©e', 'success');
        }

        // Search student
        function searchStudent() {
            const query = document.getElementById('searchStudent').value.toLowerCase().trim();
            if (!query) {
                loadStudents();
                return;
            }
            
            // Filtrer par branche d'abord
            const branchStudents = students.filter(student => student.branch === selectedBranch);
            
            const found = branchStudents.filter(s => 
                s.fullName.toLowerCase().includes(query) || 
                (s.reference && s.reference.toLowerCase().includes(query)) ||
                (s.class && s.class.toLowerCase().includes(query))
            );
            
            const tbody = document.getElementById('studentsTable');
            tbody.innerHTML = '';
            
            if (found.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <div class="text-muted">
                                <i class="fas fa-search fa-2x mb-3"></i>
                                <p>Aucun √©l√®ve trouv√©</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            found.forEach((student, index) => {
                const studentPayments = studentFees.filter(fee => fee.studentId === student.id);
                const totalPaid = studentPayments.reduce((sum, payment) => sum + (payment.amount || 0), 0);
                
                const tr = document.createElement('tr');
                tr.className = 'animate-fade-in';
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td><strong>${student.reference || 'N/A'}</strong></td>
                    <td>${student.fullName}</td>
                    <td>${student.class || ''}</td>
                    <td>${student.birthDate ? new Date(student.birthDate).toLocaleDateString('fr-FR') : ''}</td>
                    <td>${formatCurrencyRWF(totalPaid)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="viewStudentProfile('${student.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info me-1" onclick="editStudent('${student.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteStudentPrompt('${student.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // View student profile
        function viewStudentProfile(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            currentStudentId = studentId;
            
            // Afficher les informations de base
            document.getElementById('studentNameProfile').textContent = student.fullName;
            document.getElementById('studentClassProfile').textContent = `Classe: ${student.class || 'Non sp√©cifi√©e'}`;
            
            // Calculer l'√¢ge
            if (student.birthDate) {
                const birthDate = new Date(student.birthDate);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                document.getElementById('studentAgeProfile').textContent = `√Çge: ${age} ans`;
            } else {
                document.getElementById('studentAgeProfile').textContent = '√Çge: Non sp√©cifi√©';
            }
            
            document.getElementById('studentReferenceProfile').textContent = `R√©f: ${student.reference || 'N/A'}`;
            
            // Charger l'historique des paiements
            loadStudentPaymentsHistory(studentId);
            
            // Afficher la section profil
            document.getElementById('studentProfile').style.display = 'block';
        }

        // Load student payments history
        function loadStudentPaymentsHistory(studentId) {
            const tbody = document.getElementById('studentPaymentsHistory');
            tbody.innerHTML = '';
            
            const studentPayments = studentFees.filter(fee => fee.studentId === studentId);
            
            if (studentPayments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-3">
                            <div class="text-muted">
                                <i class="fas fa-money-bill-wave fa-2x mb-2"></i>
                                <p>Aucun paiement enregistr√©</p>
                            </div>
                        </td>
                    </tr>
                `;
                document.getElementById('totalPaid').textContent = '0 RWF';
                document.getElementById('remainingBalance').textContent = '0 RWF';
                return;
            }
            
            studentPayments.sort((a, b) => new Date(b.paymentDate) - new Date(a.paymentDate));
            
            studentPayments.forEach((payment, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${payment.reference || 'N/A'}</td>
                    <td>${new Date(payment.paymentDate).toLocaleDateString('fr-FR')}</td>
                    <td><span class="badge-minervale">${getPaymentTypeText(payment.paymentType)}</span></td>
                    <td><strong>${formatCurrencyRWF(payment.amount)}</strong></td>
                    <td><span class="badge ${payment.paymentMode === 'bank' ? 'badge-bank' : payment.paymentMode === 'momo' ? 'badge-momo' : 'badge-cash'}">${payment.paymentMode === 'bank' ? 'Banque' : payment.paymentMode === 'momo' ? 'Mobile Money' : 'Esp√®ces'}</span></td>
                    <td>${payment.receivedBy || 'N/A'}</td>
                `;
                tbody.appendChild(tr);
            });
            
            // Calculer les totaux
            const totalPaid = studentPayments.reduce((sum, payment) => sum + (payment.amount || 0), 0);
            document.getElementById('totalPaid').textContent = formatCurrencyRWF(totalPaid);
            
            // Ici vous pourriez ajouter la logique pour calculer le solde restant
            // bas√© sur les frais configur√©s pour la classe
            document.getElementById('remainingBalance').textContent = formatCurrencyRWF(0);
        }

        // Get payment type text
        function getPaymentTypeText(type) {
            const types = {
                'minervale': 'Minervale',
                'coaching': 'Coaching',
                'transport': 'Transport',
                'uniforme': 'Uniforme',
                'lunch': 'Lunch',
                'breakfast': 'Breakfast',
                'material': 'Mat√©riel',
                'insurance': 'Assurance',
                'autre': 'Autre'
            };
            return types[type] || type;
        }

        // Edit student
        function editStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            currentStudentId = studentId;
            
            document.getElementById('studentReference').value = student.reference || '';
            document.getElementById('studentFullName').value = student.fullName || '';
            document.getElementById('studentBirthDate').value = student.birthDate || '';
            document.getElementById('studentClass').value = student.class || '';
            document.getElementById('studentParent').value = student.parent || '';
            document.getElementById('studentParentPhone').value = student.parentPhone || '';
            document.getElementById('studentBranch').value = student.branch || selectedBranch;
            
            const modal = new bootstrap.Modal(document.getElementById('studentModal'));
            modal.show();
        }

        // Save student
        // Show student modal
        function showStudentModal() {
            // G√©n√©rer un code de r√©f√©rence unique
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0].replace(/-/g, '');
            const randomNum = Math.floor(Math.random() * 1000000000).toString().padStart(9, '0');
            const referenceCode = 'EDU-' + dateStr.substring(2) + '-' + randomNum;
            
            // Remplir le champ du code de r√©f√©rence
            document.getElementById('studentReference').value = referenceCode;
            
            // R√©initialiser les autres champs
            resetStudentFormComptable();
            
            // Afficher la modale
            const modal = new bootstrap.Modal(document.getElementById('studentModal'));
            modal.show();
        }
        
        // R√©initialiser le formulaire d'√©l√®ve
        function resetStudentFormComptable() {
            document.getElementById('studentForm').reset();
            document.getElementById('studentReference').value = '';
            document.getElementById('studentLastName').value = '';
            document.getElementById('studentFirstName').value = '';
            document.getElementById('studentBirthDate').value = '';
            document.getElementById('studentParent').value = '';
            document.getElementById('studentParentPhone').value = '';
            document.getElementById('studentParentPhone2').value = '';
            document.getElementById('studentParentEmail').value = '';
            document.getElementById('studentAddress').value = '';
            document.getElementById('studentBranch').value = '';
            document.getElementById('studentClass').value = '';
            document.getElementById('studentEnrollmentDate').value = '';
            document.getElementById('studentEnrollmentType').value = 'R√©gulier';
            document.getElementById('studentMedicalConditions').value = '';
        }

        async function saveStudent() {
            const form = document.getElementById('studentForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const lastName = document.getElementById('studentLastName').value;
            const firstName = document.getElementById('studentFirstName').value;
            const referenceCode = document.getElementById('studentReference').value;
            
            const studentData = {
                referenceCode: referenceCode,
                fullName: `${firstName} ${lastName}`,
                firstName: firstName,
                lastName: lastName,
                dateOfBirth: document.getElementById('studentBirthDate').value,
                class: document.getElementById('studentClass').value,
                parentName: document.getElementById('studentParent').value || '',
                parentPhone1: document.getElementById('studentParentPhone').value || '',
                parentPhone2: document.getElementById('studentParentPhone2').value || '',
                parentEmail: document.getElementById('studentParentEmail').value || '',
                address: document.getElementById('studentAddress').value || '',
                branch: document.getElementById('studentBranch').value,
                enrollmentDate: document.getElementById('studentEnrollmentDate').value,
                enrollmentType: document.getElementById('studentEnrollmentType').value || 'R√©gulier',
                medicalConditions: document.getElementById('studentMedicalConditions').value || '',
                status: 'active',
                timestamp: Date.now(),
                createdBy: currentUserName
            };
            
            try {
                if (currentStudentId) {
                    await studentsRef.child(currentStudentId).update(studentData);
                    showToast('√âl√®ve mis √† jour avec succ√®s!', 'success');
                } else {
                    // V√©rifier si la r√©f√©rence existe d√©j√†
                    const existingSnapshot = await studentsRef
                        .orderByChild('referenceCode')
                        .equalTo(studentData.referenceCode)
                        .once('value');
                    
                    if (existingSnapshot.exists()) {
                        showToast('Cette r√©f√©rence existe d√©j√†!', 'error');
                        return;
                    }
                    
                    await studentsRef.push(studentData);
                    showToast('√âl√®ve ajout√© avec succ√®s!', 'success');
                }
                
                bootstrap.Modal.getInstance(document.getElementById('studentModal')).hide();
                document.getElementById('studentForm').reset();
                currentStudentId = null;
                
                // Recharger les √©l√®ves
                loadStudentsFromDatabase();
                
            } catch (error) {
                console.error('Erreur sauvegarde √©l√®ve:', error);
                showToast('Erreur lors de la sauvegarde', 'error');
            }
        }

        // Generate student reference
        function generateStudentReference() {
            const now = new Date();
            const timestamp = now.getTime();
            const random = Math.floor(Math.random() * 1000);
            document.getElementById('studentReference').value = `EDU-${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}-${timestamp.toString().slice(-6)}${random.toString().padStart(3, '0')}`;
        }

        // Delete student prompt
        function deleteStudentPrompt(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            if (confirm(`√ätes-vous s√ªr de vouloir supprimer l'√©l√®ve ${student.fullName}?`)) {
                deleteStudent(studentId);
            }
        }

        // Delete student
        async function deleteStudent(studentId) {
            try {
                const student = students.find(s => s.id === studentId);
                if (!student) return;
                
                await studentsRef.child(studentId).remove();
                showToast('√âl√®ve supprim√© avec succ√®s!', 'success');
                
            } catch (error) {
                console.error('Erreur suppression √©l√®ve:', error);
                showToast('Erreur lors de la suppression', 'error');
            }
        }

        // Show student fee modal
        function showStudentFeeModal() {
            document.getElementById('studentFeeForm').reset();
            currentStudentFeeId = null;
            document.getElementById('studentPaymentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('studentInfoDisplay').style.display = 'none';
            
            // Charger les √©l√®ves de la branche s√©lectionn√©e
            loadStudentsByClass();
            
            const modal = new bootstrap.Modal(document.getElementById('studentFeeModal'));
            modal.show();
        }

        // Load students by class
        function loadStudentsByClass() {
            const selectedClass = document.getElementById('studentClassFilter').value;
            const select = document.getElementById('studentSelect');
            select.innerHTML = '<option value="">S√©lectionnez un √©l√®ve</option>';
            
            if (!selectedClass) return;
            
            // Filtrer par branche et classe
            const classStudents = students.filter(student => 
                student.branch === selectedBranch && 
                student.class === selectedClass
            );
            
            classStudents.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.reference} - ${student.fullName}`;
                select.appendChild(option);
            });
        }

        // Load student details when selected
        function loadStudentDetails() {
            const studentId = document.getElementById('studentSelect').value;
            const student = students.find(s => s.id === studentId);
            
            if (!student) {
                document.getElementById('studentInfoDisplay').style.display = 'none';
                return;
            }
            
            document.getElementById('studentReferenceDisplay').value = student.reference || 'N/A';
            document.getElementById('studentBirthDateDisplay').value = student.birthDate ? new Date(student.birthDate).toLocaleDateString('fr-FR') : 'N/A';
            document.getElementById('studentParentDisplay').value = student.parent || 'N/A';
            
            document.getElementById('studentInfoDisplay').style.display = 'flex';
        }

        // Save student fee
        async function saveStudentFee() {
            const form = document.getElementById('studentFeeForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const studentId = document.getElementById('studentSelect').value;
            const student = students.find(s => s.id === studentId);
            
            if (!student) {
                showToast('Veuillez s√©lectionner un √©l√®ve', 'error');
                return;
            }
            
            const feeData = {
                studentId: studentId,
                studentName: student.fullName,
                studentClass: student.class,
                reference: document.getElementById('studentTransactionRef').value || `PAY-${Date.now()}`,
                paymentType: document.getElementById('studentPaymentType').value,
                amount: parseFloat(document.getElementById('studentAmount').value),
                paymentMode: document.getElementById('studentPaymentMode').value,
                paymentDate: document.getElementById('studentPaymentDate').value,
                notes: document.getElementById('studentPaymentNotes').value || '',
                receivedBy: currentUserName,
                timestamp: Date.now(),
                branch: student.branch
            };
            
            try {
                await studentFeesRef.push(feeData);
                showToast('Paiement enregistr√© avec succ√®s!', 'success');
                
                await announcementsRef.push({
                    timestamp: Date.now(),
                    message: `Paiement enregistr√© pour ${student.fullName}: ${formatCurrencyRWF(feeData.amount)}`,
                    author: 'system',
                    type: 'student_payment'
                });
                
                bootstrap.Modal.getInstance(document.getElementById('studentFeeModal')).hide();
                document.getElementById('studentFeeForm').reset();
                
            } catch (error) {
                console.error('Erreur enregistrement paiement:', error);
                showToast('Erreur lors de l\'enregistrement', 'error');
            }
        }

        // Load student fees
        async function loadStudentFees() {
            try {
                const tbody = document.getElementById('studentFeesTable');
                tbody.innerHTML = '';
                
                // Filtrer par branche
                const branchFees = studentFees.filter(fee => {
                    const student = students.find(s => s.id === fee.studentId);
                    return student && student.branch === selectedBranch;
                });
                
                if (branchFees.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="11" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="fas fa-money-bill-wave fa-2x mb-3"></i>
                                    <p>Aucun paiement trouv√© dans cette branche</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                branchFees.sort((a, b) => new Date(b.paymentDate) - new Date(a.paymentDate));
                
                branchFees.forEach((fee, index) => {
                    const student = students.find(s => s.id === fee.studentId);
                    const paymentTypeBadge = fee.paymentType === 'minervale' ? 'badge-minervale' :
                                           fee.paymentType === 'coaching' ? 'badge-coaching' :
                                           fee.paymentType === 'transport' ? 'badge-transport' :
                                           'badge bg-secondary';
                    
                    const tr = document.createElement('tr');
                    tr.className = 'animate-fade-in';
                    tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td><strong>${fee.reference || 'N/A'}</strong></td>
                        <td>${fee.studentName || 'N/A'}</td>
                        <td>${fee.studentClass || 'N/A'}</td>
                        <td><span class="${paymentTypeBadge}">${getPaymentTypeText(fee.paymentType)}</span></td>
                        <td><strong>${formatCurrencyRWF(fee.amount)}</strong></td>
                        <td>${new Date(fee.paymentDate).toLocaleDateString('fr-FR')}</td>
                        <td><span class="${fee.paymentMode === 'bank' ? 'badge-bank' : fee.paymentMode === 'momo' ? 'badge-momo' : 'badge-cash'}">${fee.paymentMode === 'bank' ? 'Banque' : fee.paymentMode === 'momo' ? 'Mobile Money' : 'Esp√®ces'}</span></td>
                        <td>${formatCurrencyRWF(0)}</td>
                        <td>${fee.receivedBy || 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteStudentFeePrompt('${fee.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                
            } catch (error) {
                console.error('Erreur chargement paiements:', error);
                showToast('Erreur lors du chargement des paiements', 'error');
            }
        }

        // Delete student fee prompt
        function deleteStudentFeePrompt(feeId) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce paiement?')) {
                deleteStudentFee(feeId);
            }
        }

        // Delete student fee
        async function deleteStudentFee(feeId) {
            try {
                await studentFeesRef.child(feeId).remove();
                showToast('Paiement supprim√© avec succ√®s!', 'success');
                
            } catch (error) {
                console.error('Erreur suppression paiement:', error);
                showToast('Erreur lors de la suppression', 'error');
            }
        }

        // Filter student payments
        function filterStudentPayments() {
            const selectedClass = document.getElementById('filterClass').value;
            const selectedMonth = document.getElementById('filterMonth').value;
            
            const tbody = document.getElementById('studentFeesTable');
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach(row => {
                let showRow = true;
                
                // Filtrer par classe
                if (selectedClass) {
                    const classCell = row.cells[3]; // Index de la cellule classe
                    if (classCell && !classCell.textContent.includes(selectedClass)) {
                        showRow = false;
                    }
                }
                
                // Filtrer par mois
                if (selectedMonth) {
                    const dateCell = row.cells[6]; // Index de la cellule date
                    if (dateCell) {
                        const rowDate = new Date(dateCell.textContent);
                        const rowMonth = `${rowDate.getFullYear()}-${(rowDate.getMonth() + 1).toString().padStart(2, '0')}`;
                        if (rowMonth !== selectedMonth) {
                            showRow = false;
                        }
                    }
                }
                
                row.style.display = showRow ? '' : 'none';
            });
        }

        // Update daily report table with automatic calculation
        function updateDailyReportTable() {
            const date = document.getElementById('dailyReportDate').value;
            
            if (!date) {
                console.error('Date non sp√©cifi√©e');
                return;
            }
            
            // Calculer les paiements du jour par cat√©gorie (filtrer par branche)
            const dayFees = studentFees.filter(fee => {
                const feeDate = new Date(fee.paymentDate);
                const feeDateStr = feeDate.toISOString().split('T')[0];
                
                // V√©rifier aussi la branche
                const student = students.find(s => s.id === fee.studentId);
                return feeDateStr === date && student && student.branch === selectedBranch;
            });
            
            // Initialiser les totaux par cat√©gorie
            let minerval = 0;
            let transport = 0;
            let coaching = 0;
            let uniforme = 0;
            let autres = 0;
            
            // Calculer les totaux par cat√©gorie
            dayFees.forEach(fee => {
                const amount = parseFloat(fee.amount) || 0;
                switch(fee.paymentType) {
                    case 'minervale':
                        minerval += amount;
                        break;
                    case 'transport':
                        transport += amount;
                        break;
                    case 'coaching':
                        coaching += amount;
                        break;
                    case 'uniforme':
                        uniforme += amount;
                        break;
                    default:
                        autres += amount;
                        break;
                }
            });
            
            // Calculer les d√©penses du jour (depuis dailyExpenses) - filtrer par branche
            const dayExpenses = dailyExpenses.filter(expense => expense.date === date && expense.branch === selectedBranch);
            const totalDepenses = dayExpenses.reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
            
            // Pr√©parer les justifications (cat√©gories des d√©penses)
            const justifications = dayExpenses.length > 0 
                ? dayExpenses.map(exp => `${exp.category}: ${formatCurrencyRWF(exp.amount)}`).join('<br>')
                : 'Aucune d√©pense enregistr√©e';
            
            // R√©cup√©rer le solde d'ouverture (depuis localStorage ou 0)
            const soldeOuverture = parseFloat(localStorage.getItem(`openingBalance_${date}_${selectedBranch}`)) || 0;
            
            // Calculer les totaux
            const totalEntrees = minerval + transport + coaching + uniforme + autres;
            const soldeFinal = soldeOuverture + totalEntrees - totalDepenses;
            const difference = totalEntrees - totalDepenses;
            
            // Mettre √† jour le tableau
            const tbody = document.getElementById('dailyReportBody');
            tbody.innerHTML = `
                <tr>
                    <td>
                        <input type="number" class="form-control opening-balance-input" 
                               id="openingBalance" value="${soldeOuverture}" 
                               onchange="saveOpeningBalance('${date}')">
                    </td>
                    <td><strong class="money-in">${formatCurrencyRWF(minerval).replace('RWF', '')}</strong></td>
                    <td><strong class="money-in">${formatCurrencyRWF(transport).replace('RWF', '')}</strong></td>
                    <td><strong class="money-in">${formatCurrencyRWF(coaching).replace('RWF', '')}</strong></td>
                    <td><strong class="money-in">${formatCurrencyRWF(uniforme).replace('RWF', '')}</strong></td>
                    <td><strong class="money-in">${formatCurrencyRWF(autres).replace('RWF', '')}</strong></td>
                    <td class="justification-cell"><small>${justifications}</small></td>
                    <td><strong class="money-out">${formatCurrencyRWF(totalDepenses).replace('RWF', '')}</strong></td>
                    <td><strong class="money-out">${formatCurrencyRWF(totalDepenses).replace('RWF', '')}</strong></td>
                    <td><strong class="balance">${formatCurrencyRWF(soldeFinal).replace('RWF', '')}</strong></td>
                    <td><strong class="${difference >= 0 ? 'money-in' : 'money-out'}">
                        ${formatCurrencyRWF(difference).replace('RWF', '')}
                    </strong></td>
                </tr>
            `;
            
            // Mettre √† jour le r√©sum√© des paiements du jour
            updateDaySummary(dayFees, dayExpenses, soldeOuverture, soldeFinal, difference);
        }

        // Sauvegarder le solde d'ouverture
        function saveOpeningBalance(date) {
            const openingBalance = parseFloat(document.getElementById('openingBalance').value) || 0;
            localStorage.setItem(`openingBalance_${date}_${selectedBranch}`, openingBalance);
            updateDailyReportTable(); // Recalculer tout
        }

        // Mettre √† jour le r√©sum√© de la journ√©e
        function updateDaySummary(fees, expenses, soldeOuverture, soldeFinal, difference) {
            const totalEntrees = fees.reduce((sum, fee) => sum + (parseFloat(fee.amount) || 0), 0);
            const totalDepenses = expenses.reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
            
            const summaryHTML = `
                <div class="report-summary-cards">
                    <div class="summary-card income">
                        <h6><i class="fas fa-money-bill-wave me-2"></i>Total Entr√©es</h6>
                        <div class="summary-value">${formatCurrencyRWF(totalEntrees)}</div>
                        <small>${fees.length} paiement(s) re√ßu(s)</small>
                    </div>
                    <div class="summary-card expenses">
                        <h6><i class="fas fa-shopping-cart me-2"></i>Total D√©penses</h6>
                        <div class="summary-value">${formatCurrencyRWF(totalDepenses)}</div>
                        <small>${expenses.length} d√©pense(s) enregistr√©e(s)</small>
                    </div>
                    <div class="summary-card balance">
                        <h6><i class="fas fa-wallet me-2"></i>Solde Ouverture</h6>
                        <div class="summary-value">${formatCurrencyRWF(soldeOuverture)}</div>
                        <small>Solde initial</small>
                    </div>
                    <div class="summary-card ${difference >= 0 ? 'income' : 'expenses'}">
                        <h6><i class="fas fa-balance-scale me-2"></i>Diff√©rence</h6>
                        <div class="summary-value">${formatCurrencyRWF(difference)}</div>
                        <small>${difference >= 0 ? 'B√©n√©fice' : 'D√©ficit'}</small>
                    </div>
                </div>
            `;
            
            // Ajouter le r√©sum√© au-dessus du tableau
            const existingSummary = document.getElementById('daySummary');
            if (existingSummary) {
                existingSummary.innerHTML = summaryHTML;
            } else {
                const summaryDiv = document.createElement('div');
                summaryDiv.id = 'daySummary';
                summaryDiv.innerHTML = summaryHTML;
                document.querySelector('#dailyReportSection .table-responsive').insertAdjacentElement('beforebegin', summaryDiv);
            }
        }

        // Charger le rapport journalier avec donn√©es r√©elles
        function loadDailyReport() {
            const date = document.getElementById('dailyReportDate').value;
            
            if (!date) {
                // D√©finir la date d'aujourd'hui par d√©faut
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('dailyReportDate').value = today;
            }
            
            // Charger les d√©penses pour cette date
            loadExpensesForDate(date || document.getElementById('dailyReportDate').value);
            
            // Mettre √† jour le tableau avec les donn√©es r√©elles
            updateDailyReportTable();
            
            // Charger un rapport existant s'il y en a un
            loadExistingReport(date);
        }

        // Charger les d√©penses depuis Firebase pour une date sp√©cifique
        async function loadExpensesForDate(date) {
            try {
                const snapshot = await dailyExpensesRef
                    .orderByChild('date')
                    .equalTo(date)
                    .once('value');
                
                dailyExpenses = [];
                snapshot.forEach(childSnapshot => {
                    const expense = {
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    };
                    dailyExpenses.push(expense);
                });
                
                console.log(`${dailyExpenses.length} d√©penses charg√©es pour ${date}`);
                
            } catch (error) {
                console.error('Erreur chargement d√©penses:', error);
            }
        }

        // Mettre √† jour la liste des d√©penses (affich√©e sous le formulaire)
        function updateExpensesList() {
            const container = document.getElementById('expensesList');
            container.innerHTML = '';
            
            const date = document.getElementById('dailyReportDate').value;
            const dayExpenses = dailyExpenses.filter(exp => exp.date === date && exp.branch === selectedBranch);
            
            if (dayExpenses.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Aucune d√©pense enregistr√©e pour le ${new Date(date).toLocaleDateString('fr-FR')}
                    </div>
                `;
                return;
            }
            
            // Cr√©er une carte pour chaque d√©pense
            dayExpenses.forEach(expense => {
                const expenseCard = document.createElement('div');
                expenseCard.className = 'expense-item';
                expenseCard.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${expense.category}</strong>
                            <div class="text-muted">${expense.addedBy} - ${new Date(expense.timestamp).toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'})}</div>
                        </div>
                        <div class="text-end">
                            <div class="text-danger fw-bold">${formatCurrencyRWF(expense.amount)}</div>
                            <button class="btn btn-sm btn-outline-danger mt-1" onclick="removeExpense('${expense.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(expenseCard);
            });
            
            // Ajouter le total
            const total = dayExpenses.reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
            const totalDiv = document.createElement('div');
            totalDiv.className = 'mt-3 p-3 bg-light rounded';
            totalDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <strong>Total des d√©penses pour cette journ√©e:</strong>
                    <strong class="text-danger fs-5">${formatCurrencyRWF(total)}</strong>
                </div>
            `;
            container.appendChild(totalDiv);
        }

        // Ajouter une d√©pense avec enregistrement Firebase
        async function addDailyExpense() {
            const category = document.getElementById('expenseCategory').value;
            const amountInput = document.getElementById('expenseAmount').value;
            const amount = parseFloat(amountInput);
            const date = document.getElementById('dailyReportDate').value;
            
            if (!category || !amount || amount <= 0 || !date) {
                showToast('Veuillez remplir correctement tous les champs', 'error');
                return;
            }
            
            try {
                const expenseData = {
                    category: category,
                    amount: amount,
                    date: date,
                    addedBy: currentUserName,
                    branch: selectedBranch,
                    timestamp: Date.now()
                };
                
                // Enregistrer dans Firebase
                await dailyExpensesRef.push(expenseData);
                
                // Mettre √† jour l'affichage
                await loadExpensesForDate(date);
                updateExpensesList();
                updateDailyReportTable();
                
                // R√©initialiser le formulaire
                document.getElementById('expenseCategory').value = '';
                document.getElementById('expenseAmount').value = '';
                
                showToast('D√©pense enregistr√©e avec succ√®s', 'success');
                
            } catch (error) {
                console.error('Erreur enregistrement d√©pense:', error);
                showToast('Erreur lors de l\'enregistrement de la d√©pense', 'error');
            }
        }

        // Supprimer une d√©pense
        async function removeExpense(expenseId) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette d√©pense?')) return;
            
            try {
                await dailyExpensesRef.child(expenseId).remove();
                
                const date = document.getElementById('dailyReportDate').value;
                await loadExpensesForDate(date);
                updateExpensesList();
                updateDailyReportTable();
                
                showToast('D√©pense supprim√©e avec succ√®s', 'success');
            } catch (error) {
                console.error('Erreur suppression d√©pense:', error);
                showToast('Erreur lors de la suppression', 'error');
            }
        }

        // Sauvegarder le rapport journalier
        async function saveDailyReport() {
            try {
                const date = document.getElementById('dailyReportDate').value;
                const openingBalance = parseFloat(document.getElementById('openingBalance').value) || 0;
                
                // Calculer les totaux (filtrer par branche)
                const dayFees = studentFees.filter(fee => {
                    const feeDate = new Date(fee.paymentDate);
                    const feeDateStr = feeDate.toISOString().split('T')[0];
                    const student = students.find(s => s.id === fee.studentId);
                    return feeDateStr === date && student && student.branch === selectedBranch;
                });
                
                const totalIncome = dayFees.reduce((sum, fee) => sum + (fee.amount || 0), 0);
                const branchExpenses = dailyExpenses.filter(exp => exp.date === date && exp.branch === selectedBranch);
                const totalExpenses = branchExpenses.reduce((sum, exp) => sum + (exp.amount || 0), 0);
                const difference = totalIncome - totalExpenses;
                const closingBalance = openingBalance + difference;
                
                // Pr√©parer les donn√©es du rapport
                const reportData = {
                    date: date,
                    openingBalance: openingBalance,
                    totalIncome: totalIncome,
                    totalExpenses: totalExpenses,
                    difference: difference,
                    closingBalance: closingBalance,
                    branch: selectedBranch,
                    
                    // Donn√©es du formulaire
                    generalObservations: document.getElementById('generalObservations').value,
                    status: 'draft',
                    
                    preparedBy: document.getElementById('reportPreparedBy').value,
                    generatedBy: currentUserName,
                    timestamp: Date.now(),
                    type: 'daily'
                };
                
                // Sauvegarder dans Firebase
                await dailyReportsRef.push(reportData);
                
                // Ajouter √† l'historique
                await reportHistoryRef.push(reportData);
                
                showToast('Rapport journalier enregistr√© avec succ√®s!', 'success');
                
            } catch (error) {
                console.error('Erreur sauvegarde rapport:', error);
                showToast('Erreur lors de l\'enregistrement du rapport', 'error');
            }
        }

        // Load existing report
        async function loadExistingReport(date) {
            try {
                const snapshot = await dailyReportsRef
                    .orderByChild('date')
                    .equalTo(date)
                    .once('value');
                
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const report = childSnapshot.val();
                        if (report.branch === selectedBranch) {
                            // Remplir le formulaire avec les donn√©es du rapport
                            document.getElementById('generalObservations').value = report.generalObservations || '';
                            document.getElementById('openingBalance').value = report.openingBalance || 0;
                            
                            showToast('Rapport existant charg√©', 'info');
                        }
                    });
                }
            } catch (error) {
                console.error('Erreur chargement rapport:', error);
            }
        }

        // Show daily report
        function showDailyReport() {
            document.getElementById('dailyReportSection').style.display = 'block';
            document.getElementById('weeklyReportSection').style.display = 'none';
            document.getElementById('monthlyReportSection').style.display = 'none';
            loadDailyReport();
        }

        // Show weekly report
        function showWeeklyReport() {
            document.getElementById('dailyReportSection').style.display = 'none';
            document.getElementById('weeklyReportSection').style.display = 'block';
            document.getElementById('monthlyReportSection').style.display = 'none';
            loadWeeklyReport();
        }

        // Show monthly report
        function showMonthlyReport() {
            document.getElementById('dailyReportSection').style.display = 'none';
            document.getElementById('weeklyReportSection').style.display = 'none';
            document.getElementById('monthlyReportSection').style.display = 'block';
            loadMonthlyReport();
        }

        // Initialize charts
        function initializeCharts() {
            // Weekly chart
            const weeklyCtx = document.getElementById('weeklyChart');
            if (weeklyCtx) {
                weeklyChart = new Chart(weeklyCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'],
                        datasets: [{
                            label: 'Income (RWF)',
                            data: [0, 0, 0, 0, 0, 0, 0],
                            borderColor: 'rgba(46, 139, 87, 1)',
                            backgroundColor: 'rgba(46, 139, 87, 0.2)',
                            tension: 0.4
                        }, {
                            label: 'Expenses (RWF)',
                            data: [0, 0, 0, 0, 0, 0, 0],
                            borderColor: 'rgba(220, 20, 60, 1)',
                            backgroundColor: 'rgba(220, 20, 60, 0.2)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        }
                    }
                });
            }
            
            // Monthly chart
            const monthlyCtx = document.getElementById('monthlyChart');
            if (monthlyCtx) {
                monthlyChart = new Chart(monthlyCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'],
                        datasets: [{
                            label: 'Income (RWF)',
                            data: [0, 0, 0, 0],
                            backgroundColor: 'rgba(46, 139, 87, 0.7)',
                            borderColor: 'rgba(46, 139, 87, 1)',
                            borderWidth: 1
                        }, {
                            label: 'Expenses (RWF)',
                            data: [0, 0, 0, 0],
                            backgroundColor: 'rgba(220, 20, 60, 0.7)',
                            borderColor: 'rgba(220, 20, 60, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        // Update real payroll chart
        function updateRealPayrollChart() {
            const ctx = document.getElementById('realPayrollChart');
            if (!ctx) return;
            
            if (realPayrollChart) {
                realPayrollChart.destroy();
            }
            
            const currentYear = new Date().getFullYear();
            const monthlyData = Array(12).fill(0);
            
            // Filtrer par branche
            const branchTeachers = teachers.filter(teacher => teacher.branch === selectedBranch);
            
            // Pour l'instant, utiliser les salaires des travailleurs comme donn√©es
            monthlyData[new Date().getMonth()] = branchTeachers.reduce((sum, teacher) => sum + (teacher.salary || 0), 0);
            
            const monthNames = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ªt', 'Sep', 'Oct', 'Nov', 'D√©c'];
            
            realPayrollChart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: monthNames,
                    datasets: [{
                        label: 'Payroll Total (RWF)',
                        data: monthlyData,
                        backgroundColor: 'rgba(46, 139, 87, 0.7)',
                        borderColor: 'rgba(46, 139, 87, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    animation: {
                        duration: 2000,
                        easing: 'easeOutQuart'
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return (value / 1000000).toFixed(1) + 'M RWF';
                                    } else if (value >= 1000) {
                                        return (value / 1000).toFixed(0) + 'K RWF';
                                    }
                                    return value + ' RWF';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Save settings
        async function saveSettings() {
            const settingsData = {
                overtimeRate: parseFloat(document.getElementById('overtimeRate').value) || 0,
                socialRate: parseFloat(document.getElementById('socialRate').value) || 0,
                paymentDay: document.getElementById('paymentDay').value,
                currency: document.getElementById('currency').value,
                updatedBy: currentUserName,
                updatedAt: Date.now()
            };
            
            try {
                await settingsRef.set(settingsData);
                showToast('Param√®tres enregistr√©s avec succ√®s!', 'success');
            } catch (error) {
                console.error('Erreur sauvegarde param√®tres:', error);
                showToast('Erreur lors de l\'enregistrement des param√®tres', 'error');
            }
        }

        // Save accountant info
        async function saveAccountantInfo() {
            const accountantData = {
                name: document.getElementById('accountantName').value,
                title: document.getElementById('accountantTitle').value,
                email: document.getElementById('accountantEmail').value,
                updatedAt: Date.now()
            };
            
            try {
                await accountantRef.set(accountantData);
                currentUserName = accountantData.name;
                document.getElementById('userName').textContent = accountantData.name;
                document.getElementById('preparedBy').textContent = accountantData.name;
                document.getElementById('reportPreparedBy').value = accountantData.name;
                showToast('Informations comptable enregistr√©es avec succ√®s!', 'success');
            } catch (error) {
                console.error('Erreur sauvegarde informations comptable:', error);
                showToast('Erreur lors de l\'enregistrement', 'error');
            }
        }

        // Save fee configuration
        async function saveFeeConfiguration() {
            const feeConfigData = {
                branch: document.getElementById('feeBranch').value,
                quarter: document.getElementById('feeQuarter').value,
                year: document.getElementById('feeYear').value,
                minervale: parseFloat(document.getElementById('feeMinervale').value) || 0,
                transport: parseFloat(document.getElementById('feeTransport').value) || 0,
                coaching: parseFloat(document.getElementById('feeCoaching').value) || 0,
                uniform: parseFloat(document.getElementById('feeUniform').value) || 0,
                lunch: parseFloat(document.getElementById('feeLunch').value) || 0,
                breakfast: parseFloat(document.getElementById('feeBreakfast').value) || 0,
                material: parseFloat(document.getElementById('feeMaterial').value) || 0,
                insurance: parseFloat(document.getElementById('feeInsurance').value) || 0,
                updatedBy: currentUserName,
                updatedAt: Date.now()
            };
            
            try {
                // Cr√©er une cl√© unique bas√©e sur la branche, trimestre et ann√©e
                const configKey = `${feeConfigData.branch.replace(/\s+/g, '_')}_${feeConfigData.quarter}_${feeConfigData.year}`;
                await feeConfigRef.child(configKey).set(feeConfigData);
                showToast('Configuration des frais enregistr√©e avec succ√®s!', 'success');
            } catch (error) {
                console.error('Erreur sauvegarde configuration frais:', error);
                showToast('Erreur lors de l\'enregistrement', 'error');
            }
        }

        // Backup data
        async function backupData() {
            try {
                // R√©cup√©rer toutes les donn√©es
                const allData = {
                    teachers: teachers,
                    students: students,
                    studentFees: studentFees,
                    debts: debts,
                    dailyExpenses: dailyExpenses,
                    payrollHistory: payrollHistory,
                    timestamp: Date.now(),
                    backedUpBy: currentUserName
                };
                
                // Cr√©er un blob JSON
                const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // Cr√©er un lien de t√©l√©chargement
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_edensmart_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast('Sauvegarde cr√©√©e avec succ√®s!', 'success');
            } catch (error) {
                console.error('Erreur sauvegarde:', error);
                showToast('Erreur lors de la sauvegarde', 'error');
            }
        }

        // Export all data Excel
        async function exportAllDataExcel() {
            try {
                // Pr√©parer les donn√©es pour l'export
                const exportData = {
                    Travailleurs: teachers.filter(t => t.branch === selectedBranch).map(t => ({
                        NO: t.no,
                        Nom: t.name,
                        Type: t.type,
                        T√©l√©phone: t.phone,
                        'Mode Paiement': t.paymentMode,
                        'Salaire Base': t.salary,
                        'Date Embauche': t.hireDate,
                        Statut: t.status
                    })),
                    
                    √âl√®ves: students.filter(s => s.branch === selectedBranch).map(s => ({
                        R√©f√©rence: s.reference,
                        'Nom Complet': s.fullName,
                        Classe: s.class,
                        'Date Naissance': s.birthDate,
                        Parent: s.parent,
                        'T√©l√©phone Parent': s.parentPhone,
                        Statut: s.status
                    })),
                    
                    'Paiements √âl√®ves': studentFees.filter(f => {
                        const student = students.find(s => s.id === f.studentId);
                        return student && student.branch === selectedBranch;
                    }).map(f => ({
                        R√©f√©rence: f.reference,
                        √âl√®ve: f.studentName,
                        Classe: f.studentClass,
                        Type: f.paymentType,
                        Montant: f.amount,
                        'Mode Paiement': f.paymentMode,
                        Date: f.paymentDate,
                        'Re√ßu par': f.receivedBy
                    })),
                    
                    Dettes: debts.filter(d => {
                        const worker = teachers.find(t => t.id === d.workerId);
                        return worker && worker.branch === selectedBranch;
                    }).map(d => ({
                        Travailleur: d.workerName,
                        Montant: d.amount,
                        Motif: d.reason,
                        Date: d.date,
                        Statut: d.status
                    }))
                };
                
                // Cr√©er le classeur Excel
                const wb = XLSX.utils.book_new();
                
                // Ajouter chaque feuille
                Object.keys(exportData).forEach(sheetName => {
                    if (exportData[sheetName].length > 0) {
                        const ws = XLSX.utils.json_to_sheet(exportData[sheetName]);
                        XLSX.utils.book_append_sheet(wb, ws, sheetName);
                    }
                });
                
                // G√©n√©rer le fichier
                XLSX.writeFile(wb, `export_edensmart_${selectedBranch}_${new Date().toISOString().split('T')[0]}.xlsx`);
                
                showToast('Donn√©es export√©es en Excel avec succ√®s!', 'success');
            } catch (error) {
                console.error('Erreur export Excel:', error);
                showToast('Erreur lors de l\'export', 'error');
            }
        }

        // Logout
        function logout() {
            if (confirm('√ätes-vous s√ªr de vouloir vous d√©connecter?')) {
                auth.signOut().then(() => {
                    window.location.href = 'Auth.html';
                }).catch((error) => {
                    console.error('Erreur d√©connexion:', error);
                    showToast('Erreur lors de la d√©connexion', 'error');
                });
            }
        }

        // Toast notification
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast-notification ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <div class="flex-grow-1">
                    <div class="fw-bold">${type === 'success' ? 'Succ√®s' : type === 'error' ? 'Erreur' : 'Information'}</div>
                    <div>${message}</div>
                </div>
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;
            
            container.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }

        // Perform global search
        function performGlobalSearch(query) {
            if (!query || query.length < 2) {
                document.getElementById('searchResults').style.display = 'none';
                return;
            }
            
            const searchTerm = query.toLowerCase();
            const results = [];
            
            // Rechercher dans les travailleurs
            teachers.forEach(teacher => {
                if (teacher.branch === selectedBranch && 
                    (teacher.name.toLowerCase().includes(searchTerm) || 
                     teacher.no.toLowerCase().includes(searchTerm) ||
                     teacher.phone.includes(searchTerm))) {
                    results.push({
                        type: 'Travailleur',
                        name: teacher.name,
                        id: teacher.id,
                        action: () => {
                            showSection('teachers');
                            setTimeout(() => editWorker(teacher.id), 500);
                        }
                    });
                }
            });
            
            // Rechercher dans les √©l√®ves
            students.forEach(student => {
                if (student.branch === selectedBranch && 
                    (student.fullName.toLowerCase().includes(searchTerm) || 
                     student.reference.toLowerCase().includes(searchTerm) ||
                     student.parent.toLowerCase().includes(searchTerm))) {
                    results.push({
                        type: '√âl√®ve',
                        name: student.fullName,
                        id: student.id,
                        action: () => {
                            showSection('students');
                            setTimeout(() => viewStudentProfile(student.id), 500);
                        }
                    });
                }
            });
            
            // Afficher les r√©sultats
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '';
            
            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="search-result-item">
                        <div class="text-muted">Aucun r√©sultat trouv√©</div>
                    </div>
                `;
            } else {
                results.slice(0, 10).forEach(result => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.innerHTML = `
                        <div class="fw-bold">${result.type}: ${result.name}</div>
                        <small class="text-muted">Cliquez pour voir les d√©tails</small>
                    `;
                    item.onclick = result.action;
                    resultsContainer.appendChild(item);
                });
            }
            
            resultsContainer.style.display = 'block';
        }

        // Close search results when clicking outside
        document.addEventListener('click', function(event) {
            const searchContainer = document.getElementById('searchResults');
            const searchInput = document.getElementById('globalSearch');
            
            if (searchContainer && searchInput && 
                !searchContainer.contains(event.target) && 
                !searchInput.contains(event.target)) {
                searchContainer.style.display = 'none';
            }
        });

        // Language toggle functionality
        function toggleLanguage() {
            const languageBtn = document.getElementById('languageText');
            const isFrench = languageBtn.textContent === 'FR';
            
            if (isFrench) {
                languageBtn.textContent = 'EN';
                translateToEnglish();
            } else {
                languageBtn.textContent = 'FR';
                translateToFrench();
            }
        }

        function translateToEnglish() {
            // Navigation buttons
            document.querySelectorAll('.nav-btn span').forEach(span => {
                if (span.textContent === 'Tableau de bord') span.textContent = 'Dashboard';
                if (span.textContent === 'Gestion Travailleurs') span.textContent = 'Workers Management';
                if (span.textContent === 'G√©n√©rer Payroll') span.textContent = 'Generate Payroll';
                if (span.textContent === 'Paiements') span.textContent = 'Payments';
                if (span.textContent === '√âl√®ves') span.textContent = 'Students';
                if (span.textContent === 'Rapports Financiers') span.textContent = 'Financial Reports';
                if (span.textContent === 'Param√®tres') span.textContent = 'Settings';
            });
            
            // Dashboard section
            const dashboardSection = document.getElementById('dashboard');
            if (dashboardSection.classList.contains('active')) {
                document.querySelector('.dashboard-hero h1').textContent = 'Financial Dashboard';
                document.querySelector('.dashboard-hero p.lead').textContent = 'Compliant with Rwandan financial laws';
                document.getElementById('currencyDisplay').textContent = 'Currency: RWF (Rwandan Franc)';
                
                document.querySelectorAll('.stat-card p.text-muted').forEach(p => {
                    if (p.textContent === 'Total Travailleurs') p.textContent = 'Total Workers';
                    if (p.textContent === 'Payroll du Mois') p.textContent = 'Monthly Payroll';
                    if (p.textContent === 'Paiements Banque') p.textContent = 'Bank Payments';
                    if (p.textContent === 'Paiements √âl√®ves') p.textContent = 'Student Payments';
                });
                
                document.querySelector('.chart-container h5').innerHTML = '<i class="fas fa-chart-bar me-2 icon-text-primary"></i> Real Payroll Statistics';
                document.querySelectorAll('.list-group-item small')[0].textContent = 'Loading...';
                document.querySelectorAll('.list-group-item p')[0].textContent = 'Loading announcements...';
            }
        }

        function translateToFrench() {
            // Navigation buttons
            document.querySelectorAll('.nav-btn span').forEach(span => {
                if (span.textContent === 'Dashboard') span.textContent = 'Tableau de bord';
                if (span.textContent === 'Workers Management') span.textContent = 'Gestion Travailleurs';
                if (span.textContent === 'Generate Payroll') span.textContent = 'G√©n√©rer Payroll';
                if (span.textContent === 'Payments') span.textContent = 'Paiements';
                if (span.textContent === 'Students') span.textContent = '√âl√®ves';
                if (span.textContent === 'Financial Reports') span.textContent = 'Rapports Financiers';
                if (span.textContent === 'Settings') span.textContent = 'Param√®tres';
            });
            
            // Dashboard section
            const dashboardSection = document.getElementById('dashboard');
            if (dashboardSection.classList.contains('active')) {
                document.querySelector('.dashboard-hero h1').textContent = 'Tableau de Bord Financier';
                document.querySelector('.dashboard-hero p.lead').textContent = 'Gestion conforme aux lois financi√®res du Rwanda';
                document.getElementById('currencyDisplay').textContent = 'Devise: RWF (Franc Rwandais)';
                
                document.querySelectorAll('.stat-card p.text-muted').forEach(p => {
                    if (p.textContent === 'Total Workers') p.textContent = 'Total Travailleurs';
                    if (p.textContent === 'Monthly Payroll') p.textContent = 'Payroll du Mois';
                    if (p.textContent === 'Bank Payments') p.textContent = 'Paiements Banque';
                    if (p.textContent === 'Student Payments') p.textContent = 'Paiements √âl√®ves';
                });
                
                document.querySelector('.chart-container h5').innerHTML = '<i class="fas fa-chart-bar me-2 icon-text-primary"></i> Statistiques Payroll R√©elles';
                document.querySelectorAll('.list-group-item small')[0].textContent = 'Chargement...';
                document.querySelectorAll('.list-group-item p')[0].textContent = 'Chargement des annonces...';
            }
        }

        // Add event listener to language toggle button
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('languageToggle').addEventListener('click', toggleLanguage);
        });

        // ===== RAPPORTS FINANCIERS =====
        // Variables pour les rapports
        let weeklyReportChart = null;
        let monthlyReportChart = null;

        function showWeeklyReport() {
            document.getElementById('dailyReportSection').style.display = 'none';
            document.getElementById('weeklyReportSection').style.display = 'block';
            document.getElementById('monthlyReportSection').style.display = 'none';
            
            const today = new Date();
            const firstDayOfYear = new Date(today.getFullYear(), 0, 1);
            const pastDaysOfYear = (today - firstDayOfYear) / 86400000;
            const weekNumber = Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
            
            document.getElementById('weeklyReportDate').value = `${today.getFullYear()}-W${weekNumber.toString().padStart(2, '0')}`;
            loadWeeklyReport();
        }

        function showMonthlyReport() {
            document.getElementById('dailyReportSection').style.display = 'none';
            document.getElementById('weeklyReportSection').style.display = 'none';
            document.getElementById('monthlyReportSection').style.display = 'block';
            
            const today = new Date();
            document.getElementById('monthlyReportDate').value = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
            loadMonthlyReport();
        }

        async function loadWeeklyReport() {
            try {
                const weekInput = document.getElementById('weeklyReportDate').value;
                if (!weekInput) return;
                
                const [year, week] = weekInput.split('-W');
                const weekNumber = parseInt(week);
                
                const firstDayOfYear = new Date(year, 0, 1);
                const firstMonday = new Date(firstDayOfYear);
                firstMonday.setDate(firstDayOfYear.getDate() + ((8 - firstDayOfYear.getDay()) % 7 || 7) - 7);
                
                const startDate = new Date(firstMonday);
                startDate.setDate(firstMonday.getDate() + (weekNumber - 1) * 7);
                
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6);
                
                document.getElementById('weeklyPeriod').value = 
                    `Semaine ${weekNumber} (${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')})`;
                
                const days = [];
                const incomeData = [];
                const expensesData = [];
                const balanceData = [];
                
                for (let i = 0; i < 7; i++) {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + i);
                    const dateStr = currentDate.toISOString().split('T')[0];
                    
                    const dayIncome = studentFees.filter(fee => {
                        const feeDate = new Date(fee.paymentDate);
                        const feeDateStr = feeDate.toISOString().split('T')[0];
                        const student = students.find(s => s.id === fee.studentId);
                        return feeDateStr === dateStr && student && student.branch === selectedBranch;
                    }).reduce((sum, fee) => sum + (parseFloat(fee.amount) || 0), 0);
                    
                    const dayExpenses = dailyExpenses.filter(exp => 
                        exp.date === dateStr && exp.branch === selectedBranch
                    ).reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
                    
                    const openingBalance = parseFloat(localStorage.getItem(`openingBalance_${dateStr}_${selectedBranch}`)) || 0;
                    const closingBalance = openingBalance + dayIncome - dayExpenses;
                    
                    days.push(getDayName(i));
                    incomeData.push(dayIncome);
                    expensesData.push(dayExpenses);
                    balanceData.push(closingBalance);
                }
                
                updateWeeklyChart(days, incomeData, expensesData, balanceData);
                updateWeeklyTable(startDate, endDate);
                
            } catch (error) {
                console.error('Erreur chargement rapport hebdomadaire:', error);
                showToast('Erreur lors du chargement du rapport hebdomadaire', 'error');
            }
        }

        async function loadMonthlyReport() {
            try {
                const monthInput = document.getElementById('monthlyReportDate').value;
                if (!monthInput) return;
                
                const [year, month] = monthInput.split('-');
                const monthIndex = parseInt(month) - 1;
                
                const weeks = [];
                const weekData = [];
                
                const firstDayOfMonth = new Date(year, monthIndex, 1);
                const lastDayOfMonth = new Date(year, monthIndex + 1, 0);
                
                const totalDays = lastDayOfMonth.getDate();
                const daysPerWeek = Math.ceil(totalDays / 4);
                
                for (let week = 0; week < 4; week++) {
                    const startDay = week * daysPerWeek + 1;
                    const endDay = Math.min((week + 1) * daysPerWeek, totalDays);
                    
                    if (startDay > totalDays) break;
                    
                    let weekIncome = 0;
                    let weekExpenses = 0;
                    
                    for (let day = startDay; day <= endDay; day++) {
                        const currentDate = new Date(year, monthIndex, day);
                        const dateStr = currentDate.toISOString().split('T')[0];
                        
                        const dayIncome = studentFees.filter(fee => {
                            const feeDate = new Date(fee.paymentDate);
                            const feeDateStr = feeDate.toISOString().split('T')[0];
                            const student = students.find(s => s.id === fee.studentId);
                            return feeDateStr === dateStr && student && student.branch === selectedBranch;
                        }).reduce((sum, fee) => sum + (parseFloat(fee.amount) || 0), 0);
                        
                        const dayExpenses = dailyExpenses.filter(exp => 
                            exp.date === dateStr && exp.branch === selectedBranch
                        ).reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
                        
                        weekIncome += dayIncome;
                        weekExpenses += dayExpenses;
                    }
                    
                    weeks.push(`Semaine ${week + 1} (${startDay}-${endDay})`);
                    weekData.push({
                        income: weekIncome,
                        expenses: weekExpenses,
                        balance: weekIncome - weekExpenses
                    });
                }
                
                const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                                   'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
                document.getElementById('monthlyPeriod').value = `${monthNames[monthIndex]} ${year}`;
                
                updateMonthlyChart(weeks, weekData);
                updateMonthlyTable(weeks, weekData);
                
            } catch (error) {
                console.error('Erreur chargement rapport mensuel:', error);
                showToast('Erreur lors du chargement du rapport mensuel', 'error');
            }
        }

        function updateWeeklyChart(days, incomeData, expensesData, balanceData) {
            const ctx = document.getElementById('weeklyChart');
            if (!ctx) return;
            
            if (weeklyReportChart) {
                weeklyReportChart.destroy();
            }
            
            weeklyReportChart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: days,
                    datasets: [
                        {
                            label: 'Revenus (RWF)',
                            data: incomeData,
                            backgroundColor: 'rgba(46, 139, 87, 0.7)',
                            borderColor: 'rgba(46, 139, 87, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'D√©penses (RWF)',
                            data: expensesData,
                            backgroundColor: 'rgba(220, 20, 60, 0.7)',
                            borderColor: 'rgba(220, 20, 60, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Solde (RWF)',
                            data: balanceData,
                            type: 'line',
                            fill: false,
                            borderColor: 'rgba(32, 178, 170, 1)',
                            backgroundColor: 'rgba(32, 178, 170, 0.2)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return (value / 1000).toFixed(0) + 'K';
                                    }
                                    return value;
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += formatCurrencyRWF(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateMonthlyChart(weeks, weekData) {
            const ctx = document.getElementById('monthlyChart');
            if (!ctx) return;
            
            if (monthlyReportChart) {
                monthlyReportChart.destroy();
            }
            
            monthlyReportChart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: weeks,
                    datasets: [
                        {
                            label: 'Revenus (RWF)',
                            data: weekData.map(w => w.income),
                            backgroundColor: 'rgba(46, 139, 87, 0.7)',
                            borderColor: 'rgba(46, 139, 87, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'D√©penses (RWF)',
                            data: weekData.map(w => w.expenses),
                            backgroundColor: 'rgba(220, 20, 60, 0.7)',
                            borderColor: 'rgba(220, 20, 60, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return (value / 1000).toFixed(0) + 'K';
                                    }
                                    return value;
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += formatCurrencyRWF(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateWeeklyTable(startDate, endDate) {
            const tbody = document.getElementById('weeklyReportTable');
            tbody.innerHTML = '';
            
            let totalIncome = 0;
            let totalExpenses = 0;
            
            for (let i = 0; i < 7; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                const dateStr = currentDate.toISOString().split('T')[0];
                
                if (currentDate > endDate) break;
                
                const dayIncome = studentFees.filter(fee => {
                    const feeDate = new Date(fee.paymentDate);
                    const feeDateStr = feeDate.toISOString().split('T')[0];
                    const student = students.find(s => s.id === fee.studentId);
                    return feeDateStr === dateStr && student && student.branch === selectedBranch;
                }).reduce((sum, fee) => sum + (parseFloat(fee.amount) || 0), 0);
                
                const dayExpenses = dailyExpenses.filter(exp => 
                    exp.date === dateStr && exp.branch === selectedBranch
                ).reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
                
                const openingBalance = parseFloat(localStorage.getItem(`openingBalance_${dateStr}_${selectedBranch}`)) || 0;
                const closingBalance = openingBalance + dayIncome - dayExpenses;
                const difference = dayIncome - dayExpenses;
                
                totalIncome += dayIncome;
                totalExpenses += dayExpenses;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${getDayName(i)} ${currentDate.getDate()}</td>
                    <td class="money-in">${formatCurrencyRWF(openingBalance)}</td>
                    <td class="money-in">${formatCurrencyRWF(dayIncome)}</td>
                    <td class="money-out">${formatCurrencyRWF(dayExpenses)}</td>
                    <td class="balance">${formatCurrencyRWF(closingBalance)}</td>
                    <td class="${difference >= 0 ? 'money-in' : 'money-out'}">${formatCurrencyRWF(difference)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewDailyReport('${dateStr}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            }
            
            const totalRow = document.createElement('tr');
            totalRow.className = 'table-info';
            totalRow.innerHTML = `
                <td><strong>TOTAL SEMAINE</strong></td>
                <td></td>
                <td class="money-in"><strong>${formatCurrencyRWF(totalIncome)}</strong></td>
                <td class="money-out"><strong>${formatCurrencyRWF(totalExpenses)}</strong></td>
                <td></td>
                <td class="${(totalIncome - totalExpenses) >= 0 ? 'money-in' : 'money-out'}">
                    <strong>${formatCurrencyRWF(totalIncome - totalExpenses)}</strong>
                </td>
                <td></td>
            `;
            tbody.appendChild(totalRow);
        }

        function updateMonthlyTable(weeks, weekData) {
            const tbody = document.getElementById('monthlyReportTable');
            tbody.innerHTML = '';
            
            let totalMonthlyIncome = 0;
            let totalMonthlyExpenses = 0;
            
            weeks.forEach((weekLabel, index) => {
                const week = weekData[index];
                
                totalMonthlyIncome += week.income;
                totalMonthlyExpenses += week.expenses;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${weekLabel}</td>
                    <td class="money-in">${formatCurrencyRWF(week.income)}</td>
                    <td class="money-out">${formatCurrencyRWF(week.expenses)}</td>
                    <td class="balance">${formatCurrencyRWF(week.balance)}</td>
                    <td class="${week.balance >= 0 ? 'money-in' : 'money-out'}">${formatCurrencyRWF(week.balance)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewWeekReport(${index + 1})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            const totalRow = document.createElement('tr');
            totalRow.className = 'table-info';
            totalRow.innerHTML = `
                <td><strong>TOTAL MOIS</strong></td>
                <td class="money-in"><strong>${formatCurrencyRWF(totalMonthlyIncome)}</strong></td>
                <td class="money-out"><strong>${formatCurrencyRWF(totalMonthlyExpenses)}</strong></td>
                <td></td>
                <td class="${(totalMonthlyIncome - totalMonthlyExpenses) >= 0 ? 'money-in' : 'money-out'}">
                    <strong>${formatCurrencyRWF(totalMonthlyIncome - totalMonthlyExpenses)}</strong>
                </td>
                <td></td>
            `;
            tbody.appendChild(totalRow);
        }

        function getDayName(dayIndex) {
            const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
            return days[dayIndex];
        }

        function viewDailyReport(date) {
            showSection('reports');
            document.getElementById('dailyReportDate').value = date;
            setTimeout(() => loadDailyReport(), 500);
        }

        function viewWeekReport(weekNumber) {
            showSection('reports');
            showWeeklyReport();
            const today = new Date();
            document.getElementById('weeklyReportDate').value = `${today.getFullYear()}-W${weekNumber.toString().padStart(2, '0')}`;
            setTimeout(() => loadWeeklyReport(), 500);
        }

        async function generateWeeklyReport() {
            try {
                const weekInput = document.getElementById('weeklyReportDate').value;
                const preparedBy = document.getElementById('weeklyReportPreparedBy').value;
                const summary = document.getElementById('weeklySummary').value;
                
                if (!weekInput) {
                    showToast('Veuillez s√©lectionner une semaine', 'error');
                    return;
                }
                
                const [year, week] = weekInput.split('-W');
                
                const firstDayOfYear = new Date(year, 0, 1);
                const firstMonday = new Date(firstDayOfYear);
                firstMonday.setDate(firstDayOfYear.getDate() + ((8 - firstDayOfYear.getDay()) % 7 || 7) - 7);
                
                const startDate = new Date(firstMonday);
                startDate.setDate(firstMonday.getDate() + (parseInt(week) - 1) * 7);
                
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6);
                
                let totalIncome = 0;
                let totalExpenses = 0;
                
                for (let i = 0; i < 7; i++) {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + i);
                    const dateStr = currentDate.toISOString().split('T')[0];
                    
                    const dayIncome = studentFees.filter(fee => {
                        const feeDate = new Date(fee.paymentDate);
                        const feeDateStr = feeDate.toISOString().split('T')[0];
                        const student = students.find(s => s.id === fee.studentId);
                        return feeDateStr === dateStr && student && student.branch === selectedBranch;
                    }).reduce((sum, fee) => sum + (parseFloat(fee.amount) || 0), 0);
                    
                    const dayExpenses = dailyExpenses.filter(exp => 
                        exp.date === dateStr && exp.branch === selectedBranch
                    ).reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
                    
                    totalIncome += dayIncome;
                    totalExpenses += dayExpenses;
                }
                
                const reportData = {
                    type: 'weekly',
                    week: week,
                    year: year,
                    startDate: startDate.toISOString().split('T')[0],
                    endDate: endDate.toISOString().split('T')[0],
                    totalIncome: totalIncome,
                    totalExpenses: totalExpenses,
                    difference: totalIncome - totalExpenses,
                    preparedBy: preparedBy,
                    summary: summary,
                    branch: selectedBranch,
                    timestamp: Date.now(),
                    generatedBy: currentUserName
                };
                
                await weeklyReportsRef.push(reportData);
                await reportHistoryRef.push(reportData);
                
                showToast('Rapport hebdomadaire g√©n√©r√© avec succ√®s!', 'success');
                
            } catch (error) {
                console.error('Erreur g√©n√©ration rapport:', error);
                showToast('Erreur lors de la g√©n√©ration du rapport', 'error');
            }
        }

        async function generateMonthlyReport() {
            try {
                const monthInput = document.getElementById('monthlyReportDate').value;
                const preparedBy = document.getElementById('monthlyReportPreparedBy').value;
                const analysis = document.getElementById('monthlyAnalysis').value;
                
                if (!monthInput) {
                    showToast('Veuillez s√©lectionner un mois', 'error');
                    return;
                }
                
                const [year, month] = monthInput.split('-');
                
                const monthIndex = parseInt(month) - 1;
                const firstDay = new Date(year, monthIndex, 1);
                const lastDay = new Date(year, monthIndex + 1, 0);
                
                const monthlyIncome = studentFees.filter(fee => {
                    const feeDate = new Date(fee.paymentDate);
                    const student = students.find(s => s.id === fee.studentId);
                    return feeDate >= firstDay && feeDate <= lastDay && 
                           student && student.branch === selectedBranch;
                }).reduce((sum, fee) => sum + (parseFloat(fee.amount) || 0), 0);
                
                const monthlyExpenses = dailyExpenses.filter(exp => {
                    const expDate = new Date(exp.date);
                    return expDate >= firstDay && expDate <= lastDay && 
                           exp.branch === selectedBranch;
                }).reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
                
                const reportData = {
                    type: 'monthly',
                    month: month,
                    year: year,
                    totalIncome: monthlyIncome,
                    totalExpenses: monthlyExpenses,
                    difference: monthlyIncome - monthlyExpenses,
                    preparedBy: preparedBy,
                    analysis: analysis,
                    branch: selectedBranch,
                    timestamp: Date.now(),
                    generatedBy: currentUserName
                };
                
                await monthlyReportsRef.push(reportData);
                await reportHistoryRef.push(reportData);
                
                showToast('Rapport mensuel g√©n√©r√© avec succ√®s!', 'success');
                
            } catch (error) {
                console.error('Erreur g√©n√©ration rapport:', error);
                showToast('Erreur lors de la g√©n√©ration du rapport', 'error');
            }
        }

        // ===== FILTRAGE √âL√àVES =====
        function filterStudents() {
            const selectedClass = document.getElementById('filterClassStudents').value;
            const searchQuery = document.getElementById('searchStudent').value.toLowerCase();
            
            const tbody = document.getElementById('studentsTable');
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const classCell = row.cells[3];
                const nameCell = row.cells[2];
                
                let showRow = true;
                
                if (selectedClass && classCell && !classCell.textContent.includes(selectedClass)) {
                    showRow = false;
                }
                
                if (searchQuery && nameCell && !nameCell.textContent.toLowerCase().includes(searchQuery)) {
                    showRow = false;
                }
                
                row.style.display = showRow ? '' : 'none';
            });
        }

        async function filterStudentsByPaymentWeek() {
            const week = document.getElementById('filterPaymentWeek').value;
            
            if (!week) {
                loadStudents();
                return;
            }
            
            try {
                const today = new Date();
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();
                
                let startDate, endDate;
                
                switch(week) {
                    case '1':
                        startDate = new Date(currentYear, currentMonth, 1);
                        endDate = new Date(currentYear, currentMonth, 7);
                        break;
                    case '2':
                        startDate = new Date(currentYear, currentMonth, 8);
                        endDate = new Date(currentYear, currentMonth, 14);
                        break;
                    case '3':
                        startDate = new Date(currentYear, currentMonth, 15);
                        endDate = new Date(currentYear, currentMonth, 21);
                        break;
                    case '4':
                        startDate = new Date(currentYear, currentMonth, 22);
                        endDate = new Date(currentYear, currentMonth, 28);
                        break;
                    case '5':
                        startDate = new Date(currentYear, currentMonth, 29);
                        endDate = new Date(currentYear, currentMonth, 31);
                        break;
                }
                
                const studentsWithPayments = students.filter(student => {
                    const studentPayments = studentFees.filter(fee => 
                        fee.studentId === student.id && 
                        fee.branch === selectedBranch
                    );
                    
                    return studentPayments.some(payment => {
                        const paymentDate = new Date(payment.paymentDate);
                        return paymentDate >= startDate && paymentDate <= endDate;
                    });
                });
                
                const tbody = document.getElementById('studentsTable');
                tbody.innerHTML = '';
                
                if (studentsWithPayments.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="fas fa-search fa-2x mb-3"></i>
                                    <p>Aucun √©l√®ve avec paiements cette semaine</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                studentsWithPayments.forEach((student, index) => {
                    const studentPayments = studentFees.filter(fee => 
                        fee.studentId === student.id && 
                        fee.branch === selectedBranch
                    );
                    
                    const weeklyPayments = studentPayments.filter(payment => {
                        const paymentDate = new Date(payment.paymentDate);
                        return paymentDate >= startDate && paymentDate <= endDate;
                    });
                    
                    const totalPaid = weeklyPayments.reduce((sum, payment) => sum + (payment.amount || 0), 0);
                    
                    const tr = document.createElement('tr');
                    tr.className = 'animate-fade-in';
                    tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td><strong>${student.reference || 'N/A'}</strong></td>
                        <td>${student.fullName}</td>
                        <td>${student.class || ''}</td>
                        <td>${student.birthDate ? new Date(student.birthDate).toLocaleDateString('fr-FR') : ''}</td>
                        <td>${formatCurrencyRWF(totalPaid)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="viewStudentProfile('${student.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info me-1" onclick="editStudent('${student.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteStudentPrompt('${student.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                
            } catch (error) {
                console.error('Erreur filtrage par semaine:', error);
                showToast('Erreur lors du filtrage', 'error');
            }
        }

        // ===== EXPORT EXCEL RAPPORTS =====
        function exportWeeklyReportExcel() {
            try {
                const weekInput = document.getElementById('weeklyReportDate').value;
                if (!weekInput) {
                    showToast('Veuillez s√©lectionner une semaine', 'error');
                    return;
                }
                
                const [year, week] = weekInput.split('-W');
                const weekNumber = parseInt(week);
                
                const firstDayOfYear = new Date(year, 0, 1);
                const firstMonday = new Date(firstDayOfYear);
                firstMonday.setDate(firstDayOfYear.getDate() + ((8 - firstDayOfYear.getDay()) % 7 || 7) - 7);
                
                const startDate = new Date(firstMonday);
                startDate.setDate(firstMonday.getDate() + (weekNumber - 1) * 7);
                
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6);
                
                const exportData = [];
                let totalIncome = 0;
                let totalExpenses = 0;
                
                for (let i = 0; i < 7; i++) {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + i);
                    const dateStr = currentDate.toISOString().split('T')[0];
                    
                    const dayIncome = studentFees.filter(fee => {
                        const feeDate = new Date(fee.paymentDate);
                        const feeDateStr = feeDate.toISOString().split('T')[0];
                        const student = students.find(s => s.id === fee.studentId);
                        return feeDateStr === dateStr && student && student.branch === selectedBranch;
                    }).reduce((sum, fee) => sum + (parseFloat(fee.amount) || 0), 0);
                    
                    const dayExpenses = dailyExpenses.filter(exp => 
                        exp.date === dateStr && exp.branch === selectedBranch
                    ).reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
                    
                    totalIncome += dayIncome;
                    totalExpenses += dayExpenses;
                    
                    exportData.push({
                        'Jour': getDayName(i),
                        'Date': currentDate.toLocaleDateString('fr-FR'),
                        'Revenus': formatCurrencyRWF(dayIncome).replace('RWF', '').trim(),
                        'D√©penses': formatCurrencyRWF(dayExpenses).replace('RWF', '').trim(),
                        'Solde': formatCurrencyRWF(dayIncome - dayExpenses).replace('RWF', '').trim()
                    });
                }
                
                exportData.push({
                    'Jour': 'TOTAL SEMAINE',
                    'Date': '',
                    'Revenus': formatCurrencyRWF(totalIncome).replace('RWF', '').trim(),
                    'D√©penses': formatCurrencyRWF(totalExpenses).replace('RWF', '').trim(),
                    'Solde': formatCurrencyRWF(totalIncome - totalExpenses).replace('RWF', '').trim()
                });
                
                exportData.push({});
                exportData.push({
                    'Jour': 'Pr√©par√© par:',
                    'Date': document.getElementById('weeklyReportPreparedBy').value
                });
                exportData.push({
                    'Jour': 'P√©riode:',
                    'Date': document.getElementById('weeklyPeriod').value
                });
                exportData.push({
                    'Jour': 'Branche:',
                    'Date': document.getElementById('currentBranchText').textContent
                });
                
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Rapport Hebdomadaire");
                
                const wscols = [
                    {wch: 15},
                    {wch: 15},
                    {wch: 20},
                    {wch: 20},
                    {wch: 20}
                ];
                ws['!cols'] = wscols;
                
                XLSX.writeFile(wb, `Rapport_Hebdomadaire_S${weekNumber}_${year}_${selectedBranch}.xlsx`);
                showToast('Rapport hebdomadaire export√© avec succ√®s', 'success');
                
            } catch (error) {
                console.error('Erreur export Excel:', error);
                showToast('Erreur lors de l\'export Excel', 'error');
            }
        }

        function exportMonthlyReportExcel() {
            try {
                const monthInput = document.getElementById('monthlyReportDate').value;
                if (!monthInput) {
                    showToast('Veuillez s√©lectionner un mois', 'error');
                    return;
                }
                
                const [year, month] = monthInput.split('-');
                const monthIndex = parseInt(month) - 1;
                const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                                   'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
                const monthName = monthNames[monthIndex];
                
                const exportData = [];
                let totalMonthlyIncome = 0;
                let totalMonthlyExpenses = 0;
                
                const firstDayOfMonth = new Date(year, monthIndex, 1);
                const lastDayOfMonth = new Date(year, monthIndex + 1, 0);
                const totalDays = lastDayOfMonth.getDate();
                const daysPerWeek = Math.ceil(totalDays / 4);
                
                for (let week = 0; week < 4; week++) {
                    const startDay = week * daysPerWeek + 1;
                    const endDay = Math.min((week + 1) * daysPerWeek, totalDays);
                    
                    if (startDay > totalDays) break;
                    
                    let weekIncome = 0;
                    let weekExpenses = 0;
                    
                    for (let day = startDay; day <= endDay; day++) {
                        const currentDate = new Date(year, monthIndex, day);
                        const dateStr = currentDate.toISOString().split('T')[0];
                        
                        const dayIncome = studentFees.filter(fee => {
                            const feeDate = new Date(fee.paymentDate);
                            const feeDateStr = feeDate.toISOString().split('T')[0];
                            const student = students.find(s => s.id === fee.studentId);
                            return feeDateStr === dateStr && student && student.branch === selectedBranch;
                        }).reduce((sum, fee) => sum + (parseFloat(fee.amount) || 0), 0);
                        
                        const dayExpenses = dailyExpenses.filter(exp => 
                            exp.date === dateStr && exp.branch === selectedBranch
                        ).reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
                        
                        weekIncome += dayIncome;
                        weekExpenses += dayExpenses;
                    }
                    
                    totalMonthlyIncome += weekIncome;
                    totalMonthlyExpenses += weekExpenses;
                    
                    exportData.push({
                        'Semaine': `Semaine ${week + 1} (${startDay}-${endDay})`,
                        'Revenus': formatCurrencyRWF(weekIncome).replace('RWF', '').trim(),
                        'D√©penses': formatCurrencyRWF(weekExpenses).replace('RWF', '').trim(),
                        'Solde': formatCurrencyRWF(weekIncome - weekExpenses).replace('RWF', '').trim()
                    });
                }
                
                exportData.push({
                    'Semaine': 'TOTAL MOIS',
                    'Revenus': formatCurrencyRWF(totalMonthlyIncome).replace('RWF', '').trim(),
                    'D√©penses': formatCurrencyRWF(totalMonthlyExpenses).replace('RWF', '').trim(),
                    'Solde': formatCurrencyRWF(totalMonthlyIncome - totalMonthlyExpenses).replace('RWF', '').trim()
                });
                
                exportData.push({});
                exportData.push({
                    'Semaine': 'Pr√©par√© par:',
                    'Revenus': document.getElementById('monthlyReportPreparedBy').value
                });
                exportData.push({
                    'Semaine': 'P√©riode:',
                    'Revenus': `${monthName} ${year}`
                });
                exportData.push({
                    'Semaine': 'Branche:',
                    'Revenus': document.getElementById('currentBranchText').textContent
                });
                
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Rapport Mensuel");
                
                const wscols = [
                    {wch: 25},
                    {wch: 20},
                    {wch: 20},
                    {wch: 20}
                ];
                ws['!cols'] = wscols;
                
                XLSX.writeFile(wb, `Rapport_Mensuel_${monthName}_${year}_${selectedBranch}.xlsx`);
                showToast('Rapport mensuel export√© avec succ√®s', 'success');
                
            } catch (error) {
                console.error('Erreur export Excel:', error);
                showToast('Erreur lors de l\'export Excel', 'error');
            }
        }

        // Student Management Functions for Settings
        let currentStudentIdAdmin = null;

        function generateStudentReferenceAdmin() {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const timestamp = Date.now().toString().slice(-6);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            
            document.getElementById('studentReferenceAdmin').value = `EDU-${year}${month}${day}-${timestamp}${random}`;
        }

        function resetStudentFormAdmin() {
            document.getElementById('studentFormAdmin').reset();
            currentStudentIdAdmin = null;
            document.getElementById('studentEnrollmentDateAdmin').value = new Date().toISOString().split('T')[0];
            document.getElementById('studentBranchAdmin').value = selectedBranch;
            document.getElementById('medicalConditionInfo').style.display = 'none';
            generateStudentReferenceAdmin();
        }

        // Toggle medical condition field
        document.addEventListener('DOMContentLoaded', function() {
            const medicalCheckbox = document.getElementById('studentHasMedicalCondition');
            if (medicalCheckbox) {
                medicalCheckbox.addEventListener('change', function() {
                    document.getElementById('medicalConditionInfo').style.display = this.checked ? 'block' : 'none';
                });
                
                // G√©n√©rer une r√©f√©rence pour le formulaire d'ajout d'√©l√®ve
                generateStudentReferenceAdmin();
                
                // D√©finir la date de naissance par d√©faut (5 ans)
                const defaultBirthDate = new Date();
                defaultBirthDate.setFullYear(defaultBirthDate.getFullYear() - 5);
                document.getElementById('studentBirthDateAdmin').value = defaultBirthDate.toISOString().split('T')[0];
            }
        });

        async function saveStudentAdmin() {
            const form = document.getElementById('studentFormAdmin');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const studentData = {
                reference: document.getElementById('studentReferenceAdmin').value,
                fullName: document.getElementById('studentFullNameAdmin').value,
                birthDate: document.getElementById('studentBirthDateAdmin').value,
                class: document.getElementById('studentClassAdmin').value,
                parent: document.getElementById('studentParentAdmin').value,
                parentPhone: document.getElementById('studentParentPhoneAdmin').value,
                parentEmail: document.getElementById('studentParentEmailAdmin').value || '',
                address: document.getElementById('studentAddressAdmin').value || '',
                branch: document.getElementById('studentBranchAdmin').value,
                enrollmentDate: document.getElementById('studentEnrollmentDateAdmin').value,
                enrollmentType: document.getElementById('studentEnrollmentTypeAdmin').value,
                hasMedicalCondition: document.getElementById('studentHasMedicalCondition').checked,
                medicalDetails: document.getElementById('studentMedicalDetails').value || '',
                status: 'active',
                totalPaid: 0,
                remainingBalance: 0,
                createdAt: Date.now(),
                createdBy: currentUserName,
                updatedAt: Date.now(),
                updatedBy: currentUserName
            };
            
            try {
                // V√©rifier si la r√©f√©rence existe d√©j√†
                const existingSnapshot = await studentsRef
                    .orderByChild('reference')
                    .equalTo(studentData.reference)
                    .once('value');
                
                if (existingSnapshot.exists()) {
                    showToast('Cette r√©f√©rence existe d√©j√†! Veuillez g√©n√©rer une nouvelle r√©f√©rence.', 'error');
                    generateStudentReferenceAdmin();
                    return;
                }
                
                // V√©rifier si l'√©l√®ve existe d√©j√† (par nom et date de naissance)
                const existingStudentSnapshot = await studentsRef
                    .orderByChild('fullName')
                    .equalTo(studentData.fullName)
                    .once('value');
                
                let studentExists = false;
                existingStudentSnapshot.forEach(childSnapshot => {
                    const existingStudent = childSnapshot.val();
                    if (existingStudent.birthDate === studentData.birthDate && existingStudent.branch === studentData.branch) {
                        studentExists = true;
                        currentStudentIdAdmin = childSnapshot.key;
                    }
                });
                
                if (studentExists && currentStudentIdAdmin) {
                    if (confirm('Un √©l√®ve avec le m√™me nom et date de naissance existe d√©j√†. Voulez-vous mettre √† jour ses informations?')) {
                        await studentsRef.child(currentStudentIdAdmin).update({
                            ...studentData,
                            updatedAt: Date.now(),
                            updatedBy: currentUserName
                        });
                        showToast('√âl√®ve mis √† jour avec succ√®s!', 'success');
                        
                        await announcementsRef.push({
                            timestamp: Date.now(),
                            message: `√âl√®ve ${studentData.fullName} mis √† jour dans le syst√®me`,
                            author: 'system',
                            type: 'student_update'
                        });
                    }
                } else {
                    await studentsRef.push(studentData);
                    showToast('√âl√®ve ajout√© avec succ√®s!', 'success');
                    
                    await announcementsRef.push({
                        timestamp: Date.now(),
                        message: `Nouvel √©l√®ve inscrit: ${studentData.fullName} (${studentData.class})`,
                        author: 'system',
                        type: 'student_add'
                    });
                }
                
                // R√©initialiser le formulaire
                resetStudentFormAdmin();
                
                // Recharger la liste des √©l√®ves si la section est active
                if (document.getElementById('students').classList.contains('active')) {
                    loadStudents();
                }
                
                // Mettre √† jour les statistiques
                updateStats();
                
            } catch (error) {
                console.error('Erreur sauvegarde √©l√®ve:', error);
                showToast('Erreur lors de la sauvegarde de l\'√©l√®ve: ' + error.message, 'error');
            }
        }

        // Fonction pour importer plusieurs √©l√®ves (optionnel)
        async function importStudents() {
            try {
                // Cr√©er un input file dynamiquement
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.csv,.xlsx,.xls';
                input.onchange = async (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    // Lire le fichier
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const data = e.target.result;
                            let studentsData = [];
                            
                            // V√©rifier le type de fichier
                            if (file.name.endsWith('.csv')) {
                                studentsData = parseCSV(data);
                            } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                                studentsData = parseExcel(data);
                            }
                            
                            if (studentsData.length === 0) {
                                showToast('Aucune donn√©e valide trouv√©e dans le fichier', 'error');
                                return;
                            }
                            
                            // Confirmer l'importation
                            if (!confirm(`Voulez-vous importer ${studentsData.length} √©l√®ves?`)) {
                                return;
                            }
                            
                            // Enregistrer chaque √©l√®ve
                            let successCount = 0;
                            let errorCount = 0;
                            
                            for (const student of studentsData) {
                                try {
                                    // G√©n√©rer une r√©f√©rence unique
                                    const reference = `EDU-${Date.now().toString().slice(-6)}${Math.floor(Math.random() * 1000)}`;
                                    
                                    const studentRecord = {
                                        reference: reference,
                                        fullName: student.fullName || '',
                                        birthDate: student.birthDate || '',
                                        class: student.class || '',
                                        parent: student.parent || '',
                                        parentPhone: student.parentPhone || '',
                                        parentEmail: student.parentEmail || '',
                                        address: student.address || '',
                                        branch: student.branch || selectedBranch,
                                        enrollmentDate: student.enrollmentDate || new Date().toISOString().split('T')[0],
                                        enrollmentType: student.enrollmentType || 'regular',
                                        status: 'active',
                                        totalPaid: 0,
                                        remainingBalance: 0,
                                        createdAt: Date.now(),
                                        createdBy: currentUserName
                                    };
                                    
                                    await studentsRef.push(studentRecord);
                                    successCount++;
                                    
                                } catch (error) {
                                    console.error('Erreur import √©l√®ve:', error);
                                    errorCount++;
                                }
                            }
                            
                            showToast(`${successCount} √©l√®ves import√©s avec succ√®s, ${errorCount} erreurs`, 'success');
                            
                            // Recharger la liste des √©l√®ves
                            loadStudents();
                            updateStats();
                            
                        } catch (error) {
                            console.error('Erreur traitement fichier:', error);
                            showToast('Erreur lors du traitement du fichier', 'error');
                        }
                    };
                    
                    // Lire le fichier selon son type
                    if (file.name.endsWith('.csv')) {
                        reader.readAsText(file);
                    } else {
                        reader.readAsArrayBuffer(file);
                    }
                };
                
                input.click();
                
            } catch (error) {
                console.error('Erreur import:', error);
                showToast('Erreur lors de l\'importation', 'error');
            }
        }

        // Fonctions pour parser les fichiers
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const students = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                
                const values = lines[i].split(',').map(v => v.trim());
                const student = {};
                
                headers.forEach((header, index) => {
                    if (values[index]) {
                        student[header] = values[index];
                    }
                });
                
                if (student.fullName && student.class) {
                    students.push(student);
                }
            }
            
            return students;
        }

        function parseExcel(arrayBuffer) {
            // Cette fonction n√©cessite la biblioth√®que SheetJS
            try {
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const data = XLSX.utils.sheet_to_json(firstSheet);
                
                return data.map(row => ({
                    fullName: row['Nom Complet'] || row['fullName'] || '',
                    birthDate: row['Date Naissance'] || row['birthDate'] || '',
                    class: row['Classe'] || row['class'] || '',
                    parent: row['Parent'] || row['parent'] || '',
                    parentPhone: row['T√©l√©phone'] || row['phone'] || '',
                    parentEmail: row['Email'] || row['email'] || '',
                    address: row['Adresse'] || row['address'] || '',
                    enrollmentDate: row['Date Inscription'] || row['enrollmentDate'] || '',
                    enrollmentType: row['Type'] || row['enrollmentType'] || 'regular'
                }));
            } catch (error) {
                console.error('Erreur parsing Excel:', error);
                return [];
            }
        }

        function downloadCSVTemplate() {
            const csvContent = "Nom Complet,Date Naissance,Classe,Parent,T√©l√©phone,Email,Adresse\n" +
                              "John Doe,2018-05-15,P1A,Jean Doe,0781234567,parent@email.com,Kigali\n" +
                              "Jane Smith,2017-08-22,N2B,Marie Smith,0787654321,parent2@email.com,Kacyiru";
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = 'template_eleves.csv';
            link.click();
            
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>